<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>AD LAB Build | HackThe4O4</title>

  <!-- keywords -->
  

  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="AD LAB Buildhttps:&#x2F;&#x2F;github.com&#x2F;Dewalt-arch&#x2F;pimpmyadlab  Lab Overview and Requirementsone windows server - server 2022 two windows 10 workstations Lab Build - (Cloud Alternative)Building Free Active Di">
<meta property="og:type" content="article">
<meta property="og:title" content="AD LAB Build">
<meta property="og:url" content="https://no-flag.com/2024/12/21/AD%20LAB%20build/index.html">
<meta property="og:site_name" content="HackThe4O4">
<meta property="og:description" content="AD LAB Buildhttps:&#x2F;&#x2F;github.com&#x2F;Dewalt-arch&#x2F;pimpmyadlab  Lab Overview and Requirementsone windows server - server 2022 two windows 10 workstations Lab Build - (Cloud Alternative)Building Free Active Di">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://no-flag.com/img/ADLAB_Untitled.png">
<meta property="og:image" content="https://no-flag.com/img/ADLAB_Untitled_1.png">
<meta property="og:image" content="https://no-flag.com/img/ADLAB_Untitled_2.png">
<meta property="og:image" content="https://no-flag.com/img/ADLAB_Untitled_3.png">
<meta property="og:image" content="https://no-flag.com/img/ADLAB_Untitled_4.png">
<meta property="og:image" content="https://no-flag.com/img/ADLAB_Untitled_5.png">
<meta property="og:image" content="https://no-flag.com/img/ADLAB_Untitled_6.png">
<meta property="og:image" content="https://no-flag.com/img/ADLAB_Untitled_7.png">
<meta property="og:image" content="https://no-flag.com/img/ADLAB_Untitled_8.png">
<meta property="og:image" content="https://no-flag.com/img/ADLAB_Untitled_9.png">
<meta property="og:image" content="https://no-flag.com/img/ADLAB_Untitled_10.png">
<meta property="og:image" content="https://no-flag.com/img/ADLAB_Untitled_11.png">
<meta property="og:image" content="https://no-flag.com/img/ADLAB_Untitled_12.png">
<meta property="og:image" content="https://no-flag.com/img/ADLAB_Untitled_13.png">
<meta property="og:image" content="https://no-flag.com/img/ADLAB_Untitled_14.png">
<meta property="og:image" content="https://no-flag.com/img/ADLAB_Untitled_15.png">
<meta property="og:image" content="https://no-flag.com/img/ADLAB_Untitled_16.png">
<meta property="og:image" content="https://no-flag.com/img/ADLAB_Untitled_17.png">
<meta property="og:image" content="https://no-flag.com/img/ADLAB_Untitled_18.png">
<meta property="og:image" content="https://no-flag.com/img/ADLAB_Untitled_19.png">
<meta property="og:image" content="https://no-flag.com/img/ADLAB_Untitled_20.png">
<meta property="og:image" content="https://no-flag.com/img/ADLAB_Untitled_21.png">
<meta property="og:image" content="https://no-flag.com/img/ADLAB_Untitled_22.png">
<meta property="og:image" content="https://no-flag.com/img/ADLAB_Untitled_23.png">
<meta property="og:image" content="https://no-flag.com/img/ADLAB_Untitled_24.png">
<meta property="og:image" content="https://no-flag.com/img/ADLAB_Untitled_25.png">
<meta property="og:image" content="https://no-flag.com/img/ADLAB_Untitled_26.png">
<meta property="og:image" content="https://no-flag.com/img/ADLAB_Untitled_27.png">
<meta property="og:image" content="https://no-flag.com/img/ADLAB_Untitled_28.png">
<meta property="og:image" content="https://no-flag.com/img/ADLAB_Untitled_29.png">
<meta property="og:image" content="https://no-flag.com/img/ADLAB_Untitled_30.png">
<meta property="og:image" content="https://no-flag.com/img/ADLAB_Untitled_31.png">
<meta property="og:image" content="https://no-flag.com/img/ADLAB_Untitled_32.png">
<meta property="og:image" content="https://no-flag.com/img/ADLAB_Untitled_33.png">
<meta property="og:image" content="https://no-flag.com/img/ADLAB_Untitled_34.png">
<meta property="og:image" content="https://no-flag.com/img/ADLAB_Untitled_35.png">
<meta property="og:image" content="https://no-flag.com/img/ADLAB_Untitled_36.png">
<meta property="og:image" content="https://no-flag.com/img/ADLAB_Untitled_37.png">
<meta property="og:image" content="https://no-flag.com/img/ADLAB_Untitled_38.png">
<meta property="og:image" content="https://no-flag.com/img/ADLAB_Untitled_39.png">
<meta property="og:image" content="https://no-flag.com/img/ADLAB_Untitled_40.png">
<meta property="og:image" content="https://no-flag.com/img/ADLAB_Untitled_41.png">
<meta property="og:image" content="https://no-flag.com/img/ADLAB_Untitled_42.png">
<meta property="og:image" content="https://no-flag.com/img/ADLAB_Untitled_43.png">
<meta property="og:image" content="https://no-flag.com/img/ADLAB_Untitled_44.png">
<meta property="og:image" content="https://no-flag.com/img/ADLAB_Untitled_45.png">
<meta property="og:image" content="https://no-flag.com/img/ADLAB_Untitled_46.png">
<meta property="og:image" content="https://no-flag.com/img/ADLAB_Untitled_47.png">
<meta property="og:image" content="https://no-flag.com/img/ADLAB_Untitled_48.png">
<meta property="og:image" content="https://no-flag.com/img/ADLAB_Untitled_49.png">
<meta property="og:image" content="https://no-flag.com/img/ADLAB_Untitled_50.png">
<meta property="og:image" content="https://no-flag.com/img/ADLAB_Untitled_51.png">
<meta property="og:image" content="https://no-flag.com/img/ADLAB_Untitled_52.png">
<meta property="og:image" content="https://no-flag.com/img/ADLAB_Untitled_53.png">
<meta property="og:image" content="https://no-flag.com/img/ADLAB_Untitled_54.png">
<meta property="og:image" content="https://no-flag.com/img/ADLAB_Untitled_55.png">
<meta property="og:image" content="https://no-flag.com/img/ADLAB_Untitled_56.png">
<meta property="og:image" content="https://no-flag.com/img/ADLAB_Untitled_57.png">
<meta property="og:image" content="https://no-flag.com/img/ADLAB_Untitled_58.png">
<meta property="og:image" content="https://no-flag.com/img/ADLAB_Untitled_59.png">
<meta property="og:image" content="https://no-flag.com/img/ADLAB_Untitled_60.png">
<meta property="og:image" content="https://no-flag.com/img/ADLAB_Untitled_61.png">
<meta property="og:image" content="https://no-flag.com/img/ADLAB_Untitled_62.png">
<meta property="og:image" content="https://no-flag.com/img/ADLAB_Untitled_63.png">
<meta property="og:image" content="https://no-flag.com/img/ADLAB_Untitled_64.png">
<meta property="og:image" content="https://no-flag.com/img/ADLAB_Untitled_65.png">
<meta property="og:image" content="https://no-flag.com/img/ADLAB_Untitled_66.png">
<meta property="og:image" content="https://no-flag.com/img/ADLAB_Untitled_67.png">
<meta property="og:image" content="https://no-flag.com/img/ADLAB_Untitled_68.png">
<meta property="og:image" content="https://no-flag.com/img/ADLAB_Untitled_69.png">
<meta property="og:image" content="https://no-flag.com/img/ADLAB_Untitled_70.png">
<meta property="og:image" content="https://no-flag.com/img/ADLAB_Untitled_71.png">
<meta property="og:image" content="https://no-flag.com/img/ADLAB_Untitled_72.png">
<meta property="og:image" content="https://no-flag.com/img/ADLAB_Untitled_73.png">
<meta property="og:image" content="https://no-flag.com/img/ADLAB_Untitled_74.png">
<meta property="og:image" content="https://no-flag.com/img/ADLAB_Untitled_75.png">
<meta property="og:image" content="https://no-flag.com/img/ADLAB_Untitled_76.png">
<meta property="og:image" content="https://no-flag.com/img/ADLAB_Untitled_77.png">
<meta property="article:published_time" content="2024-12-21T12:32:07.071Z">
<meta property="article:modified_time" content="2024-03-23T19:57:28.251Z">
<meta property="article:author" content="Noflag">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://no-flag.com/img/ADLAB_Untitled.png">
  
    <link rel="alternative" href="/atom.xml" title="HackThe4O4" type="application/atom+xml">
  
  
    <link rel="icon" href="/img/cat.jpg">
  
  
<link rel="stylesheet" href="/css/style.css">

  
  

  
<script src="//cdn.bootcss.com/require.js/2.3.2/require.min.js"></script>

  
<script src="//cdn.bootcss.com/jquery/3.1.1/jquery.min.js"></script>


  


<meta name="generator" content="Hexo 7.3.0"></head>
<body>
  <div id="container">
    <div id="particles-js"></div>
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			
			<img lazy-src="/img/mela.gif" class="js-avatar">
			
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/"></a></h1>
		</hgroup>

		

		

		<div class="switch-area">
			<div class="switch-wrap">
				<section class="switch-part switch-part1">
					<nav class="header-menu">
						<ul>
						
							<li><a href="/2024/12/21/hello-world/">About Me</a></li>
				        
							<li><a href="/archives">All articles</a></li>
				        
						</ul>
					</nav>
					<nav class="header-nav">
						<div class="social">
							
						</div>
					</nav>
				</section>
				
				
				
				

				
			</div>
		</div>
	</header>				
</div>
    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"></div>
  		<h1 class="header-author js-mobile-header hide"></h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
				<img lazy-src="/img/mela.gif" class="js-avatar">
			</div>
			<hgroup>
			  <h1 class="header-author"></h1>
			</hgroup>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/2024/12/21/hello-world/">About Me</a></li>
		        
					<li><a href="/archives">All articles</a></li>
		        
		        <div class="clearfix"></div>
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
				</div>
			</nav>
		</header>				
	</div>
</nav>
      <div class="body-wrap"><article id="post-AD LAB build" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2024/12/21/AD%20LAB%20build/" class="article-date">
  	<time datetime="2024-12-21T12:32:07.071Z" itemprop="datePublished">2024-12-21</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      AD LAB Build
      
    </h1>
  

      </header>
      
      <div class="article-info article-info-post">
        
        

        
        <div class="clearfix"></div>
      </div>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="AD-LAB-Build"><a href="#AD-LAB-Build" class="headerlink" title="AD LAB Build"></a>AD LAB Build</h1><p><a target="_blank" rel="noopener" href="https://github.com/Dewalt-arch/pimpmyadlab">https://github.com/Dewalt-arch/pimpmyadlab</a></p>
<hr>
<h2 id="Lab-Overview-and-Requirements"><a href="#Lab-Overview-and-Requirements" class="headerlink" title="Lab Overview and Requirements"></a><strong>Lab Overview and Requirements</strong></h2><p>one windows server - server 2022</p>
<p>two windows 10 workstations</p>
<h3 id="Lab-Build-Cloud-Alternative"><a href="#Lab-Build-Cloud-Alternative" class="headerlink" title="Lab Build - (Cloud Alternative)"></a><strong>Lab Build - (Cloud Alternative)</strong></h3><p>Building Free Active Directory Lab in Azure - <a target="_blank" rel="noopener" href="https://kamran-bilgrami.medium.com/ethical-hacking-lessons-building-free-active-directory-lab-in-azure-6c67a7eddd7f">https://kamran-bilgrami.medium.com/ethical-hacking-lessons-building-free-active-directory-lab-in-azure-6c67a7eddd7f</a></p>
<p>going to be building the lab in the cloud using Azure</p>
<ul>
<li>It need to cost money..</li>
</ul>
<h3 id="Downloading-Necessary-ISOs"><a href="#Downloading-Necessary-ISOs" class="headerlink" title="Downloading Necessary ISOs"></a><strong>Downloading Necessary ISOs</strong></h3><p><a target="_blank" rel="noopener" href="https://www.microsoft.com/en-us/evalcenter">https://www.microsoft.com/en-us/evalcenter</a></p>
<ul>
<li>免費的話每三十分鐘會關機</li>
</ul>
<p>下載這兩個iso</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://info.microsoft.com/ww-landing-windows-10-enterprise.html">Windows 10 Enterprise Trial (microsoft.com)</a></li>
<li><a target="_blank" rel="noopener" href="https://info.microsoft.com/ww-landing-windows-server-2022.html">Windows Server 2022 Trial (microsoft.com)</a></li>
</ul>
<table>
<thead>
<tr>
<th>Windows 10 Enterprise</th>
<th>XGVPP-NMH47-7TTHJ-W3FW7-8HV2C</th>
</tr>
</thead>
</table>
<p>vm 卡在BIOS&gt;</p>
<ul>
<li>記得改選項</li>
</ul>
<p><img src="/img/ADLAB_Untitled.png" alt="Untitled"></p>
<h2 id="Windows-server-setting-Domain-Controller"><a href="#Windows-server-setting-Domain-Controller" class="headerlink" title="Windows server setting - Domain Controller"></a>Windows server setting - Domain Controller</h2><p>Win Server &gt; choose 2&gt;I accept &gt;Custom&gt;click new&gt;Apply&gt;next&gt;</p>
<p><img src="/img/ADLAB_Untitled_1.png" alt="Untitled"></p>
<p>Customize setting &gt; P@$$w0rd! &gt; setup</p>
<ul>
<li>passwd → Akali@</li>
</ul>
<p><img src="/img/ADLAB_Untitled_2.png" alt="Untitled"></p>
<p>先對 WinServer 進行命名</p>
<p>可以再搜索框直接打name &gt; View your PC name &gt; Rename this PC&gt;設定任何名稱可以識別即可</p>
<p><img src="/img/ADLAB_Untitled_3.png" alt="Untitled"></p>
<h3 id="Make-this-a-domain-controller"><a href="#Make-this-a-domain-controller" class="headerlink" title="Make this a domain controller"></a>Make this a domain controller</h3><p><img src="/img/ADLAB_Untitled_4.png" alt="Untitled"></p>
<p>Server manager &gt; Manage &gt; Add Roles and Features &gt; next &gt; next &gt; 打勾 Active Directory Domain Service &gt;next&gt;next&gt;next&gt;打勾 Restart the destination server automatically &gt; Install </p>
<p>下載後會出現Promote this server to …，點擊進去</p>
<p><img src="/img/ADLAB_Untitled_5.png" alt="Untitled"></p>
<ul>
<li>Add a new forest<ul>
<li>cause we don’t have an existing domain and new domain to an existing forest</li>
</ul>
</li>
</ul>
<p>gonna create own forest, but this forest is gonna have one little domain in it </p>
<ul>
<li>finish fill the domain name &gt; click next</li>
</ul>
<p><img src="/img/ADLAB_Untitled_6.png" alt="Untitled"></p>
<p>Setting up a functional level</p>
<ul>
<li>Password</li>
</ul>
<p><img src="/img/ADLAB_Untitled_7.png" alt="Untitled"></p>
<p>next &gt; next&gt;這邊會生成domain name&gt;next&gt;next&gt;next</p>
<p><img src="/img/ADLAB_Untitled_8.png" alt="Untitled"></p>
<p>最後都設定好就直接下載</p>
<p><img src="/img/ADLAB_Untitled_9.png" alt="Untitled"></p>
<p>重開機後登入新的domain account</p>
<h3 id="Set-up-certificate-services"><a href="#Set-up-certificate-services" class="headerlink" title="Set up certificate services"></a>Set up certificate services</h3><ul>
<li>used to verify identities in a domain controller &gt; enhanced security</li>
<li>allow us used LDAP secure or LDAP s</li>
<li>LDAP is truly your phone book, lightweight Directory access protocol</li>
<li>want to add security or basic feature, make sure you’re implementing certificate services</li>
</ul>
<p>Server manager &gt; Manage &gt; Add Roles and Features &gt; next &gt; next &gt; 打勾Active Directory Certificate Services </p>
<p><img src="/img/ADLAB_Untitled_10.png" alt="Untitled"></p>
<p><img src="/img/ADLAB_Untitled_11.png" alt="Untitled"></p>
<p>next&gt;next&gt;next&gt;打勾 Restart the destination server automatically &gt; Install </p>
<p>下載完後進入設定</p>
<p><img src="/img/ADLAB_Untitled_12.png" alt="Untitled"></p>
<p>next &gt; check Certification Authority &gt; next&gt;next&gt;next&gt;next&gt;next&gt; change 99 year&gt;next&gt;configure </p>
<p>then reboot server </p>
<p><img src="/img/ADLAB_Untitled_13.png" alt="Untitled"></p>
<p><img src="/img/ADLAB_Untitled_14.png" alt="Untitled"></p>
<p><img src="/img/ADLAB_Untitled_15.png" alt="Untitled"></p>
<h3 id="Windows-10-setting-User-Machines-2"><a href="#Windows-10-setting-User-Machines-2" class="headerlink" title="Windows 10 setting- User Machines *2"></a>Windows 10 setting- User Machines *2</h3><p>在設定vm時記得要修改成Enterprise</p>
<p><img src="/img/ADLAB_Untitled_16.png" alt="Untitled"></p>
<p><img src="/img/ADLAB_Untitled_17.png" alt="Untitled"></p>
<p>兩台的vm設置相同，跟前面server的安裝過程一樣</p>
<p>選擇Domain join instead </p>
<p>陸續輸入帳號密碼，密碼一率都輸入Akali@</p>
<p><img src="/img/ADLAB_Untitled_18.png" alt="Untitled"></p>
<p>取消勾選所有選項</p>
<p><img src="/img/ADLAB_Untitled_19.png" alt="Untitled"></p>
<p><img src="/img/ADLAB_Untitled_20.png" alt="Untitled"></p>
<p>下載vm tool &gt; 設定主機名稱</p>
<p>重開機</p>
<hr>
<h2 id="Setting-Up-Users-Groups-and-Policies"><a href="#Setting-Up-Users-Groups-and-Policies" class="headerlink" title="Setting Up Users, Groups, and Policies"></a><strong>Setting Up Users, Groups, and Policies</strong></h2><p>modifying the domain controller and setting up some users, groups and policies</p>
<ul>
<li>adding users、look at OU、objects、domain policies</li>
<li>stores all of users and computers</li>
<li>here can see different OU</li>
</ul>
<p><img src="/img/ADLAB_Untitled_21.png" alt="Untitled"></p>
<p><img src="/img/ADLAB_Untitled_22.png" alt="Untitled"></p>
<ul>
<li><p>see the computer that are joined to the domain</p>
</li>
<li><p>see what users exist</p>
<p>  <img src="/img/ADLAB_Untitled_23.png" alt="Untitled"></p>
<ul>
<li>enterprise admins</li>
<li>domain admins</li>
<li>some of the important groups</li>
<li>good for us an attack<ul>
<li>compromise domain admin</li>
<li>enterprise admin..</li>
</ul>
</li>
</ul>
</li>
<li><p>separate these out</p>
</li>
</ul>
<p><img src="/img/ADLAB_Untitled_24.png" alt="Untitled"></p>
<p><img src="/img/ADLAB_Untitled_25.png" alt="Untitled"></p>
<ul>
<li>move that into groups &gt; click Don’t show this…</li>
</ul>
<p><img src="/img/ADLAB_Untitled_26.png" alt="Untitled"></p>
<p><img src="/img/ADLAB_Untitled_27.png" alt="Untitled"></p>
<p>So the only account that we have to login into domain </p>
<p><img src="/img/ADLAB_Untitled_28.png" alt="Untitled"></p>
<ul>
<li>creat other administrator<ul>
<li>copy that administrator</li>
<li>It will copy all of the permissions that the administrator has</li>
<li>可以查看administrator有什麼權限..</li>
</ul>
</li>
</ul>
<p><img src="/img/ADLAB_Untitled_29.png" alt="Untitled"></p>
<p><img src="/img/ADLAB_Untitled_30.png" alt="Untitled"></p>
<p>copy後填入用戶訊息 &gt; tstark &gt; passwd &gt; Akali@@</p>
<p><img src="/img/ADLAB_Untitled_31.png" alt="Untitled"></p>
<p><img src="/img/ADLAB_Untitled_32.png" alt="Untitled"></p>
<p>Create a service and account that is a domain administrator</p>
<ul>
<li>SQLService &gt; password &gt; MYpassword123#</li>
<li>run as domain admin</li>
<li>名字間不要有空格</li>
</ul>
<p><img src="/img/ADLAB_Untitled_33.png" alt="Untitled"></p>
<p><img src="/img/ADLAB_Untitled_34.png" alt="Untitled"></p>
<p>很多管理員會在Description留下機敏資訊，這邊模擬他們的行為</p>
<p><img src="/img/ADLAB_Untitled_35.png" alt="Untitled"></p>
<p>再創兩個低權限用戶在domain user group</p>
<p><img src="/img/ADLAB_Untitled_36.png" alt="Untitled"></p>
<ul>
<li>fcastle &gt; Password1</li>
</ul>
<p><img src="/img/ADLAB_Untitled_37.png" alt="Untitled"></p>
<p><img src="/img/ADLAB_Untitled_38.png" alt="Untitled"></p>
<p>從前面可以看到許多不安全設定</p>
<p>複製Frank用戶設定</p>
<p><img src="/img/ADLAB_Untitled_39.png" alt="Untitled"></p>
<p><img src="/img/ADLAB_Untitled_40.png" alt="Untitled"></p>
<p><img src="/img/ADLAB_Untitled_41.png" alt="Untitled"></p>
<p>全部設定完長這樣</p>
<p><img src="/img/ADLAB_Untitled_42.png" alt="Untitled"></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">WinServer -&gt;</span><br><span class="line">DC name -  HYDRA-DC</span><br><span class="line">Forest - MARVEL.<span class="built_in">local</span></span><br><span class="line"></span><br><span class="line">useradd -&gt;</span><br><span class="line">+ admin -&gt;</span><br><span class="line">	+ Tony Stark -&gt;</span><br><span class="line">		+ logon name - tstark</span><br><span class="line">		+ passwd - Akali@@</span><br><span class="line">	+ SQLService -&gt;</span><br><span class="line">		+ logon name - SQLService</span><br><span class="line">		+ passwd -&gt; MYpassword123#</span><br><span class="line">		+ description leak the passwd</span><br><span class="line"></span><br><span class="line">+ user -&gt;</span><br><span class="line">	+ Frank Castle - &gt;</span><br><span class="line">		+ logon name - fcastle</span><br><span class="line">		+ passwd - Password1</span><br><span class="line">	+ Peter Parker -&gt;</span><br><span class="line">		+ logon name - pparker</span><br><span class="line">		+ passwd - Akali@@</span><br></pre></td></tr></table></figure>

<p>Create a file share &gt; abuse later on</p>
<ul>
<li>File and Storage Services &gt;Share &gt; New Share &gt; next &gt; next</li>
</ul>
<p><img src="/img/ADLAB_Untitled_43.png" alt="Untitled"></p>
<p><img src="/img/ADLAB_Untitled_44.png" alt="Untitled"></p>
<p>have a remote path for us of Hydro DC hackme &gt; next&gt;next&gt;create</p>
<p><img src="/img/ADLAB_Untitled_45.png" alt="Untitled"></p>
<p><img src="/img/ADLAB_Untitled_46.png" alt="Untitled"></p>
<p>Setup the service account fully that we had before</p>
<p>開啟CMD並用管理員身分運行</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">Microsoft Windows [Version 10.0.20348.587]</span><br><span class="line">(c) Microsoft Corporation. All rights reserved.</span><br><span class="line"></span><br><span class="line">C:\Users\Administrator&gt;**setspn -a HYDRA-DC/SQLService.MARVEL.<span class="built_in">local</span>:60111 MARVEL\SQLService</span><br><span class="line">Checking domain DC=MARVEL,DC=<span class="built_in">local</span></span><br><span class="line"></span><br><span class="line">Registering ServicePrincipalNames <span class="keyword">for</span> CN=SQL Service,CN=Users,DC=MARVEL,DC=<span class="built_in">local</span></span><br><span class="line">        HYDRA-DC/SQLService.MARVEL.<span class="built_in">local</span>:60111</span><br><span class="line">Updated object**</span><br></pre></td></tr></table></figure>

<ul>
<li>MARVEL.local 網域中名為 HYDRA-DC 的伺服器上執行的服務新增服務主體名稱 (SPN)</li>
</ul>
<p>如果要使用 Active Directory 作為 Kerberos 實作，請使用 <code>setspn</code> 指令來登錄 SPN。 要執行此指令，必須滿足下列條件：</p>
<ul>
<li>您必須登入到網域控制站</li>
<li>您必須使用提升的特權（以管理者身分執行）來執行命令提示字元</li>
<li>您必須是 Domain Admins 群組的成員（或者網域管理者已授予您適當的許可權）</li>
</ul>
<p>此命令將傳回在 MARVEL.local 網域中註冊的所有 SPN 的列表，以及關聯的服務類別和伺服器名稱。它對於解決 SPN 相關問題或驗證網域中配置的 SPN 非常有用。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">C:\Users\Administrator&gt;**setspn -T MARVEL.<span class="built_in">local</span> -Q */***</span><br><span class="line">Checking domain DC=MARVEL,DC=<span class="built_in">local</span></span><br><span class="line">CN=HYDRA-DC,OU=Domain Controllers,DC=MARVEL,DC=<span class="built_in">local</span></span><br><span class="line">        Dfsr-12F9A27C-BF97-4787-9364-D31B6C55EB04/HYDRA-DC.MARVEL.<span class="built_in">local</span></span><br><span class="line">        ldap/HYDRA-DC.MARVEL.<span class="built_in">local</span>/ForestDnsZones.MARVEL.<span class="built_in">local</span></span><br><span class="line">        ldap/HYDRA-DC.MARVEL.<span class="built_in">local</span>/DomainDnsZones.MARVEL.<span class="built_in">local</span></span><br><span class="line">        DNS/HYDRA-DC.MARVEL.<span class="built_in">local</span></span><br><span class="line">        GC/HYDRA-DC.MARVEL.<span class="built_in">local</span>/MARVEL.<span class="built_in">local</span></span><br><span class="line">        RestrictedKrbHost/HYDRA-DC.MARVEL.<span class="built_in">local</span></span><br><span class="line">        RestrictedKrbHost/HYDRA-DC</span><br><span class="line">        RPC/ff28a91a-7cfe-4680-84a0-e7ccfe7f8feb._msdcs.MARVEL.<span class="built_in">local</span></span><br><span class="line">        HOST/HYDRA-DC/MARVEL</span><br><span class="line">        HOST/HYDRA-DC.MARVEL.<span class="built_in">local</span>/MARVEL</span><br><span class="line">        HOST/HYDRA-DC</span><br><span class="line">        HOST/HYDRA-DC.MARVEL.<span class="built_in">local</span></span><br><span class="line">        HOST/HYDRA-DC.MARVEL.<span class="built_in">local</span>/MARVEL.<span class="built_in">local</span></span><br><span class="line">        E3514235-4B06-11D1-AB04-00C04FC2DCD2/ff28a91a-7cfe-4680-84a0-e7ccfe7f8feb/MARVEL.<span class="built_in">local</span></span><br><span class="line">        ldap/HYDRA-DC/MARVEL</span><br><span class="line">        ldap/ff28a91a-7cfe-4680-84a0-e7ccfe7f8feb._msdcs.MARVEL.<span class="built_in">local</span></span><br><span class="line">        ldap/HYDRA-DC.MARVEL.<span class="built_in">local</span>/MARVEL</span><br><span class="line">        ldap/HYDRA-DC</span><br><span class="line">        ldap/HYDRA-DC.MARVEL.<span class="built_in">local</span></span><br><span class="line">        ldap/HYDRA-DC.MARVEL.<span class="built_in">local</span>/MARVEL.<span class="built_in">local</span></span><br><span class="line">CN=krbtgt,CN=Users,DC=MARVEL,DC=<span class="built_in">local</span></span><br><span class="line">        kadmin/changepw</span><br><span class="line">CN=SQL Service,CN=Users,DC=MARVEL,DC=<span class="built_in">local</span></span><br><span class="line">        HYDRA-DC/SQLService.MARVEL.<span class="built_in">local</span>:60111</span><br><span class="line"></span><br><span class="line">**Existing SPN found!**</span><br></pre></td></tr></table></figure>

<ul>
<li>存在<strong>Kerberos rusting attack risk</strong></li>
<li>只需一個網域帳戶即可執行 Kerberoasting，**服務主體名稱 (SPN)**可以請求 - 任何人都可以執行此操作</li>
<li>Kerberos 驗證使用 SPN 將服務實例與使用者帳戶關聯。</li>
<li>這允許客戶端應用程式要求服務對帳戶進行身份驗證，即使客戶端不知道帳戶名稱也是如此。</li>
<li>當提供指定一個<strong>SPN 的TGS 請求</strong>並且該 SPN 已在 Active Directory 中註冊時，網域控制站會提供一張票證。該票證包含執行該服務的帳戶的<strong>金鑰</strong>。有了這些訊息，攻擊者現在就可以嘗試使用票據離線<strong>暴力攻擊</strong>進行破解，從而獲取用戶的明文密碼。</li>
</ul>
<p>設定Group policy</p>
<ul>
<li>pushing for the entire domain</li>
<li>搜索框搜尋Group</li>
<li>Specifically create GPOs for specific groups or users &gt; do it for whole domain</li>
</ul>
<p><img src="/img/ADLAB_Untitled_47.png" alt="Untitled"></p>
<p><img src="/img/ADLAB_Untitled_48.png" alt="Untitled"></p>
<p>going to disable Windows Defender in this environment &gt; attacker can run all attacks</p>
<ul>
<li>where is antivirus going to get picked up if run an attack</li>
</ul>
<p><img src="/img/ADLAB_Untitled_49.png" alt="Untitled"></p>
<p>找到Microsoft Defender Antivirus &gt; Turn off Microsoft Defender Antivirus</p>
<ul>
<li>再更早版本的winser含2019 &gt; Windows Defender Antivirus</li>
</ul>
<p><img src="/img/ADLAB_Untitled_50.png" alt="Untitled"></p>
<p><img src="/img/ADLAB_Untitled_51.png" alt="Untitled"></p>
<p><img src="/img/ADLAB_Untitled_52.png" alt="Untitled"></p>
<p>回到GPO設定 &gt; Disable Windows Defender &gt; Enforced</p>
<ul>
<li>anytime that user joins the domain or a computer joins the domain, it’s going to get this policy</li>
<li>or when the policy updates on that computer, If it’s already domain joined, it will get this policy as will</li>
<li>So this will disable defender once we join the domain with our computers</li>
</ul>
<p><img src="/img/ADLAB_Untitled_53.png" alt="Untitled"></p>
<p><img src="/img/ADLAB_Untitled_54.png" alt="Untitled"></p>
<p>Make sure this machine have IP address</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">C:\Users\Administrator&gt;ipconfig</span><br><span class="line"></span><br><span class="line">Windows IP Configuration</span><br><span class="line"></span><br><span class="line">Ethernet adapter Ethernet0:</span><br><span class="line"></span><br><span class="line">   Connection-specific DNS Suffix  . : localdomain</span><br><span class="line">   Link-<span class="built_in">local</span> IPv6 Address . . . . . : fe80::6da1:be85:db3e:51ea%6</span><br><span class="line">   IPv4 Address. . . . . . . . . . . : 192.168.19.148</span><br><span class="line">   Subnet Mask . . . . . . . . . . . : 255.255.255.0</span><br><span class="line">   Default Gateway . . . . . . . . . : 192.168.19.2</span><br></pre></td></tr></table></figure>

<p>或是手動設置IP地址</p>
<p><img src="/img/ADLAB_Untitled_55.png" alt="Untitled"></p>
<p>這台機器不需要聯網，所以設置靜態IP給他</p>
<p><img src="/img/ADLAB_Untitled_56.png" alt="Untitled"></p>
<h2 id="Joining-Our-Machines-to-the-Domain"><a href="#Joining-Our-Machines-to-the-Domain" class="headerlink" title="Joining Our Machines to the Domain"></a><strong>Joining Our Machines to the Domain</strong></h2><p>兩台win10都要設定</p>
<p>Join these machines to the domain </p>
<ul>
<li>check to make sure that we’re getting all of our policies and that everything’s joined</li>
<li>utilize the accounts that we have for this machine</li>
<li>change the DNS, because need to point this directly at our domain controller</li>
</ul>
<p><img src="/img/ADLAB_Untitled_57.png" alt="Untitled"></p>
<p><img src="/img/ADLAB_Untitled_58.png" alt="Untitled"></p>
<h3 id="Join-the-domain"><a href="#Join-the-domain" class="headerlink" title="Join the domain"></a>Join the domain</h3><ul>
<li>搜索框打domain &gt; Access work or school &gt;Connect &gt; Join this device to a local Active..</li>
</ul>
<p><img src="/img/ADLAB_Untitled_59.png" alt="Untitled"></p>
<p><img src="/img/ADLAB_Untitled_60.png" alt="Untitled"></p>
<p>輸入帳號密碼登入</p>
<ul>
<li>username - administrator</li>
<li>passwd - Akali@</li>
</ul>
<p><img src="/img/ADLAB_Untitled_61.png" alt="Untitled"></p>
<p><img src="/img/ADLAB_Untitled_62.png" alt="Untitled"></p>
<p>back to winser &gt; make sure that actually did join these machines</p>
<p><img src="/img/ADLAB_Untitled_63.png" alt="Untitled"></p>
<p><img src="/img/ADLAB_Untitled_64.png" alt="Untitled"></p>
<p>兩台win10重登後登入網域下的帳戶，設置相同</p>
<p>並找到 locla users and groups &gt; users &gt; Administrator &gt; Set Password &gt; Proceed &gt; 輸入密碼</p>
<p><img src="/img/ADLAB_Untitled_65.png" alt="Untitled"></p>
<p><img src="/img/ADLAB_Untitled_66.png" alt="Untitled"></p>
<p><img src="/img/ADLAB_Untitled_67.png" alt="Untitled"></p>
<p>雙擊Administrator - uncheck Account is disable</p>
<p><img src="/img/ADLAB_Untitled_68.png" alt="Untitled"></p>
<p>Look at the administrators on this computer，並且新增Frank Castle用戶</p>
<ul>
<li>Group &gt; Administrators &gt;Add &gt; Frank Castle</li>
</ul>
<p>THEPUNISHER-2 &gt; Group - Add Frank Castle</p>
<p>SPIDERMAN-2 &gt; Group - Add Peter Parker、Frank Castle</p>
<p><img src="/img/ADLAB_Untitled_69.png" alt="Untitled"></p>
<p><img src="/img/ADLAB_Untitled_70.png" alt="Untitled"></p>
<p><img src="/img/ADLAB_Untitled_71.png" alt="THEPUNISHER-2"></p>
<p>THEPUNISHER-2</p>
<p><img src="/img/ADLAB_Untitled_72.png" alt="SPIDERMAN-2"></p>
<p>SPIDERMAN-2</p>
<p>到檔案管理員 &gt; 網路 &gt; 關閉錯誤訊息 &gt; Turn on network discovery and file sharing</p>
<p>點入HYDRA-DC文件能查看到共享文件內容</p>
<p><img src="/img/ADLAB_Untitled_73.png" alt="Untitled"></p>
<p><img src="/img/ADLAB_Untitled_74.png" alt="Untitled"></p>
<p><img src="/img/ADLAB_Untitled_75.png" alt="Untitled"></p>
<p>登出當前管理員帳號，登入一般使用者嘗試</p>
<ul>
<li>logon name - .\peterparker</li>
<li>passwd - Akail@</li>
</ul>
<p>文件 &gt; This PC &gt; Computer &gt; Map network..&gt;填入文件位置 <code>\\HYDRA-DC\hackme</code> &gt; 打勾Connect using different credentials &gt; 輸入administrator&#x2F;Akali@</p>
<p><img src="/img/ADLAB_Untitled_76.png" alt="Untitled"></p>
<p><img src="/img/ADLAB_Untitled_77.png" alt="Untitled"></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">WinServer -&gt;</span><br><span class="line">DC name -  HYDRA-DC</span><br><span class="line">Forest - MARVEL.<span class="built_in">local</span></span><br><span class="line">GPO(Group Policy Management) - Disable Windows Defender</span><br><span class="line">IP - 192.168.19.140</span><br><span class="line"></span><br><span class="line">win10 -&gt;</span><br><span class="line">user -&gt; </span><br><span class="line">+ frankcastle/Akali@@</span><br><span class="line">	+ IP - 192.168.19.149</span><br><span class="line">+ peterparker/Akali@@</span><br><span class="line">	+ IP - 192.168.19.150</span><br><span class="line"></span><br><span class="line">useradd -&gt;</span><br><span class="line">+ admin -&gt;</span><br><span class="line">	+ Tony Stark -&gt;</span><br><span class="line">		+ logon name - tstark</span><br><span class="line">		+ passwd - Akali@@</span><br><span class="line">	+ SQL Service -&gt;</span><br><span class="line">		+ logon name - SQL Service</span><br><span class="line">		+ passwd -&gt; MYpassword123#</span><br><span class="line">		+ description leak the passwd</span><br><span class="line"></span><br><span class="line">+ user -&gt;</span><br><span class="line">	+ Frank Castle - &gt;</span><br><span class="line">		+ logon name - fcastle</span><br><span class="line">		+ passwd - Password1</span><br><span class="line">	+ Peter Parker -&gt;</span><br><span class="line">		+ logon name - pparker</span><br><span class="line">		+ passwd - Password1</span><br></pre></td></tr></table></figure>
      
    </div>
    
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2024/12/21/Attacking%20Active%20Directory%20Post-Compromise%20Enumera/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">&lt;</strong>
      <div class="article-nav-title">
        
          AD - Post Compromise Enumeration
        
      </div>
    </a>
  
  
    <a href="/2024/12/21/Attacking%20Active%20Directory%20Initial%20Attack%20Vectors/" id="article-nav-older" class="article-nav-link-wrap">
      <div class="article-nav-title">AD - Initial Attack Vectors</div>
      <strong class="article-nav-caption">&gt;</strong>
    </a>
  
</nav>

  
</article>





</div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
      <div class="footer-left">
        &copy; 2025 Noflag
      </div>
        <div class="footer-right">
          <a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/smackgg/hexo-theme-smackdown" target="_blank">Smackdown</a>
        </div>
    </div>
  </div>
</footer>
    </div>
    
  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">



<script>
	var yiliaConfig = {
		fancybox: true,
		mathjax: true,
		animate: true,
		isHome: false,
		isPost: true,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: false
	}
</script>

<script src="/js/main.js"></script>




<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';                 
    }       
});
</script>

<script src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js"></script>


  </div>
</body>
</html>